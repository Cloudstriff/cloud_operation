!function(a,b){"function"==typeof define&&define.amd?define("BulbEditor",["jqueryContextMenu","backbone","underscore.string"],function(){return a.BulbEditor=b()}):"undefined"!=typeof exports?b():a.BulbEditor=b()}(this,function(){this.JST=this.JST||{},this.JST["ytable/editor/button"]=function(obj){obj||(obj={});var __t,__p="";_.escape,Array.prototype.join;with(obj)__p+='<div class="button" title="'+(null==(__t=tag)?"":__t)+'"></div><div class="button-text" ',text||(__p+=' style="display:none;" '),__p+=" >"+(null==(__t=text)?"":__t)+"</div>";return __p},this.JST["ytable/editor/cell_resize"]=function(obj){obj||(obj={});var __p="";_.escape;with(obj)__p+='<div class="resize-top"></div><div class="resize-right"></div><div class="resize-bottom"></div><div class="resize-left"></div>';return __p},this.JST["ytable/editor/col_header"]=function(obj){obj||(obj={});var __p="";_.escape;with(obj)__p+='<div class="col-header-table-wrapper"><table><thead><tr></tr></thead></table></div>';return __p},this.JST["ytable/editor/col_header_cell"]=function(obj){obj||(obj={});var __p="";_.escape;with(obj)__p+='<div class="col-header-cell-wrapper"><div class="col-name"></div><div class="col-resizer"></div></div>';return __p},this.JST["ytable/editor/combo_box"]=function(obj){obj||(obj={});var __t,__p="";_.escape,Array.prototype.join;with(obj){options.button&&(__p+='<div class="button-wrapper"><div class="button button-'+(null==(__t=name)?"":__t)+'">',options.color&&(__p+='<div class="current-color"></div>'),__p+='</div><div class="button-text" ',text||(__p+=' style="display:none;" '),__p+=" >"+(null==(__t=text)?"":__t)+"</div></div>"),__p+='<div class="combo-disp"></div><ul class="combo-list">';for(name in items)"split"==items[name].type?(__p+='<li class="combo-split">',__p+=items[name].html?null==(__t=items[name].html)?"":__t:'<div class="combo-box-split"></div>',__p+="</li>"):__p+='<li class="combo-item combo-item-'+(null==(__t=name)?"":__t)+'" data-name="'+(null==(__t=name)?"":__t)+'">'+(null==(__t=items[name].html)?"":__t)+"</li>";__p+="</ul>"}return __p},this.JST["ytable/editor/formula_edit"]=function(obj){obj||(obj={});var __p="";_.escape;with(obj)__p+='<div class="edit-wrapper"><div class="cell-name"></div><div class="input-wrapper"><input class="edit-input"/></div></div>';return __p},this.JST["ytable/editor/row_header"]=function(obj){obj||(obj={});var __p="";_.escape;with(obj)__p+='<table></table><div class="add-row-button" title="添加10行">+</div>';return __p},this.JST["ytable/editor/row_header_cell"]=function(obj){obj||(obj={});var __p="";_.escape;with(obj)__p+='<div class="row-header-cell-wrapper"><div class="row-name"></div><div class="row-resizer"></div></div>';return __p},this.JST["ytable/editor/table_edit"]=function(obj){obj||(obj={});var __t,__p="";_.escape;with(obj)__p+='<div class="table-padding"><div class="'+(null==(__t=className)?"":__t)+'"><table class="contents"><colgroup></colgroup></table></div></div><div class="'+(null==(__t=selectionClassName)?"":__t)+'"><div class="'+(null==(__t=activeCellClassName)?"":__t)+'"></div><div class="'+(null==(__t=rangeClassName)?"":__t)+'"></div><div class="'+(null==(__t=rangeClassName)?"":__t)+'"></div><div class="'+(null==(__t=rangeClassName)?"":__t)+'"></div><div class="'+(null==(__t=rangeClassName)?"":__t)+'"></div><div class="'+(null==(__t=rangeClassName)?"":__t)+'"></div><div class="'+(null==(__t=rangeClassName)?"":__t)+'"></div><div class="'+(null==(__t=rangeClassName)?"":__t)+'"></div><div class="'+(null==(__t=rangeClassName)?"":__t)+'"></div><div class="'+(null==(__t=rangeClassName)?"":__t)+'"></div><div class="'+(null==(__t=rangeClassName)?"":__t)+'"></div></div><div class="'+(null==(__t=clipboardClassName)?"":__t)+'"></div><div class="'+(null==(__t=cellEditorClassName)?"":__t)+'"><div class="cell-edit-box" contenteditable="true"></div></div>';return __p},this.JST["ytable/editor/table_title"]=function(obj){obj||(obj={});var __p="";_.escape;with(obj)__p+='<input class="title-input" placeHolder="请输入标题"/>';return __p},this.JST["ytable/editor/toolbar"]=function(obj){obj||(obj={});var __p="";_.escape;with(obj)__p+='<div class="toolbar"></div>';return __p},this.JST["ytable/editor/wait_view"]=function(obj){obj||(obj={});var __t,__p="";_.escape;with(obj)__p+='<div class="loading-wrapper"><div class="loading-inner"><div class="loading-image"></div><div class="loading-text">'+(null==(__t=text)?"":__t)+"</div></div></div>";return __p},this.JST["ytable/plugins/border_combo_item"]=function(obj){obj||(obj={});var __t,__p="";_.escape,Array.prototype.join;with(obj)__p+='<div class="combo-icon"></div><div class="combo-text">',info&&(__p+=null==(__t=info.name)?"":__t),__p+="</div>";return __p},this.JST["ytable/plugins/color_combo_item"]=function(obj){obj||(obj={});var __t,__p="";_.escape,Array.prototype.join;with(obj)__p+='<div class="color-item color-item-'+(null==(__t=type)?"":__t)+" "+(null==(__t=additionalClass)?"":__t)+'" style="background:'+(null==(__t=dispName)?"":__t)+';" title="'+(null==(__t=setupName)?"":__t)+'"><div class="color-outline"></div></div>',"default"===type&&(__p+='<div class="color-label" title="默认颜色">默认颜色</div>');return __p},this.JST["ytable/plugins/combo_more"]=function(obj){obj||(obj={});var __t,__p="";_.escape,Array.prototype.join;with(obj)__p+='<div class="toolbar-more-split"></div><div class="button-wrapper"><div class="button button-more"></div><div class="button-text" ',text||(__p+=' style="display:none;" '),__p+=" >"+(null==(__t=text)?"":__t)+'</div></div><div class="combo-more-wrapper"><div class="combo-more-list"></div></div>';return __p},this.JST["ytable/plugins/font_name_combo_item"]=function(obj){obj||(obj={});var __t,__p="";_.escape;with(obj)__p+='<span style="font-family:'+(null==(__t=setupName)?"":__t)+'">'+(null==(__t=dispName)?"":__t)+"</span>";return __p},this.JST["ytable/plugins/font_size_combo_item"]=function(obj){obj||(obj={});var __t,__p="";_.escape;with(obj)__p+='<span style="font-size:'+(null==(__t=setupName)?"":__t)+'">'+(null==(__t=dispName)?"":__t)+"</span>";return __p},this.JST["ytable/plugins/info_view"]=function(obj){obj||(obj={});var __t,__p="";_.escape,Array.prototype.join;with(obj)__p+='<div class="info-icon ',iconShown||(__p+="hide"),__p+='"></div><div class="info-text">'+(null==(__t=text)?"":__t)+"</div>";return __p},this.JST["ytable/plugins/online_clients_child"]=function(obj){obj||(obj={});var __t,__p="";_.escape;with(obj)__p+='<div class="online-child-wrapper" title="'+(null==(__t=userInfo.name)?"":__t)+'"><img class="online-photo" src="'+(null==(__t=userInfo.photo)?"":__t)+'" /><div class="online-name">'+(null==(__t=userInfo.name)?"":__t)+"</div></div>";return __p},this.JST["ytable/plugins/online_clients_container"]=function(obj){obj||(obj={});var __p="";_.escape;with(obj)__p+='<div class="online-clients-wrapper"></div>';return __p},this.JST["ytable/plugins/others_selection"]=function(obj){obj||(obj={});var __t,__p="";_.escape;with(obj)__p+='<div class="focus-cell client-'+(null==(__t=clientId)?"":__t)+'"><div class="focus-name hide">'+(null==(__t=userInfo.name)?"":__t)+"</div></div>";return __p},this.JST["common/attachment-view-attachment-container"]=function(obj){obj||(obj={});var __t,__p="";_.escape;with(obj)__p+='<div class="attachment-container"><img src="'+(null==(__t=src)?"":__t)+'" /><div class="menu-wrapper"><div class="yne-button-group"><div class="yne-button-item" title="查看"><span class="yne-button" data-button-name="view">查看</span></div><div class="yne-button-item yne-last" title="快捷菜单"><span class="yne-button" data-button-name="menu">快捷菜单</span><span class="yne-arrow-down"></span></div><div class="yne-clear"></div></div><ul class="yne-popup-menu"><li class="yne-popup-item" data-cm-name="float-left"><span>左浮动</span></li><li class="yne-popup-item" data-cm-name="float-right"><span>右浮动</span></li><li class="yne-popup-item" data-cm-name="clear-float"><span>清除浮动</span></li><li class="yne-popup-item yne-popup-split"></li><li class="yne-popup-item" data-cm-name="upload"><span>上传附件</span></li><li class="yne-popup-item" data-cm-name="delete"><span>删除附件</span></li><li class="yne-popup-item" data-cm-name="download"><span>另存为</span></li></ul></div></div>';return __p},this.JST["common/image-view-image-container"]=function(obj){obj||(obj={});var __t,__p="";_.escape;with(obj)__p+='<div class="image-container"><img src="'+(null==(__t=src)?"":__t)+'" /><div class="resize-handle" data-corner="0"></div><div class="resize-handle" data-corner="1"></div><div class="resize-handle" data-corner="2"></div><div class="resize-handle" data-corner="3"></div><div class="menu-wrapper"><div class="yne-button-group"><div class="yne-button-item yne-last" title="快捷菜单"><span class="yne-button" data-button-name="menu">快捷菜单</span><span class="yne-arrow-down"></span></div><div class="yne-clear"></div></div><ul class="yne-popup-menu"><li class="yne-popup-item" data-cm-name="float-left"><span>左浮动</span></li><li class="yne-popup-item" data-cm-name="float-right"><span>右浮动</span></li><li class="yne-popup-item" data-cm-name="clear-float"><span>清除浮动</span></li><li class="yne-popup-item" data-cm-name="clear-resize"><span>清除缩放</span></li><li class="yne-popup-item yne-popup-split"></li><li class="yne-popup-item" data-cm-name="upload"><span>上传图片</span></li><li class="yne-popup-item" data-cm-name="delete"><span>删除图片</span></li></ul></div></div>';return __p},this.JST["common/list_item_view"]=function(obj){obj||(obj={});var __p="";_.escape,Array.prototype.join;with(obj)__p+=isOrdered?'<ol class="li-box"><li><div class="para-text"></div></li></ol>':'<ul class="li-box"><li><div class="para-text"></div></li></ul>';return __p},this.JST["common/paragraph_view"]=function(obj){obj||(obj={});var __p="";_.escape;with(obj)__p+='<div class="para-text"></div>';return __p},this.JST["web/toolbar-button-template"]=function(obj){obj||(obj={});var __t,__p="";_.escape;with(obj)__p+='<div class="button-wrapper button-wrapper-'+(null==(__t=name)?"":__t)+'"><div class="button button-'+(null==(__t=name)?"":__t)+'" title="'+(null==(__t=label)?"":__t)+'"></div></div>';return __p},this.JST["web/toolbar-combo-box-align"]=function(obj){obj||(obj={});var __t,__p="";_.escape,Array.prototype.join;with(obj){__p+='<div class="combo-display-wrapper" title="'+(null==(__t=label)?"":__t)+'"><div class="combo-value-wrapper"><span class="combo-value combo-value-'+(null==(__t=name)?"":__t)+'"></span></div><div class="combo-expand-wrapper"><span class="combo-expand"></span></div></div><div class="combo-menu-wrapper"><ul class="combo-menu combo-menu-'+(null==(__t=name)?"":__t)+'">';for(key in items)__p+='<li class="combo-item" data-value="'+(null==(__t=key)?"":__t)+'"><span class="combo-item-icon-'+(null==(__t=name)?"":__t)+" "+(null==(__t=key)?"":__t)+'">&nbsp;</span><span class="combo-item-span-'+(null==(__t=name)?"":__t)+'">'+(null==(__t=items[key])?"":__t)+"</span></li>";__p+="</ul></div>"}return __p},this.JST["web/toolbar-combo-box-color"]=function(obj){obj||(obj={});var __t,__p="";_.escape,Array.prototype.join;with(obj){__p+='<div class="combo-display-wrapper" title="'+(null==(__t=label)?"":__t)+'"><div class="combo-value-wrapper"><span class="combo-value combo-value-'+(null==(__t=name)?"":__t)+'"><span class="combo-value-buttom-color"></span></span></div><div class="combo-expand-wrapper"><span class="combo-expand"></span></div></div><div class="combo-menu-wrapper"><div class="combo-menu combo-menu-'+(null==(__t=name)?"":__t)+'"><div class="color-section color-section-default combo-item" data-value="'+(null==(__t=defaultValue)?"":__t)+'"><div class="color-cell combo-item color-cell-default" data-value="'+(null==(__t=defaultValue)?"":__t)+'" style="background-color:'+(null==(__t=defaultValue)?"":__t)+';"></div><div class="color-label color-label-default">默认颜色</div></div><hr class="color-section-split"><div class="color-section color-section-theme"><div class="color-label color-label-theme">主题颜色</div><div class="color-row">';for(key in items.theme)__p+='<div class="color-cell combo-item" data-value="'+(null==(__t=items.theme[key])?"":__t)+'" style="background-color:'+(null==(__t=items.theme[key])?"":__t)+';"></div>';__p+='</div><div class="color-row-split"></div><div class="color-part-theme">';for(row in items.other){__p+='<div class="color-row">';for(key in items.other[row])__p+='<div class="color-cell combo-item" data-value="'+(null==(__t=items.other[row][key])?"":__t)+'" style="background-color:'+(null==(__t=items.other[row][key])?"":__t)+';"></div>';__p+="</div>"}__p+='</div></div><hr class="color-section-split"><div class="color-section color-section-standard"><div class="color-label color-label-standard">标准色</div><div class="color-row">';for(key in items.standard)__p+='<div class="color-cell combo-item" data-value="'+(null==(__t=items.standard[key])?"":__t)+'" style="background-color:'+(null==(__t=items.standard[key])?"":__t)+';"></div>';__p+="</div></div></div></div>"}return __p},this.JST["web/toolbar-combo-box-font-family"]=function(obj){obj||(obj={});var __t,__p="";_.escape,Array.prototype.join;with(obj){__p+='<div class="combo-display-wrapper" title="'+(null==(__t=label)?"":__t)+'"><div class="combo-value-wrapper"><span class="combo-value combo-value-'+(null==(__t=name)?"":__t)+'"></span></div><div class="combo-expand-wrapper"><span class="combo-expand"></span></div></div><div class="combo-menu-wrapper"><ul class="combo-menu combo-menu-'+(null==(__t=name)?"":__t)+'">';for(key in items)__p+='<li class="combo-item" data-value="'+(null==(__t=key)?"":__t)+'"><span style="font-family:'+(null==(__t=key)?"":__t)+';">'+(null==(__t=items[key])?"":__t)+"</span></li>";__p+="</ul></div>"}return __p},this.JST["web/toolbar-combo-box-font-size"]=function(obj){obj||(obj={});var __t,__p="";_.escape,Array.prototype.join;with(obj){__p+='<div class="combo-display-wrapper" title="'+(null==(__t=label)?"":__t)+'"><div class="combo-value-wrapper"><span class="combo-value combo-value-'+(null==(__t=name)?"":__t)+'"></span></div><div class="combo-expand-wrapper"><span class="combo-expand"></span></div></div><div class="combo-menu-wrapper"><ul class="combo-menu combo-menu-'+(null==(__t=name)?"":__t)+'">';for(key in items)__p+='<li class="combo-item" data-value="'+(null==(__t=key)?"":__t)+'" style="height:'+(null==(__t=key)?"":__t)+"px; line-height:"+(null==(__t=key)?"":__t)+'px;"><span style="font-size:'+(null==(__t=key)?"":__t)+'px;">'+(null==(__t=items[key])?"":__t)+"</span></li>";__p+="</ul></div>"}return __p},this.JST["web/toolbar-combo-box-line-height"]=function(obj){obj||(obj={});var __t,__p="";_.escape,Array.prototype.join;with(obj){__p+='<div class="combo-display-wrapper" title="'+(null==(__t=label)?"":__t)+'"><div class="combo-value-wrapper"><span class="combo-value combo-value-'+(null==(__t=name)?"":__t)+'"></span></div><div class="combo-expand-wrapper"><span class="combo-expand"></span></div></div><div class="combo-menu-wrapper"><ul class="combo-menu combo-menu-'+(null==(__t=name)?"":__t)+'">';for(idx in items)__p+='<li class="combo-item" data-value="'+(null==(__t=items[idx].key)?"":__t)+'"><span class="combo-item-icon-'+(null==(__t=name)?"":__t)+" line-height-"+(null==(__t=idx)?"":__t)+'">&nbsp;</span><span class="combo-item-span-'+(null==(__t=name)?"":__t)+'">'+(null==(__t=items[idx].value)?"":__t)+"</span></li>";__p+="</ul></div>"}return __p},this.JST["web/toolbar-combo-box-show-more"]=function(obj){obj||(obj={});var __t,__p="";_.escape;with(obj)__p+='<div class="toolbar-more-split"></div><div class="combo-display-wrapper combo-showmore-wrapper" title="'+(null==(__t=label)?"":__t)+'"><div class="combo-value-wrapper combo-value-wrapper-'+(null==(__t=name)?"":__t)+'"><span class="combo-value combo-value-'+(null==(__t=name)?"":__t)+'">更多</span><span class="combo-expand-gray"></span></div></div><div class="combo-menu-wrapper  wrapper-'+(null==(__t=name)?"":__t)+'"><div class="combo-menu combo-menu-'+(null==(__t=name)?"":__t)+'"></div></div>';return __p},this.JST["web/toolbar-combo-box-table"]=function(obj){obj||(obj={});var __t,__p="";_.escape,Array.prototype.join;with(obj){__p+='<div class="combo-display-wrapper" title="'+(null==(__t=label)?"":__t)+'"><div class="combo-value-wrapper"><span class="combo-value combo-value-'+(null==(__t=name)?"":__t)+'"></span></div></div><div class="combo-menu-wrapper"><div class="combo-menu-label-'+(null==(__t=name)?"":__t)+'">插入表格</div><div class="combo-menu combo-menu-'+(null==(__t=name)?"":__t)+'">';for(var i=0;i<maxRows;i++)for(var j=0;j<maxCols;j++)__p+='<span class="combo-item" data-row="'+(null==(__t=i)?"":__t)+'" data-col="'+(null==(__t=j)?"":__t)+'"></span>';__p+="</div></div>"}return __p},this.JST["web/toolbar-combo-box-template"]=function(obj){obj||(obj={});var __p="";_.escape;with(obj)__p+='<div class="combo-display-wrapper"><div class="combo-value-wrapper"></div><div class="combo-expand-wrapper"></div></div><div class="combo-menu-wrapper"></div>';return __p},this.JST["web/toolbar_view"]=function(obj){obj||(obj={});var __t,__p="";_.escape,Array.prototype.join;with(obj)__p+='<div class="toolbar-container">',_.each(items,function(a,b){"button"===a.type?__p+='<button class="'+(null==(__t=b)?"":__t)+'" action="'+(null==(__t=a.action)?"":__t)+'" name="'+(null==(__t=a.name)?"":__t)+'" type="button" data-yne-is-block="'+(null==(__t=!!a.block)?"":__t)+'">'+(null==(__t=a.label)?"":__t)+"</button>":"select"===a.type&&(__p+='<select class="'+(null==(__t=b)?"":__t)+'" action="'+(null==(__t=a.action)?"":__t)+'" name="'+(null==(__t=a.name)?"":__t)+'" data-yne-is-block="'+(null==(__t=!!a.block)?"":__t)+'">',_.each(a.options,function(a,b){__p+='<option value="'+(null==(__t=b)?"":__t)+'">'+(null==(__t=a)?"":__t)+"</option>"}),__p+="</select>")}),__p+="</div>";return __p};var yne_underscore,yne_jtk_core_Class,yne_backbone,yne_jquery,yne_common_constants,yne_common_key_keyCodeMap,yne_common_key_KeyMonitor,yne_jtk_core_L,yne_common_selection_BlockRange,yne_common_selection_ImageRange,yne_common_selection_AttachmentRange,yne_common_data_blockTypes,yne_common_selection_TableRange,yne_common_selection_HrRange,yne_common_selection_NoteRange,yne_common_selection_UnknownRange,yne_common_data_supportedBlockStyles,yne_common_data_Block,yne_jtk_core_assert,yne_common_util_schemaVersion,yne_common_data_supportedInlineStyles,yne_common_util_unknownInlineStyles,yne_common_util_clearString,yne_common_data_RichText,yne_common_data_inlineStyleRules,yne_common_data_Rich2HtmlConvertor,yne_common_util_unknownTree,yne_common_util_blockStyles,yne_common_data_Paragraph,yne_common_views_BlockView,yne_common_selection_ParagraphRange,yne_jtk_web_dom_nodeType,yne_common_jst,yne_common_data_blankLine,yne_common_views_ParagraphView,yne_common_util_autoAdjustMenu,yne_common_views_ImageView,yne_common_views_AttachmentView,yne_common_data_supportedListItemStyles,yne_common_views_ListItemView,yne_common_views_TableView,yne_common_views_HrView,yne_common_views_UnknownView,yne_common_views_BlockViewMapper,yne_common_selection_nativeSelection,yne_common_views_NoteView,yne_underscorestring,yne_common_data_Image,yne_common_data_Attachment,yne_common_data_ListItem,yne_ytable_tools_core_console,yne_ytable_tools_core_underscore,yne_ytable_tools_web_dom_isTag,yne_ytable_tools_core_str_trim,yne_ytable_tools_core_reg_encode,yne_ytable_tools_web_dom_className,yne_ytable_tools_web_bom_userAgent,yne_ytable_tools_web_dom_attr,yne_ytable_tools_web_console,yne_ytable_tools_web_dom_Selector,yne_ytable_tools_web_dom_nodeType,yne_ytable_tools_web_dom_findParent,yne_ytable_tools_jq_jquery,yne_ytable_client_shared_const,yne_ytable_editor_config_defaults,yne_ytable_tools_web_dom_insert,yne_ytable_tools_web_dom_remove,yne_ytable_editor_utils_TableUtils,yne_ytable_client_editor_TableConvertor,yne_ytable_tools_core_Class,yne_ytable_tools_core_Events,yne_ytable_tools_core_EventClass,yne_ytable_tools_mvc_Backbone,yne_ytable_editor_views_ContainerView,yne_ytable_templates_jst,yne_ytable_editor_views_ToolbarView,yne_ytable_editor_views_FreezeBarView,yne_ytable_editor_utils_Draggable,yne_ytable_editor_views_ColumnHeaderView,yne_ytable_editor_views_HorizontalView,yne_ytable_editor_views_RowHeaderView,yne_ytable_editor_views_VerticalView,yne_ytable_editor_views_SelectionView,yne_ytable_editor_views_ClipboardView,yne_ytable_editor_views_CellEditorView,yne_ytable_editor_views_HiddenInputView,yne_ytable_editor_utils_ScrollUtils,yne_ytable_editor_utils_isRangeIn,yne_ytable_editor_core_HotkeyManager,yne_ytable_editor_views_TableEditView,yne_ytable_editor_views_CellResizeView,yne_ytable_editor_views_RowResizeLine,yne_ytable_editor_views_ColumnResizeLine,yne_ytable_editor_utils_OperateTable,yne_ytable_editor_views_TableView,yne_ytable_editor_views_FooterView,yne_ytable_editor_views_FormulaEditView,yne_ytable_tools_web_dom_getScrollBarWidth,yne_ytable_editor_views_EditorView,yne_ytable_editor_utils_Cache2,yne_ytable_editor_core_Table,yne_ytable_editor_core_Selection,yne_ytable_editor_views_ControlView,yne_ytable_editor_views_SplitView,yne_ytable_editor_views_ButtonView,yne_ytable_editor_views_ComboBoxView,yne_ytable_editor_views_ButtonComboView,yne_ytable_editor_views_ColorComboView,yne_ytable_editor_views_TableComboView,yne_ytable_editor_views_MoreComboView,yne_ytable_editor_core_Toolbar,yne_ytable_editor_core_Commander,yne_ytable_editor_commands_CommandFactory,yne_ytable_editor_commands_CommandHelper,yne_ytable_editor_core_Clipboard,yne_ytable_editor_core_Range,yne_ytable_editor_commands_Command,yne_ytable_editor_commands_SimpleCommand,yne_ytable_editor_commands_NoOp,yne_ytable_editor_commands_SetCellValue,yne_ytable_editor_commands_SetCellStyle,yne_ytable_editor_commands_CompositeCommand,yne_ytable_editor_commands_SetCellStyles,yne_ytable_editor_commands_SetCellAttribute,yne_ytable_editor_commands_SetCellAttributes,yne_ytable_editor_commands_SetRangeValue,yne_ytable_editor_commands_SetRangeStyle,yne_ytable_editor_commands_SetRangeStyles,yne_ytable_editor_commands_ToggleRangeMerge,yne_ytable_editor_commands_SetColumnWidth,yne_ytable_editor_commands_SetRowHeight,yne_ytable_editor_commands_DelRangeValue,yne_ytable_editor_commands_ClearCellStyles,yne_ytable_editor_commands_ClearRangeStyles,yne_ytable_editor_commands_CustomCommand,yne_ytable_editor_commands_InsertRowOnly,yne_ytable_editor_commands_InsertRow,yne_ytable_editor_commands_InsertRows,yne_ytable_editor_commands_DeleteRowOnly,yne_ytable_editor_commands_DeleteRow,yne_ytable_editor_commands_DeleteRows,yne_ytable_editor_commands_InsertColumnOnly,yne_ytable_editor_commands_InsertColumn,yne_ytable_editor_commands_InsertColumns,yne_ytable_editor_commands_DeleteColumnOnly,yne_ytable_editor_commands_DeleteColumn,yne_ytable_editor_commands_DeleteColumns,yne_ytable_editor_config_config,yne_ytable_editor_plugins_utils,yne_ytable_editor_plugins_undo_plugin,yne_ytable_editor_plugins_globalUndo_plugin,yne_ytable_editor_plugins_colors,yne_ytable_editor_plugins_basic_plugin,yne_ytable_editor_plugins_border_plugin,yne_ytable_editor_plugins_merge_plugin,yne_ytable_editor_plugins_more_plugin,yne_ytable_editor_config_pluginMap,yne_ytable_editor_core_Editor,yne_common_data_tableDataValidator,yne_common_data_Table,yne_common_data_Hr,yne_common_data_Unknown,yne_common_data_blockMap,yne_parser_html_handlers_tagHandlers,yne_tinycolor,yne_parser_html_utils_convertColor,yne_parser_html_handlers_styleHandlers,yne_parser_html_handlers_BaseHandler,yne_parser_html_utils_handleParagraphSpaces,yne_parser_html_handlers_ParagraphHandler,yne_parser_html_handlers_DocumentHandler,yne_parser_html_handlers_UnknownHandler,yne_jtk_web_dom_parseHTML,yne_parser_html_Parser,yne_parser_html_handlers_InlineHandler,yne_parser_html_handlers_AnchorHandler,yne_parser_html_handlers_BreakHandler,yne_parser_html_handlers_HrHandler,yne_parser_html_handlers_ImageHandler,yne_parser_html_handlers_TableHandler,yne_common_data_List,yne_parser_html_handlers_ListHandler,yne_parser_html_handlers_ListItemHandler,yne_parser_html_handlers_handlerMap,yne_parser_html_tagConfig,yne_parser_html_mso_ListHandler,yne_parser_html_convert,yne_parser_plain_createRichText,yne_common_commands_link_LinkMatch,yne_parser_plain_parseLine,yne_parser_plain_convert,yne_parser_json_createBlock,yne_parser_json_convert,yne_parser_Parser,yne_common_util_ListItemNode,yne_common_data_Note,yne_common_selection_NoteSelection,yne_common_commands_Command,yne_common_commands_SimpleCommand,yne_common_commands_ManagerAdapter,yne_common_commands_CommandManager,yne_common_commands_CompositeCommand,yne_common_commands_paragraph_DeleteRange,yne_common_commands_paragraph_SetStyle,yne_common_commands_link_DeleteLink,yne_common_commands_paragraph_DeleteBackward,yne_common_commands_paragraph_Merge,yne_common_commands_paragraph_DeleteAtStart,yne_common_commands_block_SetBlockStyle,yne_common_commands_note_TextIndent,yne_common_commands_note_ReplaceBlock,yne_common_commands_note_ReplaceListItemWithParagraph,yne_common_commands_list_SetLevel,yne_common_commands_list_DeleteAtStart,yne_common_commands_note_DeleteBlock,yne_common_selection_ListItemRange,yne_common_selection_rangeUtil,yne_common_commands_utils_CmdUtils,yne_common_commands_image_Delete,yne_common_commands_attachment_Delete,yne_common_commands_table_Delete,yne_common_commands_note_DeleteRange,yne_common_commands_key_Backspace,yne_common_commands_paragraph_SplitParagraph,yne_common_commands_paragraph_InsertText,yne_common_commands_key_InsertLink,yne_common_commands_link_RecognitionLink,yne_common_commands_key_Enter,yne_common_commands_note_InsertText,yne_common_commands_key_TextInput,yne_common_commands_key_Space,yne_common_commands_note_IndentOutdent,yne_common_commands_key_Tab,yne_common_commands_key_Indent,yne_common_commands_key_Outdent,yne_common_commands_paragraph_ForwardDelete,yne_common_commands_paragraph_ForwardDeleteAtStart,yne_common_commands_key_Delete,yne_common_commands_block_InsertBlock,yne_common_commands_block_InsertBlocks,yne_common_commands_note_InsertBlocks,yne_common_commands_key_InsertHorizontalRule,yne_common_commands_key_InsertImage,yne_common_commands_key_InsertAttachment,yne_common_commands_key_InsertTable,yne_common_commands_note_ApplyInlineStyle,yne_common_commands_note_ApplyBlockStyle,yne_common_commands_note_ReplaceParagraphWithListItem,yne_common_commands_list_ToggleType,yne_common_commands_note_InsertList,yne_common_commands_note_InsertOrderedList,yne_common_commands_note_InsertUnorderedList,yne_common_commands_key_RemoveFormat,yne_common_commands_key_FormatPainter,yne_common_commands_image_ReplaceSrc,yne_common_commands_image_Replace,yne_common_commands_attachment_ReplaceSource,yne_common_commands_attachment_Replace,yne_common_commands_note_DragBlocks,yne_common_commands_CommandFactory,yne_common_core_Controller,yne_toolbar_BaseButton,yne_toolbar_other_Undo,yne_toolbar_other_Redo,yne_toolbar_other_RemoveFormat,yne_toolbar_other_FormatPainterManager,yne_toolbar_other_FormatPainter,yne_toolbar_BaseSplit,yne_toolbar_BaseComboBox,yne_toolbar_inline_BaseInlineComboBox,yne_toolbar_inline_FontFamily,yne_toolbar_inline_FontSize,yne_toolbar_inline_BaseInlineButton,yne_toolbar_inline_Bold,yne_toolbar_inline_Italic,yne_toolbar_inline_Underline,yne_toolbar_inline_Strike,yne_toolbar_config_colors,yne_toolbar_BaseColorComboBox,yne_toolbar_inline_Color,yne_toolbar_inline_BackColor,yne_toolbar_block_BaseBlockComboBox,yne_toolbar_block_Align,yne_toolbar_block_Indent,yne_toolbar_block_Outdent,yne_toolbar_block_BaseBlockButton,yne_toolbar_block_UnorderedList,yne_toolbar_block_OrderedList,yne_toolbar_block_LineHeight,yne_toolbar_insert_InsertTable,yne_toolbar_insert_InsertHorizontalRule,yne_toolbar_insert_InsertLink,yne_toolbar_insert_InsertImage,yne_toolbar_insert_InsertAttachment,yne_toolbar_other_showMore,yne_toolbar_Toolbar,yne_common_contextMenu_ContextMenuItem,yne_common_contextMenu_ContextMenu,yne_common_contextMenu_undo,yne_common_contextMenu_redo,yne_common_contextMenu_removeFormat,yne_common_contextMenu_selectAll,yne_common_contextMenu_countWords,yne_common_contextMenu_paste,yne_contextMenu_config,yne_common_contextMenu_ytableAdapter,yne_common_core_Editor,yne_core_WebEditor,yne_common_io_editorApi,yne_io_editorApi,yne_io_eventList,yne_common_util_htmlConvert,yne_BulbEditor;return yne_underscore=function(){var a=window._;if(!a&&window.require&&(a=window.require("underscore")),!a)throw"no `underscore` library";return a}(),yne_jtk_core_Class=function(a){function b(a){var b=this;b.options=c.extend({},a),b.initialize.apply(b,arguments)}var c=yne_underscore,d=function(a,b){var d,e,f=this;return d=a&&c.has(a,"constructor")?a.constructor:function(){return f.apply(this,arguments)},c.extend(d,f,b),e=function(){this.constructor=d},e.prototype=f.prototype,d.prototype=new e,a&&c.extend(d.prototype,a),d.__super__=f.prototype,d};return b.prototype.initialize=function(){},b.extend=d,b}({}),yne_backbone=function(){var a=window.Backbone;if(!a&&window.require&&(a=window.require("Backbone")||window.require("backbone")),!a)throw"no `backbone` library";return a}(),yne_jquery=function(){var a=window.jQuery||window.$;if(!a&&window.require&&(a=window.require("jQuery")||window.require("jquery")),!a)throw"no `jQuery` library";return a}(),yne_common_constants=function(){var a=/Windows/.test(window.navigator.userAgent);return{COMPAT:"compat",INTERM:"interm",INDENT_WIDTH:40,LINE_BREAK:a?"\r\n":"\n",IS_MAC:/Mac|iPod|iPhone|iPad/.test(window.navigator.platform)}}(),yne_common_key_keyCodeMap=function(a){var b=yne_underscore,c=yne_common_constants,d={8:"backspace",9:"tab",13:"enter",16:"shift",17:"ctrl",18:"alt",19:"pause",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",44:"printscreen",45:"ins",46:"del",106:"*",107:"+",109:"-",110:".",111:"/",144:"numlock",186:";",189:"-",187:"=",188:",",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"},e=c.IS_MAC?{3:"enter",91:"meta",93:"meta",224:"meta"}:{91:"win",92:"win",93:"menu",224:"win",229:"ime"},f=function(a,c,d){return b.some(a,function(a,b){return a===c&&parseInt(b,10)===d})},g={},h="A".charCodeAt(0),i="Z".charCodeAt(0);for(h;i>=h;h++)d[h]=String.fromCharCode(h).toLowerCase();for(h=1;20>h;++h)d[111+h]="f"+h;for(h=0;9>=h;h++)d[48+h]=h+"";for(h=0;9>=h;++h)d[h+96]=h+"";return{isMatch:function(a,b){var c=a+"-"+b,h=g[c];return null==h&&(h=f(e,a,b)||f(d,a,b),g[c]=h),h}}}({}),yne_common_key_KeyMonitor=function(a){var b,c=yne_jtk_core_Class,d=yne_jquery,e=yne_underscore,f=yne_common_constants,g=yne_common_key_keyCodeMap,h=["shift","alt","ctrl","meta"],i={"return":"enter",escape:"esc",plus:"+"},j={mod:f.IS_MAC?"meta":"ctrl",option:"alt",command:"meta"};return b=c.extend({initialize:function(a){var b=this;a=a||{},a.el&&(e.bindAll(b,"_onKeyDown"),b.el=a.el,b._hasBindEvents=!1)},_bindEvents:function(){var a=this;a._hasBindEvents||(d(a.el).on("keydown",a._onKeyDown),a._hasBindEvents=!0)},_unbindEvents:function(){var a=this;a._hasBindEvents&&(d(a.el).off("keydown",a._onKeyDown),a._hasBindEvents=!1)},_prepareForBindKey:function(){var a=this;a._hasBindEvents||a._bindEvents(),a._keyMap||(a._keyMap={}),a._matchCache||(a._matchCache={})},_formatKey:function(a){a=d.trim(a),a=a.toLowerCase(),a=a.replace(/\s+/g,""),e.each(j,function(b,c){a=a.replace(c+"+",b+"+")});var b={},c=a.split(/\+/),f=e.last(c),g=[];return f=i[f]||f,b.key=f,e.each(h,function(c){a.indexOf(c)>-1&&(b[c]=!0,g.push(c))}),g.push(f),b.mark=g.join("-"),b},_extractEventInfo:function(a){var b={},c=[];return e.each(h,function(d){a[d+"Key"]&&(b[d]=!0,c.push(d))}),c.push(a.keyCode),b.keyCode=a.keyCode,b.mark=c.join("-"),b},_isMatch:function(a,b){return b&&event?e.every(h,function(c){return b[c]===a[c]})&&g.isMatch(b.key,a.keyCode):!1},_onKeyDown:function(a){var b,c,d=this,f=d._keyMap,g=d._extractEventInfo(a),h=g.mark,i=d._matchCache,j=i[h];j||(j=i[h]={eventInfo:g},b={},c=!1,e.each(f,function(a,e){d._isMatch(g,a.keyInfo)&&(b[e]=a,c=!0)}),c&&(j.handlers=b)),e.each(j.handlers,function(b){b.callback.apply(null,[a])})},bind:function(a,b){var c,d,f=this,g=f._formatKey(a);g&&(f._prepareForBindKey(),
d=f._keyMap["key-"+a]={keyInfo:g,callback:b},c=f._matchCache,e.each(c,function(a){if(a&&a.eventInfo){var b,c=a.handlers;c?b=!0:(c={},b=!1),f._isMatch(a.eventInfo,g)&&(c[g.mark]=d,b=!0),b&&(a.handlers=c)}}))},unbind:function(a){var b=this,c=b._keyMap,d=b._matchCache,f="key-"+a;c&&c[f]&&delete c[f],e.each(d,function(a){var b=a.handlers;b&&b[f]&&delete b[f]})},unbindAll:function(){var a=this;a._unbindEvents(),a._keyMap={},a._matchCache={}},clearCache:function(){var a=this;a._matchCache={}}})}({}),yne_jtk_core_L=function(){for(var a,b=this,c=b.DEBUG,d=b.console,e={},f=function(){},g="log warn error time timeEnd".split(" "),h=g.length;--h>=0;)a=g[h],c&&d[a]?e[a]=d[a].bind(d):e[a]=f;return e.DEBUG=c,e}(),yne_common_selection_BlockRange=function(a){var b=yne_jtk_core_Class,c=yne_jtk_core_L,d=b.extend({_type:"block",block:null,isCollapsed:function(){c.error("isCollapsed () should be implemented by subclass")},getType:function(){var a=this;return a._type},clone:function(){c.error("Every subclass of BlockRange should implement the `clone` method")},collapse:function(){c.error("Every subclass of BlockRange should implement the `collapse` method")},getDataAsJSON:function(){c.error("toJSON() should be implemented by subclass!")},getDataAsHtml:function(){c.error("toHtml() should be implemented by subclass!")},getDataAsPlain:function(){c.error("toPlain() should be implemented by subclass!")},canDrawedByNative:function(){c.error("canDrawedByNative() should be implemented by subclass!")},toNativeRange:function(a){if(!a||!a.getBlockViewByBlock)return void c.error("note view is unvalid!");var b=this,d=a.getBlockViewByBlock(b.block);return d?d.convertToNativeRange(b):void c.warn("No blockView")}});return d}({}),yne_common_selection_ImageRange=function(a){var b=yne_common_selection_BlockRange,c=b.extend({_type:"image",initialize:function(a){var b=this;a=a||{},b.block=a.block},isCollapsed:function(){return!1},collapse:function(){},getDataAsJSON:function(){var a=this,b=a.block.toJSON();return b},getDataAsHtml:function(){var a=this,b=a.block.toHtml();return b},getDataAsPlain:function(){var a=this,b=a.block.toPlain();return b},canDrawedByNative:function(){return!1}});return c}({}),yne_common_selection_AttachmentRange=function(a){var b=yne_common_selection_BlockRange,c=b.extend({_type:"attachment",initialize:function(a){var b=this;a=a||{},b.block=a.block},isCollapsed:function(){return!1},collapse:function(){},getDataAsJSON:function(){var a=this,b=a.block.toJSON();return b},getDataAsHtml:function(){var a=this,b=a.block.toHtml();return b},getDataAsPlain:function(){var a=this,b=a.block.toPlain();return b},canDrawedByNative:function(){return!1}});return c}({}),yne_common_data_blockTypes={BLOCK:"block",PARAGRAPH:"paragraph",IMAGE:"image",ATTACHMENT:"attachment",LIST_ITEM:"list-item",TABLE:"table",HR:"horizontal-line",UNKNOWN:"unknown",getType:function(a){return a?a._type:void 0},isParagraph:function(a){var b=this,c=b.getType(a);return c===b.PARAGRAPH||c===b.LIST_ITEM},isListItem:function(a){var b=this;return b.getType(a)===b.LIST_ITEM},isAttachment:function(a){var b=this;return b.getType(a)===b.ATTACHMENT},isTable:function(a){var b=this;return b.getType(a)===b.TABLE},isImage:function(a){var b=this;return b.getType(a)===b.IMAGE},isHr:function(a){var b=this;return b.getType(a)===b.HR},isUnknown:function(a){return this.getType(a)===this.UNKNOWN}},yne_common_selection_TableRange=function(a){var b=yne_common_selection_BlockRange,c=yne_common_data_blockTypes,d={EXISTING:1,FIRST_ROW:2,LAST_ROW:3},e=b.extend({_type:c.TABLE,ytableJSONRange:null,initialize:function(a){var b=this;a=a||{},b.block=a.block,b._initYTableJSONRange(a.type),delete b.options},_initYTableJSONRange:function(a){var b,c,e,f=this,g=f.block;if(g)if(b=g.getYTableEditor())switch(a){case d.FIRST_ROW:f.ytableJSONRange=b.getFirstRowRangeAsJSON();break;case d.LAST_ROW:f.ytableJSONRange=b.getLastRowRangeAsJSON();break;default:f.ytableJSONRange=b.getFirstRangeAsJSON()}else if(g.data)switch(c=g.data,a){case d.LAST_ROW:e=c.heights.length||1,f.ytableJSONRange={left:0,right:1,top:e-1,bottom:e};break;default:f.ytableJSONRange={left:0,right:1,top:0,bottom:1}}},isCollapsed:function(){return!1},clone:function(){},collapse:function(){},getDataAsJSON:function(){},getDataAsHtml:function(){},getDataAsPlain:function(){},canDrawedByNative:function(){return!1}},{TYPES:d});return e}({}),yne_common_selection_HrRange=function(a){var b=yne_common_selection_BlockRange,c=yne_common_data_blockTypes;return b.extend({_type:c.HR,initialize:function(a){var b=this;b.block=a.block},isCollapsed:function(){return!1},getDataAsHtml:function(){return this.block.toHtml()},getDataAsJSON:function(){return this.block.toJSON()},getDataAsPlain:function(){var a=this,b=a.block.toPlain();return b},canDrawedByNative:function(){return!0}})}({}),yne_common_selection_NoteRange=function(a){var b=yne_jtk_core_Class,c=yne_jtk_core_L,d=yne_underscore,e=yne_common_data_blockTypes,f=yne_common_constants,g={JSON:1,HTML:2,PLAIN:3,isValidType:function(a){var b=this;return a===b.JSON||a===b.HTML||a===b.PLAIN},_getMethodName:function(a){var b=this,c="";switch(a){case b.JSON:c="JSON";break;case b.HTML:c="Html";break;case b.PLAIN:c="Plain"}return c},getBlockMethodName:function(a){var b=this,c=b._getMethodName(a);return c?"to"+c:void 0},getBlockRangeMethodName:function(a){var b=this,c=b._getMethodName(a);return c?"getDataAs"+c:void 0}},h=b.extend({_type:"note",_startRange:null,_endRange:null,initialize:function(a){var b=this;a=a||{},b._startRange=a.startRange,b._endRange=a.endRange,delete b.options,a.startRange||a.endRange||!a.blockRanges||b.setBlockRanges(a.blockRanges)},isInSingleBlock:function(){var a=this;return a._startRange&&a._startRange===a._endRange},isInMultiBlock:function(){var a=this;return!a.isInSingleBlock()},isMatchBlockTypes:function(a,b){if(!a)return c.warn("The param note does not exist!"),!1;var d,f,g,h=this,i=h._startRange.block,j=h._endRange.block,k=a.getBlockIndex(i),l=a.getBlockIndex(j);if(-1===k||-1===l)return c.warn("startIndex or endIndex is -1!"),!1;for(d=a.getAllBlocks(),f=k;l>=f;f++)if(g=e.getType(d[f]),-1===b.indexOf(g))return!1;return!0},canDrawedByNative:function(){var a,b=this;return b.isInSingleBlock()?(a=b.getStartBlockRange(),a.canDrawedByNative()):!0},isCollapsed:function(){var a,b=this;return b.isInSingleBlock()?(a=b.getStartBlockRange(),a&&a.isCollapsed()):!1},getStartBlockRange:function(){var a=this;return a._startRange},getEndBlockRange:function(){var a=this;return a._endRange},setBlockRanges:function(a){var b=this;b._startRange=d.first(a),b._endRange=d.last(a)},clone:function(a){var b,c,d=this;return a===!1?(b=d._startRange,c=d._endRange):(b=d._startRange.clone(),c=d._endRange.clone()),h.create({startRange:b,endRange:c})},collapse:function(a){var b=this,d=a===!1?b.getEndBlockRange():b.getStartBlockRange();d&&d.collapse?(d.collapse(a),b._startRange=d,b._endRange=d):c.warn("There is no blockRange or blockRange has no `collapse` method")},toNativeRange:function(a){var b,d,e,f,g,h=this;if(h.canDrawedByNative())return c.log("to native range",h),b=h.getStartBlockRange(),(e=b.toNativeRange(a))?h.isInSingleBlock()?e:(d=h.getEndBlockRange(),(f=d.toNativeRange(a))?(g=document.createRange(),g.setStart(e.startContainer,e.startOffset),g.setEnd(f.endContainer,f.endOffset),g):void c.warn("no native range for end block!")):void c.warn("no native range for start block!")},_getDataWithType:function(a,b){if(!a||!a.getBlockAt)return void c.warn("note is unvalid!");if(!g.isValidType(b))return void c.warn("type is unvalid!");var d,e,f,h,i=this,j=[],k=i._startRange,l=i._endRange,m=a.getBlockIndex(k.block),n=a.getBlockIndex(l.block),o=g.getBlockRangeMethodName(b),p=g.getBlockMethodName(b);for(d=m;n>=d;d++)e=null,d===m||d===n?(f=d===m?k:l,f[o]&&(e=f[o]())):(h=a.getBlockAt(d),h&&h[p]&&(e=h[p]())),null!=e?j.push(e):c.warn("data is null!");return j},getDataAsJSON:function(a){var b,c=this,d=c._getDataWithType(a,g.JSON);return d=d||[],b=window.JSON.stringify(d)},getDataAsHtml:function(a){var b,c=this,d=c._startRange,e=c._endRange,f=a.getBlockIndex(d.block),g=a.getBlockIndex(e.block);return b=a.toHtml({startIndex:f,endIndex:g,startRangeStart:d.start,startRangeEnd:d.end,endRangeStart:e.start,endRangeEnd:e.end})},getDataAsPlain:function(a){var b=this,c=b._getDataWithType(a,g.PLAIN),d="";return c&&c.length&&(d=c.join(f.LINE_BREAK)),d}},{create:function(a){return a&&a.startRange&&a.endRange?new h(a):void c.warn("options is unvalid!")},fromNativeRange:function(a,b){if(!a)return void c.warn("no range");if(a instanceof h)return a;c.log("NoteRange.fromNativeRange()",a);var e,f=b.parseNativeRange(a);return f&&f.length?(e=new h({startRange:d.first(f),endRange:d.last(f)}),c.log("noteRange fromNativeRange",e),e):void c.warn("Failed to parse native range to note range!")}});return h}({}),yne_common_selection_UnknownRange=function(a){var b=yne_common_selection_BlockRange,c=yne_common_data_blockTypes;return b.extend({_type:c.UNKNOWN,initialize:function(a){this.block=a.block},isCollapsed:function(){return!1},getDataAsHtml:function(){return this.block.toHtml()},getDataAsJSON:function(){return this.block.toJSON()},getDataAsPlain:function(){return this.block.toPlain()},canDrawedByNative:function(){return!1}})}({}),yne_common_data_supportedBlockStyles=function(a){var b,c=yne_underscore,d={align:{type:"Enum",possible:{left:!0,right:!0,center:!0,justify:!0},"default":"left"},"line-height":{type:"Number","default":1.5},indent:{type:"Number","default":0},"text-indent":{type:"Number","default":0},width:{type:"Number","default":null},"float":{type:"Enum",possible:{none:!0,left:!0,right:!0},"default":"none"},height:{type:"Number","default":1},color:{type:"String","default":"#999999"}},e={block:[],paragraph:"align|indent|text-indent|line-height".split("|"),"list-item":"align|indent|text-indent|line-height".split("|"),image:"align|width|float".split("|"),attachment:"align|float".split("|"),"horizontal-line":"align|width|height|color".split("|"),table:[]},f={"horizontal-line":{width:{type:"Number","default":100}}},g={};return{getBlockStyles:function(a){if(a&&e[a]){if(!g[a]){var b,h=c.pick(d,e[a]);h&&(b=f[a],b&&c.each(b,function(a,b){h[b]=a})),g[a]=h}return g[a]}},getAllKeys:function(){return b||(b=c.keys(d),Object.freeze&&Object.freeze(b)),b},getDefault:function(a){var b=d[a];return b&&null!=b["default"]?b["default"]:void 0}}}({}),yne_common_data_Block=function(a){var b,c,d,e=yne_underscore,f=yne_backbone,g=yne_jtk_core_Class,h=yne_common_data_blockTypes,i=yne_common_data_supportedBlockStyles,j=yne_jtk_core_L;return b={_type:h.BLOCK,_styles:null,_supportedBlockStyles:null,_locked:!1,unknownTree:null,initialize:function(){var a=this;a.initSupportedBlockStyles(),a._styles={},a.unknownTree={}},initSupportedBlockStyles:function(){this._supportedBlockStyles=i.getBlockStyles(this._type)},isSupportedBlockStyle:function(a){var b=this;return null!=(b._supportedBlockStyles||{})[a]},setBlockStyle:function(a,b){var c=this._supportedBlockStyles||{},d=c[a];d&&("Enum"===d.type?d.possible[b]||(b=d["default"]):"Number"!==d.type||e.isNumber(b)?"Boolean"!==d.type||e.isBoolean(b)?e["is"+d.type]&&(e["is"+d.type](b)||(b=b["default"])):b="true"===b:(b=null===b||""===b?NaN:Number(b),(isNaN(b)||!b)&&(b=d["default"])),b=b||c[a]["default"],this._styles[a]=b,j.log("style-change "+a+": "+b),this.trigger("style-change",a,b))},setBlockStyles:function(a){var b=this;a&&e.each(a,function(a,c){b.setBlockStyle(c,a)})},getBlockStyles:function(){return e.clone(this._styles)},getBlockStyle:function(a){var b=this._supportedBlockStyles[a];return b?this._styles[a]||b["default"]:null},getDefaultBlockStyles:function(){var a=this,b={};return e.each(a._supportedBlockStyles,function(a,c){b[c]=a["default"]}),b},toXml:function(){var a="The toXml() method should be implemented by subclass!";j.error(new Error(a))},getType:function(){var a=this;return a._type},toJSON:function(){j.error("toJSON() should be implemented by subclass!")},toHtml:function(){j.error("toHtml() should be implemented by subclass!")},toPlain:function(){j.error("toPlain() should be implemented by subclass!")},countWords:function(){j.error("countWords() should be implemented by subclass!")},setLocked:function(a){var b=this;a=!!a,b.isLocked()!==a&&(b._locked=a,b.trigger("locked-change",a))},isLocked:function(){return this._locked}},c={fromXml:function(){var a=new d;return a}},e.extend(b,f.Events),d=g.extend(b,c)}({}),yne_jtk_core_assert=function(){var a=this,b=a.DEBUG,c=a.console,d=function(){};return b&&c.assert?c.assert.bind(c):d}(),yne_common_util_schemaVersion=function(a){var b=yne_underscore,c={major:1,minor:0,revision:0},d=function(a){a=a||"";var b=parseInt(a+"",10);return isNaN(b)?0:b},e={GRETER:1,EQUAL:0,LESS:-1},f=function(a,b){return a===b?e.EQUAL:a>b?e.GRETER:e.LESS};return{getDefaultAsString:function(){return c.major+"."+c.minor+"."+c.revision},parse:function(a){if(a){var b=(a+"").split(".");return{major:d(b[0]),minor:d(b[1]),revision:d(b[2])}}},_compare:function(a,c){var d=e.EQUAL;return b.some(["major","minor","revision"],function(b){var g=f(a[b]||0,c[b]||0);return g!==e.EQUAL?(d=g,!0):void 0}),d},isCompatable:function(a){if(a=a||"",!a)return!1;if("true"===a)return!0;var b=this,d=b.parse(a);return b._compare(c,d)!==e.LESS}}}({}),yne_common_data_supportedInlineStyles=function(a){var b=yne_underscore,c={bold:{key:"b","default":!1,type:"Boolean"},italic:{key:"i","default":!1,type:"Boolean"},underline:{key:"u","default":!1,type:"Boolean"},strike:{key:"s","default":!1,type:"Boolean"},"font-family":{key:"ff","default":"Microsoft YaHei",type:"String"},"font-size":{key:"fs","default":14,type:"Number"},color:{key:"cl","default":"#000000",type:"String"},"back-color":{key:"bc","default":"transparent",type:"String"},href:{key:"href","default":"",type:"String"}},d={};return{getConfig:function(a){var e=c[a],f=d[a];return e&&f&&(e=b.clone(e),e["default"]=f),e},isSupport:function(a){return null!=c[a]},getAllConfig:function(a){var c=this,d=c.getKeys(a),e={};return b.each(d,function(a){e[a]=c.getConfig(a)}),e},getKeys:function(a){var d=b.keys(c);return a&&a.length?b.difference(d,a):d},getDefault:function(a){var b;return b=d[a],null!=b?b:(b=c[a],b?b["default"]:void 0)},setDefault:function(a,b){var c=this,e=c.getDefault(a);null!=b&&b!==e&&(d[a]=b)},reset:function(){d={}}}}({}),yne_common_util_unknownInlineStyles=function(a){var b=yne_underscore,c=yne_common_data_supportedInlineStyles,d=[];return{add:function(a){a&&!c.isSupport(a)&&(b.contains(d,a)||d.push(a))},get:function(){return d},reset:function(){d=[]}}}({}),yne_common_util_clearString=function(a){var b=yne_underscore;return function(a){var c,d,e="";if(!b.isString(a))return a;for(c=0;c<a.length;c++)d=a[c].charCodeAt(),(d>31&&127>d||d>159||"	"===a[c]||"\n"===a[c]||"\r"===a[c])&&(e+=a[c]);return e}}({}),yne_common_data_RichText=function(a){var b,c=yne_underscore,d=yne_jquery,e=yne_jtk_core_Class,f=yne_jtk_core_assert,g=yne_jtk_core_L,h=yne_common_constants,i=yne_common_util_schemaVersion,j=yne_common_data_supportedInlineStyles,k=yne_common_util_unknownInlineStyles,l=function(a){f(c.isString(a)&&1===a.length),this["char"]=a,this.styles={}},m=function(a){var b,c=a.length,d=new Array(c);for(b=0;c>b;++b)d[b]=a[b].clone();return d},n=yne_common_util_clearString,o=function(a){var b=a.indexOf("|");return-1===b?{value:a}:{compat:a.substring(0,b),value:a.substring(b+1)}};return l.prototype.toString=function(){return this["char"]},l.prototype.setStyle=function(a,b){var d=this.styles,e=j.getConfig(a);if(!e)return void g.warn("The RichText does not support `"+a+"` style!");if(b&&!c["is"+e.type](b))switch(e.type){case"Number":b=Number(b),b=isNaN(b)?e["default"]:b;break;case"Boolean":b=b+""=="true";break;default:g.warn("The value `"+b+"` of `"+a+"` is not valid type!"),b=null}b&&b!==e["default"]?d[a]=b:delete d[a]},l.prototype.setUnknownStyle=function(a,b){var c=this,d=j.isSupport(a);return d?void g.warn("The RichText supports `"+a+"` style!"):(c.unknownStyles||(c.unknownStyles={}),void(c.unknownStyles[a]=b))},l.prototype.getStyle=function(a,b){var d,e=j.getConfig(a);return e?(d=this.styles[a],b=b!==!1,null==d?b?e["default"]:null:(c["is"+e.type](d)||(g.warn("The value `"+d+"` of `"+a+"` is not valid type!"),d=null),b?null==d?e["default"]:d:d===e["default"]?null:d)):null},l.prototype.getUnknownStyle=function(a){var b=this,c=b.unknownStyles;return c?c[a]:void 0},l.prototype.getStyles=function(){var a=this,b={},d=j.getAllConfig();return c.each(d,function(c,d){b[d]=a.getStyle(d)}),b},l.prototype.clone=function(){var a=this,b=new l(a["char"]);return b.styles=c.clone(a.styles),a.unknownStyles&&(b.unknownStyles=c.clone(a.unknownStyles)),b},l.prototype.toJSON=function(){var a=this,b={"char":a["char"]},d={},e=!1,f=j.getAllConfig();return c.each(f,function(b,c){var f=a.getStyle(c,!1);f&&(d[c]=f,e=!0)}),e&&(b.styles=d),b},l.fromJSON=function(a){if(a&&a["char"]){var b=new l(a["char"]);return c.each(a.styles,function(a,c){b.setStyle(c,a)}),b}},b=e.extend({_data:null,initialize:function(a){a=a||{};var b=this,d=a.text||"",e=b._data=[];d=n(d),c.each(d,function(a){e.push(new l(a))})},getLength:function(){return this._data.length},isEmpty:function(){return this.getLength()<=0},getClonedData:function(){return m(this._data)},getReadOnlyData:function(){return this._data},toString:function(){return this._data.join("")},setStyle:function(a,b,d,e){var f,g=this,h=g._data,i=c.isArray(e);for(b=Math.min(b,h.length),f=a;b>f;++f)h[f].setStyle(d,i?e[f-a]:e)},setUnknownStyle:function(a,b,d,e){var f,g=this,h=g._data,i=c.isArray(e);for(b=Math.min(b,h.length),f=a;b>f;++f)h[f].setUnknownStyle(d,i?e[f-a]:e)},getStyle:function(a,b,c){var d,e,g,h=this,i=h._data;for(f(a>=0),f(b>=a),f(b<=i.length),g=new Array(b-a),d=a;b>d;++d)e=i[d].getStyle(c),g[d-a]=e;return g},setStyles:function(a,b,d){var e=this;d&&c.each(d,function(c,d){e.setStyle(a,b,d,c)})},getCommonStyle:function(a,b,c){var d,e,g=this,i=g._data,k=null;if(g.isEmpty())return j.getDefault(c);if(f(a>=0),f(b>=a),f(b<=i.length),a===b)k=0===a?i[0].getStyle(c):i[a-1].getStyle(c);else for(d=a;b>d;++d)if(e=i[d].getStyle(c),null===k)k=e;else if(k!==e)return h.INTERM;return k},getCommonStyles:function(a,b){var d=this,e={},f=j.getAllConfig();return c.each(f,function(c,f){e[f]=d.getCommonStyle(a,b,f)}),e},slice:function(a,c,d){var e=this,f=e._data.slice(a,c),g=new b;return g._data=d!==!1?m(f):f,g},append:function(a){if(a&&a.getClonedData){var b=this,c=a.getClonedData();b._data=b._data.concat(c)}},insert:function(a,b){if(a&&a.getClonedData){var c=this,d=c._data,e=d.splice(b),f=a.getClonedData();g.log("insert ...",a,b),c._data=d.concat(f,e)}},getReadOnlyStylesList:function(a){var b=this,d=b._data,e=[],f=j.getAllConfig();return a=a!==!1,c.each(d,function(b){var d={};c.each(f,function(c,e){var f=b.getStyle(e,a);(a||!a&&null!=f)&&(d[e]=f)}),e.push(d)}),e},_getStyleRanges:function(a,b){if(a){if(b=b===!0,j.isSupport(a))b=!1;else if(!b)return;var d,e,f,g,h=this,i=h._data,k=i.length,l=[],m=!1;for(d=0;k>d;d++)e=i[d],f=b?e.getUnknownStyle(a):e.getStyle(a,!1),f?(g=c.last(l),!m&&g&&g.value===f?g.to=d+1:l.push({from:d,to:d+1,value:f}),m=!1):m=!0;return l}},_handleStyleRanges:function(a,b,d,e,f){e&&e.length&&c.each(e,function(c){if(c&&c.value){var e,g,i,j=a.createElement(d),k=a.createElement("from"),l=a.createElement("to"),m=a.createElement("value");k.appendChild(a.createTextNode(c.from)),j.appendChild(k),l.appendChild(a.createTextNode(c.to)),j.appendChild(l),f?(e=o(c.value),i=e.compat,i&&j.setAttribute(h.COMPAT,i),g=e.value):g=c.value,m.appendChild(a.createTextNode(g)),j.appendChild(m),b.appendChild(j)}})},toXml:function(a){var b,d=this,e=a.createElement("inline-styles"),f=j.getAllConfig();return c.each(f,function(b,c){var f=d._getStyleRanges(c,!1);d._handleStyleRanges(a,e,c,f,!1)}),b=k.get(),c.each(b,function(b){var c=d._getStyleRanges(b,!0);d._handleStyleRanges(a,e,b,c,!0)}),e},toJSON:function(){var a=this,b=c.map(a._data,function(a){return a.toJSON()});return{isRichText:!0,data:b}}},{fromXml:function(a){var c=d(a),e=new b({text:c.find("text").text()});return c.find("inline-styles").children().each(function(a,b){var c,f,g=b.nodeName,l=d(b),m=parseInt(l.find("from").text()),n=parseInt(l.find("to").text()),o=l.find("value");0!==o.length&&(c=o.text(),j.isSupport(g)?e.setStyle(m,n,g,c):(f=l.attr(h.COMPAT),i.isCompatable(f)&&(k.add(g),c=f+"|"+c,e.setUnknownStyle(m,n,g,c))))}),e},fromJSON:function(a){if(a&&a.isRichText&&a.data){var d,e=[];return c.each(a.data,function(a){var b=l.fromJSON(a);b&&e.push(b)}),d=new b,d._data=e,d}}})}({}),yne_common_data_inlineStyleRules=function(a){var b=yne_underscore,c={"font-size":function(a){var b=a["font-size"];return null!=b?b+"px":void 0},"font-family":function(a){return a["font-family"]},color:function(a){return a.color},"background-color":function(a){return a["back-color"]},"font-weight":function(a){var b={"true":"bold","false":"normal"};return b[a.bold+""]},"font-style":function(a){var b={"true":"italic","false":"normal"};return b[a.italic+""]},"text-decoration":function(a){if(a.underline===!1&&a.strike===!1)return"none";var b=[];return a.underline&&b.push("underline"),a.strike&&b.push("line-through"),b=b.join(" "),b||""}};return{getRules:function(a){var d=a?b.clone(a):{};return b.defaults(d,c),d}}}({}),yne_common_data_Rich2HtmlConvertor=function(a){var b,c=yne_underscore,d=yne_jquery,e=yne_common_data_RichText,f=yne_common_data_supportedInlineStyles,g=yne_common_data_inlineStyleRules,h=function(a,b){var d=[];return c.each(b,function(b,c){var e=b(a);(e||0===e)&&d.push(c+":"+e)}),d=d.join(";"),'<span style="'+d+'">'},i=function(){return"</span>"},j=function(a){return'<a href="'+a+'">'},k=function(){return"</a>"},l=function(a,b,d){c.isEmpty(b)||a.push(h(b,d))},m=function(a,b){b&&a.push(j(b))},n=function(a,b){c.isEmpty(b)||a.push(i(b))},o=function(a,b){b&&a.push(k(b))},p=f.getKeys(),q=function(a,b){if(!a||!b)return!1;var c,d=p.length;for(c=0;d>c;c++)if(a[p[c]]!==b[p[c]])return!1;return!0},r=function(a,b,d){if(!d)return c.escape(a);switch(a){case" ":return"&nbsp";case"	":return"&nbsp;&nbsp;&nbsp;&nbsp;";case"\r":return"<br>";case"\n":return"\r"===b?"":"<br>";default:return c.escape(a)}},s={},t={};return b={setCssRules:function(a){var b=this;c.each(a,function(a,d){c.isFunction(a)&&(s[d]=a,b.resetInlineStyleDefaultForHtml(d))})},getCssRule:function(a){var b=s[a];return b},resetCssRules:function(){var a=this;s={},a.resetInlineStyleDefaultForHtml()},getDefaultForHtml:function(a){var b,c,d,e=this,g=t[a];return null==g&&(b=e.getCssRule(a),c=f.getDefault(a),b?(d={},d[a]=c,g=b(d)):g=c,t[a]=g),g},resetInlineStyleDefaultForHtml:function(a){a?(a+="",delete t[a]):t={}},rich2html:function(a,b){var d,e,f,h,i,j,k,p,t=a.getReadOnlyData(),u=t.length,v=[],w="";if(b=c.defaults(b||{},{withDefault:!0,convertSpace:!1,styleRules:null}),0===u)return"<br>";for(d=a.getReadOnlyStylesList(b.withDefault),b.styleRules?(p=c.clone(b.styleRules),c.defaults(p,s)):p=s,p=g.getRules(p),e=0;u>e;++e)f=t[e],i=d[e],q(h,i)||(n(v,h),w!==i.href&&(o(v,w),m(v,i.href)),l(v,i,p)),k=f.toString(),v.push(r(k,j,b.convertSpace)),h=i,w=i.href,j=k;return n(v,h),o(v,w),v=v.join("")},html2rich:function(a){return new e(d(a).text())}}}({}),yne_common_util_unknownTree=function(a){var b=yne_underscore,c=yne_jquery,d=yne_jtk_core_L,e=yne_common_constants,f=yne_common_util_schemaVersion;return{appendToTree:function(a,b){if(!a||!b)return void d.error("arguments are not valid!");var g=c(b).attr(e.COMPAT);f.isCompatable(g)&&(a.unknown||(a.unknown=[]),a.unknown.push(b.cloneNode(!0)))},appendToXml:function(a,c){return a&&c?void(a.unknown&&a.unknown.length&&b.each(a.unknown,function(a){a&&a.cloneNode&&c.appendChild(a.cloneNode(!0))})):void d.error("arguments are not valid!")}}}({}),yne_common_util_blockStyles=function(a){var b=yne_common_util_unknownTree,c=yne_jquery,d=yne_underscore;return{toXml:function(a,c,e){var f=a.getBlockStyles();d.each(f,function(a,b){var d=e.createElement(b),f=e.createTextNode(a);d.appendChild(f),c.appendChild(d)}),a.unknownTree&&a.unknownTree.styles&&b.appendToXml(a.unknownTree.styles,c)},fromXml:function(a,d){var e=a.unknownTree;c(d).children().each(function(d,f){var g,h=f.nodeName;a.isSupportedBlockStyle(h)?(g=c(f).text(),a.setBlockStyle(h,g)):(e.styles||(e.styles={}),b.appendToTree(e.styles,f))})}}}({}),yne_common_data_Paragraph=function(a){var b,c,d,e=yne_underscore,f=yne_jquery,g=yne_common_data_Block,h=yne_common_data_Rich2HtmlConvertor,i=yne_common_data_blockTypes,j=yne_common_constants,k=yne_common_data_RichText,l=yne_jtk_core_L,m=yne_common_util_unknownTree,n=yne_common_util_blockStyles,o=yne_common_data_supportedBlockStyles;return b={_type:i.PARAGRAPH,_richText:null,_styles:null,_defaultInlineStyles:null,initialize:function(){var a=this;a.setText(""),g.prototype.initialize.apply(a,arguments)},setText:function(a){a instanceof k||(e.isString(a)||(a=String(a)),a=new k({text:a}));var b=this;b._richText=a,b.trigger("content-change",b)},getText:function(){return this._richText.slice(0)},getReadOnlyText:function(){return this._richText},getStartOffset:function(){return 0},getEndOffset:function(){return this.getLength()},getLength:function(){var a=this;return a._richText.getLength()},isEmpty:function(){var a=this;return a._richText.isEmpty()},getRangeText:function(a){if(a&&null!=a.start){var b=this;return b.sliceText(a.start,a.end)}},sliceText:function(a,b,c){var d=this;return d._richText.slice(a,b,c)},append:function(a){var b=this;b._richText.append(a)},insertText:function(a,b){var c=this;return l.log("insert Text",a,b),c._richText.insert(b,a),l.log(c._richText),c.trigger("content-change"),!0},deleteText:function(a,b){e.isObject(a)&&!e.isUndefined(a.start)&&(b=a.end,a=a.start);var c=this,d=c._richText,f=d.slice(0,a),g=new k,h=new k;b>=0&&(g=d.slice(b)),h.append(f),h.append(g),c.setText(h)},setTextStyle:function(a,b,c,d){var f=this,g=f._richText;e.isObject(c)&&null!=c.start&&(d=c.end,c=c.start),g.setStyle(c,d,a,b),f.trigger("content-change")},getTextStyle:function(a,b,c){var d=this,f=d._richText;return e.isObject(b)&&null!=b.start&&(c=b.end,b=b.start),f.getStyle(b,c,a)},getCommonStyle:function(a,b){var c,d,e=this;return b?(c=b.start,d=b.end):(c=e.getStartOffset(),d=e.getEndOffset()),e._richText.getCommonStyle(c,d,a)},getCommonStyles:function(a){var b,c,d=this,e=d._richText;return a?(b=a.start,c=a.end):(b=d.getStartOffset(),c=d.getEndOffset()),e.getCommonStyles(b,c)},setDefaultInlineStyles:function(a){this._defaultInlineStyles=e.clone(a)},getDefaultInlineStyles:function(){return e.clone(this._defaultInlineStyles||null)},getDefaultInlineStyle:function(a){return this._defaultInlineStyles&&this._defaultInlineStyles[a]},toXml:function(a){var b,c,d=this,e=a.createElement("para"),f=a.createElement("text"),g=d._richText.toString(),h=a.createTextNode(g);return f.appendChild(h),e.appendChild(f),c=d._richText.toXml(a),c&&e.appendChild(c),b=a.createElement("styles"),n.toXml(d,b,a),e.appendChild(b),m.appendToXml(d.unknownTree,e),e},toJSON:function(a,b){a=a||0;var c=this,d=c.sliceText(a,b,!1),e={blockType:c._type,richText:d.toJSON(),styles:c.getBlockStyles()};return e},toHtml:function(a,b){var c,d,e,g=this,i=document.createElement("div"),j=f(i);return j.attr("yne-bulb-block","paragraph"),g._applyBlockStylesOnElement(j),a=a||0,c=g.sliceText(a,b,!1),d=h.rich2html(c,{withDefault:!1,convertSpace:!0}),j.html(d),e=i.outerHTML,i=j=null,e},_applyBlockStylesOnElement:function(a){var b,c=this.getBlockStyles(),d={};e.each(c,function(a,c){switch(l.log("toHtml key",c," value ",a),c){case"align":d["text-align"]=a;break;case"indent":case"text-indent":a=a>0?a:0,b="indent"===c?"margin-left":"text-indent",d[b]=a*j.INDENT_WIDTH||"";break;case"line-height":a>0&&(d["line-height"]=String(a));break;default:l.warn("unknown block style: "+c)}}),d["line-height"]||(b=o.getDefault("line-height"),d["line-height"]=b),b=h.getDefaultForHtml("font-size"),d["font-size"]=b,a.css(d)},toPlain:function(a,b){var c,d,e=this;return a=a||0,c=e.sliceText(a,b,!1),d=c.toString()},countWords:function(){var a=this.getLength();return a}},c={fromXml:function(a){var b=new d;return b.setText(k.fromXml(a)),f(a).children().each(function(a,c){switch(c.nodeName){case"text":case"inline-styles":break;case"styles":n.fromXml(b,c);break;default:m.appendToTree(b.unknownTree,c)}}),b},fromJSON:function(a){if(!a||!a.blockType||a.blockType!==i.PARAGRAPH||!a.richText)return void l.warn("jsonObj is not valid!");var b=new d,c=k.fromJSON(a.richText);return b.setText(c),e.each(a.styles,function(a,c){b.setBlockStyle(c,a)}),b}},d=g.extend(b,c)}({}),yne_common_views_BlockView=function(a){var b=yne_backbone,c=yne_underscore,d=yne_jtk_core_L;return b.View.extend({className:"block-view unknown-block-view",attributes:{tabIndex:1},block:null,_getSelector:function(){var a=this,b=a.tagName,d=a.className.split(/\s+/),e=a.id,f=a.cid,g=".note-view ";return g+=b,e&&(g+="#"+e),c.each(d,function(a){a&&(g+="."+a)}),g+='[data-yne-cid="'+f+'"]'},initialize:function(a){var b=this;b.block=a.block,c.bindAll(b,"_onLockedChange"),b.block.on("locked-change",b._onLockedChange)},render:function(){this.$el.attr("data-yne-cid",this.cid),this._renderLockStatus()},convertToNativeRange:function(){d.error("convertToNativeRange() should be implemented by subclass!")},parseNativeRange:function(){d.error("parseNativeRange() should be implemented by subclass!")},bindSelectionEvents:function(){var a=this;c.bindAll(a,"onDrawRange"),a.on("draw-range",a.onDrawRange)},onDrawRange:function(){throw"Method not implemented."},isLocked:function(){var a=this,b=a.block;return b?b.isLocked():void 0},_onLockedChange:function(){var a=this;a._renderLockStatus()},_renderLockStatus:function(){var a=this,b=a.isLocked();b?a.$el.addClass("locked"):a.$el.removeClass("locked")}})}({}),yne_common_selection_ParagraphRange=function(a){var b=yne_common_selection_BlockRange,c=b.extend({_type:"paragraph",start:0,end:0,initialize:function(a){var b=this;a=a||{},b.start=a.start||0,b.end=a.end||0,b.block=a.block},isCollapsed:function(){var a=this;return a.start===a.end},clone:function(){var a=this;return c.create({start:a.start,end:a.end,block:a.block})},collapse:function(a){var b=this;a===!1?b.start=b.end:b.end=b.start},getDataAsJSON:function(){var a=this,b=a.block.toJSON(a.start,a.end);return b},getDataAsHtml:function(){var a=this,b=a.block.toHtml(a.start,a.end);return b},getDataAsPlain:function(){var a=this,b=a.block,c=b.toPlain(a.start,a.end);return c},getContent:function(){var a=this;return a.block.sliceText(a.start,a.end)},canDrawedByNative:function(){return!0}},{create:function(a){return new c(a)}});return c}({}),yne_jtk_web_dom_nodeType=function(a){var b=yne_underscore;return{ELEMENT_NODE:1,ATTRIBUTE_NODE:2,TEXT_NODE:3,CDATA_SECTION_NODE:4,ENTITY_REFERENCE_NODE:5,ENTITY_NODE:6,PROCESSING_INSTRUCTION_NODE:7,COMMENT_NODE:8,DOCUMENT_NODE:9,DOCUMENT_TYPE_NODE:10,DOCUMENT_FRAGMENT_NODE:11,NOTATION_NODE:12,getType:function(a){return a&&a.nodeType?a.nodeType:void 0},isNode:function(a){var c=this,d=c.getType(a);return b.isNumber(d)&&d>=c.ELEMENT_NODE&&d<=c.NOTATION_NODE},isElement:function(a){return this.getType(a)===this.ELEMENT_NODE},isAttribute:function(a){return this.getType(a)===this.ATTRIBUTE_NODE},isText:function(a){return this.getType(a)===this.TEXT_NODE},isCDataSection:function(a){return this.getType(a)===this.CDATA_SECTION_NODE},isEntityReference:function(a){return this.getType(a)===this.ENTITY_REFERENCE_NODE},isEntity:function(a){return this.getType(a)===this.ENTITY_NODE},isProcessingInstruction:function(a){return this.getType(a)===this.PROCESSING_INSTRUCTION_NODE},isComment:function(a){return this.getType(a)===this.COMMENT_NODE},isDocument:function(a){return this.getType(a)===this.DOCUMENT_NODE},isDocumentType:function(a){return this.getType(a)===this.DOCUMENT_TYPE_NODE},isDocumentFragment:function(a){return this.getType(a)===this.DOCUMENT_TYPE_NODE},isNotation:function(a){return this.getType(a)===this.NOTATION_NODE}}}({}),yne_common_jst=function(a){var b=yne_jtk_core_L,c=this;return{getTemplate:function(a,d){var e=a+"/"+d,f=c.JST[e];return f||b.error("JST has no template: "+e),
f},render:function(a,c,d){var e=this.getTemplate(a,c);return e?e(d):void b.error("no tempalte: "+a+"/"+c+".jst","template/jst.js")}}}({}),yne_common_data_blankLine=function(a){var b=yne_common_data_supportedBlockStyles,c=yne_common_data_Rich2HtmlConvertor,d=null;return{_computeMinHeight:function(){var a,d=b.getDefault("line-height"),e=c.getDefaultForHtml("font-size");return e=parseInt(e,10),a=Math.ceil(e*d)},getMinHeight:function(){return d||(d=this._computeMinHeight()),d},reset:function(){d=null}}}({}),yne_common_views_ParagraphView=function(a){var b=yne_underscore,c=yne_jquery,d=yne_common_views_BlockView,e=yne_common_selection_ParagraphRange,f=yne_common_data_Rich2HtmlConvertor,g=yne_jtk_web_dom_nodeType,h=yne_common_constants,i=yne_jtk_core_L,j=yne_common_jst,k=yne_common_data_Rich2HtmlConvertor,l=yne_common_data_blankLine;return d.extend({className:"block-view paragraph-view",_template:j.getTemplate("common","paragraph_view"),initialize:function(){d.prototype.initialize.apply(this,arguments);var a=this,c=a.block;b.bindAll(a,"_onContentChange","_onStyleChange"),a._onContentChange=a._onContentChange.bind(a),c.on("content-change",a._onContentChange),c.on("style-change",a._onStyleChange)},render:function(){var a=this;a._renderTemplate(),d.prototype.render.apply(a,arguments),a._renderText(),a._renderStyles()},_renderTemplate:function(){var a=this;a.$el.html(a._template())},convertToNativeRange:function(a){if(!a)return void i.warn("block range is unvalid!");var b,c,d=this;return(c=d._getCharacterInfo(a.start))?(b=document.createRange(),b.setStart(c.node,c.offset),(c=d._getCharacterInfo(a.end))?(b.setEnd(c.node,c.offset),b):void i.error("_getCharacterInfo blockRange.end error!")):void i.error("_getCharacterInfo blockRange.start error!")},parseNativeRange:function(a,b,c){var d,f,g,h,i,j,k=this;return c?j=new e({start:0,end:b.getEndOffset(),block:b}):(d=a.startContainer,f=a.startOffset,g=a.endContainer,h=k._getCharacterIndex(a.startContainer,a.startOffset,!0),i=k._getCharacterIndex(a.endContainer,a.endOffset,!1),-1===i&&(i=b.getEndOffset()),j=new e({start:h,end:i,block:b}))},_getCharacterInfo:function(a){var b,c=this,d=c.$el.find(".para-text").get(0),e=document.createNodeIterator(d,NodeFilter.SHOW_TEXT),f=e.nextNode(),g=0;if(0===a||!f)return{node:f||d,offset:0};for(;f;){if(b=f.length,b>0&&a>g&&g+b>=a)return{node:f,offset:a-g};g+=b,f=e.nextNode()}},_getTextOfNode:function(a){if(g.isText(a))return a.nodeValue;var b,c=document.createNodeIterator(a,NodeFilter.SHOW_TEXT),d="";if(!c)return"";for(b=c.nextNode();b;)d+=b.nodeValue,b=c.nextNode();return d},_textLengthOfNode:function(a){var b=this,c=b._getTextOfNode(a);return c.length},_getCharacterIndex:function(a,b,d){var e,f,h=this,i=h.$el.find(".para-text").get(0),j=0;if(!c.contains(i,a)&&a!==i)return d?0:-1;for(g.isText(a)&&(j+=b),e=a;e!==i;){for(f=e.previousSibling;f;)j+=h._textLengthOfNode(f),f=f.previousSibling;e=e.parentNode}return j},_renderText:function(){var a,b=this,c=b.block,d=c.getReadOnlyText(),e=f.rich2html(d),g=b.$el.find(".para-text");a=d.isEmpty()?l.getMinHeight():"",g.css("minHeight",a).html(e)},_renderStyles:function(){var a=this,c=a.block,d=c.getBlockStyles();b.each(d,function(b,c){a._setStyle(c,b)}),a._renderStylesFix()},_renderStylesFix:function(){var a=this.$el,b=a.find(".para-text");b.css("fontSize",k.getDefaultForHtml("font-size"))},_setStyle:function(a,b){var c=this.$el,d=c.find(".para-text");switch(a){case"align":d.css("text-align",b);break;case"line-height":b>0?d.css("line-height",String(b)):d.css("line-height","normal");break;case"indent":b=b>0?b:0,c.css("margin-left",b*h.INDENT_WIDTH||"");break;case"text-indent":b=b>0?b:0,d.css("text-indent",b*h.INDENT_WIDTH||"");break;default:i.warn("unknown block style: "+a)}},_onContentChange:function(){var a=this;a._renderText()},_onStyleChange:function(a,b){this._setStyle(a,b)}})}({}),yne_common_util_autoAdjustMenu=function(a){var b=yne_jquery;return{adjustMenu:function(a){var c=a.find(".menu-wrapper"),d=c.width(),e=b(a.children()[0]),f=a.offsetParent().width(),g=e.position().left;d>g&&e.width()<d?c.addClass("menu-wrapper-left"):c.removeClass("menu-wrapper-left"),f-g-e.width()<d?e.width()<d?(c.addClass("menu-wrapper-mini"),c.removeClass("menu-wrapper-right")):(c.addClass("menu-wrapper-right"),c.removeClass("menu-wrapper-mini")):(c.removeClass("menu-wrapper-mini"),c.removeClass("menu-wrapper-right")),c.show()}}}({}),yne_common_views_ImageView=function(a){var b=yne_common_views_BlockView,c=yne_jquery,d=yne_underscore,e=yne_common_jst,f=yne_common_selection_ImageRange,g=yne_jtk_core_L,h=yne_common_util_autoAdjustMenu;return b.extend({className:"block-view image-view",events:{"mousedown .resize-handle":"_onMouseDownResizeHandle",mouseenter:"_onMouseEnter",mouseleave:"_onMouseLeave","mouseleave .menu-wrapper":"_onMouseLeaveMenuWrapper","click .yne-button-item":"_onButtonItemClick","click .yne-popup-item":"_onPopupMenuItemClick"},_imageResizeStartInfo:null,_imageResizeEventNS:null,initialize:function(){var a=this;b.prototype.initialize.apply(a,arguments),a._imageResizeEventNS=".img-resize-"+d.uniqueId(),d.bindAll(a,"_onStyleChange","_onContentChange"),a.block.on("style-change",a._onStyleChange),a.block.on("content-change",a._onContentChange),a.bindSelectionEvents()},render:function(){var a=this,c=a.block,f=c.getSource(),g=e.render("common","image-view-image-container",{src:f,randomId:d.uniqueId("img-view")});b.prototype.render.apply(a,arguments),a.$el.html(g),a._renderStyles()},_renderStyles:function(){var a=this,b=a.block.getBlockStyles();d.each(b,function(b,c){a._setStyle(c,b)})},_setStyle:function(a,b){var d,e=this,f=e.$el;switch(a){case"align":f.css("text-align",b);break;case"width":d=e.getImgElement(),g.log("set image width: "+b),null==b?c(d).css("width",""):c(d).css("width",b);break;case"float":f.css("float",b)}},_onStyleChange:function(a,b){this._setStyle(a,b)},_onContentChange:function(){var a=this,b=a.block,c=a.$el;c.find("img").attr("src",b.getSource())},getImgElement:function(){return this.$el.find("img").get(0)},convertToNativeRange:function(){var a=this,b=document.createRange(),c=a.$el.get(0);return b.setStart(c,0),b.setEnd(c,c.childNodes.length),b},parseNativeRange:function(a,b,c){var d=this;return c||d._isImageInNativeRange(a)||d._isNativeRangeInImageView(a)?new f({block:b}):void 0},_isImageInNativeRange:function(a){var b,c=this,d=c.getImgElement();return b=d.ownerDocument.createRange(),b.selectNode(d),a.compareBoundaryPoints(Range.START_TO_START,b)<1&&a.compareBoundaryPoints(Range.END_TO_END,b)>-1?!0:!1},_isNativeRangeInImageView:function(a){var b,d=this,e=d.el;return b=a.commonAncestorContainer,3===b.nodeType&&(b=b.parentNode),b===e||c.contains(e,b)?!0:!1},_showButtonGroup:function(){var a=this;a._hidePopupMenu(),h.adjustMenu(a.$el)},_hideButtonGroup:function(){var a=this;a.$el.find(".menu-wrapper").hide(),a._hidePopupMenu()},_onButtonItemClick:function(a){var b=this,c=a.target,d=c.dataset.buttonName;switch(d){case"menu":b._togglePopupMenu();break;default:b._togglePopupMenu()}},_togglePopupMenu:function(){var a=this;a.$el.find(".yne-popup-menu").toggle()},_hidePopupMenu:function(){var a=this;a.$el.find(".yne-popup-menu").hide()},_onMouseEnter:function(){var a=this;a.isLocked()||a._showButtonGroup()},_onMouseLeave:function(){var a=this;a.isLocked()||a._hideButtonGroup()},_onMouseLeaveMenuWrapper:function(){var a=this;a._hidePopupMenu()},_onPopupMenuItemClick:function(a){g.log("click on menu item",a.currentTarget);var b,d,e=this,f=a.currentTarget,h=c(f).attr("data-cm-name"),i=e.block;switch(e._hidePopupMenu(),h){case"float-left":case"float-right":case"clear-float":b="float",d="float-left"===h?"left":"float-right"===h?"right":"none";break;case"clear-resize":b="width",d=null;break;case"upload":e.trigger("yne-replace-image",function(a){e.trigger("command","replaceImage",{src:a,image:i})},i.getSource());break;case"delete":e.trigger("command","deleteRange",{range:null,imageBlockView:e})}b&&e.trigger("command","applyBlockStyle",{range:null,imageBlockView:e,name:b,value:d})},_removeFocusedClass:function(){var a=this;a.$el.removeClass("focused")},_addFocusedClass:function(){var a=this;a.$el.addClass("focused")},onDrawRange:function(a){var b=this;a?b._addFocusedClass():b._removeFocusedClass()},_onMouseDownResizeHandle:function(a){var b,d,e=this,f=e.getImgElement(),g=a.pageX,h=a.pageY,i={centerX:0,centerY:0,startWidth:0,startToCenter:0};f&&(b=c(f),i.startWidth=b.width(),d=b.offset(),i.centerX=d.left+i.startWidth/2,i.centerY=d.top+b.height()/2,i.startToCenter=Math.sqrt(Math.pow(i.centerX-g,2)+Math.pow(i.centerY-h,2)),e._imageResizeStartInfo=i,e._bindEventsForResize(),a.preventDefault())},_bindEventsForResize:function(){var a=this,b=a.el.ownerDocument,d=a._imageResizeEventNS;a._unbindEventsForResize(),c(b).bind("mousemove"+d,a._onResizeMove.bind(a)).bind("mouseup"+d,a._onResizeEnd.bind(a))},_unbindEventsForResize:function(){var a=this,b=a.el.ownerDocument;c(b).unbind(a._imageResizeEventNS)},_onResizeMove:function(a){var b=this;b._handleImageResize(a.pageX,a.pageY)},_onResizeEnd:function(a){var b=this;b._unbindEventsForResize(),b._handleImageResize(a.pageX,a.pageY,!0)},_handleImageResize:function(a,b,d){var e,f,h,i=this,j=i._imageResizeStartInfo;if(j){if(e=Math.sqrt(Math.pow(j.centerX-a,2)+Math.pow(j.centerY-b,2)),f=e*j.startWidth/j.startToCenter,h=i.getImgElement(),!h)return void g.warn("no image element!");c(h).css("width",f),d===!0&&i.trigger("command","applyBlockStyle",{range:null,imageBlockView:i,name:"width",value:f})}}})}({}),yne_common_views_AttachmentView=function(a){var b=yne_common_views_BlockView,c=yne_jquery,d=yne_underscore,e=yne_common_jst,f=yne_common_selection_AttachmentRange,g=yne_jtk_core_L,h=yne_common_util_autoAdjustMenu;return b.extend({className:"block-view attachment-view",events:{mouseenter:"_onMouseEnter",mouseleave:"_onMouseLeave","mouseleave .menu-wrapper":"_onMouseLeaveMenuWrapper","click .yne-button-item":"_onButtonItemClick","click .yne-popup-item":"_onPopupMenuItemClick"},initialize:function(){var a=this;b.prototype.initialize.apply(a,arguments),d.bindAll(a,"_onStyleChange","_onContentChange"),a.block.on("style-change",a._onStyleChange),a.block.on("content-change",d.debounce(a._onContentChange,100)),a.bindSelectionEvents()},render:function(){var a=this,c=a.block,f=c.getSource(),g="attachment-view-attachment-container",h=e.render("common",g,{src:f,randomId:d.uniqueId("attach-view")});b.prototype.render.apply(a,arguments),a.$el.html(h),a._renderStyles()},_renderStyles:function(){var a=this,b=a.block.getBlockStyles();d.each(b,function(b,c){a._setStyle(c,b)})},_setStyle:function(a,b){var c=this,d=c.$el;switch(a){case"align":d.css("text-align",b);break;case"float":d.css("float",b)}},_onStyleChange:function(a,b){this._setStyle(a,b)},_onContentChange:function(){var a=this;a.render(),g.log("redraw attachment")},getImgElement:function(){return this.$el.find("img").get(0)},convertToNativeRange:function(){var a=this,b=document.createRange(),c=a.$el.get(0);return b.setStart(c,0),b.setStart(c,c.childNodes.length),b},parseNativeRange:function(a,b,c){var d=this;return c||d._isAttachmentInNativeRange(a)||d._isNativeRangeInAttachmentView(a)?new f({block:b}):void 0},_isAttachmentInNativeRange:function(a){var b,c=this,d=c.getImgElement(),e=window.Range;return b=d.ownerDocument.createRange(),b.selectNode(d),a.compareBoundaryPoints(e.START_TO_START,b)<1&&a.compareBoundaryPoints(e.END_TO_END,b)>-1?!0:!1},_isNativeRangeInAttachmentView:function(a){var b,d=this,e=d.el;return b=a.commonAncestorContainer,3===b.nodeType&&(b=b.parentNode),b===e||c.contains(e,b)?!0:!1},_showButtonGroup:function(){var a=this;a._hidePopupMenu(),h.adjustMenu(a.$el)},_hideButtonGroup:function(){var a=this;a.$el.find(".menu-wrapper").hide(),a._hidePopupMenu()},_onButtonItemClick:function(a){var b=this,c=a.target,d=c.dataset.buttonName;switch(d){case"view":b._hidePopupMenu();break;case"menu":b._togglePopupMenu();break;default:b._togglePopupMenu()}},_togglePopupMenu:function(){var a=this;a.$el.find(".yne-popup-menu").toggle()},_hidePopupMenu:function(){var a=this;a.$el.find(".yne-popup-menu").hide()},_onMouseEnter:function(){var a=this;a.isLocked()||a._showButtonGroup()},_onMouseLeave:function(){var a=this;a.isLocked()||a._hideButtonGroup()},_onMouseLeaveMenuWrapper:function(){var a=this;a._hidePopupMenu()},_onPopupMenuItemClick:function(a){g.log("click on menu item",a);var b,e,f=this,h=a.currentTarget,i=c(h).attr("data-cm-name");switch(f._hidePopupMenu(),i){case"float-left":case"float-right":case"clear-float":b="float",e="float-left"===i?"left":"float-right"===i?"right":"none";break;case"upload":f.trigger("yne-replace-attachment",function(a){f.trigger("command","replaceAttachment",d.extend(a,{attachment:f.block}))});break;case"delete":f.trigger("command","deleteRange",{range:null,attachmentBlockView:f});break;case"download":f.trigger("yne-download-attachment",f.block.getResource(),f.block.getFileName())}b&&f.trigger("command","applyBlockStyle",{range:null,attachmentBlockView:f,name:b,value:e})},_removeFocusedClass:function(){var a=this;a.$el.removeClass("focused")},_addFocusedClass:function(){var a=this;a.$el.addClass("focused")},onDrawRange:function(a){var b=this;a?b._addFocusedClass():b._removeFocusedClass()}})}({}),yne_common_data_supportedListItemStyles=function(){function a(a){if(isNaN(a))return"";for(var b=[["","i","ii","iii","iv","v","vi","vii","viii","ix"],["","x","xx","xxx","xl","l","lx","lxx","lxxx","xcc"],["","c","cc","ccc","cd","d","dc","dcc","dcc","cm"]],c="",d=0,e=0,f=1e3;3>e;e++,f/=10)d=Math.floor(a%f/(f/10)),c+=b[2-e][d];return c}function b(a){if(isNaN(a))return"";var b="a".charCodeAt(0),c="z".charCodeAt(0),d=c-b+1,e="";for(a--;a>=0;)e=String.fromCharCode(a%d+b)+e,a=Math.floor(a/d)-1;return e}var c=["lower-roman","decimal","lower-alpha"],d=["square","disc","circle"];return{getStyle:function(a){var b=a.getLevel();return a.isOrdered()?c[b%3]:d[b%3]},getPlainStyle:function(c,d){var e="";switch(c%3){case 0:e=a(d);break;case 2:e=b(d);break;default:case 1:e=d}return e}}}(),yne_common_views_ListItemView=function(a){var b=yne_underscore,c=yne_common_views_ParagraphView,d=yne_common_jst,e=yne_common_data_supportedListItemStyles.getStyle;return c.extend({className:"block-view list-item-view paragraph-view",_template:d.getTemplate("common","list_item_view"),_styleSheet:null,initialize:function(){var a=this;c.prototype.initialize.apply(a,arguments),a._initEvents()},_initEvents:function(){var a=this,c=a.block,d=c.getOwnerList();b.bindAll(a,"_onLevelChange","_onIndexChange","_onTypeChange"),c.on("level-change",a._onLevelChange),c.on("index-change",a._onIndexChange),d.on("type-change",a._onTypeChange)},_renderLevel:function(){var a=this,b=a.block,c=b.getLevel(),d=a.$el.find(".li-box");d.attr("data-level",c),d.attr("data-style-type",e(b))},_renderIndex:function(){var a=this,b=a.block;a.$el.find(".li-box").attr("start",b.getIndex())},render:function(){var a=this;c.prototype.render.apply(a,arguments),a._renderLevel(),a._renderIndex()},_renderTemplate:function(){var a=this,b=a.block;a.$el.html(a._template({isOrdered:b.isOrdered()}))},_onLevelChange:function(){var a=this;a._renderLevel(),a._renderIndex()},_onIndexChange:function(){var a=this;a._renderIndex()},_onTypeChange:function(){this.render()}})}({}),yne_common_views_TableView=function(a){var b=yne_common_views_BlockView,c=yne_common_selection_TableRange,d=yne_jtk_core_L,e=yne_jquery;return b.extend({className:"block-view table-view",initialize:function(){var a=this;b.prototype.initialize.apply(a,arguments),a.bindSelectionEvents(),a._bindEvents()},render:function(){var a,b=this,c=b.block;e('<div class="ytable-app-root" />').appendTo(b.$el),a=b.$el.find(".ytable-app-root").get(0),c.renderYTableView(a),b.on("view-resize",function(){c.trigger("view-resize")})},_bindEvents:function(){var a=this,b=["textInput","compositionstart","compositionend","keyup","keypress","keydown"];a.$el.on(b.join(" "),function(a){a.stopPropagation()}).on("contextmenu",function(a){a.preventDefault(),a.stopPropagation()})},parseNativeRange:function(a,b,d){var e,f=this,g=f.block.getYTableEditor();if(d)return e=new c({block:b});if(a&&!g.isRangeInEditBox(a))return e=new c({block:b,type:g.isRangeInLastRow(a)?c.TYPES.LAST_ROW:c.TYPES.FIRST_ROW})},convertToNativeRange:function(){var a=this,b=document.createRange(),c=a.$el.get(0);return b.setStart(c,0),b.setEnd(c,c.childNodes.length),b},becomeFirstResponder:function(){var a=this,b=a.block.getYTableEditor();d.log("ytableEditor becomeFirstResponder"),b.becomeFirstResponder()},resignFirstResponder:function(){var a=this,b=a.block.getYTableEditor();d.log("ytableEditor resignFirstResponder"),a.trigger("ytable-hide-toolbar",b),b.resignFirstResponder()},onDrawRange:function(a,b){var c,e=this,f=e.block.getYTableEditor();return f?(c=f.getSelection(),c.removeAllRanges(),e.trigger("ytable-show-toolbar",f),void(b===this.block&&f.isEditing()||(a?(f.selectRangeJSON(a.ytableJSONRange),e.becomeFirstResponder()):e.resignFirstResponder()))):void d.warn("views/TableView.js-onDrawRange: no ytableEditor!")}})}({}),yne_common_views_HrView=function(a){var b=yne_common_views_BlockView,c=yne_common_selection_HrRange;return b.extend({className:"block-view hr-view",initialize:function(){var a=this;b.prototype.initialize.apply(a,arguments)},render:function(){var a=this,b=a.block,c=b.getBlockStyle("width"),d=b.getBlockStyle("height");a.$el.html('<div class="hr-container"></div>').css({"text-align":b.getBlockStyle("align")}).find(".hr-container").css({width:c+"%",height:d,backgroundColor:b.getBlockStyle("color")})},convertToNativeRange:function(){var a=this,b=document.createRange(),c=a.$el.get(0);return b.setStart(c,0),b.setEnd(c,c.childNodes.length),b},parseNativeRange:function(a,b,d){var e=this;return d||e._isHrInNativeRange(a)?new c({block:b}):void 0},_isHrInNativeRange:function(a){var b,c=this,d=c.$el.find(".hr-container").get(0);return b=d.ownerDocument.createRange(),b.selectNode(d),a.compareBoundaryPoints(Range.START_TO_START,b)<1&&a.compareBoundaryPoints(Range.END_TO_END,b)>-1?!0:!1}})}({}),yne_common_views_UnknownView=function(a){var b=yne_common_views_BlockView,c=yne_common_selection_UnknownRange;return b.extend({className:"block-view unknown-view",initialize:function(){var a=this;b.prototype.initialize.apply(a,arguments)},render:function(){this.$el.html("<div>当前版本不支持的内容</div>")},convertToNativeRange:function(){},parseNativeRange:function(a,b,d){return d?new c({block:b}):void 0}})}({}),yne_common_views_BlockViewMapper=function(a){var b=yne_common_data_blockTypes,c=yne_common_views_BlockView,d={};return d[b.PARAGRAPH]=yne_common_views_ParagraphView,d[b.IMAGE]=yne_common_views_ImageView,d[b.ATTACHMENT]=yne_common_views_AttachmentView,d[b.LIST_ITEM]=yne_common_views_ListItemView,d[b.TABLE]=yne_common_views_TableView,d[b.HR]=yne_common_views_HrView,d[b.UNKNOWN]=yne_common_views_UnknownView,function(a){var b=d[a];return b?b:c}}({}),yne_common_selection_nativeSelection=function(a){var b=yne_jtk_core_L;return{getSelection:function(a){return a=a||window,a.getSelection()},setRange:function(a,c){var d=this,e=d.getSelection(c);e&&a?(e.removeAllRanges(),e.addRange(a)):b.warn("The selection or range is null!")},getRange:function(a){var c,d=this,e=d.getSelection(a);return e?e.rangeCount>0?c=e.getRangeAt(0):b.warn("The selection has no range!"):b.warn("The selection is null!"),c},removeAllRanges:function(a){var b=this,c=b.getSelection(a);c&&c.removeAllRanges()},isRangeInNode:function(a){if(!a)return b.warn("The param node is unvalid!"),!1;var c,d=this,e=a.ownerDocument||document,f=e.defaultView,g=d.getRange(f);if(!g)return b.warn("The native range is null!"),!1;for(c=g.commonAncestorContainer;c;){if(c===a)return!0;c=c.parentNode}return!1}}}({}),yne_common_views_NoteView=function(a){var b,c=yne_underscore,d=yne_jquery,e=yne_backbone,f=yne_common_key_KeyMonitor,g=yne_common_selection_ImageRange,h=yne_common_selection_AttachmentRange,i=yne_common_selection_TableRange,j=yne_common_selection_HrRange,k=yne_common_selection_NoteRange,l=yne_common_selection_UnknownRange,m=yne_common_data_blockTypes,n=yne_common_data_Paragraph,o=yne_common_views_BlockViewMapper,p=yne_jtk_core_assert,q=yne_jtk_web_dom_nodeType,r=yne_common_selection_nativeSelection,s=yne_jtk_core_L;return b=e.View.extend({className:"note-view",attributes:{tabIndex:1,spellcheck:!1,contenteditable:"true"},directionKeyJustMoved:!1,events:{textInput:"_onTextInput",compositionstart:"_onCompositionStart",compositionend:"_onCompositionEnd",mousedown:"_onMouseDown",selectstart:"_onSelectStart",contextmenu:"_onContextMenu",dragstart:"_onDragDropEvent",dragover:"_onDragDropEvent",drop:"_onDragDropEvent",copy:"_onCopy",cut:"_onCut",paste:"_onPaste","click a[href]":"_onAnchorClick",blur:"_onBlur",focus:"_onFocus"},note:null,blockViews:null,tableViews:null,_isOnComposition:!1,_isSilent:!1,_noteEvents:{"insert-block":"_onInsertBlock","remove-block":"_onRemoveBlock","replace-block":"_onReplaceBlock",resize:"onResize","read-only-change":"_onReadOnlyChange"},_docEvents:{selectionchange:"_onSelectionChange"},initialize:function(a){var b=this;b._bindEventHandlers(),b.setOptions(a),b._bindEventsForDoc(),b._bindEventsForThis(),b.bindKeys()},_bindEventHandlers:function(){var a=this,b=function(b){s.log("bindHandlers: "+b),c.bindAll(a,b)};c.each(a._noteEvents,b),c.each(a._docEvents,b),c.each(a._elEvents,b)},_setNote:function(a){var b=this;b._removeNote(),b.note=a,b._bindEventsForNote()},_removeNote:function(){var a=this;a.note&&a._unbindEventsForNote(),a.note=null},reset:function(){var a=this;if(a._removeNote(),a.$el.html(""),a.options&&a.options.note&&(a.options.note=null),a._keyMonitor&&a._keyMonitor.clearCache(),d(document.head).find("style.note-style").remove(),a._isSilent=!1,window.parent!==window){var b=window.getSelection();b.removeAllRanges()}},setOptions:function(a){var b=this;b.reset(),b._setNote(a.note),b.options=a},render:function(){var a=this,b=a.$el,e=a.note,f=a.blockViews=[];a.tableViews=[],s.log(e.blocks),b.html(""),d(document.head).find("style.note-style").remove(),d(document.head).append('<style class="note-style"></style>'),c.each(e.blocks,function(c){var d=a._createBlockView(c);d||s.warn("Failed to create block view!"),f.push(d),b.append(d.$el),d.render(),a._bindEventsForBlockView(c,d)})},reRenderTextBlockView:function(){var a=this;c.each(a.blockViews,function(a){var b=a.block;(m.isParagraph(b)||m.isListItem(b))&&a.render()})},_unbindEventsForBlockView:function(a,b){b.off("command"),m.isImage(a)&&b.off("yne-replace-image"),m.isAttachment(a)&&b.off("yne-replace-attachment").off("yne-download-attachment"),m.isTable(a)&&b.off("ytable-show-toolbar").off("ytable-hide-toolbar")},_bindEventsForBlockView:function(a,b){var c=this,d=c.tableViews;c._unbindEventsForBlockView(a,b),b.on("command",c.onCommand.bind(c)),m.isImage(a)&&b.on("yne-replace-image",c.trigger.bind(c,"yne-replace-image")),m.isAttachment(a)&&b.on("yne-replace-attachment",c.trigger.bind(c,"yne-replace-attachment")).on("yne-download-attachment",c.trigger.bind(c,"yne-download-attachment")),m.isTable(a)&&(b.on("ytable-show-toolbar",c.trigger.bind(c,"ytable-show-toolbar")),b.on("ytable-hide-toolbar",c.trigger.bind(c,"ytable-hide-toolbar")),d.push(b))},setHtmlContentEditable:function(a){var b=this;b.$el.attr("contenteditable",!!a)},updateFormatPainterCursorUI:function(a){a?this.$el.addClass("format-painter-active"):this.$el.removeClass("format-painter-active")},_handleNoteEvents:function(a){var b=this,d=b.note;return d&&d.on&&d.off?void c.each(b._noteEvents,function(c,e){a?d.on(e,b[c]):d.off(e,b[c])}):void s.warn("Failed to bind note events!")},_bindEventsForNote:function(){var a=this;a._handleNoteEvents(!0)},_unbindEventsForNote:function(){var a=this;a._handleNoteEvents(!1)},_bindEventsForDoc:function(){var a=this,b=d(document);c.each(a._docEvents,function(c,d){s.log("bind document event: "+d+" -> "+c),s.log(a[c]),b.on(d,a[c])})},_bindEventsForThis:function(){var a=this;a.on("draw-range",a._onDrawRange.bind(a))},bindKeys:function(){var a=this,b=new f({el:a.el}),d=["backspace","del","enter","tab","space","mod+z","mod+y","mod+shift+z","mod+shift+r","mod+b","mod+i","mod+u","left","up","right","down","esc","mod+s"];c.each(d,function(c){b.bind(c,function(b){a.trigger("key-pressed",c,b)})}),a._keyMonitor=b},_onDrawRange:function(a){var b=this;b._silentDo(function(){b._drawRange(a)})},_drawRange:function(a){if(!a||!a.canDrawedByNative)return void s.log("note range is not valid!");s.log("on draw range",a);var b,c,d,e=this,f=a.getStartBlockRange(),g=f.block;if(e._clearCustomSelectionUI(g),a.canDrawedByNative())e.setHtmlContentEditable(!0),b=a.toNativeRange(e),r.setRange(b,window),e.trigger("ytable-hide-toolbar"),e._scrollNativeSelectionIntoWrapper(b);else{if(e.setHtmlContentEditable(!1),r.removeAllRanges(),a.isInMultiBlock())return void s.warn("The note range is note valid!");f=a.getStartBlockRange(),c=e.note.getBlockIndex(f.block),d=e.getBlockViewAt(c),d&&d.trigger("draw-range",f,g)}},_scrollNativeSelectionIntoWrapper:function(a){var b,c,d=this;return a?(b=a.collapsed?a.getClientRects()[0]:a.getBoundingClientRect(),b||(c=a.commonAncestorContainer,1!==c.nodeType&&(c=c.parentNode),b=c.getBoundingClientRect()),b?void d._scrollRectIntoWrapper(b):void s.error("can not get selection client rect")):void s.warn("range not found")},_scrollRectIntoWrapper:function(a){var b=this,c=b.el.parentNode,d=c.getBoundingClientRect(),e=d.top,f=d.bottom,g=d.height;return a.height>g?void((a.bottom<0||a.top>g)&&b._scrollWrapperBy(0,a.bottom-g)):a.top<e?void b._scrollWrapperBy(0,a.top-e):a.bottom>f?void b._scrollWrapperBy(0,a.bottom-f):void 0},_scrollWrapperBy:function(a,b){var c=this.el.parentNode;a>0?a+=20:0>a&&(a-=20),b>0?b+=20:0>b&&(b-=20),c.scrollLeft+=a,c.scrollTop+=b},parseNativeRange:function(a){if(!a||!a.startContainer)return void s.warn("no native range!");var b,c,d,e,f=this,g=a.startContainer,h=a.endContainer,i=f.getBlockViewContainer(g),j=f.getBlockViewContainer(h),k=f.getBlockViewIndex(i),l=f.getBlockViewIndex(j),m=[];if(-1===k||-1===l)return void s.error("start/end block index is -1 !");for(s.log("start/end block index "+k+"/"+l),b=k;l>=b;b++)d=f.blockViews[b],c=f.note.getBlockAt(b),s.log("blockView.parseNativeRange "+b),e=d.parseNativeRange(a,c,b!==k&&b!==l),e?m.push(e):s.warn("Failed to parse native range to block range!");return m},_isRangeInTableBlock:function(){var a,b=r.getRange(),c=".block-view.table-view";if(!b||!b.startContainer)return!1;for(a=b.startContainer,q.isText(a)&&(a=a.parentElement||a.parentNode);a&&a.webkitMatchesSelector;){if(a.webkitMatchesSelector(c))return!0;a=a.parentNode}return!1},_onSelectionChange:function(a){var b,c,d=this,e=!r.isRangeInNode(d.el);if(e||d._isSilent||d._isOnComposition)return c=e?"The native range is not in note view!":d._isSilent?"The _isSilent flag is true!":"The _isOnComposition flag is true!",s.log("XXXXXXXdocument selection change deprecated!XXXXXXXX"),void s.log(c);if(b=d._isRangeInTableBlock()){if(!d.directionKeyJustMoved)return c="The selection/range is in table box!",s.log("XXXXXXdocument selection change deprecated!XXXXXXX"),void s.log(c);d.directionKeyJustMoved=!1}s.log("-------------document selection change--------"),d.trigger("selectionchange",a)},_silentDo:function(a){var b=this;if(b._isSilent=!0,s.DEBUG)a();else try{a()}catch(c){s.warn("silent do error")}window.setTimeout(function(){b._isSilent=!1},0)},clearNativeSelectionUI:function(){var a=r.getSelection(window);a.removeAllRanges()},_clearCustomSelectionUI:function(a){var b=this,d=b.blockViews;c.each(d,function(b){b.trigger("draw-range",null,a)})},_appendBlankLineIfNeed:function(){var a,b=this,c=b.note;c&&!c.lastBlockIsEasyInput()&&(a=new n,c.append(a))},focusLastBlankLine:function(){var a=this;a._appendBlankLineIfNeed(),window.setTimeout(function(){var b=a.getLastBlockView();d(b.el).trigger("mousedown")},50)},isReadOnly:function(){var a=this,b=a.note;return b&&b.isReadOnly()},_onMouseDown:function(a){var b,c,d,e,f=this,n=f.getBlockViewContainer(a.target),o=f.getBlock(a.target);if(!f.isReadOnly()){if(!o)return s.warn("_onMouseDown(): block is null!"),void f.focusLastBlankLine();switch(b=m.getType(o)){case m.IMAGE:case m.ATTACHMENT:e=b===m.IMAGE?g:h,c=new e({block:o}),d=new k({startRange:c,endRange:c}),f.setHtmlContentEditable(!0),n.focus(),f.trigger("set-range",d,!0,!0);break;case m.PARAGRAPH:case m.LIST_ITEM:f.setHtmlContentEditable(!0),f._clearCustomSelectionUI();break;case m.TABLE:c=new i({block:o}),d=new k({startRange:c,endRange:c}),f.setHtmlContentEditable(!1),f.trigger("set-range",d,!0,!0,f.lastBlock===o);break;case m.HR:c=new j({block:o}),d=new k({startRange:c,endRange:c}),f.setHtmlContentEditable(!1),f.trigger("set-range",d,!0,!0);break;case m.UNKNOWN:c=new l({block:o}),d=new k({startRange:c,endRange:c}),f.setHtmlContentEditable(!1),f.trigger("set-range",d,!0,!0);break;default:s.warn("_onMouseDown is not handled, block type is "+b)}f.lastBlock=o}},_onAnchorClick:function(a){var b,c=a.currentTarget;a.preventDefault(),b=c&&c.getAttribute("href"),b&&this.trigger("open-link",b)},_onSelectStart:function(a){this.trigger("selectstart",a)},_onTextInput:function(a){var b,c,d=this;s.log("------------------ noteview text input event ----------"),a.preventDefault(),d.isReadOnly()||(c=a.originalEvent||a,c&&(b=c.data+"",b&&d.trigger("text-input",b)))},_onCompositionStart:function(a){var b=this;return b.isReadOnly()?void a.preventDefault():(s.log("note view compositionstart ---------->>>>>>"),window.clearTimeout(b._compositionEndTimer),b._setCompositionState(!0),void b.trigger("delete-selection"))},_onCompositionEnd:function(a){var b=this,c=a.originalEvent||a;return b.isReadOnly()?void a.preventDefault():(s.log("note view compositionend ---------->>>>>>"),c.data||b.trigger("delete-selection"),void(b._compositionEndTimer=window.setTimeout(function(){b._setCompositionState(!1)},0)))},_setCompositionState:function(a){var b,c=this;a&&(b=r.getRange(),c.trigger("set-range",b,!1,!1)),c._isOnComposition=a},_onInsertBlock:function(a,b){var c=this,d=c._createBlockView(b);p(d),c._insertBlockView(a,d),c._bindEventsForBlockView(b,d)},_onRemoveBlock:function(a){var b=this;b._removeBlockView(a)},_onReplaceBlock:function(a,b){var c=this,d=c._createBlockView(b);p(d),c._replaceBlockView(a,d)},_createBlockView:function(a){var b=m.getType(a),c=o(b);return p(!!c),new c({block:a})},_insertBlockView:function(a,b){var c=this,d=c.blockViews,e=c.$el,f=e.children(),g=f.length;d.splice(a,0,b),a===g?e.append(b.$el):e.children().eq(a).before(b.$el),b.render()},_removeBlockView:function(a){var b,d=this,e=d.blockViews,f=d.$el,g=d.tableViews;b=e.splice(a,1),g.splice(c.indexOf(g,b),1),f.children().eq(a).remove()},_replaceBlockView:function(a,b){var c=this,d=c.blockViews,e=c.$el;d.splice(a,1,b),e.children().eq(a).replaceWith(b.$el),b.render()},getBlockViewAt:function(a){var b=this;return b.blockViews[a]},getLastBlockView:function(){var a=this,b=a.blockViews;return b[b.length-1]},getBlockViewContainer:function(a){var b=".block-view",c=d(a).closest(b)[0];return c},getBlockViewIndex:function(a){if(!a)return-1;var b=this,c=">.block-view";return b.$el.find(c).index(a)},getBlock:function(a){var b=this,c=b.note,d=b.getBlockViewContainer(a),e=b.getBlockViewIndex(d);return c.getBlockAt(e)},getBlockViewByBlock:function(a){var b=this,c=b.note.getBlockIndex(a);return b.getBlockViewAt(c)},onCommand:function(a,b){var c,d,e,f=this;null==b.range&&(b.imageBlockView?(c=b.imageBlockView,b.imageBlockView=null,e=new g({block:c.block}),d=new k({blockRanges:[e]}),b.range=d):b.attachmentBlockView&&(c=b.attachmentBlockView,b.attachmentBlockView=null,e=new h({block:c.block}),d=new k({blockRanges:[e]}),b.range=d)),f.trigger("command",a,b)},_onCopy:function(a){var b=this;b.trigger("copy",a)},_onCut:function(a){var b=this;return b.isReadOnly()?void a.preventDefault():void b.trigger("cut",a)},_onPaste:function(a){var b=this;return b.isReadOnly()?void a.preventDefault():void b.trigger("paste",a)},_onContextMenu:function(a){var b=this;a.preventDefault(),
b.isReadOnly()||b.trigger("contextmenu",a)},_onDragDropEvent:function(a){var b,c=this;if(!c.isReadOnly())switch(a=a.originalEvent,b=c.getBlock(a.srcElement),a.type){case"dragstart":c.trigger("dragstart",a,b);break;case"dragover":c.trigger("dragover",a,b);break;case"drop":c.trigger("drop",a)}},_onBlur:function(){var a=this;a.trigger("blur")},_onFocus:function(){var a=navigator.userAgent.toLowerCase();window.parent!==window&&a&&a.indexOf("applewebkit")>-1&&a.indexOf("chrome")<=-1&&window.parent.getSelection().removeAllRanges()},onSelectAll:function(){var a=this,b=document.createRange();b.setStart(a.el.firstChild,0),b.setEnd(a.el.lastChild,1),r.setRange(b,window),a.parseNativeRange(b)},onResize:function(){var a=this,b=a.tableViews;c.each(b,function(a){a.trigger("view-resize")})},_onReadOnlyChange:function(){var a=this,b=a.isReadOnly();a.setHtmlContentEditable(!b),b?a.$el.addClass("read-only"):a.$el.removeClass("read-only")}})}({}),yne_underscorestring=function(){var a,b=window._;if(!b&&window.require&&(b=window.require("underscore")),!b)throw"no `underscore` library";if(a=b.string||b.str||window.s,!a&&window.require&&(a=window.require("underscore.string")),!a)throw"no `underscore.string` library";return a}(),yne_common_data_Image=function(a){var b,c,d,e=yne_jquery,f=yne_underscore,g=yne_common_data_Block,h=yne_common_data_blockTypes,i=yne_jtk_core_L,j=yne_common_util_unknownTree,k=yne_common_util_blockStyles;return b={_type:h.IMAGE,_source:null,initialize:function(a){var b=this;g.prototype.initialize.apply(b,arguments),b._source=a.source},setSource:function(a){var b=this;return a&&a!==b._source?(b._source=a+"",b.trigger("content-change"),!0):!1},getSource:function(){return this._source},getStyles:function(a){var b=this;return a?b.getBlockStyle(a):b.getBlockStyles()},setStyles:function(a,b){var c=this;return f.isString(a)?c.setBlockStyle(a,b):f.isObject(a)&&c.setBlockStyles(a),!0},toXml:function(a){var b,c,d,e,f=this,g=f.getSource();if(g)return b=a.createElement("image"),c=a.createElement("source"),d=a.createTextNode(g),c.appendChild(d),b.appendChild(c),e=a.createElement("styles"),k.toXml(f,e,a),b.appendChild(e),j.appendToXml(f.unknownTree,b),b},toJSON:function(){var a=this,b={blockType:a._type,source:a.getSource(),styles:a.getStyles()};return b},toHtml:function(){var a,b=this,c=b.getStyles(),d=document.createElement("div"),g=e(d),h=e(document.createElement("img"));return g.attr("yne-bulb-block","image"),f.each(c,function(a,b){switch(b){case"align":g.css("text-align",a);break;case"width":null==a?h.css("width",""):h.css("width",a);break;case"float":g.css("float",a)}}),h.attr({"data-media-type":"image",src:b._source}),g.append(h),a=d.outerHTML,d=g=h=null,a},toPlain:function(){var a="[图片]";return a},countWords:function(){return 0}},c={fromXml:function(a){var b=e(a),c=e.trim(b.find("source").text()),f=new d({source:c});return b.children().each(function(a,b){switch(b.nodeName){case"source":break;case"styles":k.fromXml(f,b);break;default:j.appendToTree(f.unknownTree,b)}}),f},fromJSON:function(a){if(!a||!a.blockType||a.blockType!==h.IMAGE||!a.source)return void i.warn("jsonObj or jsonObj.source does NOT exist!");var b=new d({source:a.source});return a.styles&&b.setStyles(a.styles),b}},d=g.extend(b,c)}({}),yne_common_data_Attachment=function(a){var b,c,d,e=yne_jquery,f=yne_underscore,g=yne_common_data_Block,h=yne_common_data_blockTypes,i=yne_jtk_core_L,j=yne_common_util_unknownTree,k=yne_common_util_blockStyles;return b={_type:h.ATTACHMENT,_source:null,_resource:null,_fileName:null,_fileLength:null,initialize:function(a){var b=this;g.prototype.initialize.apply(b,arguments),b._source=a.source,b._resource=a.resource,b._fileName=a.fileName,b._fileLength=a.fileLength},setSource:function(a){var b=this;return a=(a||"")+"",a&&a!==b._source?(b._source=a,b.trigger("content-change"),!0):!1},getSource:function(){return this._source},getResource:function(){return this._resource},setResource:function(a){var b=this;return a=(a||"")+"",a&&a!==b._resource?(b._resource=a,b.trigger("content-change"),!0):!1},getFileName:function(){var a=this;return a._fileName},setFileName:function(a){var b=this;return a=String(a||""),a&&a!==b._fileName?(b._fileName=a,b.trigger("content-change"),!0):!1},getFileLength:function(){var a=this;return a._fileLength},setFileLength:function(a){var b=this;return a=parseInt(a||0),a&&a!==b._fileName?(b._fileLength=a,b.trigger("content-change"),!0):!1},getStyles:function(a){var b=this;return a?b.getBlockStyle(a):b.getBlockStyles()},setStyles:function(a,b){var c=this;return f.isString(a)?c.setBlockStyle(a,b):f.isObject(a)&&f.each(a,function(a,b){c.setBlockStyle(b,a)}),!0},toXml:function(a){var b,c,d=this,e=d.getSource(),g=["Source","Resource","FileName","FileLength"];if(e)return b=a.createElement("attach"),f.each(g,function(c){var e=a.createElement(c.toLowerCase()),f=d["get"+c](),g=a.createTextNode(f);e.appendChild(g),b.appendChild(e)}),c=a.createElement("styles"),k.toXml(d,c,a),b.appendChild(c),j.appendToXml(d.unknownTree,b),b},toJSON:function(){var a=this,b={blockType:a._type,source:a.getSource(),resource:a.getResource(),fileName:a.getFileName(),fileLength:a.getFileLength(),styles:a.getStyles()};return b},toHtml:function(){var a,b=this,c=b.getStyles(),d=document.createElement("div"),g=e(d),h=e(document.createElement("img"));return g.attr("yne-bulb-block","attachment"),f.each(c,function(a,b){switch(b){case"align":g.css("text-align",a);break;case"float":g.css("float",a)}}),h.attr({"data-media-type":"attachment",src:b._source,path:b._resource,filelength:b._fileLength,title:b._fileName,alt:b._fileName,filename:b._fileName}),g.append(h),a=d.outerHTML,d=g=h=null,a},toPlain:function(){var a=this,b=a._fileName,c="[附件"+(b?":"+b:"")+"]";return c},countWords:function(){return 0}},c={fromXml:function(a){var b,c="无文件名",f=e(a),g=e.trim(f.find("source").text()),h=e.trim(f.find("resource").text()),i=e.trim(f.find("filename").text())||c,l=e.trim(f.find("filelength").text());return l=parseInt(l,10),isNaN(l)&&(l=0),b=new d({source:g,resource:h,fileName:i,fileLength:l}),f.children().each(function(a,c){switch(c.nodeName){case"source":case"resource":case"filename":case"filelength":break;case"styles":k.fromXml(b,c);break;default:j.appendToTree(b.unknownTree,c)}}),b},fromJSON:function(a){if(!(a&&a.blockType&&a.blockType===h.ATTACHMENT&&a.source&&a.resource))return void i.warn("jsonObj or jsonObj.source/resource does NOT exist!");var b=new d({source:a.source,resource:a.resource,fileName:a.fileName,fileLength:a.fileLength});return a.styles&&b.setStyles(a.styles),b}},d=g.extend(b,c)}({}),yne_common_data_ListItem=function(a){var b,c=yne_common_data_Paragraph,d=yne_common_data_RichText,e=yne_common_data_blockTypes,f=yne_common_data_Rich2HtmlConvertor,g=yne_jquery,h=yne_underscore,i=yne_underscorestring,j=yne_jtk_core_L,k=yne_common_util_unknownTree,l=yne_common_util_blockStyles,m=yne_jtk_core_assert,n=yne_common_data_supportedListItemStyles,o=n.getStyle,p=n.getPlainStyle;return b=c.extend({_type:e.LIST_ITEM,_level:null,_ownerList:null,_index:null,initialize:function(a){var b=this,d=a.level||1;c.prototype.initialize.call(b,a),b.setLevel(d),b.setIndex(1),b._ownerList=a.list,b.on("attached",b._onAttached.bind(b)),b.on("detached",b._onDetached.bind(b))},setLevel:function(a){h.isNumber(a)&&(a=Math.max(a,1),a=Math.min(a,9),this._level=a,this._ownerList&&this._ownerList.updateIndexes(),this.trigger("level-change",a))},getLevel:function(){return this._level},setIndex:function(a){h.isNumber(a)&&a>0&&(this._index=a,this.trigger("index-change",a))},getIndex:function(){return this._index},setOwnerList:function(a){this._ownerList=a},getOwnerList:function(){return this._ownerList},isOrdered:function(){return this._ownerList.isOrdered()},_onAttached:function(a){var b,c,d=this,f=d.getOwnerList(),g=a.getAllBlocks(),h=a.getBlockIndex(d),i=null;if(m(h>=0,"Block not attached yet.",h,d),0===f.getLength())f.insertAfter(d,null);else{for(b=h-1;b>=0;--b)if(c=g[b],e.isListItem(c)&&c.getOwnerList()===f){i=c;break}f.insertAfter(d,i)}},_onDetached:function(){this.getOwnerList().removeItem(this)},toXml:function(a){var b,c,d,e,f,g,h=this,i=h.getOwnerList();return i?(b=a.createElement("list-item"),b.setAttribute("level",h.getLevel()),g=i.getId(),b.setAttribute("list-id",g),c=h._richText.toString(),d=a.createElement("text"),d.appendChild(a.createTextNode(c)),b.appendChild(d),f=h._richText.toXml(a),f&&b.appendChild(f),e=a.createElement("styles"),l.toXml(h,e,a),b.appendChild(e),k.appendToXml(h.unknownTree,b),{listId:g,listType:i.getType(),ownerList:i,listItem:b}):void j.error("The list item has no owner list!")},toJSON:function(a,b){var c,d=this,e=d.sliceText(a,b,!1),f={blockType:d._type,richText:e.toJSON(),styles:d.getBlockStyles(),level:d.getLevel(),index:d.getIndex()},g=d.getOwnerList();return g&&g.getId&&(c=g.getId()),c&&(f.listId=c),g&&g.getType&&g.getType()&&(f.listType=g.getType()),f},_getLabel:function(){var a=this,b="",c=a.getLevel();if(a.isOrdered())b=p(c,a.getIndex())+".";else switch(c%3){case 0:b="■";break;case 2:b="○";break;default:case 1:b="●"}return b},toHtml:function(a,b){var c,d,e,h=this,i=document.createElement("li"),j=g(i);return j.css("list-style-type",o(h)),j.css("list-style-position","inside"),h._applyBlockStylesOnElement(j),a=a||0,c=h.sliceText(a,b,!1),d=f.rich2html(c,{withDefault:!1,convertSpace:!0}),i.innerHTML=d,e=i.outerHTML,i=j=null,e},toPlain:function(a,b){var c,d,e=this,f=e.getLevel()||1;return a=a||0,c=e.sliceText(a,b,!1),d=c.toString(),d=e._getLabel()+" "+d,d=i.repeat(" ",4*f-2)+d},getListType:function(){var a=this;return a._ownerList?a._ownerList.getType():a.listType}},{fromXml:function(a){var c,e=g(a),f=parseInt(e.attr("level"))||1;return c=new b({level:f}),c.setText(d.fromXml(a)),g(a).children().each(function(a,b){switch(b.nodeName){case"text":case"inline-styles":break;case"styles":l.fromXml(c,b);break;default:k.appendToTree(c.unknownTree,b)}}),c},fromJSON:function(a){if(!a||!a.blockType||a.blockType!==e.LIST_ITEM)return void j.warn("jsonObj is not valid!");var c=new b({level:a.level});return c.setText(d.fromJSON(a.richText)),h.each(a.styles,function(a,b){c.setBlockStyle(b,a)}),a.listType&&(c.listType=a.listType),a.listId&&(c.listId=a.listId),c}})}({}),yne_ytable_tools_core_console=function(){var a,b=window||global,c=function(){},d={DEBUG:!1,EXPORTS:b.JTK_EXPORTS||{},log:c,warn:c,error:c};return b.DEBUG!==!0?d:b.console&&b.console.log?(a=b.console,d.DEBUG=!0,a.log&&a.log.bind?(d.log=a.log.bind(a),d.warn=a.warn.bind(a),d.error=a.error.bind(a),d):(d.log=function(){var b,c=arguments.length;for(b=0;c>b;b++)a.log(arguments[b])},d.warn=function(){var b,c=arguments.length;for(b=0;c>b;b++)a.warn(arguments[b])},d.error=function(){var b,c=arguments.length;for(b=0;c>b;b++)a.error(arguments[b])},d)):d}(),yne_ytable_tools_core_underscore=function(a){var b=yne_ytable_tools_core_console,c=this._||this.underscore;return c?(b.EXPORTS.underscore===!1&&c.noConflict&&(c=c.noConflict()),c):void b.error("no underscore library","core/underscore.js")}({}),yne_ytable_tools_web_dom_isTag=function(a,b){return b=String(b).toLowerCase(),a&&a.nodeName&&b?String(a.nodeName).toLowerCase()===b:!1},yne_ytable_tools_core_str_trim=function(a){return null==a||""===a?"":String(a).replace(/^[\s\t\xA0\u3000]+/,"").replace(/[\s\t\xA0\u3000]+$/,"")},yne_ytable_tools_core_reg_encode=function(a){return String(a).replace(/([.*?\^$=!:{}()|\[\]\/\\+])/g,"\\$1")},yne_ytable_tools_web_dom_className=function(a){var b=yne_ytable_tools_core_underscore,c=yne_ytable_tools_core_str_trim,d=yne_ytable_tools_core_reg_encode;return{has:function(a,b){return a&&b&&a.className?a.classList&&a.classList.contains?a.classList.contains(b):new RegExp("(^|\\s+)"+d(b)+"(\\s+|$)","").test(a.className):!1},add:function(a,d){var e,f=this;return a&&d&&b.isString(d)&&!f.has(a,d)?a.classList?(a.classList.add(d),f):(e=c(a.className),a.className=e?e+" "+d:d,f):f},remove:function(a,e){var f=this;return a&&e&&b.isString(e)?a.classList?(a.classList.remove(e),f):(e=String(a.className).replace(new RegExp("(^|\\s+)"+d(e)+"(\\s+|$)","g")," "),a.className=c(e),f):f},toggle:function(a,b){var c=this;return a.classList?(a.classList.toggle(b),c):c.has(b)?c.remove(a,b):c.add(a,b)}}}({}),yne_ytable_tools_web_bom_userAgent=function(a){var b=yne_ytable_tools_core_underscore,c=window.navigator.userAgent.toLowerCase(),d=function(a){var b=0;return parseFloat(a.replace(/\./g,function(){return b+=1,1===b?".":""}))},e={WEBKIT:function(){var a=c.match(/applewebkit\/([^\s]*)/);return a&&a[1]?d(a[1]):void 0},PRESTO:function(){var a=c.match(/presto\/([\d.]*)/);return a&&a[1]?d(a[1]):void 0},TRIDENT:function(){var a=c.match(/msie\s([^;]*)/);return a?(a=c.match(/trident\/([\d.]*)/),a&&a[1]?d(a[1]):1):void 0},GECKO:function(){if(/gecko/.test(c)){var a=c.match(/rv:([\d.]*)/);return a&&a[1]?d(a[1]):1}}},f={RETINA:window.devicePixelRatio>=2,MOBILE:/mobile/.test(c),IPOD:/ipod/.test(c),IPAD:/ipad/.test(c),IPHONE:/iphone/.test(c),IPHONE_5:!1,IOS:!1,IOS_5:!1,IOS_6:!1,WIN:/windows|win32/.test(c),MAC:/macintosh/.test(c),IE:/msie/.test(c),IE6:/msie 6/.test(c),IE7:/msie 7/.test(c),IE8:/msie 8/.test(c),IE9:/msie 9/.test(c),IE10:/msie 10/.test(c),OPERA:/opera/.test(c),MOZ:/gecko/.test(c)&&!/(compatible|webkit)/.test(c),SAFARI:!/chrome\/([\d.]*)/.test(c)&&/\/([\d.]*) safari/.test(c),CHROME:/chrome\/([\d.]*)/.test(c),WEBKIT:!1,PRESTO:!1,TRIDENT:!1,GECKO:!1};return(f.IPHONE||f.IPOD)&&(f.IPHONE_5=window.screen.height>481),(f.IPAD||f.IPHONE||f.IPOD)&&(f.IOS=!0,f.IOS_5=/ os 5/.test(c),f.IOS_6=/ os 6/.test(c)),b.some(e,function(a,b){var c;try{if(c=a())return f[b]=c,!0}catch(d){return!1}}),f}({}),yne_ytable_tools_web_dom_attr=function(a){var b=yne_ytable_tools_web_bom_userAgent,c=yne_ytable_tools_core_underscore,d=b.IE,e=function(){if(null==e._isNeed){var a=document.createElement("div");a.setAttribute("class","hello"),e._isNeed=-1===a.className.indexOf("hello")}return e._isNeed},f={acceptcharset:"acceptCharset",accesskey:"accessKey",allowtransparency:"allowTransparency",bgcolor:"bgColor",cellpadding:"cellPadding",cellspacing:"cellSpacing","class":"className",colspan:"colSpan",checked:"defaultChecked",selected:"defaultSelected","for":"htmlFor",frameborder:"frameBorder",hspace:"hSpace",longdesc:"longDesc",maxlength:"maxLength",marginwidth:"marginWidth",marginheight:"marginHeight",noresize:"noResize",noshade:"noShade",readonly:"readOnly",rowspan:"rowSpan",tabindex:"tabIndex",valign:"vAlign",vspace:"vSpace"},g=e()?function(a){return f[a]||a}:function(a){return a};return{has:function(a,b,c){var d=this;return a&&null!=b?(b=g(b),null==c?a.hasAttribute&&a.hasAttribute(b)||null!=a[b]:d.get(a,b)===c):!1},get:function(a,b){return a&&null!=b?d&&"style"===b?a.style.cssText:(b=g(b),a.getAttribute?a.getAttribute(b):void 0):void 0},set:function(a,b,e){var f=this;return a&&null!=b?null==e&&c.isObject(b)?(c.each(b,function(b,c){f.set(a,c,b)}),f):d&&"style"===b?(a.style.cssText=e,f):(b=g(b),a.setAttribute&&a.setAttribute(b,e),f):f},remove:function(a,b){var c=this;return a&&null!=b?d&&"style"===b?(a.style.cssText="",c):(b=g(b),a.removeAttribute&&a.removeAttribute(b),c):c}}}({}),yne_ytable_tools_web_console=function(a){var b=yne_ytable_tools_core_console,c=window.console,d=/msie/i.test(window.navigator.userAgent);return b.DEBUG&&c&&c.log&&(d||!c.log.apply)&&(b.log=function(){var a,b,d=arguments.length,e=[],f=window.JSON;for(a=0;d>a;a++){if(b=arguments[a],f)try{b=f.stringify(b)}catch(g){}e.push(String(b))}c.log(e.join(";"))}),b}({}),yne_ytable_tools_web_dom_Selector=function(a){function b(a){var d=this;d._options=c.extend({id:null,tag:null,className:null,attr:null,attrVal:null},c.isString(a)?b.parse(a):a),d._formatedSelector=b.stringify(d._options),d.isOptionsValid=!!d._formatedSelector,d.isOptionsValid||h.error("The options for Selector() is not valid","web/dom/Selector")}var c=yne_ytable_tools_core_underscore,d=yne_ytable_tools_web_dom_isTag,e=yne_ytable_tools_web_dom_className,f=yne_ytable_tools_web_dom_attr,g=yne_ytable_tools_core_str_trim,h=yne_ytable_tools_web_console;return b.prototype.test=function(a){var b=this,c=b._options;return a&&a.nodeType&&b.isOptionsValid?(c.id?a.getAttribute("id")===c.id:!0)&&(c.tag?d(a,c.tag):!0)&&(c.className?e.has(a,c.className):!0)&&(c.attr?f.has(a,c.attr,c.attrVal):!0):!1},b.prototype.toString=function(){var a=this;return a.isOptionsValid?a._formatedSelector:void 0},b.parse=function(a){if(a=g(a)){var b={selector:a},d={tag:/^([a-zA-Z]+)/,id:/#([a-zA-Z_\-\d]+)/,className:/\.([a-zA-Z_\-\d]+)/,attr:/\[([a-zA-Z_\-\d]+)(?:=([^\]]+))?\]/};return c.each(["tag","attr","id","className"],function(a){var c=d[a],e=c.exec(b.selector);e&&e[1]&&(b[a]=e[1],b.selector=g(b.selector.replace(e[0],"")),"attr"===a&&(b.attrVal=e[2]||null),b.attrVal&&(b.attrVal=b.attrVal.replace(/^['"]/,"").replace(/['"]$/,"")))}),""!==b.selector?void h.error("selector can not to be parsed","web/dom/Selector"):b.id||b.tag||b.className||b.attr?(delete b.selector,b):void 0}},b.stringify=function(a){if(c.isString(a)||!a)return a||"";var b=a.tag||"",d={id:"#",className:"."};return c.each(["id","className"],function(c){a[c]&&(b+=d[c]+a[c])}),a.attr?b+"["+a.attr+(a.attrVal?'="'+a.attrVal+'"':"")+"]":b},b}({}),yne_ytable_tools_web_dom_nodeType=function(a){var b=yne_ytable_tools_core_underscore;return{ELEMENT_NODE:1,ATTRIBUTE_NODE:2,TEXT_NODE:3,CDATA_SECTION_NODE:4,ENTITY_REFERENCE_NODE:5,ENTITY_NODE:6,PROCESSING_INSTRUCTION_NODE:7,COMMENT_NODE:8,DOCUMENT_NODE:9,DOCUMENT_TYPE_NODE:10,DOCUMENT_FRAGMENT_NODE:11,NOTATION_NODE:12,getType:function(a){return a&&a.nodeType?a.nodeType:void 0},isNode:function(a){var c=this,d=c.getType(a);return b.isNumber(d)&&d>=c.ELEMENT_NODE&&d<=c.NOTATION_NODE},isElement:function(a){return this.getType(a)===this.ELEMENT_NODE},isAttribute:function(a){return this.getType(a)===this.ATTRIBUTE_NODE},isText:function(a){return this.getType(a)===this.TEXT_NODE},isCDataSection:function(a){return this.getType(a)===this.CDATA_SECTION_NODE},isEntityReference:function(a){return this.getType(a)===this.ENTITY_REFERENCE_NODE},isEntity:function(a){return this.getType(a)===this.ENTITY_NODE},isProcessingInstruction:function(a){return this.getType(a)===this.PROCESSING_INSTRUCTION_NODE},isComment:function(a){return this.getType(a)===this.COMMENT_NODE},isDocument:function(a){return this.getType(a)===this.DOCUMENT_NODE},isDocumentType:function(a){return this.getType(a)===this.DOCUMENT_TYPE_NODE},isDocumentFragment:function(a){return this.getType(a)===this.DOCUMENT_TYPE_NODE},isNotation:function(a){return this.getType(a)===this.NOTATION_NODE}}}({}),yne_ytable_tools_web_dom_findParent=function(a){var b=yne_ytable_tools_core_underscore,c=yne_ytable_tools_web_dom_Selector,d=yne_ytable_tools_web_dom_nodeType;return function(a,e){var f;for(b.isString(e)&&(f=new c(e),e=function(a){return f.test(a)});a&&(a.nodeType===d.ELEMENT_NODE||a.nodeType===d.TEXT_NODE);){if(e(a)===!0)return a;a=a.parentNode}}}({}),yne_ytable_tools_jq_jquery=function(a){var b=yne_ytable_tools_core_console,c=window.jQuery||window.$;return c?(b.EXPORTS.jquery===!1&&c.noConflict&&(c=c.noConflict(!0)),c):void b.error("no jQuery library","jq/jquery.js")}({}),yne_ytable_client_shared_const={OP:{CODE:"code",CLIENT_ID:"clientId",CLIENT_VERSION:"clientVersion",OTHER_VERSION:"otherVersion",SERVER_VERSION:"serverVersion"},SINGLE_CELL:{X:"x",Y:"y"},MULTIPLE_CELLS:{X1:"x1",Y1:"y1",X2:"x2",Y2:"y2"},CELL_OP:{PROP_KEY:"key",PROP_VALUE:"value"},LINE_OP:{INDEX:"index",COUNT:"count"},SET_ROWS_HEIGHT_OP:{HEIGHT:"height"},SET_COLUMNS_WIDTH_OP:{WIDTH:"width"},COMPOSITE_OP:{OPLIST:"opList"},OPS:{REQID:"reqId",CLIENT_ID:"clientId",CLIENT_VERSION:"clientVersion",OTHER_VERSION:"otherVersion",SERVER_VERSION:"serverVersion",OP_LIST:"opList"},REQUEST:{ID:"id",TYPE:"type"},COLLABORATE_REQUEST:{OPS:"ops"},SAVE_REQUEST:{FILEID:"saveId"},CLIENT_ID_TO_USER_REQUEST:{CLIENT_ID:"clientId"},FOCUS_CELL_REQUEST:{X:"x",Y:"y"},RESPONSE:{ID:"id",TYPE:"type",CLIENT_VERSION:"clientVersion",OTHER_VERSION:"otherVersion",SERVER_VERSION:"serverVersion"},GET_ID_RESPONSE:{CLIENT_ID:"clientId"},SYNC_RESPONSE:{CLIENT_ID:"clientId",FILE_ID:"fileId",CONTENT:"content",CONNECTED_CLIENTS:"clients"},COLLABORATE_RESPONSE:{OP_LIST:"opList"},CLIENT_ID_TO_USER_RESPONSE:{CLIENT_ID:"clientId",USER_ID:"userId",NAME:"name",PHOTO:"photo",DESCRIPTION:"description",LOCATION:"location",PHONE:"phone",EMAIL:"email",SEX:"sex"},NEW_TABLE_RESPONSE:{FILE_ID:"fileId"},SAVE_RESPONSE:{RESULT:"result",USER_ID:"saveUserId",CLIENT_ID:"saveClientId",FILE_ID:"saveId"},SAVE_RESPONSE_SUCCESS:0,SAVE_RESPONSE_FAILED:1,TABLE:{ROW_HEIGHTS:"heights",COLUMN_WIDTHS:"widths",CELLS:"cells",CLIENT_VERSION_MAP:"clientVersionMap",OTHER_VERSION_MAP:"otherVersionMap",SERVER_VERSION_MAP:"serverVersionMap",LAST_REQ_ID_MAP:"lastReqIdMap",CLIENT_INFO_MAP:"clientInfoMap",CURRENT_VERSION:"currentVersion",LAST_MODIFIED_USER_ID:"lastModifiedUserId",LAST_MODIFIED_TIME:"lastModifiedTime",NEXT_CLIENT_ID:"nextClientId"},TABLE_CELL:{VALUE:"value",MERGE_WIDTH:"mergeWidth",MERGE_HEIGHT:"mergeHeight",MERGE_POINT_DIST_X:"mergePointDX",MERGE_POINT_DIST_Y:"mergePointDY"},CLIENT_INFO:{CLIENT_ID:"clientId",USER_ID:"userId",LAST_UPDATE_TIME:"lastUpdate"},CLIENT_CONNECT_RESPONSE:{CLIENT_ID:"clientId"},CLIENT_DISCONNECT_RESPONSE:{CLIENT_ID:"clientId"},FOCUS_CELL_RESPONSE:{X:"x",Y:"y",CLIENT_ID:"clientId"},DEFAULT_ROW_HEIGHT:23,DEFAULT_COLUMN_WIDTH:70,CLIENT_CONNECT_REQUEST_ID:-1,CLIENT_DISCONNECT_REQUEST_ID:-2,FOCUS_CELL_REQUEST_ID:-3,OTHER_CLIENT_CHANGED_REQUEST_ID:-4,ERROR_MESSAGE_SOCKET_REQUEST_ID:-5,OTHER_CLIENT_SAVE_REQUEST_ID:-6,ACCESS:{GROUP_ID:"groupId",CLIENT_ID:"clientId",USER_ID:"userId",FILE_ID:"fileId",TOKEN:"token"},ERROR:{CODE:"errCode",MESSAGE:"errMsg"},WEB_SOCKET_MAX_TEXT_MESSAGE_SIZE:262144,WEB_SOCKET_MAX_BINARY_MESSAGE_SIZE:524288,DEFAULT_TABLE_COLUMN_NUM:20,DEFAULT_TABLE_ROW_NUM:40,COLLABORATE_USER_LIMIT:20,HISTORY:{TABLE_KEY:"histTbKey",TABLE_VER_NO:"histTbVerNO",TABLE_CONTENT:"histTbContent",TABLE_REVISORS:"histTbRevisors",TABLE_OPS:"histTbOpsInfo",TABLE_OPS_USR:"histTbOpsInfoUsr",TABLE_OPS_OPS:"histTbOpsInfoOps",TABLE_OPS_TIME:"histTbOpsInfoTime",TABLE_LAST_VERSION:"histTbLastVersion",TABLE_START_OPS_TIME:"histTbStartOpsTime",TABLE_LAST_OPS_TIME:"histTbLastOpsTime",TABLE_OLD_TITLE:"histTbOldTitle",TABLE_NEW_TITLE:"histTbNewTitle",TABLE_TITLE_MODIFIER:"histTbTitleModifier"}},yne_ytable_editor_config_defaults=function(a){var b,c=yne_ytable_client_shared_const;return b={fontSize:12,fontName:"Microsoft YaHei",rowHeight:c.DEFAULT_ROW_HEIGHT,columnWidth:c.DEFAULT_COLUMN_WIDTH,rowPageLength:30}}({}),yne_ytable_tools_web_dom_insert=function(a){return{before:function(b){var c;b&&b.parentNode&&(c=b.parentNode,c.insertBefore&&c.insertBefore(a,b))},after:function(b){var c;b&&b.parentNode&&(c=b.parentNode,b.nextSibling&&c.insertBefore?c.insertBefore(a,b.nextSibling):c.appendChild&&c.appendChild(a))}}},yne_ytable_tools_web_dom_remove=function(a){var b=yne_ytable_tools_web_dom_nodeType,c=yne_ytable_tools_web_dom_insert;return function(a,d){if(b.isNode(a)){if(d=d!==!1,a.removeNode&&d)return a.removeNode(a,d);if(a.parentNode&&a.parentNode.removeChild){if(!d)for(;a.firstChild;)c(a.firstChild).before(a);return a.parentNode.removeChild(a)}}}}({}),yne_ytable_editor_utils_TableUtils=function(a){var b=yne_ytable_tools_web_dom_findParent,c=yne_ytable_tools_core_underscore,d=yne_ytable_tools_jq_jquery,e=yne_ytable_editor_config_defaults.rowPageLength,f=yne_ytable_tools_web_dom_remove;return{WIDTH_DIFF:3,HEIGHT_DIFF:3,findParent:b,getPageInfo:function(a){var b=Math.floor(a/e);return{page:b,pageRow:a-b*e}},chunkRange:function(a,b,e,f){if(f=f||1,!c.isFunction(f)){var g=f;f=function(){return g}}var h=d.Deferred();if(!e||a>=b)return h.resolve().promise();var i=a,j=!0,k=function(){j=e(i++)!==!1,j&&b>i?window.setTimeout(k,f()):h.resolve()};return window.setTimeout(k,f()),h.promise()},forRange:function(a,b,c){var e=d.Deferred();if(!c||a>=b)return e.resolve().promise();var f;for(f=a;b>f&&c(f)!==!1;++f);return e.resolve().promise()},isRowHeader:function(a){return!!b(a,"td")&&!!b(a,".row-header")},isColHeader:function(a){return!!b(a,"th")&&!!b(a,".column-header")},isRowResizer:function(a){return a.classList.contains("row-resizer")},isColResizer:function(a){return a.classList.contains("col-resizer")},isTableCell:function(a){return"TD"===a.tagName&&!!b(a,".table-wrapper")},setElementStyles:function(a,b,d,e){var g,h,i;"true"===b.bold?a.style.fontWeight="bold":a.style.fontWeight="","true"===b.italic?a.style.fontStyle="italic":a.style.fontStyle="",h="true"===b.underline,i="true"===b.lineThrough,h&&i?a.style.textDecoration="underline line-through":h?a.style.textDecoration="underline":i?a.style.textDecoration="line-through":a.style.textDecoration="",g=b.fontName,c.isString(g)&&"default"!==g?a.style.fontFamily=g:a.style.fontFamily="",g=parseInt(b.fontSize),isNaN(g)?a.style.fontSize="":a.style.fontSize=b.fontSize,g=b.textAlign,"center"===g||"right"===g||"left"===g?a.style.textAlign=g:a.style.textAlign="",g=b.verticalAlign,"top"===g||"middle"===g||"bottom"===g?a.style.verticalAlign=g:a.style.verticalAlign="","true"===b.wrap?a.style.whiteSpace="normal":a.style.whiteSpace="",g=b.textColor,g?a.style.color=g:a.style.color="",g=b.backColor,g&&"inherit"!==g&&"transparent"!==g?a.style.backgroundColor=g:a.style.backgroundColor="",!d||e&&e!==b["diff|user"]||(g=b.diff,"mod"===g?(a.style.backgroundColor="rgb(225, 246, 209)",a.style.color="black"):"delete"===g&&(a.style.backgroundColor="rgb(245, 219, 216)",a.style.color="black",-1!==a.style.textDecoration.indexOf("underline")?a.style.textDecoration="underline line-through":a.style.textDecoration="line-through")),b.link?this.setElementText(a,a.innerText,b,e):(g=a.querySelector("a"),g&&(g.firstChild&&a.appendChild(g.firstChild),f(g)))},setElementText:function(a,b,c,d){if("delete"===c.diff&&d&&d!==c["diff|user"])return void(a.innerText="");if(a.innerHTML="",c.link){var e=document.createElement("a");e.setAttribute("target","_blank"),e.setAttribute("href",c.link),c.textColor&&(e.style.color="inherit"),a.appendChild(e),a=e}a.innerText=b},getCellElFromTableEl:function(a,b,c){var d=a.rows[b];return d?d.cells[c]:null},setBorder:function(a,b,c,d){var e,f,g=a.editor.getTable(),h=d["border|vertical"],i=d["border|horizontal"];g.isMergedCell(b,c)||(h||(f=d.backColor,h=f&&"inherit"!==f&&"transparent"!==f?"1px solid "+f:""),i||(f=d.backColor,i=f&&"inherit"!==f&&"transparent"!==f?"1px solid "+f:""),0===b||g.isMergePoint(b,c)||g.isMergedCell(b-1,c)||g.isMergePoint(b-1,c)?(e=a.getCellElementAt(b,c),e&&(e.style.borderTop=i)):(e=a.getCellElementAt(b-1,c),e&&(e.style.borderBottom=i)),0===c||g.isMergePoint(b,c)||g.isMergedCell(b,c-1)||g.isMergePoint(b,c-1)?(e=a.getCellElementAt(b,c),e&&(e.style.borderLeft=h)):(e=a.getCellElementAt(b,c-1),e&&(e.style.borderRight=h)))},getStylesFromElement:function(a){var b,c={},d=a.style;return-1!==d.fontWeight.indexOf("bold")&&(c.bold="true"),-1!==d.fontStyle.indexOf("italic")&&(c.italic="true"),b=d.textDecoration,-1!==b.indexOf("underline")&&(c.underline="true"),-1!==b.indexOf("line-through")&&(c.lineThrough="true"),b=d.fontFamily,b&&(c.fontName=b),b=parseInt(d.fontSize),isNaN(b)||(c.fontSize=d.fontSize),b=d.textAlign,("center"===b||"right"===b)&&(c.textAlign=b),b=d.verticalAlign,("top"===b||"middle"===b)&&(c.verticalAlign=b),b=d.whiteSpace,"normal"===b&&(c.wrap="true"),b=d.color,b&&(c.textColor=b),b=d.backgroundColor,b&&"inherit"!==b&&("transparent"===b&&(b="white"),c.backColor=b),b=a.querySelector("a"),b&&b.href&&(c.link=b.href),c},getRowName:function(a){return String(a+1)},getColumnName:function(a){for(var b="";a>=0;a=a/26-1)b=String.fromCharCode(a%26+"A".charCodeAt(0))+b;return b},measureText:function(a,b){var d=window.document,e=b.fontSize,f=b.fontName,g=b.isBold?"bold ":"",h=b.isItalic?"italic ":"",i=d.createElement("canvas"),j=i.getContext("2d");return c.isNumber(e)&&(e+="px"),j.font=g+h+e+" "+f,j.measureText(a)}}}({}),yne_ytable_client_editor_TableConvertor=function(a){var b=yne_ytable_client_shared_const,c=yne_ytable_tools_core_underscore,d=b.TABLE_CELL.VALUE,e=[b.TABLE_CELL.MERGE_WIDTH,b.TABLE_CELL.MERGE_HEIGHT,b.TABLE_CELL.MERGE_POINT_DIST_X,b.TABLE_CELL.MERGE_POINT_DIST_Y],f=[d].concat(e);return{toEditorData:function(a){var d,e,f,g=this,h=[],i=a[b.TABLE.CELLS],j=a[b.TABLE.COLUMN_WIDTHS],k=a[b.TABLE.ROW_HEIGHTS],l=k.length,m=j.length;for(d=0;l>d;++d)for(h[d]=[],e=0;m>e;++e)f=d*m+e,h[d][e]=g._toEditorCell(i[f]);return{data:h,rowHeights:c.clone(k),colWidths:c.clone(j)}},_toEditorCell:function(a){var b=c.omit(a,f),g={value:a[d],styles:b};return c.each(e,function(b){var c=a[b];null!=c&&(g[b]=c)}),g},toOutData:function(a){if(a&&a.table){var d,e,f=this,g=a.table,h={},i=g.rowHeights.length,j=g.colWidths.length,k=[];for(d=0;i>d;++d)for(e=0;j>e;e++)k.push(f._cellOut(g.data[d][e]));return h[b.TABLE.CELLS]=k,h[b.TABLE.COLUMN_WIDTHS]=c.clone(g.colWidths),h[b.TABLE.ROW_HEIGHTS]=c.clone(g.rowHeights),h}},_cellOut:function(a){if(!a)return{};var b=c.clone(a.styles);return b[d]=a.value,c.each(e,function(c){var d=a[c];null!=d&&(b[c]=d)}),b}}}({}),yne_ytable_tools_core_Class=function(a){function b(a){var b=this;b.options=c.extend({},a),b.initialize.apply(b,arguments)}var c=yne_ytable_tools_core_underscore,d=function(a,b){var d,e,f=this;return d=a&&c.has(a,"constructor")?a.constructor:function(){return f.apply(this,arguments)},c.extend(d,f,b),e=function(){this.constructor=d},e.prototype=f.prototype,d.prototype=new e,a&&c.extend(d.prototype,a),d.__super__=f.prototype,d};return b.prototype.initialize=function(){},b.extend=d,b}({}),yne_ytable_tools_core_Events=function(a){var b,c=yne_ytable_tools_core_underscore,d=Array.prototype.slice,e=/\s+/,f=function(a,b,c,d){var f,g,h;if(!c)return!0;if(e.test(c)){for(f=c.split(e),h=f.length,g=0;h>g;g++)a[b].apply(a,[f[g]].concat(d));return!1}return!0},g=function(a,b){var c,d=-1,e=a.length,f=b[0],g=b[1],h=b[2];switch(b.length){case 0:for(;++d<e;)(c=a[d]).callback.call(c.ctx);return;case 1:for(;++d<e;)(c=a[d]).callback.call(c.ctx,f);return;case 2:for(;++d<e;)(c=a[d]).callback.call(c.ctx,f,g);return;case 3:for(;++d<e;)(c=a[d]).callback.call(c.ctx,f,g,h);return;default:for(;++d<e;)(c=a[d]).callback.apply(c.ctx,b)}},h={listenTo:"on",listenToOnce:"once"};return b={on:function(a,b,c){var d=this;return f(d,"on",a,[b,c])&&b?(d.__events||(d.__events={}),d.__events[a]||(d.__events[a]=[]),d.__events[a].push({callback:b,context:c,ctx:c||d}),d):d},once:function(a,b,d){var e,g=this;return f(g,"once",a,[b,d])&&b?(e=c.once(function(){g.off(a,e),b.apply(g,arguments)}),e._callback=b,g.on(a,e,d)):g},off:function(a,b,d){var e,g,h,i,j,k,l,m,n=this;if(!n.__events||!f(n,"off",a,[b,d]))return n;if(!a&&!b&&!d)return n.__events={},n;for(i=a?[a]:c.keys(n.__events),j=0,k=i.length;k>j;j++)if(a=i[j],h=n.__events[a]){if(n.__events[a]=e=[],b||d)for(l=0,m=h.length;m>l;l++)g=h[l],(b&&b!==g.callback&&b!==g.callback._callback||d&&d!==g.context)&&e.push(g);e.length||delete n.__events[a]}return n},trigger:function(a){var b,c,e,h=this;return h.__events?(b=d.call(arguments,1),f(h,"trigger",a,b)?(c=h.__events[a],e=h.__events.all,c&&g(c,b),e&&g(e,arguments),h):h):h},stopListening:function(a,b,c){var d,e,f=this,g=f.__listeners;if(!g)return f;d=!b&&!c,"object"==typeof b&&(c=f),a&&((g={})[a.__listenerId]=a);for(e in g)g[e].off(b,c,f),d&&delete f.__listeners[e];return f}},c.each(h,function(a,d){b[d]=function(b,d,e){var f,g,h=this;return f=h.__listeners||(h.__listeners={}),g=b.__listenerId||(b.__listenerId=c.uniqueId("l")),f[g]=b,"object"==typeof d&&(e=h),b[a](d,e,h),h}}),b.bind=b.on,b.unbind=b.off,b}({}),yne_ytable_tools_core_EventClass=function(a){var b=yne_ytable_tools_core_Class,c=yne_ytable_tools_core_Events;return b.extend(c)}({}),yne_ytable_tools_mvc_Backbone=function(a){var b=yne_ytable_tools_core_console,c=yne_ytable_tools_jq_jquery,d=window.Backbone;return d?(b.EXPORTS.backbone===!1&&d.noConflict&&(d=d.noConflict(),d.$=c),d):void b.error("no Backbone library","mvc/backbone.js")}({}),yne_ytable_editor_views_ContainerView=function(a){var b=yne_ytable_tools_mvc_Backbone,c=yne_ytable_tools_core_underscore;return b.View.extend({
className:"container",isContainer:!0,initialize:function(a){var b=this;b.editor=a.editor,b.subviews=[]},addView:function(a){var b=this;b.subviews.push(a),a.parentView=b,b.rendered&&(b.el.appendChild(a.el),a.render())},render:function(){var a=this;c.each(a.subviews,function(b){a.el.appendChild(b.el),b.render()}),a.rendered=!0}})}({}),yne_ytable_templates_jst=function(a){var b=yne_ytable_tools_web_console,c=this;return{getTemplate:function(a,d){var e="ytable/"+a+"/"+d,f=c.JST[e];return f||b.error("JST has no template: "+e),f},render:function(a,c,d){var e=this.getTemplate(a,c);return e?e(d):void b.error("no tempalte: templates"+a+"/"+c+".jst","template/template.js")}}}({}),yne_ytable_editor_views_ToolbarView=function(a){var b=yne_ytable_editor_views_ContainerView,c=yne_ytable_templates_jst;return b.extend({tagName:"div",className:"toolbar-wrapper",events:{mousedown:"_onMouseDown"},template:c.getTemplate("editor","toolbar"),initialize:function(a){var b=this;b.constructor.__super__.initialize.apply(b,arguments),b.editor=a.editor,b.options=a,b._floating=a.floating},render:function(){var a,b=this,c=b.el;b.options.floating&&(a=b.$el.outerHeight(),b.$el.css({position:"absolute",top:0-a})),b.options.showAtInit&&b.$el.show(),c.innerHTML=b.template(),b.sentinel=c.querySelector(".sentinel"),b.toolbarEl=c.querySelector(".toolbar"),b.constructor.__super__.render.apply(b,arguments)},addView:function(a){var b=this;b.subviews.push(a),a.parentView=b,b.rendered&&(a.render(),b.toolbarEl.insertBefore(a.el,b.sentinel),b.options.floating&&b.$el.css("top",0-b.$el.outerHeight()))},isFloating:function(){return this.options.floating===!0},_onMouseDown:function(a){a.preventDefault(),a.stopPropagation()}})}({}),yne_ytable_editor_views_FreezeBarView=function(a){var b=yne_ytable_tools_mvc_Backbone,c=yne_ytable_tools_core_underscore;return b.View.extend({tagName:"div",className:"freeze-bar",initialize:function(a){var b=this;b.editor=a.editor,c.bindAll(b,"onMouseDown"),b.el.addEventListener("mousedown",b.onMouseDown)},render:function(){},onMouseDown:function(){var a=this,b=a.editor,c=a.editor.view.tableView.tableEditView,d=b.getSelection();d.selectAll(),window.setTimeout(function(){c.focus()},0)}})}({}),yne_ytable_editor_utils_Draggable=function(a){var b=yne_ytable_tools_core_EventClass,c=yne_ytable_tools_core_underscore;return b.extend({initialize:function(a){c.bindAll(this,"onMouseDown","onMouseMove","onMouseUp"),this.el=a.el,this.disableDocSelection=a.disableDocSelection===!0,this.document=this.el.ownerDocument,this.makeDraggable()},makeDraggable:function(){var a=this,b=this.el;b.addEventListener("mousedown",this.onMouseDown),a._setUserSelect(b,"none")},_getUserSelect:function(a){return a.style.webkitUserSelect||a.style.mozUserSelect||a.style.msUserSelect||a.style.userSelect||""},_setUserSelect:function(a,b){a.style.webkitUserSelect=b,a.style.mozUserSelect=b,a.style.msUserSelect=b,a.style.userSelect=b},onMouseDown:function(a){if(1===a.which){var b=this,c=this.el,d=this.document;c.setCapture&&c.setCapture(),d.addEventListener("mousemove",this.onMouseMove),d.addEventListener("mouseup",this.onMouseUp),b.disableDocSelection&&(b._backupDocUserSelect=b._getUserSelect(d.body),b._setUserSelect(d.body,"none")),this.trigger("dragStart",a)}},onMouseMove:function(a){1===a.which&&this.trigger("dragging",a)},cancel:function(){var a=this,b=this.el,c=this.document;b.releaseCapture&&b.releaseCapture(),c.removeEventListener("mousemove",this.onMouseMove),c.removeEventListener("mouseup",this.onMouseUp),a.disableDocSelection&&a._setUserSelect(c.body,a._backupDocUserSelect)},onMouseUp:function(a){1===a.which&&(this.cancel(),this.trigger("dragEnd",a))}})}({}),yne_ytable_editor_views_ColumnHeaderView=function(a){var b=yne_ytable_tools_mvc_Backbone,c=yne_ytable_editor_utils_Draggable,d=yne_ytable_tools_core_underscore,e=yne_ytable_tools_jq_jquery,f=yne_ytable_templates_jst,g=yne_ytable_editor_config_defaults,h=yne_ytable_editor_utils_TableUtils;return b.View.extend({tagName:"div",className:"column-header",template:f.getTemplate("editor","col_header"),cellTemplate:f.getTemplate("editor","col_header_cell"),initialize:function(a){var b=this;b.editor=a.editor,b.draggable=new c({el:b.el}),b._initEvents()},_initEvents:function(){var a=this,b=a.draggable;d.bindAll(a,"onDragStart","onDragging","onDragEnd","onTableExtend","onColumnInserted","onColumnDeleted","onSelectionChange","onDblClick","onColumnWidthSet"),b.on("dragStart",a.onDragStart),b.on("dragging",a.onDragging),b.on("dragEnd",a.onDragEnd),a.editor.onSelection("change",a.onSelectionChange),a.editor.on("extend",a.onTableExtend),a.editor.onTable("columnInserted",a.onColumnInserted),a.editor.onTable("columnDeleted",a.onColumnDeleted),a.editor.onTable("columnWidthSet",a.onColumnWidthSet),a.el.addEventListener("dblclick",a.onDblClick,!1)},render:function(){var a=this;a.el.innerHTML=a.template(),a.tableEl=a.el.querySelector("table")},renderColumnHeader:function(){var a,b,c=this,d=c.editor.getTable(),e=d.getColumnCount(),f=c.tableEl,g=f.rows[0],h=g.ownerDocument;for(c.rendered=!0,g.innerHTML="",a=0;e>a;++a)b=h.createElement("th"),b.innerHTML=c.cellTemplate(),g.appendChild(b),c.setupColumn(a);c.onSelectionChange()},setupColumn:function(a,b){if(this.rendered){var c,f=this,g=f.tableEl.rows[0],h=g.cells[a],i=f.editor.getTable();h&&(b|=i.getColumnWidth(a),c=b+1,d.defer(function(){e(h).outerWidth(c),f.setupColumnName(a)}))}},getColResizeLine:function(){return this.editor.view.tableView.columnResizeLine},fitWidth:function(a){var b=this,c=b.editor,e=c.getTable(),f=e.getRowCount(),i=0,j=c.getCommandHelper(),k=4;d.times(f,function(b){var c=e.getStylesAt(b,a),f=c.fontName||g.fontName,j=c.fontSize||g.fontSize,k="true"===c.bold,l="true"===c.italic,m=e.getValueAt(b,a);d.each(m.split(/[\r\n]/),function(a){var b=h.measureText(a,{fontSize:j,fontName:f,isBold:k,isItalic:l}).width;i=Math.max(i,b)})}),i>0&&j.setColumnWidth(a,i+k)},onDblClick:function(a){if(h.isColResizer(a.target)){var b=this,c=a.target,d=h.findParent(c,"th"),e=d.cellIndex,f=b.editor,g=f.getSelection().getFirstRange(),i=g.getRect(),j=f.getCommander();j.beginCompond(),(g.type===g.TYPE.COLUMNS||g.type===g.TYPE.ALL)&&i.left<=e&&i.right>e?g.forEachColumn(function(a){b.fitWidth(a)}):b.fitWidth(e),j.endCompond(),b.getColResizeLine().hide()}},onDragStart:function(a){var b=this;h.isColResizer(a.target)?b.onResizeStart(a):h.isColHeader(a.target)&&b.onSelectStart(a)},onResizeStart:function(a){if(!this.editor.locked){var b=this,c=a.target,d=h.findParent(c,"th"),e=d.cellIndex,f=b.getColResizeLine(),g=a.clientX,i=b.editor.view.tableView.el.getBoundingClientRect().left;b.dragInfo={mode:"resize",col:e,initX:g,initWidth:d.offsetWidth,headerCell:d,leftDiff:i},f.show(),f.moveTo(g-i),b.isFitSize=!0}},onSelectStart:function(a){var b,c,d=this,e=d.editor,f=e.getSelection(),g=h.findParent(a.target,"th"),i=g.cellIndex,j=f.getActiveCell();0>i||(a.shiftKey?(b=e.createRange({left:Math.min(i,j.col),right:Math.max(i,j.col)+1}),f.selectRange(b),c=j.col):(f.selectColumn(i),c=i),d.dragInfo={mode:"select",startCol:c,lastX:a.x})},onDragging:function(a,b){var c=this,d=c.dragInfo;d&&("resize"===d.mode?c.onResizing(a,b):"select"!==d.mode||b||c.onSelecting(a,b))},onResizing:function(a,b){if(!this.editor.locked){var c,d,e,f,g=this,h=g.dragInfo,i=h.col,j=h.initX,k=a.clientX-j,l=g.editor,m=h.initWidth,n=m+k,o=g.getColResizeLine();if(10>n&&(n=10),b){if(g.isFitSize)return;c=l.getCommandHelper(),d=l.getCommander(),e=l.getSelection().getFirstRange(),f=e.getRect(),d.beginCompond(),(e.type===e.TYPE.COLUMNS||e.type===e.TYPE.ALL)&&f.left<=i&&f.right>i?e.forEachColumn(function(a){c.setColumnWidth(a,n)}):c.setColumnWidth(i,n),d.endCompond(),o.hide()}else o.moveTo(j-h.leftDiff+n-m);g.isFitSize=!1}},onSelecting:function(a){var b,c,d,e,f=this,g=f.editor,i=g.view.tableView.tableEditView,j=g.getSelection(),k=f.dragInfo;h.isColHeader(a.target)?(b=h.findParent(a.target,"th"),c=b.cellIndex):h.isTableCell(a.target)?(b=a.target,c=b.cellIndex):c=-1,c>=0&&(d=k.startCol,j.selectRange(g.createRange({left:Math.min(c,d),right:Math.max(c,d)+1})),i.focus()),e=document.documentElement.clientWidth,a.x<150&&a.x-k.lastX<0?i.scrollBy(-20,0):a.x>e-150&&a.x-k.lastX>0&&i.scrollBy(20,0),k.lastX=a.x},onDragEnd:function(a){this.onDragging(a,!0),this.getColResizeLine().hide(),delete this.dragInfo},onTableExtend:function(){var a=this;d.defer(function(){a.renderColumnHeader()})},onTableScroll:function(a,b){var c=this;c.el.style.marginLeft=-b+"px"},onColumnWidthSet:function(a,b,c){var d=this;d.setupColumn(b,c)},setupColumnName:function(a){var b=this,c=b.tableEl.rows[0],d=c.cells[a];d&&(d.querySelector(".col-name").innerText=h.getColumnName(a))},onColumnInserted:function(a,b){var c,e,f,g=this,h=1,i=g.tableEl,j=g.editor.view.tableView.tableEditView,k=i.rows[0];d(h).times(function(a){e=document.createElement("th"),e.innerHTML=g.cellTemplate(),k.insertBefore(e,k.cells[b]),d.defer(function(){g.setupColumn(b+a)})}),d.delay(function(){for(f=j.getColumnCount();k.cells.length>f;)k.removeChild(k.lastChild);for(c=b+h;f>c;++c)g.setupColumnName(c);g.onSelectionChange()},100)},onColumnDeleted:function(){var a=this;d.defer(function(){a.renderColumnHeader()})},onSelectionChange:function(a){a||(a=this.editor.getSelection());var b=this,c=b.tableEl,e=c.rows[0],f=d.toArray(e.querySelectorAll(".active"));d.each(f,function(a){a.classList.remove("active")}),a.forEachRange(function(a){(a.type===a.TYPE.NORMAL||a.type===a.TYPE.COLUMNS)&&a.forEachColumn(function(a){var b=e.cells[a];b&&b.classList.add("active")})})}})}({}),yne_ytable_editor_views_HorizontalView=function(a){var b=yne_ytable_editor_views_ContainerView,c=yne_ytable_editor_views_ColumnHeaderView,d=yne_ytable_tools_core_underscore;return b.extend({tagName:"div",className:"horizontal-bar",initialize:function(a){var b=this;b.constructor.__super__.initialize.apply(b,arguments),b.editor=a.editor,b._initSubviews(),b._initEvents()},_initSubviews:function(){var a=this;a.columnHeaderView=new c({editor:a.editor}),a.addView(a.columnHeaderView)},_initEvents:function(){var a=this;d.bindAll(a,"onTableScroll")},render:function(){var a=this;a.constructor.__super__.render.apply(a,arguments)},onTableReady:function(a){var b=this;b.columnHeaderView.renderColumnHeader(a)},onTableScroll:function(a,b){var c=this;c.columnHeaderView.onTableScroll(a,b)}})}({}),yne_ytable_editor_views_RowHeaderView=function(a){var b=yne_ytable_tools_mvc_Backbone,c=yne_ytable_editor_utils_Draggable,d=yne_ytable_tools_core_underscore,e=yne_ytable_editor_config_defaults,f=yne_ytable_templates_jst,g=yne_ytable_editor_utils_TableUtils,h=e.rowPageLength;return b.View.extend({tagName:"div",className:"row-header",template:f.getTemplate("editor","row_header"),cellTemplate:f.getTemplate("editor","row_header_cell"),initialize:function(a){var b=this;b.editor=a.editor,b.draggable=new c({el:b.el}),b._initEvents()},_initEvents:function(){var a=this,b=a.editor,c=a.draggable;d.bindAll(a,"onCommandExec","onDragStart","onDragging","onDragEnd","onClick","onTableExtend","onRowInserted","onRowDeleted","onSelectionChange","onDblClick"),c.on("dragStart",a.onDragStart),c.on("dragging",a.onDragging),c.on("dragEnd",a.onDragEnd),b.onCommander("commandExec",a.onCommandExec),b.onSelection("change",a.onSelectionChange),a.el.addEventListener("click",a.onClick),a.editor.on("extend",a.onTableExtend),a.editor.onTable("rowInserted",a.onRowInserted),a.editor.onTable("rowDeleted",a.onRowDeleted),a.el.addEventListener("dblclick",a.onDblClick,!1)},render:function(){var a=this;a.el.innerHTML=a.template(),a.tableEl=a.el.querySelector("table")},_insertNewHeader:function(a){var b=this,c=b.tableEl,d=c.insertRow(a),e=d.insertCell(0);e.innerHTML=b.cellTemplate()},renderRowHeader:function(){var a,b=this,c=b.editor.view.tableView.tableEditView,d=b.tableEl,e=b.editor.getTable(),f=e.getRowCount();for(b.rendered=!0,d.innerHTML="",a=0;f>a;++a)b._insertNewHeader(a),b.setupRow(a);b.onSelectionChange(),c.off("validationChanged"),c.on("validationChanged",function(a,c){c&&b.renderPage(a)})},renderPage:function(a){var b=this,c=b.editor.getTable().getRowCount(),d=a*h,e=Math.min(d+h,c);g.forRange(d,e,function(a){b.setupRow(a)})},getRowResizeLine:function(){return this.editor.view.tableView.rowResizeLine},setupRow:function(a){var b,c=this,e=c.tableEl,f=e.rows[a],h=c.editor.view.tableView.tableEditView,i=h.getFirstUnmergeCellElementAtRow(a);i&&(f||(g.forRange(e.rows.length,a+1,function(a){c._insertNewHeader(a)}),f=e.rows[a]),b=i.offsetHeight,d.defer(function(){f.style.height=b+"px",f.querySelector(".row-name").innerText=g.getRowName(a)}))},onCommandExec:function(a,b){var c=this,d=b.getRange(c.editor),e=c.editor.getTable();d&&"DeleteRow"!==b.name&&d.forEachRow(function(a){a>=e.MAX_ROW_COUNT||c.setupRow(a)})},fitHeight:function(a){var b=this,c=b.editor,d=c.getCommandHelper();d.setRowHeight(a,e.rowHeight)},onDblClick:function(a){if(g.isRowResizer(a.target)){var b=this,c=a.target,d=g.findParent(c,"tr"),e=d.rowIndex,f=b.editor.getSelection().getFirstRange(),h=f.getRect(),i=b.editor.getCommander();i.beginCompond(),(f.type===f.TYPE.ROWS||f.type===f.TYPE.ALL)&&h.top<=e&&h.bottom>e?f.forEachRow(function(a){b.fitHeight(a)}):b.fitHeight(e),i.endCompond(),b.getRowResizeLine().hide()}},onDragStart:function(a){var b=this;g.isRowResizer(a.target)?b.onResizeStart(a):g.isRowHeader(a.target)&&b.onSelectStart(a)},onResizeStart:function(a){if(!this.editor.locked){var b=this,c=a.target,d=g.findParent(c,"tr"),e=d.rowIndex,f=d.cells[0],h=b.getRowResizeLine(),i=a.clientY,j=b.editor.view.tableView.el.getBoundingClientRect().top;b.dragInfo={mode:"resize",row:e,initY:i,headerCell:f,initHeight:f.offsetHeight,topDiff:j},h.show(),h.moveTo(i-j),b.isFitSize=!0}},onSelectStart:function(a){var b,c,d=this,e=d.editor,f=e.getSelection(),h=g.findParent(a.target,"tr"),i=h.rowIndex,j=f.getActiveCell();0>i||(a.shiftKey?(b=e.createRange({top:Math.min(i,j.row),bottom:Math.max(i,j.row)+1}),f.selectRange(b),c=j.row):(f.selectRow(i),c=i),d.dragInfo={mode:"select",startRow:c,lastY:a.y})},onDragging:function(a,b){var c=this,d=c.dragInfo;d&&("resize"===d.mode?c.onResizing(a,b):"select"!==d.mode||b||c.onSelecting(a,b))},onResizing:function(a,b){if(!this.editor.locked){var c,d,e,f,g=this,h=g.dragInfo,i=h.row,j=h.initY,k=a.clientY-j,l=g.editor,m=h.initHeight,n=m+k,o=g.getRowResizeLine();if(10>n&&(n=10),b){if(g.isFitSize)return;c=l.getCommandHelper(),d=l.getCommander(),e=l.getSelection().getFirstRange(),f=e.getRect(),d.beginCompond(),(e.type===e.TYPE.ROWS||e.type===e.TYPE.ALL)&&f.top<=i&&f.bottom>i?e.forEachRow(function(a){c.setRowHeight(a,n)}):c.setRowHeight(i,n),d.endCompond(),o.hide()}else o.moveTo(j-h.topDiff+n-m);g.isFitSize=!1}},onSelecting:function(a){var b,c,d,e,f=this,h=f.editor,i=h.view.tableView.tableEditView,j=h.getSelection(),k=f.dragInfo,l=k.startRow;g.isRowHeader(a.target)?(b=g.findParent(a.target,"tr"),d=b.rowIndex):g.isTableCell(a.target)?(c=g.findParent(a.target,"td"),d=i.getRowIndex(c)):d=-1,d>=0&&(j.selectRange(h.createRange({top:Math.min(d,l),bottom:Math.max(d,l)+1})),i.focus()),e=document.documentElement.clientHeight,a.y<200&&a.y-k.lastY<0?i.scrollBy(0,-10):a.y>e-150&&a.y-k.lastY>0&&i.scrollBy(0,10),k.lastY=a.y},onDragEnd:function(a){this.onDragging(a,!0),this.getRowResizeLine().hide(),delete this.dragInfo},onClick:function(a){var b=this,c=a.target;g.findParent(c,".add-row-button")&&b.onAddRowClick(a)},onAddRowClick:function(){var a=this,b=a.editor.view.tableView.tableEditView;b.addRows(10)},onTableExtend:function(a){var b,c=this,d=c.tableEl,e=d.rows.length;for(b=e;a>=b;++b)c._insertNewHeader(b),c.setupRow(b)},onTableScroll:function(a){var b=this;b.el.style.marginTop=-a+"px"},onRowInserted:function(a,b){if(this.rendered){var c,d=this,e=1,f=b+e;for(c=b;f>c;++c)d._insertNewHeader(c)}},onRowDeleted:function(a,b){if(this.rendered){var c,d=this,e=1,f=d.tableEl,g=b+e;for(c=b;g>c;++c)f.deleteRow(b)}},onSelectionChange:function(a){a||(a=this.editor.getSelection());var b=this,c=b.tableEl,e=d.toArray(c.querySelectorAll(".active"));d.each(e,function(a){a.classList.remove("active")}),a.forEachRange(function(a){(a.type===a.TYPE.NORMAL||a.type===a.TYPE.ROWS)&&a.forEachRow(function(a){var b=c.rows[a];b&&b.classList.add("active")})})}})}({}),yne_ytable_editor_views_VerticalView=function(a){var b=yne_ytable_editor_views_ContainerView,c=yne_ytable_editor_views_RowHeaderView,d=yne_ytable_tools_core_underscore;return b.extend({tagName:"div",className:"vertical-bar",initialize:function(a){var b=this;b.constructor.__super__.initialize.apply(b,arguments),b.editor=a.editor,b._initSubviews(),b._initEvents()},_initSubviews:function(){var a=this;a.rowHeaderView=new c({editor:a.editor}),a.addView(a.rowHeaderView)},_initEvents:function(){var a=this;d.bindAll(a,"onTableScroll")},render:function(){var a=this;a.constructor.__super__.render.apply(a,arguments)},onTableReady:function(a){var b=this;b.rowHeaderView.renderRowHeader(a)},onTableScroll:function(a,b){var c=this;c.rowHeaderView.onTableScroll(a,b)}})}({}),yne_ytable_editor_views_SelectionView=function(a){var b=yne_ytable_tools_mvc_Backbone,c=yne_ytable_tools_core_underscore,d=yne_ytable_tools_jq_jquery,e=yne_ytable_tools_web_console,f=10,g=b.View.extend({tagName:"div",className:"selection-layer",activeCellClassName:"selection-active-cell",rangeClassName:"selection-range",initialize:function(a){var b=this;b.editor=a.editor,b.tableEditView=a.tableEditView,b._initEvents()},_initEvents:function(){var a=this;c.bindAll(a,"onSelectionReady","onActiveCellChanged","onRangeChanged","onCommandExec","onColumnWidthSet","onRowHeightSet"),a.editor.onSelection("activeCellChanged",a.onActiveCellChanged),a.editor.onSelection("rangeChanged",a.onRangeChanged),a.editor.onCommander("commandExec",a.onCommandExec),a.editor.onTable("columnWidthSet",a.onColumnWidthSet),a.editor.onTable("rowHeightSet",a.onRowHeightSet)},render:function(){var a=this;a.activeCellEl=a.el.querySelector("."+a.activeCellClassName)},redrawActiveCell:function(a){a||(a=this.editor.getSelection());var b,c=this,e=a.getActiveCell(),f=c.tableEditView,g=f.getCellElementAt(e.row,e.col),h=c.activeCellEl;g&&h&&(b=f.getBoundingRect(g),d(h).css({left:b.left,top:b.top}).outerWidth(b.width).outerHeight(b.height))},redrawRanges:function(a){a||(a=this.editor.getSelection());var b,c,d,e=this,g=a.getRanges(),h=e.el.querySelectorAll("."+e.rangeClassName),i=Math.min(f,g.length);for(d=0;i>d;++d)b=g[d],c=h[d],c.style.display="block",e.drawRange(b,c);for(;f>d;++d)c=h[d],c.style.display="none"},drawRange:function(a,b){if(a&&a.isValid()){e.log("draw range: "+a);var f,g,h,i,j,k,l,m,n,o,p,q,r=this,s=r.tableEditView,t={row:-1,col:-1},u={row:-1,col:-1},v=s.getBoundingRect(s.tableEl);if(a.type===a.TYPE.NORMAL){try{o=s.getCellElementAt(a.top,a.left)}catch(w){}o&&(p=s.getBoundingRect(o),j=p.left);try{o=s.getCellElementAt(a.bottom-1,a.right-1)}catch(w){}o&&(p=s.getBoundingRect(o),k=p.right),t={row:a.top,col:a.left},u={row:a.bottom-1,col:a.right-1}}else if(a.type===a.TYPE.COLUMNS)l=0,m=v.bottom,j=(s.getColumnRect(a.left)||{}).left,k=(s.getColumnRect(a.right-1)||{}).right;else if(a.type===a.TYPE.ROWS)f=s.getFirstUnmergeCellElementAtRow(a.top),h=s.getBoundingRect(f),q=s.getFirstCellElementInView(),q=s.getBoundingRect(q),h={left:q.left,top:h.top},u={row:a.bottom-1,col:s.getColumnCount()-1};else{if(a.type!==a.TYPE.ALL)return void window.assert(!1);l=0,m=v.bottom,j=0,k=v.right}f||(f=s.getCellElementAt(t.row,t.col)),g=s.getCellElementAt(u.row,u.col),f?(h||(h=s.getBoundingRect(f)),c.isNumber(j)||(j=h.left),c.isNumber(l)||(l=h.top)):(n=s.getBoundingRect(b),c.isNumber(j)||(j=n.left),c.isNumber(l)||(l=n.top)),g?(i=s.getBoundingRect(g),c.isNumber(k)||(k=i.right),c.isNumber(m)||(m=i.bottom)):(n||(n=s.getBoundingRect(b)),c.isNumber(k)||(k=n.right-1),c.isNumber(m)||(m=n.bottom-1)),d(b).css({left:j,top:l}).outerWidth(k-j).outerHeight(m-l)}},onSelectionReady:function(a){var b=this;b.redrawActiveCell(a),b.redrawRanges(a)},onActiveCellChanged:function(a){var b=this;b.redrawActiveCell(a)},onRangeChanged:function(a){var b=this;b.redrawRanges(a)},onCommandExec:function(){var a=this;a.redrawActiveCell(),a.redrawRanges()},onColumnWidthSet:function(){var a=this;a.redrawActiveCell(),a.redrawRanges()},onRowHeightSet:function(){var a=this;a.redrawActiveCell(),a.redrawRanges()},show:function(){var a=this;d(a.el).show()},hide:function(){var a=this;d(a.el).hide()}});return g}({}),yne_ytable_editor_views_ClipboardView=function(a){var b=yne_ytable_tools_mvc_Backbone,c=yne_ytable_tools_core_underscore,d=b.View.extend({tagName:"div",className:"clipboard-layer",initialize:function(a){var b=this;b.editor=a.editor,b.tableEditView=a.tableEditView,b._initEvents()},_initEvents:function(){var a=this,b=a.editor,d=b.getClipboard();c.bindAll(a,"onClipboardChanged"),b.onCommander("commandExec",a.onClipboardChanged),b.onTable("columnWidthSet",a.onClipboardChanged),b.onTable("rowHeightSet",a.onClipboardChanged),a.tableEditView.on("scroll",a.onClipboardChanged),d.on("change",a.onClipboardChanged)},render:function(){var a=this;a.hide()},drawRange:function(a,b){if(a&&a.isValid()){var d,e,f,g,h,i,j,k,l,m,n=this,o=n.tableEditView,p=o.selectionView,q={row:-1,col:-1},r={row:-1,col:-1},s=o.getBoundingRect(o.tableEl);if(a.equals(n.editor.getSelection().getFirstRange()))return d=p.el.querySelector("."+p.rangeClassName),b.style.top=d.style.top,b.style.left=d.style.left,b.style.width=d.style.width,void(b.style.height=d.style.height);if(a.type===a.TYPE.NORMAL)q={row:a.top,col:a.left},r={row:a.bottom-1,col:a.right-1};else if(a.type===a.TYPE.COLUMNS)k=0,l=s.bottom,i=o.getColumnRect(a.left).left,j=o.getColumnRect(a.right-1).right;else if(a.type===a.TYPE.ROWS)q={row:a.top,col:0},r={row:a.bottom-1,col:o.getColumnCount()-1};else{if(a.type!==a.TYPE.ALL)return void window.assert(!1);k=0,l=s.bottom,i=0,j=s.right}e=o.getCellElementAt(q.row,q.col),f=o.getCellElementAt(r.row,r.col),e?(g=o.getBoundingRect(e),i=g.left,k=g.top):(m=o.getBoundingRect(b),c.isNumber(i)||(i=m.left),c.isNumber(k)||(k=m.top)),f?(h=o.getBoundingRect(f),j=h.right,l=h.bottom):(m||(m=o.getBoundingRect(b)),c.isNumber(j)||(j=m.right-3),c.isNumber(l)||(l=m.bottom-3)),b.style.left=i+"px",b.style.top=k+"px",b.style.width=j-i-1+"px",b.style.height=l-k-1+"px"}},onClipboardChanged:function(){var a=this,b=a.editor,c=b.getClipboard(),d=c.range,e=a.el;d?(a.show(),a.drawRange(c.range,e)):a.hide(),"cut"===c.status?e.classList.add("cut"):e.classList.remove("cut")},show:function(){var a=this,b=a.el;b.style.display="block"},hide:function(){var a=this,b=a.el;b.style.display="none"}});return d}({}),yne_ytable_editor_views_CellEditorView=function(a){var b=yne_ytable_tools_mvc_Backbone,c=yne_ytable_tools_core_underscore,d=yne_ytable_editor_utils_TableUtils,e=yne_ytable_tools_web_console,f=b.View.extend({tagName:"div",className:"cell-edit",initialize:function(a){var b=this;b.editor=a.editor,b.tableEditView=a.tableEditView,c.bindAll(b,"onBoxKeyDown","onBoxBlur","onCopy","onPaste","onCut","onBarEditStart","onBarEditEnd","onBarEditing","onBarKeyDown","onRowInserted","onColumnInserted","onRowDeleted","onColumnDeleted"),b.editor.on("barEditStart",b.onBarEditStart),b.editor.on("barEditEnd",b.onBarEditEnd),b.editor.on("barEditing",b.onBarEditing),b.editor.on("barKeyDown",b.onBarKeyDown),b.editor.onTable("rowInserted",b.onRowInserted),b.editor.onTable("rowDeleted",b.onRowDeleted),b.editor.onTable("columnInserted",b.onColumnInserted),b.editor.onTable("columnDeleted",b.onColumnDeleted)},render:function(){var a=this;a.editBox=a.el.querySelector(".cell-edit-box"),a.editBox.addEventListener("keydown",a.onBoxKeyDown),a.editBox.addEventListener("blur",a.onBoxBlur),a.editBox.addEventListener("paste",a.onPaste),a.editBox.addEventListener("copy",a.onCopy),a.editBox.addEventListener("cut",a.onCut)},edit:function(a,b,d,f){if(e.log("cell edit "+a+","+b),!this.editor.locked){var g=this,h=g.tableEditView,i=h.getCellElementAt(a,b),j=h.getBoundingRect(i),k=g.editor,l=k.getTable(),m=l.getValueAt(a,b),n=m,o=l.getStylesAt(a,b);e.log("oldValue: "+m),c.isString(d)&&(n=d),c.isBoolean(f)||(f=!0),g.cellInfo={row:a,col:b},g.oldValue=m,g.setBoxValue(n),g.setBoxStyles(o),g.showBox(j,f),k.getClipboard().reset()}},showBox:function(a,b){var c=this,e=c.editBox,f=e.ownerDocument,g=f.createRange(),h=f.getSelection();a&&(e.style.left=a.left+"px",e.style.top=a.top+"px",e.style.minWidth=a.width-d.WIDTH_DIFF+"px",e.style.minHeight=a.height-d.HEIGHT_DIFF+"px"),e.style.display="block",b&&(g.setStart(e,e.childNodes.length),g.setEnd(e,e.childNodes.length),h.removeAllRanges(),h.addRange(g),e.focus()),c.isEditing=!0,c.trigger("show")},hideBox:function(){var a=this;a.editBox.style.display="none",a.isEditing=!1,a.trigger("hide")},setBoxStyles:function(a){var b=this,c=b.editBox;d.setElementStyles(c,a)},setBoxValue:function(a){var b=this;b.editBox.innerText=a},getBoxValue:function(){var a=this;return a.editBox.innerText.trim()},getBoxHtml:function(){var a=this;return a.editBox.innerHTML.trim()},confirm:function(){var a=this;a.editBox.blur()},cancel:function(){var a=this,b=a.editor,c=b.table,e=a.cellInfo,f=e.row,g=e.col,h=c.getValueAt(f,g),i=c.getStylesAt(f,g),j=a.tableEditView.getCellElementAt(f,g);b.trigger("inPlaceEditing",h),d.setElementText(j,h,i),a.canceled=!0,a.editBox.blur(),a.tableEditView.focus()},onBoxKeyDown:function(a,b){var d=this,e=d.tableEditView;switch(c.isBoolean(b)||(b=!0),a.keyCode){case 9:a.preventDefault(),a.stopPropagation(),b&&d.confirm(),a.shiftKey?e.selectToDirection("left"):e.selectToDirection("right");break;case 13:a.preventDefault(),a.stopPropagation(),a.altKey?document.execCommand("insertLineBreak"):(a.shiftKey?e.selectToDirection("up"):e.selectToDirection("down"),b&&d.confirm());break;case 27:a.preventDefault(),b&&d.cancel();break;default:b&&d.editor.trigger("inPlaceEditing",d.getBoxValue())}},onCopy:function(a){a.stopPropagation()},onCut:function(a){a.stopPropagation()},onPaste:function(a){var b,d,e=a.clipboardData,f=null,g=/<html[\S\s]*<\/html>/;-1!==c.indexOf(e.types,"text/html")?(d=e.getData("text/html"),d.match(g)&&(d=d.match(g)[0]),b=document.createElement("div"),b.innerHTML=d,d=b.innerHTML,document.execCommand("insertHTML",!1,d)):-1!==c.indexOf(e.types,"text/plain")&&(f=e.getData("text/plain"),document.execCommand("insertText",!1,f)),a.stopPropagation(),a.preventDefault()},onBoxBlur:function(){if(this.canceled)return delete this.canceled,delete this.cellInfo,void this.hideBox();if(this.cellInfo){var a=this,b=a.editor.getCommandHelper(),c=a.cellInfo.row,d=a.cellInfo.col,e=a.getBoxValue(),f=a.getBoxHtml();e!==a.oldValue&&b.setCellValueWithUriRec(c,d,e,f),a.hideBox(),delete a.cellInfo}},onBarEditStart:function(a){var b=this,c=b.editor,d=c.getSelection().getActiveCell();b.edit(d.row,d.col,a,!1),b.setBoxValue(a)},onBarEditEnd:function(a,b){var c=this;b||c.hideBox()},onBarEditing:function(a){var b=this;b.setBoxValue(a)},onBarKeyDown:function(a){var b=this;b.onBoxKeyDown(a,!1)},onRowInserted:function(){var a=this;a.cellInfo&&(a.cellInfo=a.editor.getSelection().getActiveCell())},onRowDeleted:function(){var a=this;a.cellInfo&&(a.cellInfo=a.editor.getSelection().getActiveCell())},onColumnInserted:function(){var a=this;a.cellInfo&&(a.cellInfo=a.editor.getSelection().getActiveCell())},onColumnDeleted:function(){var a=this;a.cellInfo&&(a.cellInfo=a.editor.getSelection().getActiveCell())}});return f}({}),yne_ytable_editor_views_HiddenInputView=function(a){var b=yne_ytable_tools_mvc_Backbone;return b.View.extend({tagName:"input",className:"hidden-input",initialize:function(a){var b,c=this;b=c.editor=a.editor,c._initEvents()},_initEvents:function(){window.addEventListener("load",this.focus.bind(this)),this.on("blur",this.onBlur.bind(this)),this.on("focus",this.onFocus.bind(this))},render:function(){},focus:function(){var a=this;a.el.focus()},blur:function(){var a=this;a.el.blur()},setPosition:function(a,b){var c=this,d=c.el;d.style.left=a+"px",d.style.top=b+"px"},setWidth:function(a){var b=this,c=b.el;c.style.width=a+"px"},bringToFront:function(){this.el.value="",this.el.style.zIndex=255},hideBehind:function(){this.el.style.zIndex=-255},on:function(a,b,c){var d=this;d.el.addEventListener(a,b,c)},onFocus:function(){var a=this.el;a.value=" "},onBlur:function(){var a=this;a.el.value=""}})}({}),yne_ytable_editor_utils_ScrollUtils=function(){var a=!0;return{enableTableEditScroll:function(){a=!0},disableTableEditScroll:function(){a=!1}}}(),yne_ytable_editor_utils_isRangeIn=function(a){var b=yne_ytable_tools_jq_jquery,c=yne_ytable_tools_web_dom_nodeType;return function(a,d){if(!a||!d)return!1;for(var e=a.startContainer;e&&c.isText(e);)e=e.parentNode;return e===d||b.contains(d,e)}}({}),yne_ytable_editor_core_HotkeyManager=function(a){var b=yne_ytable_tools_core_Class,c=yne_ytable_tools_core_underscore,d=["mod","alt","shift"],e=/Mac|iPod|iPhone|iPad/.test(navigator.platform)?"meta":"ctrl",f=function(a){if(c.isObject(a))return{mod:!!a.mod,alt:!!a.alt,shift:!!a.shift,key:c.isNumber(a.key)?a.key:(a.key||" ").charCodeAt(0)};a=a.trim().toLowerCase();var b=a.split(/[\s\+]+/),e={};return b.forEach(function(a){d.indexOf(a)>=0?e[a]=!0:e.key=a.charCodeAt(0)}),e},g=function(a){var b="";return d.forEach(function(c){a[c]&&(""!==b&&(b+="+"),b+=c)}),""!==b&&(b+="+"),b+=String.fromCharCode(a.key),b.toLowerCase()};return b.extend({initialize:function(){var a=this;a.hotkeyMap={}},register:function(a,b){if(b){var c=this,d=c.hotkeyMap,e=f(a);d[g(e)]=b}},call:function(a){var b={mod:a[e+"Key"],alt:a.altKey,shift:a.shiftKey,key:a.keyCode},c=g(b),d=this.hotkeyMap;d[c]&&(a.preventDefault(),d[c].apply())}},{MOD:e,MOD_KEY:e+"Key"})}({}),yne_ytable_editor_views_TableEditView=function(a){var b=yne_ytable_tools_core_underscore,c=yne_ytable_tools_jq_jquery,d=yne_ytable_editor_views_ContainerView,e=yne_ytable_editor_views_SelectionView,f=yne_ytable_editor_views_ClipboardView,g=yne_ytable_editor_views_CellEditorView,h=yne_ytable_editor_views_HiddenInputView,i=yne_ytable_templates_jst,j=yne_ytable_editor_utils_Draggable,k=yne_ytable_tools_web_dom_remove,l=yne_ytable_editor_utils_TableUtils,m=yne_ytable_editor_utils_ScrollUtils,n=yne_ytable_editor_config_defaults.rowPageLength,o=yne_ytable_tools_core_console,p=yne_ytable_editor_utils_isRangeIn,q=yne_ytable_editor_core_HotkeyManager,r=function(a){var b=c(a),d=c(".note-view-wrapper"),e=d.scrollTop(),f=e+d.height(),g=b.offset().top,h=g+b.height();return f>=h&&g>=e};return d.extend({tagName:"div",className:"table-edit",events:{"mouseenter td":"_onCellMouseEnter","mouseleave td":"_onCellMouseLeave"},template:i.getTemplate("editor","table_edit"),wrapperClassName:"table-wrapper",initialize:function(a){var b=this;b.editor=a.editor,b.draggable=new j({el:this.el}),b.cellEditorView=new g({editor:b.editor,tableEditView:b}),b.hiddenInputView=new h({editor:b.editor}),b._initEvents(),b.selectionView=new e({editor:b.editor,tableEditView:b}),b.clipboardView=new f({editor:b.editor,tableEditView:b}),b.subviews=[],b.addView(b.cellEditorView),b.addView(b.hiddenInputView),b.addView(b.selectionView),b.addView(b.clipboardView)},_initEvents:function(){var a=this,c=a.editor,d=a.draggable,e=a.hiddenInputView;b.bindAll(a,"onTableValueChanged","onTableStylesChanged","onTableAttributeChanged","onDragStart","onDragging","onDragEnd","onDblClick","onKeyDown","onCompositionStart","onCompositionEnd","onColumnWidthSet","onRowHeightSet","onColumnInserted","onRowInserted","onColumnDeleted","onRowDeleted","onCopy","onCut","onPaste","onBarEditStart","onCommandExec","onBarEditEnd"),a.onTableScroll=b.debounce(a.onTableScroll,80),a.triggerResize=b.debounce(a.triggerResize,100),a.onTableAttributeChanged=b.debounce(a.onTableAttributeChanged,80),c.onTable("valueChanged",a.onTableValueChanged),c.onTable("stylesChanged",a.onTableStylesChanged),c.onTable("attributeChanged",a.onTableAttributeChanged),c.onTable("columnWidthSet",a.onColumnWidthSet),c.onTable("rowHeightSet",a.onRowHeightSet),c.onTable("columnInserted",a.onColumnInserted),c.onTable("columnDeleted",a.onColumnDeleted),c.onTable("rowInserted",a.onRowInserted),c.onTable("rowDeleted",a.onRowDeleted),c.on("barEditStart",a.onBarEditStart),
c.on("barEditEnd",a.onBarEditEnd),d.on("dragStart",a.onDragStart),d.on("dragging",a.onDragging),d.on("dragEnd",a.onDragEnd),a.el.addEventListener("dblclick",a.onDblClick),a.editor.onCommander("commandExec",a.onCommandExec),e.on("keydown",a.onKeyDown),e.on("compositionstart",a.onCompositionStart),e.on("compositionend",a.onCompositionEnd),e.on("copy",a.onCopy),e.on("cut",a.onCut),e.on("paste",a.onPaste),a.cellEditorView.on("show",function(){a.selectionView.hide()}).on("hide",function(){a.selectionView.show()}),a._registerHotkeys()},_hotKeySetStyle:function(a){var b=this,c=b.editor,d=c.getSelection(),e=c.getCommandFactory(),f=c.getCommander();d.forEachRange(function(b){var c=e.create("SetRangeStyle",{range:b,style:{key:a,value:"true"}});c.query()&&(c.args.style.value="false"),f.exec(c,!0)})},_registerHotkeys:function(){var a,b=this,c=b.editor.getCommandHelper(),d=b.editor.getHotkeyManager();d.register({key:9},b.selectToDirection.bind(b,"right")),d.register({key:9,shift:!0},b.selectToDirection.bind(b,"left")),d.register({key:13},b.selectToDirection.bind(b,"down")),d.register({key:13,shift:!0},b.selectToDirection.bind(b,"up")),d.register({key:27},function(){b.editor.getClipboard().reset()}),a=function(){c.clearSelectionData()},d.register({key:8},a),d.register({key:46},a),d.register({key:113},function(){b.enterEditMode()}),d.register("Mod + A",function(){b.editor.getSelection().selectAll()}),d.register("Mod + S",function(){b.editor.trigger("save-content")}),d.register("Mod + B",function(){b._hotKeySetStyle("bold")}),d.register("Mod + I",function(){b._hotKeySetStyle("italic")}),d.register("Mod + U",function(){b._hotKeySetStyle("underline")})},render:function(){var a=this,b=a.el,c=a.wrapperClassName,d="."+c,e=a.selectionView,f=a.clipboardView,g=a.cellEditorView,h=a.hiddenInputView;b.innerHTML=a.template({className:c,selectionClassName:e.className,clipboardClassName:f.className,activeCellClassName:e.activeCellClassName,rangeClassName:e.rangeClassName,cellEditorClassName:g.className}),a.wrapper=b.querySelector(d),e.el=b.querySelector("."+e.className),e.render(),f.el=b.querySelector("."+f.className),f.render(),g.el=b.querySelector("."+g.className),g.render(),b.appendChild(h.el),h.render(),a.tableEl=b.querySelector("table"),a.colgroup=b.querySelector("colgroup"),a.editor.on("hashchange",function(){a.firstRenderTable()}),a.rendered=!0},dataPosition2ViewPosition:function(a,b){var c=this,d=c.editor.getTable();return d.toViewPosition(a,b)},getFirstCellElementInView:function(){var a=this,b=a.tableEl.tBodies[0],c=b.rows[0].cells[0];return c},getCellElementAt:function(a,b){if(!(0>a||0>b)){var c=this,d=c.dataPosition2ViewPosition(a,b),e=l.getPageInfo(d.row),f=e.page,g=e.pageRow,h=c.tableEl,i=h.tBodies[f];if(i&&!c.isPageInvalid(f))return i.rows[g]?i.rows[g].cells[d.col]:void 0}},getFirstUnmergeCellElementAtRow:function(a){if(!(0>a)){var b=this,c=b.editor.getTable(),d=c.getFirstUnmergeCellAtRow(a),e=l.getPageInfo(a),f=e.page,g=e.pageRow,h=b.tableEl,i=h.tBodies[f];if(i&&d&&!b.isPageInvalid(f))return i.rows[g]?i.rows[g].cells[d.col]:void 0}},ensureCellElementAt:function(a,b){if(!(0>a||0>b)){var c,d=this,e=l.getPageInfo(a),f=e.page,g=e.pageRow,h=d.tableEl,i=h.tBodies[f];if(i&&!d.isPageInvalid(f))return c=i.rows[g],c&&c.cells[b]||(d.renderTable(null,!0),c=i.rows[g],d.editor.trigger("extend",a,b)),c.cells[b]}},getRowElAt:function(a){var b,c=this,d=l.getPageInfo(a),e=d.page,f=d.pageRow,g=c.tableEl,h=g.tBodies[e];if(h&&!c.isPageInvalid(e))return b=h.rows[f]},getColElAt:function(a){if(!(0>a)){var b=this,c=b.colgroup,d=c.querySelectorAll("col");return d[a]}},getBoundingRect:function(a){var b=this,c=b.getBoundingClientRect(),d=a.getBoundingClientRect();return{left:d.left-c.left,top:d.top-c.top,right:d.right-c.left,bottom:d.bottom-c.top,width:d.width,height:d.height}},getBoundingClientRect:function(){var a=this,b=a.wrapper.getBoundingClientRect();return b},_getNextCellWithDirection:function(a,b,c){var d,e,f,g=this,h={up:[-1,0],down:[1,0],left:[0,-1],right:[0,1]},i=h[c];if(d=a+i[0],e=b+i[1],f=g.getCellElementAt(d,e),!f)if("left"===c){if(d=a-1,0>d)return;e=g.getColumnCount()-1,f=g.getCellElementAt(d,e)}else if("right"===c){if(d=a+1,d>g.getRowCount()-1)return;e=0,f=g.getCellElementAt(d,e)}return f?{row:d,col:e,cell:f}:void 0},selectToDirection:function(a,c,d){var e,f,g,h,i=this,j=i.editor,k=j.getSelection(),l=k.getActiveCell(),m=k.getFirstRange().getRect(),n=i.getRowCount(),p=i.getColumnCount();if(b.isBoolean(c)||(c=!1),c){switch(a){case"up":k.isCellAtRange("bottom")?m.top=Math.max(m.top-1,0):k.isCellAtRange("top")&&(m.bottom=m.bottom-1),e=j.createRange(m);break;case"down":k.isCellAtRange("top")?m.bottom=Math.min(m.bottom+1,n+1):k.isCellAtRange("bottom")&&(m.top=m.top+1),e=j.createRange(m);break;case"left":k.isCellAtRange("right")?m.left=Math.max(m.left-1,0):k.isCellAtRange("left")&&(m.right=m.right-1),e=j.createRange(m);break;case"right":k.isCellAtRange("left")?m.right=Math.min(m.right+1,p+1):k.isCellAtRange("right")&&(m.left=m.left+1),e=j.createRange(m);break;default:return}e&&k.selectRange(e)}else g=i._getNextCellWithDirection(l.row,l.col,a),g?(k.selectCell(g.row,g.col),f=g.cell,f.scrollIntoViewIfNeeded&&f.scrollIntoViewIfNeeded(),i.focusAtElement(f)):d===!0&&(h="up"===a||"left"===a,o.log("ytable editor trigger move-overflow"),i.editor.trigger("move-overflow",h))},resizeToWidth:function(a){var b=this;b.$el.outerWidth(a)},getViewHeight:function(){return this.$el.outerHeight(!0)+parseInt(this.$el.css("top"),10)},triggerResize:function(){var a=this,b=a.getViewHeight();a._viewHeight!==b&&(a.trigger("resize",b),a._viewHeight=b)},getTableWrapper:function(){return this.el.querySelector("."+this.wrapperClassName)},getRowCount:function(){return this.tableEl.rows.length},getColumnCount:function(){var a=this.tableEl.rows[0];return a?a.cells.length:this.editor.getTable().getColumnCount()},ensureTbody:function(a){var b,c,d=this,e=window.document,f=d.tableEl,g=f.tBodies,h=g.length;if(h>a)return g[a];for(b=h;a>=b;++b)c=e.createElement("tbody"),d.invalidateTbody(c),f.appendChild(c);return c},invalidatePage:function(a){var c=this,d=c.ensureTbody(a);c.invalidateTbody(d),b.defer(function(){c.trigger("validationChanged",a,!1)})},invalidateTbody:function(a){if(!a.classList.contains("invalid")){var b=a.offsetHeight;b>0&&(a.style.height=a.offsetHeight+"px"),a.classList.add("invalid"),a.innerHTML=""}},validatePage:function(a){var c=this,d=c.ensureTbody(a);c.validateTbody(d),b.defer(function(){c.trigger("validationChanged",a,!0)})},validateTbody:function(a){a.style.height="",a.classList.remove("invalid")},isPageInvalid:function(a){var b=this,c=b.ensureTbody(a);return c.classList.contains("invalid")},renderPage:function(a,b){var c,d,e,f,g=this,h=g.editor.getTable(),i=g.editor.hash,j=h.getRowCount(),k=Math.ceil(j/n);return a>=k?(c=g.tableEl.tBodies[a],c&&l.forRange(0,g.tableEl.tBodies.length-a,function(){do c=g.tableEl.lastElementChild,"TBODY"===c.nodeName&&g.tableEl.removeChild(c);while("TBODY"!==c.nodeName)}),!1):(d=h.getColumnCount(),c=g.ensureTbody(a),g.isInViewport(c)||c.previousElementSibling&&g.isInViewport(c.previousElementSibling)||c.nextElementSibling&&g.isInViewport(c.nextElementSibling)?(c.rows.length<n&&c.rows.length+a*n!==j&&(b=!0),(b||g.isPageInvalid(a))&&(g.validatePage(a),c.innerHTML="",e=a*n,f=Math.min(n,j-e),l.forRange(0,f,function(a){var b,f,j,k,m,n=e+a,o=c.insertRow(a),p=0;for(b=0;d>b;++b)h.isMergedCell(n,b)||(f=o.insertCell(p),p++,k=h.getAttributesAt(n,b),m=k.mergeWidth,m&&m>1&&f.setAttribute("colspan",m),m=k.mergeHeight,m&&m>1&&f.setAttribute("rowspan",m),j=h.getStylesAt(n,b),l.setBorder(g,n,b,j),l.setElementStyles(f,j,!0,i.user),l.setElementText(f,h.getValueAt(n,b),j,i.user));g.setRowHeight(n,h.getRowHeight(n))}).then(function(){var a,b,c=e+f;for(a=0;d>a;++a)h.isMergedCell(c,a)||(b=h.getStylesAt(c,a),l.setBorder(g,c,a,b))}).then(function(){var a=g.colgroup.querySelectorAll("col").length;g.renderColumns(a,d)}))):g.invalidatePage(a),!0)},isInViewport:function(a){var b=this.el,c=b.scrollTop,d=c+b.clientHeight,e=a.offsetTop,f=e+a.offsetHeight;return c>f||e>d?!1:!0},isPageInViewport:function(a){var b=this,c=b.ensureTbody(a);return b.isInViewport(c)},renderTable:function(a,c){a=a||this.editor.getTable();var d,e=this,f=a.getRowCount(),g=Math.ceil(f/n),h=e.tableEl,i=b.toArray(h.tBodies);for(d=i.length-1;d>=g;--d)k(i[d]);return e.ensureTbody(g-1),i=h.tBodies,l.forRange(0,g,function(a){e.renderPage(a,c)},1)},renderColumns:function(a,c){if(a=a||0,!(a>=c)){var d,e=this,f=e.editor.getTable(),g=f.getColumnCount(),h=e.colgroup,i=b.toArray(h.querySelectorAll("col"));for(c=c||g,d=a;c>d;++d)e.setColumnWidth(d,f.getColumnWidth(d));for(d=i.length-1;d>=g;--d)k(i[d])}},firstRenderTable:function(a){a=a||this.editor.getTable();var c,d=this,e=a.getRowCount(),f=Math.ceil(e/n),g=d.tableEl,h=b.toArray(g.tBodies),i=d.colgroup;for(c=h.length-1;c>=f;--c)k(h[c]);return d.ensureTbody(f-1),h=g.tBodies,l.chunkRange(0,f,function(a){d.renderPage(a,!0)},1).then(function(){i.innerHTML="",d.renderColumns()})},getTableElement:function(){return this.tableEl},ensureColEl:function(a){var b,c=this,d=c.getColumnCount(),e=Math.max(a+1,d),f=c.colgroup,g=e-f.querySelectorAll("col").length,h=c.getColElAt(a);if(h)return h;for(b=0;g>b;++b)f.appendChild(document.createElement("col"));return c.getColElAt(a)},addRows:function(a){var b=this,c=b.getRowCount(),d=b.getColumnCount(),e=c-1+a,f=d-1,g=b.editor.getCommandHelper();g.setCellValueAt(e,f,"")},addColumns:function(a){var b=this,c=b.getRowCount(),d=b.getColumnCount(),e=c-1,f=d-1+a,g=b.editor.getCommandHelper();g.setCellValueAt(e,f,"")},setRowHeight:function(a,b){var c=this;c.ifShownDo(a,0,function(){var d=c.getRowElAt(a);d&&(d.style.height=b+"px")})},setColumnWidth:function(a,b){var c=this,d=c.ensureColEl(a);d.style.width=b+"px"},onTableReady:function(a){var b=this;return b.firstRenderTable(a).then(function(){b.selectionView.redrawActiveCell(),b.selectionView.redrawRanges(),b.triggerResize()})},onCommandExec:function(){this.triggerResize()},ifShownDo:function(a,b,c,d){d=d||[];var e=this,f=e.tableEl,g=l.getPageInfo(a).page,h=f.tBodies[g];h?e.isPageInvalid(g)||c.apply(null,d):(e.renderTable(),e.editor.trigger("extend",a,b))},onTableValueChanged:function(a,b,c,d){var e=this,f=e.dataPosition2ViewPosition(b,c);e.ifShownDo(f.row,f.col,function(){var g=e.ensureCellElementAt(f.row,f.col),h=e.colgroup.querySelectorAll("col").length;e.renderColumns(h,f.col+1),l.setElementText(g,d,a.getStylesAt(b,c),e.editor.hash.user)})},onTableStylesChanged:function(a,b,c,d){var e=this,f=e.dataPosition2ViewPosition(b,c);e.ifShownDo(f.row,f.col,function(){var a=e.ensureCellElementAt(f.row,f.col),g=e.colgroup.querySelectorAll("col").length;e.renderColumns(g,f.col+1),l.setBorder(e,b,c,d),l.setElementStyles(a,d,!0,e.editor.hash.user)})},onTableAttributeChanged:function(){var a=this,b=a.editor.getSelection();o.log("onTableAttributeChanged"),a.renderTable(null,!0),b.redraw()},getRowIndex:function(a){var c=this,d=c.tableEl,e=a.parentNode,f=e.rowIndex%n,g=e.parentNode,h=b.indexOf(d.tBodies,g);return h*n+f},getColumnIndex:function(a,b){var c,d,e,f,g=this,h=g.getBoundingRect(a),i=(h.left+h.right)/2,j=g.colgroup.querySelectorAll("col"),k=j.length,l=0,m=0;for(c=0;k>c;c++){if(d=parseInt(j[c].style.width,10),i>=l&&l+d>i){m=c;break}l+=d}return f=g.editor.getTable(),e=f.getAttributeAt(b,m,"mergePointDX"),m-=e||0},onDragStart:function(a){var b,c,d,e,f,g=this,h=g.editor,i=h.getSelection();l.isTableCell(a.target)&&(d=a.target,b=g.getRowIndex(d),c=g.getColumnIndex(d,b),o.log("on Drag start row, col: "+b+", "+c),g.trigger("select-start"),a.shiftKey?(e=i.getActiveCell(),f=h.createRange({left:Math.min(c,e.col),right:Math.max(c,e.col)+1,top:Math.min(b,e.row),bottom:Math.max(b,e.row)+1}),i.selectRange(f)):(g.focusAtCell(b,c),i.selectCell(b,c)))},onDragging:function(a,b){var c,d,e,f,g,h,i,j=this,k=j.editor,m=k.getSelection();!j.cellEditorView.isEditing&&l.isTableCell(a.target)&&(h=a.target,c=j.getRowIndex(h),d=j.getColumnIndex(h,c),e=m.getActiveCell().row,f=m.getActiveCell().col,f>d&&(g=d,d=f,f=g),e>c&&(g=c,c=e,e=g),i=k.createRange({left:f,top:e,right:d+1,bottom:c+1}),o.log("range onDragging",i),m.selectRange(i),b?j.focus():j.focusAtElement(h))},onDragEnd:function(a){var b=this;b.onDragging(a,!0),b.trigger("select-end")},enterEditMode:function(){var a=this,b=a.editor,c=b.getSelection(),d=c.getActiveCell(),e=a.cellEditorView;e.edit(d.row,d.col)},onDblClick:function(a){"TD"===a.target.tagName&&this.enterEditMode()},onKeyDown:function(a){if(a.stopPropagation(),this.cellEditorView.isEditing)return void o.log("the cellEditorView is editing!");var c=this,d=c.editor,e=[8,9,13,16,17,18,19,20,27,33,34,35,36,37,38,39,40,45,46,91,92,93,112,113,114,115,116,117,118,119,120,121,122,123,144,145,229],f=c.editor.getHotkeyManager(),g=a.keyCode;switch(g){case 37:a.preventDefault(),c.selectToDirection("left",a.shiftKey,!0);break;case 38:a.preventDefault(),c.selectToDirection("up",a.shiftKey,!0);break;case 39:a.preventDefault(),c.selectToDirection("right",a.shiftKey,!0);break;case 40:a.preventDefault(),c.selectToDirection("down",a.shiftKey,!0);break;default:if(90===g&&a[q.MOD_KEY]&&!a.altKey)return a.shiftKey?d.trigger("key-redo"):d.trigger("key-undo"),void a.stopPropagation();f.call(a),-1!==b.indexOf(e,g)||a.ctrlKey||a.metaKey||c.onPrintableKeyDown(a)}},onPrintableKeyDown:function(a){if(!this.cellEditorView.isEditing&&13!==a.charCode){var b=this,c=b.editor,d=c.getSelection(),e=d.getActiveCell();b.cellEditorView.edit(e.row,e.col,"")}},onCompositionStart:function(){var a,b,c,d=this;d.editor.locked||(a=d.editor.getSelection(),b=a.getActiveCell(),c=d.getCellElementAt(b.row,b.col),c.innerHTML="",d.focusAtActiveCell(),d.hiddenInputView.bringToFront())},onCompositionEnd:function(a){if(!this.locked){var c=this,d=a.data,e=c.editor,f=e.getSelection(),g=f.getActiveCell();d&&b.defer(function(){c.cellEditorView.edit(g.row,g.col,d)}),c.hiddenInputView.hideBehind()}},onColumnWidthSet:function(a,b,c){var d=this;d.setColumnWidth(b,c)},onRowHeightSet:function(a,b,c){var d=this;d.setRowHeight(b,c)},onColumnInserted:function(a,b){var c=this;c.renderColumns(b),c.renderTable(a,!0)},onColumnDeleted:function(a,b){var c=this;c.renderColumns(b),c.renderTable(a,!0)},onRowInserted:function(a,b){var c,d,e,f,g=this;c=l.getPageInfo(b),d=c.page,e=a.getRowCount(),f=Math.ceil(e/n),l.forRange(d,f,function(a){g.renderPage(a,!0)})},onRowDeleted:function(a,b){var c,d,e,f,g=this;c=l.getPageInfo(b),d=c.page,e=a.getRowCount(),f=Math.ceil(e/n),l.forRange(d,f,function(a){g.renderPage(a,!0)})},doCopyOrCut:function(a,b){var c,d,e=this,f=a.clipboardData,g=e.editor,h=g.getClipboard();"cut"===b?h.cut():h.copy(),c=h.extractContents(),f.setData("text/html",c.html),f.setData("text/plain",c.text),d=h.extractJson(),f.setData("text/yne-ytable-json",JSON.stringify(d)),a.preventDefault()},onCopy:function(a){var b=this;a.stopPropagation(),b.doCopyOrCut(a,"copy")},onCut:function(a){var b=this;a.stopPropagation(),b.doCopyOrCut(a,"cut")},onPaste:function(a){var c=this,d=a.clipboardData,e=c.editor,f=e.getClipboard();f.canPaste()?f.paste():-1!==b.indexOf(d.types,"text/html")?c.pasteHtml(d.getData("text/html")):-1!==b.indexOf(d.types,"text/plain")&&c.pastePlainText(d.getData("text/plain")),a.stopPropagation(),a.preventDefault()},onBarEditStart:function(){m.disableTableEditScroll()},onBarEditEnd:function(){m.enableTableEditScroll()},onTableScroll:function(){this.renderTable(),this.selectionView.redrawActiveCell(),this.selectionView.redrawRanges(),this.trigger("scroll")},pasteTable:function(a){if(!this.editor.locked){var b,c,d,e,f,g,h,i,j,k,m,n,o=this,p=o.editor,q=p.getTable(),r=p.getCommandHelper(),s=p.getCommander(),t=p.getSelection(),u=t.getFirstRange(),v=u.getRect(),w=v.top,x=v.left,y=w,z=x,A=[],B=function(a,b){return!A[a]||!A[a][b]},C=function(a,b,c){A[a]||(A[a]=[]),A[a][b]=c},D=a.rows,E=Math.min(D.length,q.MAX_ROW_COUNT-w);for(e=0;E>e;e++)for(c=D[e].cells,d=Math.min(c.length,q.MAX_COLUMN_COUNT-x),i=e,f=0;d>f;f++){for(j=f;!B(i,j);)++j;for(g=c[f],n=l.getStylesFromElement(g),k=0;k<g.rowSpan;++k)for(m=0;m<g.colSpan;++m)0===k&&0===m?(h={styles:n,value:g.innerText,mergeWidth:g.colSpan,mergeHeight:g.rowSpan},C(i+k,j+m,h)):(h={value:"",styles:{},mergePointDX:m,mergePointDY:k},C(i+k,j+m,h))}for(E=A.length,y=w+E,s.beginCompond(),e=0;E>e;++e)for(d=A[e].length,z=Math.max(z,x+d),f=0;d>f;++f)h=A[e][f]||{value:"",styles:{}},r.setCellAttributesAt(w+e,x+f,h),r.setCellStylesAt(w+e,x+f,h.styles),r.setCellValueAt(w+e,x+f,h.value);s.endCompond(),b=p.createRange({top:w,left:x,bottom:y,right:z}),t.select(w,x,b)}},pasteHtml:function(a){var b,c,d=this,e=document.createElement("div"),f=/<html[\S\s]*<\/html>/i;b=e.querySelector("table"),b?d.pasteTable(b):(f.test(a)&&(a=a.match(f)[0]),e.innerHTML=a,c=e.innerText,c=c.replace(/\n\n/g,"").replace(/.*<!--[\s\S]*?-->/g,""),d.pastePlainText(c,e.innerHTML.trim()))},pastePlainText:function(a,b){var c=this,d=c.editor,e=d.getSelection(),f=e.getFirstRange(),g=f.getRect(),h=g.top,i=g.left,j=d.getCommandHelper();j.setCellValueWithUriRec(h,i,a,b),e.selectCell(h,i)},focus:function(){var a=this,b=a.hiddenInputView,c=a.el,d=c.scrollTop,e=c.scrollLeft;r(b.el)&&b.focus(),c.scrollTop=d,c.scrollLeft=e},focusAt:function(a,b,c){var d=this,e=d.hiddenInputView;e.setPosition(a,b),e.setWidth(c),e.focus()},focusAtElement:function(a){var b=this,c=b.getBoundingRect(a);b.focusAt(c.left,c.top,c.width)},focusAtCell:function(a,b){var c=this,d=c.getCellElementAt(a,b);c.focusAtElement(d)},focusAtActiveCell:function(){var a=this,b=a.editor,c=b.getSelection(),d=c.getActiveCell();a.focusAtCell(d.row,d.col)},scrollTo:function(a,b){var c=this.el;c.scrollLeft=a,c.scrollTop=b},scrollBy:function(a,b){var c=this.el;c.scrollLeft+=a,c.scrollTop+=b},getColumnRect:function(a){for(var b,c,d,e,f=this,g=f.tableEl,h=f.getBoundingRect(g),i=f.colgroup.querySelectorAll("col"),j=i.length,k=0,l=0;a>l&&j>l;)d=i[l],c=parseInt(d.style.width,10),k+=c,l++;return d=i[l],c=parseInt(d.style.width,10),b=k+c,e={left:k,right:b,top:0,bottom:h.bottom,width:c,height:h.bottom}},_onCellMouseEnter:function(a){var b=this;b.trigger("cell-enter",a,b)},_onCellMouseLeave:function(a){var b=this;b.trigger("cell-leave",a,b)},getVisibleHeight:function(){var a=this.$el;return a.find("div").first().innerHeight()},getVisibleWidth:function(){var a=this.$el;return b.min([a.find("div").first().innerWidth(),a.innerWidth()])},isRangeInEditBox:function(a){var b=this,c=b.hiddenInputView.el,d=b.cellEditorView.el;return p(a,c)||p(a,d)},isRangeInLastRow:function(a){var b=this,c=b.$el.find("tr:last").get(0),d=p(a,c);return d},isEditing:function(){return this.cellEditorView.isEditing}})}({}),yne_ytable_editor_views_CellResizeView=function(a){var b,c=yne_ytable_tools_mvc_Backbone,d=yne_ytable_editor_utils_Draggable,e=yne_ytable_templates_jst,f=yne_ytable_tools_core_underscore,g={TOP:1,RIGHT:2,BOTTOM:3,LEFT:4},h=35,i=10;return b=c.View.extend({className:"cell-resize-layer",initialize:function(a){var b=this;b.editor=a.editor,b.draggable=new d({el:b.el,disableDocSelection:!0}),b._active=!0,b._onDrag=!1,b._resizeType=null,b._cellInfo=null,b._bindEvents()},_bindEvents:function(){var a=this,b=a.draggable,c=a.editor;f.bindAll(a,"_onDragStart","_onDragging","_onDragEnd","_onCellEnter"),b.on("dragStart",a._onDragStart),b.on("dragging",a._onDragging),b.on("dragEnd",a._onDragEnd),c.on("cell-enter",a._onCellEnter)},render:function(){var a=this,b=e.render("editor","cell_resize",{});a.$el.html(b),a.showAt()},showAt:function(a){var b=this;a&&null!=a.width&&b.$el.css({width:a.width,height:a.height,top:a.top,left:a.left}).show()},hide:function(){var a=this;a.$el.hide()},enable:function(){this._active=!0},disable:function(){var a=this;a._active=!1,a.hide()},isActive:function(){return this._active},_parseType:function(a){var b,c=a.className;return f.some(g,function(a,d){var e=d.toLowerCase();return c.indexOf(e)>-1?(b=a,!0):void 0}),b||g.TOP},_onDragStart:function(a){var b,c=this,d=c.editor.getTableView();d&&(c._onDrag=!0,c._resizeType=c._parseType(a.target),b=d.getBoundingRect(a),c._startRect=b,d.showOverflow(),c._updateResizeLine(b.left,b.top))},_onDragging:function(a){var b,c=this,d=c.editor.getTableView();d&&(c._onDrag=!0,b=d.getBoundingRect(a),d.showOverflow(),c._updateResizeLine(b.left,b.top))},_onDragEnd:function(a){var b,c,d,e=this,f=e.editor.getTableView();f&&(e._onDrag=!1,b=f.getBoundingRect(a),e._updateResizeLine(b.left,b.top,!0),f.resetOverflow(),c=b.left-e._startRect.left,d=b.top-e._startRect.top,e._execResizeCommand(c,d))},_updateResizeLine:function(a,b,c){var d=this;switch(d._resizeType){case g.TOP:case g.BOTTOM:c?d.trigger("row-resize-line-hide"):d.trigger("row-resize-line-show",b);break;case g.RIGHT:case g.LEFT:c?d.trigger("column-resize-line-hide"):d.trigger("column-resize-line-show",a)}},_execResizeCommand:function(a,b){var c,d,e,j,k,l,m=this,n=m.editor,o=n.getTable(),p=n.getCommandHelper(),q=n.getCommander(),r=m._cellInfo;switch(q.beginCompond(),m._resizeType){case g.TOP:case g.BOTTOM:c=r.row,m._resizeType===g.TOP?c-=1:(l=o.getAttributeAt(r.row,r.col,"mergeHeight")||0,l>1&&(c+=l-1)),c=0>c?0:c,e=o.getRowHeight(c),e+=b,e=f.max([e,i]),p.setRowHeight(c,e);break;case g.RIGHT:case g.LEFT:d=r.col,m._resizeType===g.LEFT?d-=1:(k=o.getAttributeAt(r.row,r.col,"mergeWidth")||0,k>1&&(d+=k-1)),d=0>d?0:d,j=o.getColumnWidth(d),j+=a,j=f.max([j,h]),p.setColumnWidth(d,j)}q.endCompond()},_onCellEnter:function(a,b){var c,d,e,f=this,g=f.editor.getTableView();g&&f.isActive()&&!f._onDrag&&(c=a.target,d=g.getBoundingRect(c),d&&(e={row:b.getRowIndex(c)},e.col=b.getColumnIndex(c,e.row),f._cellInfo=e,f.showAt(d)))}})}({}),yne_ytable_editor_views_RowResizeLine=function(a){var b=yne_ytable_tools_mvc_Backbone;return b.View.extend({className:"row-resize-line",show:function(){this.el.style.display="block"},hide:function(){this.el.style.display="none"},moveTo:function(a){this.el.style.top=a+"px"},setLength:function(a){this.$el.width(a)}})}({}),yne_ytable_editor_views_ColumnResizeLine=function(a){var b=yne_ytable_tools_mvc_Backbone;return b.View.extend({className:"col-resize-line",show:function(){this.el.style.display="block"},hide:function(){this.el.style.display="none"},moveTo:function(a){this.el.style.left=a+"px"},setLength:function(a){this.$el.height(a)}})}({}),yne_ytable_editor_utils_OperateTable=function(a){var b=yne_ytable_tools_core_Class;return b.extend({initialize:function(a){var b=this;b.editor=a.editor},insertRowUp:function(){var a=this,b=a.editor,c=b.getCommandHelper(),d=b.getSelection(),e=d.activeCell.row;c.insertRow(e,1)},insertRowDown:function(){var a=this,b=a.editor,c=b.getCommandHelper(),d=b.getSelection(),e=d.getFirstRange(),f=e.getRect(),g=f.bottom;c.insertRow(g,1)},deleteRow:function(){var a=this,b=a.editor,c=b.getCommandHelper(),d=b.getSelection(),e=d.getFirstRange(),f=e.getRect(),g=f.bottom-f.top,h=d.activeCell.row;c.deleteRows(h,g)},insertColumnLeft:function(){var a=this,b=a.editor,c=b.getCommandHelper(),d=b.getSelection(),e=d.activeCell.col;c.insertColumn(e,1)},insertColumnRight:function(){var a=this,b=a.editor,c=b.getCommandHelper(),d=b.getSelection(),e=d.getFirstRange(),f=e.getRect(),g=f.right;c.insertColumn(g,1)},deleteColumn:function(){var a=this,b=a.editor,c=b.getCommandHelper(),d=b.getSelection(),e=d.getFirstRange(),f=e.getRect(),g=f.right-f.left,h=d.activeCell.col;c.deleteColumns(h,g)},deleteTable:function(){var a=this,b=a.editor;b.trigger("ytable-delete")}})}({}),yne_ytable_editor_views_TableView=function(a){var b=yne_ytable_tools_core_underscore,c=yne_ytable_tools_core_console,d=yne_ytable_editor_views_ContainerView,e=yne_ytable_editor_views_FreezeBarView,f=yne_ytable_editor_views_HorizontalView,g=yne_ytable_editor_views_VerticalView,h=yne_ytable_editor_views_TableEditView,i=yne_ytable_editor_views_CellResizeView,j=yne_ytable_editor_views_RowResizeLine,k=yne_ytable_editor_views_ColumnResizeLine,l=yne_ytable_editor_utils_OperateTable,m=yne_ytable_editor_utils_TableUtils,n=yne_ytable_tools_jq_jquery,o=yne_ytable_editor_utils_isRangeIn,p=function(a){return m.findParent(a,function(a){return a.tagName&&("TD"===a.tagName||"TH"===a.tagName)})};return d.extend({tagName:"div",className:"table-area",animationId:null,freezeBarView:null,horizontalView:null,verticalView:null,initialize:function(a){var b=this;b.constructor.__super__.initialize.apply(b,arguments),b.editor=a.editor,b._tableMode=a.tableMode,b._initSubviews(),b._initEvents(),b._operateTable=new l({editor:b.editor})},_initSubviews:function(){var a=this,b=a.editor;a._tableMode?a.$el.addClass("table-mode"):(a.freezeBarView=new e({editor:b}),a.addView(a.freezeBarView),c.log("tableMode: "+a._tableMode),a.horizontalView=new f({editor:b}),a.addView(a.horizontalView),a.verticalView=new g({editor:b}),a.addView(a.verticalView)),a.tableEditView=new h({editor:b}),a.addView(a.tableEditView),a._tableMode&&(a.cellResizeView=new i({editor:b}),a.addView(a.cellResizeView)),a.rowResizeLine=new j,a.addView(a.rowResizeLine),a.columnResizeLine=new k,a.addView(a.columnResizeLine)},_initEvents:function(){var a=this,c=a.editor;b.bindAll(a,"onTableReady","onTableScroll","onBuildContextMenu","onContextMenuClick","onContextMenu","onLock","onUnlock","onTableEditViewResize"),c.onTable("ready",a.onTableReady),a.tableEditView.el.addEventListener("scroll",function(b){var c=b.target;a.onTableScroll(c.scrollTop,c.scrollLeft)}),a.tableEditView.on("cell-enter",function(){var c=["cell-enter"].concat(b.toArray(arguments));a.trigger.apply(a,c)}),a.tableEditView.on("cell-leave",function(){var c=["cell-leave"].concat(b.toArray(arguments));a.trigger.apply(a,c)}),a.on("view-resize",b.debounce(function(b){a._onViewResize(b)},100)),c.on("lock",a.onLock),c.on("unlock",a.onUnlock),a._initContextMenu(),a.tableEditView.on("resize",a.onTableEditViewResize),a.cellResizeView&&(b.bindAll(a,"_onRowResizeLineShow","_onRowResizeLineHide","_onColumnResizeLineShow","_onColumnResizeLineHide"),a.cellResizeView.on("row-resize-line-show",a._onRowResizeLineShow),a.cellResizeView.on("row-resize-line-hide",a._onRowResizeLineHide),a.cellResizeView.on("column-resize-line-show",a._onColumnResizeLineShow),a.cellResizeView.on("column-resize-line-hide",a._onColumnResizeLineHide),a.tableEditView.on("select-start",function(){a.cellResizeView.disable()}),a.tableEditView.on("select-end",function(){a.cellResizeView.enable()}))},_onRowResizeLineShow:function(a){var b=this,c=b.rowResizeLine,d=b.tableEditView;c.setLength(d.getVisibleWidth()),c.moveTo(a),c.show()},_onRowResizeLineHide:function(){var a=this,b=a.rowResizeLine;b.hide()},_onColumnResizeLineShow:function(a){var b=this,c=b.columnResizeLine,d=b.tableEditView;c.setLength(d.getVisibleHeight()),c.moveTo(a),c.show()},_onColumnResizeLineHide:function(){var a=this,b=a.columnResizeLine;b.hide()},_initContextMenu:function(){var a=this,b=a.editor;b.isDefaultContextmenu?a.$el.contextMenu({zIndex:255,selector:"td, th, td *, th *",callback:a.onContextMenuClick,build:a.onBuildContextMenu}):a.el.addEventListener("contextmenu",a.onContextMenu,!1),b.on("replaceContextmenu",function(){a.$el.contextMenu("destroy"),a.el.addEventListener("contextmenu",a.onContextMenu,!1)})},onContextMenu:function(a){var c,d=this,e=d.editor,f=p(a.target),g=[];f&&(c=d.createContextMenu(f).items,c&&(a.preventDefault(),a.stopPropagation(),b.each(c,function(a,c){var d;b.isObject(a)?(d=b.clone(a),d.key=c):d=a,g.push(d)}),e.trigger("contextmenu",{items:g,x:a.x,y:a.y,callback:d.onContextMenuClick})))},createContextMenu:function(a){var c,d,e,f=this,g=f.editor,h=g.getTable(),i=f.getRowCount(),j=f.getColumnCount(),k=g.getClipboard(),l=!k.canPaste(),n=!1,o=function(a,b,c){var d,e,f,g;return"row"===c?(e=m.getRowName(a),f=m.getRowName(b),g="行"):(e=m.getColumnName(a),f=m.getColumnName(b),g="列"),d="删除整"+g},p=function(a,b,c){var d,e;return d="row"===b?"行":"列",e="在"+c+"插入"+d},q={cut:{name:"剪切"},copy:{name:"复制"},paste:{name:"粘贴"},pastePlainText:{name:"纯文本粘贴"}};return m.isRowHeader(a)?(f.contextMenuInfo={mode:"row-header",target:a},f.selectRow()):m.isColHeader(a)?(f.contextMenuInfo={mode:"col-header",target:a},f.selectColumn()):m.isTableCell(a)&&(f.contextMenuInfo={mode:"table-cell",target:a},f.selectTableCell()),c=g.getSelection().getFirstRange(),c.type===c.TYPE.NORMAL?(d=c.bottom-c.top,e=c.right-c.left):(d=i,e=j),b.extend(q,{sep1:"-",insertRowUp:{name:p(d,"row","上方")},insertRowDown:{name:p(d,"row","下方")},deleteRow:{name:o(c.top,c.bottom-1,"row")},sep2:"-",insertColumnLeft:{name:p(e,"column","左侧")},insertColumnRight:{name:p(e,"column","右侧")},deleteColumn:{name:o(c.left,c.right-1,"col")},sep3:"-",mergeCells:{name:"合并单元格",disabled:c.onlyOneCell()}}),q.deleteTable={name:"删除整个表格"},c.forEach(function(a,b){n||h.getStylesAt(a,b).link&&(n=!0)}),n&&b.extend(q,{sep100:"-",clearLink:{name:"清除链接"}}),g.locked?b.each(q,function(a,c){"copy"!==c&&b.isObject(a)&&(a.disabled=!0)}):(["paste","pastePlainText","insertColumnLeftCopy","insertColumnRightCopy","insertRowUpCopy","insertRowDownCopy"].forEach(function(a){q[a]&&(q[a].disabled=l)}),["insertColumnLeftCopy","insertColumnRightCopy"].forEach(function(a){q[a]&&(!k.range||k.range.type!==c.TYPE.COLUMNS||k.range.overlaps(c))&&(q[a].disabled=!0)}),["insertRowUpCopy","insertRowDownCopy"].forEach(function(a){q[a]&&(!k.range||k.range.type!==c.TYPE.ROWS||k.range.overlaps(c))&&(q[a].disabled=!0)})),{items:q}},onBuildContextMenu:function(a){var b=this,c=p(a[0]);return b.createContextMenu(c)},onContextMenuClick:function(a){var b,d=this,e=d.editor,f=e.getClipboard(),g=e.getCommandHelper(),h=e.getCommandFactory(),i=e.getCommander(),j=e.getSelection(),k=j.getFirstRange(),l=e.getTable(),m=d._operateTable;switch(a){case"cut":f.cut();break;case"copy":f.copy();break;case"paste":f.paste();break;case"pastePlainText":f.paste(!0);break;case"insertRowUp":m.insertRowUp();break;case"insertRowDown":m.insertRowDown();break;case"mergeCells":b=h.create("ToggleRangeMerge",{range:k}),i.exec(b,!0);break;case"deleteRow":m.deleteRow();break;case"insertColumnLeft":m.insertColumnLeft();break;case"insertColumnRight":m.insertColumnRight();break;case"deleteColumn":m.deleteColumn();break;case"deleteTable":m.deleteTable();break;case"clear":g.clearSelectionData();break;case"clearLink":k.forEach(function(a,b){l.getStylesAt(a,b).link&&g.addCellStylesAt(a,b,{link:""})});break;default:c.error("未定义的右键菜单命令")}delete d.contextMenuInfo},selectRow:function(){var a=this,b=a.contextMenuInfo,c=b.target,d=c.parentNode.rowIndex,e=a.editor,f=e.getSelection(),g=f.getFirstRange(),h=e.createRange({top:d,bottom:d+1});g.type===g.TYPE.ROWS&&h.overlaps(g)||f.select(d,0,h)},selectColumn:function(){var a=this,b=a.contextMenuInfo,c=b.target,d=c.cellIndex,e=a.editor,f=e.getSelection(),g=f.getFirstRange(),h=e.createRange({left:d,right:d+1});g.type===g.TYPE.COLUMNS&&h.overlaps(g)||f.select(0,d,h)},selectTableCell:function(){var a=this,b=a.contextMenuInfo,c=b.target,d=m.findParent(c,"td"),e=a.tableEditView.getRowIndex(d),f=a.tableEditView.getColumnIndex(d,e),g=a.editor,h=g.getSelection(),i=h.getFirstRange(),j=g.createRange({top:e,left:f,bottom:e+1,right:f+1});j.overlaps(i)||h.select(e,f,j)},render:function(){var a=this;a.constructor.__super__.render.apply(a,arguments)},focus:function(){this.tableEditView.focus()},focusDebounced:b.debounce(function(){this.focus()},50),getRowCount:function(){return this.tableEditView.getRowCount()},getColumnCount:function(){return this.tableEditView.getColumnCount()},_onViewResize:function(a){var b=this;b.tableEditView.resizeToWidth(a)},onTableEditViewResize:function(a){var b=this;b.$el.height(a),b.trigger("resize",a)},onTableReady:function(a){var b=this,c=b.editor;c.trigger("startWait"),b.tableEditView.onTableReady(a).then(function(){b.horizontalView&&(b.horizontalView.onTableReady(a),b.verticalView.onTableReady(a)),c.trigger("endWait")})},onTableScroll:function(a,b){var c=this,d=window.requestAnimationFrame||window.webkitRequestAnimationFrame,e=window.cancelAnimationFrame||window.webkitCancelAnimationFrame;null!==c.animationId&&e(c.animationId),d(function(){c.tableEditView.onTableScroll(a,b),c.horizontalView&&(c.horizontalView.onTableScroll(a,b),c.verticalView.onTableScroll(a,b));
})},onLock:function(){var a=this;a.el.classList.add("locked")},onUnlock:function(){var a=this;a.el.classList.remove("locked")},getBoundingRect:function(a){var c,d,e,f=this,g=f.$el.offset(),h={width:0,height:0};return b.isElement(a)?(c=n(a),e=c.offset(),h.width=c.outerWidth(),h.height=c.outerHeight()):(d=a,e={top:d.pageY,left:d.pageX}),h.top=e.top-g.top,h.bottom=h.top+h.height,h.left=e.left-g.left,h.right=h.left+h.width,h},resetOverflow:function(){this.$el.css("overflow","")},showOverflow:function(){this.$el.css("overflow","visible")},_getSelectionView:function(){var a=this,b=a.tableEditView;return b.selectionView},showSelectionView:function(){var a=this,b=a._getSelectionView();b.show()},hideSelectionView:function(){var a=this,b=a._getSelectionView();b.hide()},isRangeInEditBox:function(a){return this.tableEditView.isRangeInEditBox(a)},isRangeInLastRow:function(a){var b,c=this;return c.cellResizeView&&(b=o(a,c.cellResizeView.el)),b=b||o(a,c.rowResizeLine.el)||o(a,c.columnResizeLine.el),b||c.tableEditView.isRangeInLastRow(a)},isEditing:function(){return this.tableEditView.isEditing()}})}({}),yne_ytable_editor_views_FooterView=function(a){var b=yne_ytable_editor_views_ContainerView;return b.extend({tagName:"div",className:"footer",initialize:function(a){var b=this;b.constructor.__super__.initialize.apply(b,arguments),b.editor=a.editor,b._initEvents()},_initEvents:function(){}})}({}),yne_ytable_editor_views_FormulaEditView=function(a){var b=yne_ytable_editor_views_ContainerView,c=yne_ytable_templates_jst,d=yne_ytable_tools_core_underscore,e=yne_ytable_editor_utils_TableUtils;return b.extend({tagName:"div",className:"formula-edit",template:c.getTemplate("editor","formula_edit"),initialize:function(a){var b=this;b.constructor.__super__.initialize.apply(b,arguments),b.editor=a.editor,b.cellInfo=null,b._initEvents()},_initEvents:function(){var a=this,b=a.editor;d.bindAll(a,"onActiveCellChanged","onValueChanged","onInPlaceEditing","onInputClick","onInputKeyDown","onInputBlur","onInputKeyUp"),b.onSelection("activeCellChanged",a.onActiveCellChanged),b.onTable("valueChanged",a.onValueChanged),b.on("inPlaceEditing",a.onInPlaceEditing)},render:function(){var a=this,b=a.el;b.innerHTML=a.template(),a.nameBox=b.querySelector(".cell-name"),a.inputBox=b.querySelector("input.edit-input"),a.inputBox.readOnly=!0,a.inputBox.addEventListener("click",a.onInputClick),a.inputBox.addEventListener("keydown",a.onInputKeyDown),a.inputBox.addEventListener("keyup",a.onInputKeyUp),a.inputBox.addEventListener("blur",a.onInputBlur),a.constructor.__super__.render.apply(a,arguments)},getInputValue:function(){var a=this;return a.inputBox.value},setInputValue:function(a){var b=this;b.inputBox.value=a},setCellName:function(a){var b=this;b.nameBox.textContent=a},deactivate:function(a,b){var c=this,d=c.inputBox;d.readOnly||(d.readOnly=!0,b||(a?c.confirm():c.cancel()),c.cellInfo=null,c.editor.trigger("barEditEnd",a,b))},activate:function(){if(!this.editor.locked){var a=this,b=a.inputBox,c=a.editor,d=c.getSelection(),e=d.getActiveCell(),f=c.getTable(),g=f.getValueAt(e.row,e.col);b.readOnly&&(b.readOnly=!1,b.focus(),a.cellInfo={row:e.row,col:e.col,oldValue:g,value:g},c.trigger("barEditStart",g))}},confirm:function(){var a=this,b=a.editor,c=b.getCommandHelper(),d=a.cellInfo,e=d.value;e!==d.oldValue&&c.setCellValueWithUriRec(d.row,d.col,e)},cancel:function(){var a=this,b=a.editor,c=b.getTable(),d=a.cellInfo,e=c.getValueAt(d.row,d.col);a.setInputValue(e)},onActiveCellChanged:function(a){var b=this,c=a.getActiveCell(),d=e.getColumnName(c.col)+e.getRowName(c.row),f=b.editor,g=f.getTable(),h=g.getValueAt(c.row,c.col);b.setCellName(d),b.setInputValue(h)},onValueChanged:function(a,b,c,d){var e=this,f=e.editor,g=f.getSelection(),h=g.getActiveCell();h.row===b&&h.col===c&&e.setInputValue(d)},onInPlaceEditing:function(a){var b=this;b.setInputValue(a)},onInputClick:function(){var a=this;a.activate()},onInputKeyDown:function(a){var b=this;switch(a.keyCode){case 27:b.deactivate(!1)}b.editor.trigger("barKeyDown",a)},onInputKeyUp:function(){var a=this,b=a.getInputValue(),c=a.cellInfo;c&&(c.value=b,a.editor.trigger("barEditing",b))},onInputBlur:function(){var a=this;window.setTimeout(function(){var b=document.activeElement,c=!1;b&&b.webkitMatchesSelector(".cell-edit-box")&&(c=!0),a.deactivate(!0,c)},100)}})}({}),yne_ytable_tools_web_dom_getScrollBarWidth=function(){var a=0;return function(){if(!a){var b,c,d=document.createElement("p"),e=document.createElement("div");d.style.width="100%",d.style.height="200px",e.style.position="absolute",e.style.top="0px",e.style.left="0px",e.style.visibility="hidden",e.style.width="200px",e.style.height="150px",e.style.overflow="hidden",e.appendChild(d),document.body.appendChild(e),b=d.offsetWidth,e.style.overflow="scroll",c=d.offsetWidth,b===c&&(c=e.clientWidth),document.body.removeChild(e),a=b-c}return a}}(),yne_ytable_editor_views_EditorView=function(a){var b=yne_ytable_editor_views_ContainerView,c=yne_ytable_editor_views_ToolbarView,d=yne_ytable_editor_views_TableView,e=yne_ytable_editor_views_FooterView,f=yne_ytable_editor_views_FormulaEditView,g=yne_ytable_tools_core_underscore,h=yne_ytable_tools_jq_jquery,i=yne_ytable_tools_web_dom_getScrollBarWidth,j=b.extend({tagName:"div",className:"ytable-editor-area",initialize:function(a){var c=this;b.prototype.initialize.apply(c,arguments),c.editor=a.editor,c.options=a,c._initSubviews(),c._initEvents()},_initSubviews:function(){var a=this,b=a.editor;a.options.toolbar&&(a.toolbarView=new c({editor:b,floating:a.options.toolbarFloat,showAtInit:a.options.toolbarShowAtInit}),a.addView(a.toolbarView)),a.tableView=new d({editor:b,tableMode:a.options.tableMode}),a.addView(a.tableView),a.options.footer===!0&&(a.footerView=new e({editor:b}),a.addView(a.footerView),a.formulaEditView=new f({editor:b}),a.footerView.addView(a.formulaEditView))},_initEvents:function(){var a=this;a._onResize=a._onResize.bind(a),a.onTableViewResize=a.onTableViewResize.bind(a),a.$el.on("resize",a._onResize),a.on("view-resize",a._onResize),a.tableView.on("resize",a.onTableViewResize),a.tableView.on("cell-enter",function(){var b=["cell-enter"].concat(g.toArray(arguments));a.trigger.apply(a,b)}),a.tableView.on("cell-leave",function(){var b=["cell-leave"].concat(g.toArray(arguments));a.trigger.apply(a,b)})},render:function(){var a=this;b.prototype.render.apply(a,arguments)},_onResize:function(){var a=this,b=a.$el.innerWidth();b-=i(),a.tableView.trigger("view-resize",b)},onTableViewResize:function(a){var b=this;b.toolbarView&&!b.toolbarView.isFloating()&&h.contains(b.$el,b.toolbarView.$el)&&(a+=b.toolbarView.$el.outerHeight()),b.footerView&&(a+=b.footerView.$el.outerHeight()),b.$el.parent().height(a)}});return j}({}),yne_ytable_editor_utils_Cache2=function(a){var b,c=yne_ytable_tools_core_Class;return b=c.extend({initialize:function(){var a=this;a.clear()},get:function(a,b){var c=this;return c._cache||(c._cache={}),c._cache[a]||(c._cache[a]={}),1===arguments.length?c._cache[a]:c._cache[a][b]},set:function(a,b,c){var d=this,e=d.get(a);null==c?delete e[b]:e[b]=c},clear:function(){var a=this;a._cache={}}})}({}),yne_ytable_editor_core_Table=function(a){var b=yne_ytable_tools_core_EventClass,c=yne_ytable_tools_core_underscore,d=yne_ytable_tools_web_console,e=yne_ytable_editor_utils_Cache2,f={value:"",styles:{}},g=yne_ytable_editor_config_defaults,h=g.columnWidth,i=g.rowHeight,j=1,k=1,l=500,m=35,n=["mergeWidth","mergeHeight","mergePointDX","mergePointDY"];return b.extend({MAX_ROW_COUNT:l,MAX_COLUMN_COUNT:m,initialize:function(a){var b=this;a=a||{},delete b.options,b.setContent(a),b.locked=!1,b._cache2=new e},setContent:function(a){var b=this;b.data=a.data||[[{styles:{},value:""}]],b.rowHeights=a.rowHeights||[i],b.colWidths=a.colWidths||[h],b.title=a.title||"",b._columnCount=b._computeColumnCount(),b._cache2&&b._cache2.clear(),b.trigger("ready")},getContent:function(){var a=this,b={rowHeights:a.rowHeights,colWidths:a.colWidths,title:a.title,data:a.data},c=window.JSON.stringify(b);return c},lock:function(){this.locked=!0},unlock:function(){this.locked=!1},getRowCount:function(){return Math.max(j,this.data.length)},_computeColumnCount:function(){var a=this,b=0;return c.each(a.data,function(a){a&&(b=Math.max(b,a.length))}),Math.max(k,b)},getColumnCount:function(){return Math.max(k,this._columnCount)},getRowHeight:function(a){return this.rowHeights[a]||i},setRowHeight:function(a,b){this.locked||(this.rowHeights[a]=b,this.trigger("rowHeightSet",a,b))},getColumnWidth:function(a){return this.colWidths[a]||h},setColumnWidth:function(a,b){this.locked||(this.colWidths[a]=b,this.trigger("columnWidthSet",a,b))},_getCellData:function(a,b,c){var d=this,e=d.data;return e[a]&&e[a][b]?e[a][b]:c===!0?f:null},isMergePoint:function(a,b){var c=this,d=c._getCellData(a,b,!0);return d.mergeWidth>1||d.mergeHeight>1},isMergedCell:function(a,b){var c=this,d=c._getCellData(a,b,!0);return d.mergePointDX>=1||d.mergePointDY>=1},getValueAt:function(a,b){var c,d=this;return d.isMergedCell(a,b)?f.value:(c=d._getCellData(a,b,!0),c.value||f.value)},setValueAt:function(a,b,c){d.log("setValueAt "+a+","+b+":"+c);var e,f=this.rowHeights.length,g=this.colWidths.length;if(!this.locked){if(this.ensureRow(a),void 0===this.data[a][b]?this.data[a][b]=this.createCell({value:c}):this.data[a][b].value=c,a>=f)for(e=0;a-f+1>e;e++)this.rowHeights.splice(a,0,i);if(b>=g)for(e=0;b-g+1>e;e++)this.colWidths.splice(b,0,h);b>=this._columnCount&&(this._columnCount=b+1),this.trigger("valueChanged",a,b,c)}},getStylesAt:function(a,b){var c=this,d=c._getCellData(a,b,!0),e=d.styles;return e},getAttributeAt:function(a,b,d){if(c.contains(n,d)){var e=this,f=e._getCellData(a,b,!0),g=f[d];return g}},setAttributeAt:function(a,b,d,e){var f,g=this;c.contains(n,d)&&(g.locked||(g.ensureRow(a),void 0===g.data[a][b]&&(g.data[a][b]=g.createCell()),f=g.data[a][b],null==e?delete f[d]:f[d]=e,b>=g._columnCount&&(g._columnCount=b+1),g._cache2.clear(),g.trigger("attributeChanged",a,b,d,e)))},getAttributesAt:function(a,b){var d=this,e={};return c.each(n,function(c){var f=d.getAttributeAt(a,b,c);null!=f&&(e[c]=f)}),e},setStylesAt:function(a,b,c){d.log("setStylesAt"),this.locked||(this.ensureRow(a),void 0===this.data[a][b]?this.data[a][b]=this.createCell({styles:c}):this.data[a][b].styles=c,b>=this._columnCount&&(this._columnCount=b+1),this.trigger("stylesChanged",a,b,this.data[a][b].styles))},addStylesAt:function(a,b,e){var f,g,h=this;h.locked||h.isMergedCell(a,b)||(d.log("addStylesAt"),f=h.getStylesAt(a,b),g=c.clone(f),h.ensureRow(a),void 0===h.data[a][b]?h.data[a][b]=h.createCell({styles:e}):h.data[a][b].styles=c.extend(g,e),c.each(h.data[a][b].styles,function(c,d){c||delete h.data[a][b].styles[d]}),b>=h._columnCount&&(h._columnCount=b+1),h.trigger("stylesChanged",a,b,h.data[a][b].styles))},insertRowOnly:function(a,b,c){var d=this;d.locked||(c?i>c&&(c=i):c=i,d.data.splice(a,0,b),d.rowHeights.splice(a,0,c),d._cache2.clear(),d.trigger("rowInserted",a))},deleteRowOnly:function(a){var b=this;b.locked||(b.data.splice(a,1),b.rowHeights.splice(a,1),b._cache2.clear(),b.trigger("rowDeleted",a))},insertColumnOnly:function(a,b,d){var e=this;e.locked||(b=b||[],d=d||h,c.each(e.data,function(c,d){if(c){var e=b[d];c.splice(a,0,e)}}),e.colWidths.splice(a,0,d),e._columnCount+=1,e._cache2.clear(),e.trigger("columnInserted",a))},deleteColumnOnly:function(a){var b=this;b.locked||(c.each(b.data,function(b){b&&b.splice(a,1)}),b.colWidths.splice(a,1),b._columnCount=Math.max(k,b._columnCount-1),b._cache2.clear(),b.trigger("columnDeleted",a))},createCell:function(a){a=a||{};var b=c.defaults(a,f);return b.styles=a.styles||{},b},ensureRow:function(a){void 0===this.data[a]&&(this.data[a]=[])},copyRow:function(a,b){var d=this,e=this.data[a],f=[];return e?(b=c.extend({styles:!0,attrs:!0,value:!0},b),c.each(e,function(c,e){if(c){var g=d.copyCell(a,e,b);f[e]=g}}),f):void 0},copyColumn:function(a,b){var d=this,e=[];return b=c.extend({styles:!0,attrs:!0,value:!0},b),c.each(d.data,function(c,f){if(c){var g=d.copyCell(f,a,b);e[f]=g}}),e},copyCell:function(a,b,d){var e,g=this,h=g._getCellData(a,b);return h?(d=c.extend({styles:!0,attrs:!0,value:!0},d),e={},d.value&&(e.value=g.getValueAt(a,b)),d.styles&&(e.styles=c.clone(g.getStylesAt(a,b))),d.attrs&&c.each(n,function(a){var b=h[a];null!=b&&(e[a]=b)}),e):f},toViewPosition:function(a,b){var c,d=this,e=b,f=0,g=0,h=0,i="viewPosition",j=[a+","+b],k=d._cache2.get(i,j);if(k)return k;for(c=d.getAttributesAt(a,b),h=a,c.mergePointDY>0&&(h-=c.mergePointDY),c.mergePointDX>0&&(e-=c.mergePointDX);e>f;)c=d.getAttributesAt(h,f),c.mergeWidth>1?(f+=c.mergeWidth,g++):c.mergePointDY?f++:(f++,g++);return k={row:h,col:g},d._cache2.set(i,j,k),k},getFirstUnmergeCellAtRow:function(a){var b,c=this,d=c.getColumnCount();for(b=0;d>b;b++)if(!c.isMergePoint(a,b)&&!c.isMergedCell(a,b))return{row:a,col:b}},isMergeRange:function(a){var b,c,d,e,f=this,g="mergeRange";return a.type!==a.TYPE.NORMAL?!1:(b=a.toString(),c=f._cache2.get(g,b),null!=c?c:(d=f.getAttributeAt(a.top,a.left,"mergeWidth"),e=f.getAttributeAt(a.top,a.left,"mergeHeight"),d=d||1,e=e||1,c=(d>1||e>1)&&d>=a.right-a.left&&e>=a.bottom-a.top,f._cache2.set(g,b,c),c))},DEFALUT_WIDTH:h,DEFALUT_HEIGHT:i})}({}),yne_ytable_editor_core_Selection=function(a){var b=yne_ytable_tools_core_EventClass,c=yne_ytable_tools_core_underscore,d=yne_ytable_tools_web_console;return b.extend({initialize:function(a){var b,d=this;b=d.editor=a.editor,d.ranges=[],d.activeCell={row:0,col:0},c.bindAll(d,"onRowInserted","onRowDeleted","onColumnInserted","onColumnDeleted"),b.onTable("rowInserted",d.onRowInserted),b.onTable("rowDeleted",d.onRowDeleted),b.onTable("columnInserted",d.onColumnInserted),b.onTable("columnDeleted",d.onColumnDeleted)},addRange:function(a){-1===c.indexOf(this.ranges,a)&&this.ranges.push(a),d.log("addRange "+a),this.trigger("rangeAdded",a),this.trigger("rangeChanged"),this.trigger("change")},removeRange:function(a){var b=c.indexOf(this.ranges,a);-1!==b&&(this.ranges.splice(b,1),this.trigger("rangesRemoved",[a]),this.trigger("rangeChanged"),this.trigger("change"))},removeAllRanges:function(){var a=this.ranges.splice(0);0!==a.length&&(this.trigger("rangesRemoved",a),this.trigger("rangeChanged"),this.trigger("change"))},getRanges:function(){return this.ranges},getFirstRange:function(){var a=this,b=a.activeCell;return 0===a.ranges.length?a.editor.createRange({left:b.col,top:b.row,right:b.col+1,bottom:b.row+1}):a.ranges[0]},setActiveCell:function(a,b){d.log("setActiveCell: "+a+","+b),this.activeCell={row:a,col:b},this.trigger("activeCellChanged",a,b),this.trigger("change")},getActiveCell:function(){return this.activeCell},forEach:function(a){var b=this,d=b.ranges,e=b.activeCell;0===d.length?a(e.row,e.col):c.each(d,function(b){b.forEach(a)})},forEachRange:function(a){var b=this,d=b.ranges,e=b.activeCell;0===d.length?a(b.editor.createRange({left:e.col,top:e.row,right:e.col+1,bottom:e.row+1})):c.each(d,function(b){a(b)})},selectRange:function(a){var b=this;b.removeAllRanges(),b.addRange(a)},selectCell:function(a,b){var c=this,d={top:a,bottom:a+1,left:b,right:b+1},e=c.editor.createRange(d);c.select(a,b,e)},select:function(a,b,c){var d=this;d.removeAllRanges(),d.setActiveCell(a,b),d.addRange(c)},selectColumn:function(a,b){b||(b=1);var c=this,d=c.editor;c.select(0,a,d.createRange({left:a,right:a+b}))},selectRow:function(a,b){b||(b=1);var c=this,d=c.editor;c.select(a,0,d.createRange({top:a,bottom:a+b}))},selectAll:function(){var a=this,b=a.editor;a.removeAllRanges(),a.addRange(b.createRange())},isCellAtRange:function(a){var b=this,c=b.getActiveCell(),d=b.getFirstRange(),e=d.getRect();switch(a){case"top":return c.row===e.top;case"left":return c.col===e.left;case"bottom":return c.row===e.bottom-1;case"right":return c.col===e.right-1;default:return!1}},onRowInserted:function(a,b){var d=this,e=1,f=d.editor,g=d.getActiveCell(),h=d.getFirstRange(),i=g.row,j=h.top,k=h.bottom;i>=b&&(i+=e),c.isNumber(j)&&j>=b&&(j+=e),c.isNumber(k)&&k>b&&(k+=e),d.select(i,g.col,f.createRange({top:j,bottom:k,left:h.left,right:h.right}))},onRowDeleted:function(a){var b=this,d=b.editor,e=b.getActiveCell(),f=b.getFirstRange(),g=e.row,h=f.top,i=f.bottom,j=a.getRowCount();g>=j&&(g=j-1),c.isNumber(h)&&h>=j&&(h=j-1),c.isNumber(i)&&i>j&&(i=j),b.select(g,e.col,d.createRange({top:h,bottom:i,left:f.left,right:f.right}))},onColumnInserted:function(a,b){var d=this,e=1,f=d.editor,g=d.getActiveCell(),h=d.getFirstRange(),i=g.col,j=h.left,k=h.right;i>=b&&(i+=e),c.isNumber(j)&&j>=b&&(j+=e),c.isNumber(k)&&k>b&&(k+=e),d.select(g.row,i,f.createRange({top:h.top,bottom:h.bottom,left:j,right:k}))},onColumnDeleted:function(a){var b=this,d=b.editor,e=b.getActiveCell(),f=b.getFirstRange(),g=e.col,h=f.left,i=f.right,j=a.getColumnCount();g>=j&&(g=j-1),c.isNumber(h)&&h>=j&&(h=j-1),c.isNumber(i)&&i>j&&(i=j),b.select(e.row,g,d.createRange({top:f.top,bottom:f.bottom,left:h,right:i}))},redraw:function(){var a=this,b=a.getFirstRange(),c=b.clone();a.select(c.top,c.left,c)}})}({}),yne_ytable_editor_views_ControlView=function(a){var b=yne_ytable_tools_mvc_Backbone;return b.View.extend({className:"control",initialize:function(a){var b=this;b.editor=a.editor},render:function(){}})}({}),yne_ytable_editor_views_SplitView=function(a){var b=yne_ytable_editor_views_ControlView;return b.extend({className:"toolbar_split",initialize:function(){},render:function(){}})}({}),yne_ytable_editor_views_ButtonView=function(a){var b=yne_ytable_editor_views_ControlView,c=yne_ytable_templates_jst,d="activated",e="disabled";return b.extend({className:"button-wrapper",template:c.getTemplate("editor","button"),initialize:function(a){var b,c=this;c.editor=a.editor,c.name=a.name,b=a.click,c.options=a,b||(b=c.click),c.click=function(){b.apply(c)}},render:function(){var a=this,b=a.options;a.el.innerHTML=a.template({tag:b.tag,text:b.text}),a.textEl=a.el.querySelector(".button-text"),a.buttonEl=a.el.querySelector(".button"),a.buttonEl.classList.add("button-"+a.name),a.el.addEventListener("click",function(){a.click()})},disable:function(){var a=this.el;a.classList.add(e)},enable:function(){var a=this.el;a.classList.remove(e)},isDisabled:function(){var a=this.el.classList;return a.contains(e)},activate:function(){var a=this.el;a.classList.add(d)},deactivate:function(){var a=this.el;a.classList.remove(d)},isActivated:function(){var a=this.el.classList;return a.contains(d)},hideText:function(){this.textEl&&(this.textEl.style.display="none")},showText:function(){this.textEl&&(this.textEl.style.display="inline-block")},setText:function(a){var b=this,c=b.textEl;b.options.text=a,c&&(a?(c.innerText=a,b.showText()):(c.innerText="",b.hideText()))},click:function(){}})}({}),yne_ytable_editor_views_ComboBoxView=function(a){var b=yne_ytable_editor_views_ControlView,c=yne_ytable_templates_jst,d=yne_ytable_editor_utils_TableUtils,e=yne_ytable_tools_core_underscore;return b.extend({className:"combo-box",template:c.getTemplate("editor","combo_box"),renderOptions:{},initialize:function(a){var b=this;b.editor=a.editor,b.name=a.name,b.tag=a.tag,b.items=a.items,b.options=a,b.defaultKey="default",b.selected=null,e.bindAll(b,"onClick","onDocumentClick"),b.el.addEventListener("click",b.onClick),document.addEventListener("click",b.onDocumentClick)},render:function(){var a=this,b=a.tag;a.el.classList.add("combo-"+a.name),a.el.title=b,a.el.innerHTML=a.template({items:a.items,name:a.name,text:a.options.text,options:a.renderOptions}),a.dispEl=a.el.querySelector(".combo-disp")},setDefaultKey:function(a){a&&e.isString(a)&&(this.defaultKey=a)},setDisplayHtml:function(a){var b=this,c=b.dispEl;c&&(c.innerHTML=a)},select:function(a){"default"===a&&(a=this.defaultKey||"default");var b=this,c='li[data-name="'+a+'"]',d=b.el.querySelector(c);d?(b.selected=a,b.setDisplayHtml(d.textContent)):(b.selected=null,b.setDisplayHtml(a))},onClick:function(a){var b,c=this,e=d.findParent(a.target,".combo-item"),f=c.el,g=f.querySelector(".combo-list"),h=f.classList;h.contains("activated")?(h.remove("activated"),g.style.right=""):(h.add("activated"),b=g.getBoundingClientRect(),b.right>window.document.documentElement.offsetWidth&&(g.style.right="0")),e&&c.onItemClick(e)},onItemClick:function(a){var b=this,c=a.dataset.name;b.select(c),b.items[c].click()},onDocumentClick:function(a){var b=this,c=d.findParent(a.target,".combo-box");c!==b.el&&b.el.classList.remove("activated")}})}({}),yne_ytable_editor_views_ButtonComboView=function(a){var b=yne_ytable_editor_views_ComboBoxView,c=yne_ytable_editor_utils_TableUtils;return b.extend({className:"combo-box button-combo",renderOptions:{button:!0},setCurrent:function(a){var b=this,c="button-"+b.current,d="button-"+a,e=b.el.querySelector(".button");b.current=a,e&&(e.classList.remove(c),e.classList.add(d))},setDisplayHtml:function(){},hideText:function(){var a=this,b=a.el.querySelector(".button-text");b&&(b.style.display="none")},showText:function(){var a=this,b=a.el.querySelector(".button-text");b&&(b.style.display="inline-block")},setText:function(a){var b=this,c=b.el.querySelector(".button-text");b.options.text=a,c&&(a?(c.innerText=a,b.showText()):(c.innerText="",b.hideText()))},onClick:function(a){var d=this,e=c.findParent(a.target,".button-wrapper");e?d.onButtonClick():b.prototype.onClick.apply(d,arguments)},onItemClick:function(a){var c=this,d=a.dataset.name;c.setCurrent(d),b.prototype.onItemClick.apply(c,arguments)},onButtonClick:function(){var a=this,b=a.current;b&&a.items[b]&&a.items[b].click()}})}({}),yne_ytable_editor_views_ColorComboView=function(a){var b=yne_ytable_editor_views_ButtonComboView;return b.extend({className:"combo-box button-combo color-combo",renderOptions:{button:!0,color:!0},setCurrent:function(a){var c=this,d=c.el.querySelector(".current-color");d&&(d.style.backgroundColor=c.options.colors[a]),b.prototype.setCurrent.apply(c,arguments)}})}({}),yne_ytable_editor_views_TableComboView=function(a){var b=yne_ytable_editor_views_ButtonComboView;return b.extend({className:"combo-box button-combo",renderOptions:{button:!0},setCurrent:function(){var a=this;b.prototype.setCurrent.apply(a,arguments)}})}({}),yne_ytable_editor_views_MoreComboView=function(a){var b=yne_ytable_editor_views_ControlView,c=yne_ytable_templates_jst,d=yne_ytable_tools_core_underscore;return b.extend({className:"combo-box combo-more",template:c.getTemplate("plugins","combo_more"),renderOptions:{},initialize:function(a){var b=this;b.editor=a.editor,b.name=a.name,b.tag=a.tag,b.options=a,d.bindAll(b,"onClick","onDocumentClick"),b.el.addEventListener("click",b.onClick),document.addEventListener("click",b.onDocumentClick)},render:function(){var a=this,b=a.tag;a.el.classList.add("combo-"+a.name),a.el.title=b,a.el.innerHTML=a.template({name:a.name,text:a.options.text}),a.$menuWrapperEl=a.$el.find(".combo-more-wrapper")},showMenu:function(){var a=this,b=a.$menuWrapperEl;b.addClass("show")},hideMenu:function(){var a=this,b=a.$menuWrapperEl;b.removeClass("show")},toggleMenu:function(){var a=this,b=a.$menuWrapperEl;b.toggleClass("show")},onClick:function(a){var b=this;return a.stopPropagation(),"更多"===a.target.innerHTML?b.toggleMenu():void b.showMenu()},onDocumentClick:function(){var a=this;a.hideMenu()}})}({}),yne_ytable_editor_core_Toolbar=function(a){var b=yne_ytable_tools_core_EventClass,c=yne_ytable_editor_views_SplitView,d=yne_ytable_editor_views_ButtonView,e=yne_ytable_editor_views_ComboBoxView,f=yne_ytable_editor_views_ButtonComboView,g=yne_ytable_editor_views_ColorComboView,h=yne_ytable_editor_views_TableComboView,i=yne_ytable_editor_views_MoreComboView,j=yne_underscore,k=yne_jquery;return b.extend({initialize:function(a){var b=this;b.editor=a.editor,k(window).on("resize",function(){j.each(b.items,function(a){b.$toolbar.append(a)}),b.shrink.call(b)})},_getView:function(){var a=this;return a.editor.getView().toolbarView},addControl:function(a){var b=this;switch(a.type){case"button":return b.addButton(a);case"split":return b.addSplit();case"combo":return b.addComboBox(a);case"button-combo":return b.addButtonCombo(a);case"color-combo":return b.addColorCombo(a);case"table-combo":return b.addTableCombo(a);case"more-combo":return b.addMoreCombo(a)}},addColorCombo:function(a){var b=this,c=b._getView(),d=new g(a);return c.addView(d),d},addTableCombo:function(a){var b=this,c=b._getView(),d=new h(a);return c.addView(d),d},addButtonCombo:function(a){var b=this,c=b._getView(),d=new f(a);return c.addView(d),d},addComboBox:function(a){var b=this,c=b._getView(),d=new e(a);return c.addView(d),d},addSplit:function(){var a=this,b=a._getView(),d=new c;return b.addView(d),d},addButton:function(a){var b=this,c=b._getView(),e=new d(a);return c.addView(e),e},addMoreCombo:function(a){var b=this,c=b._getView(),d=new i(a);return c.addView(d),d},show:function(){var a=this,b=a._getView();setTimeout(a.shrink.bind(a),0),b.$el.show()},hide:function(){var a=this,b=a._getView();b.$el.hide()},reset:function(a,b,c){var d;j.map(c,function(b){a.append(b)}),a.children().length>0?(d=b.prev(),"toolbar_split"===d.attr("class")?d.hide():d.show(),b.show()):b.hide()},shrink:function(){var a=this,b=a._getView(),c=b.$el.children(),d=c.children(),e=c.find(".combo-more"),f=e.find(".combo-more-list"),g=e.outerWidth(!0),h=k(".toolbar-wrapper").width(),i=g;a.items||(a.items=d),a.$toolbar=c,a.moreItems=[],j.map(d,function(b,c){return k(b).show(),c===d.length-1?void a.reset(f,e,a.moreItems):(i+=k(b).outerWidth(!0),void(i>h&&a.moreItems.push(b)))})},mountTo:function(a,b){var c=this,d=c._getView(),e=d.$el;a&&e.get(0).parentNode!==a&&(b===!0?e.detach().prependTo(a):e.detach().appendTo(a))}})}({}),yne_ytable_editor_core_Commander=function(a){var b=yne_ytable_tools_core_EventClass,c=yne_ytable_tools_web_console,d=yne_ytable_tools_core_underscore;return b.extend({initialize:function(a){var b=this;b.editor=a.editor,b.undoStack=[],b.redoStack=[],b.compondCmdList=null,b.compondLevel=0},beginCompond:function(){var a=this;a.compondLevel++,a.isCompond()||(a.compondCmdList=[])},endCompond:function(){var a,b,c=this,d=c.editor.getCommandFactory();c.isCompond()&&(c.compondLevel--,c.compondLevel>0||(a=c.compondCmdList,c.compondCmdList=null,a.length>1?(b=d.create("CustomCommand",{cmdList:a}),c._exec(b,!0,!1)):1===a.length&&(b=a[0],c._exec(b,!0,!1))))},endCompondImmediately:function(){window.console.assert(!1,"beginCompond and endCompond should be called synchronously.");var a,b,c=this,d=c.editor.getCommandFactory();c.isCompond()&&(a=c.compondCmdList,c.compondCmdList=null,c.compondLevel=0,a.length>0&&(b=d.create("CustomCommand",{cmdList:a}),c._exec(b,!0,!1)))},isCompond:function(){return!!this.compondCmdList},_registerUndo:function(a){var b,c,d=this,e=d.editor,f=e.getSelection(),g=a.getRange(e);g?(b=g.getRect(),c={row:b.top,col:b.left}):(g=f.getFirstRange(),c=f.getActiveCell()),d.undoStack.push({command:a,cell:c,range:g}),d.redoStack=[]},_clearUndo:function(){var a=this;a.undoStack=[],a.redoStack=[]},_exec:function(a,b,d){var e=this,f=e.editor;if(f.locked)return!1;if(b=!!b,b&&!d?e._registerUndo(a):d||e._clearUndo(),c.DEBUG)a.action();else try{a.action()}catch(g){c.error("Command Action Error",g)}return e._triggerCommand(a,b),!0},_triggerCommand:function(a,b){var c=this;d.defer(function(){c.trigger("commandExec",a,b)}),c.trigger("sendCommand",a,b)},exec:function(a,b,c){var d=this;b&&!c&&d.isCompond()?d.compondCmdList.push(a):d.isCompond()?(d.endCompondImmediately(),c||d._exec(a,b,c)):d._exec(a,b,c),c||d.trigger("execute-command")},undo:function(){var a,b,c,d,e,f=this,g=f.editor,h=g.getSelection();f.canUndo()&&!g.locked&&(a=f.undoStack.pop(),b=a.command,c=b.getReversed(),f.exec(c,!0,!0),d=a.cell,e=a.range,d&&e&&h.select(d.row,d.col,e),f.redoStack.push(a))},canUndo:function(){return 0!==this.undoStack.length},redo:function(){var a,b,c,d,e=this,f=e.editor,g=f.getSelection();e.canRedo()&&!f.locked&&(a=e.redoStack.pop(),b=a.command,e.exec(b,!0,!0),c=a.cell,d=a.range,c&&d&&g.select(c.row,c.col,d),e.undoStack.push(a))},canRedo:function(){return 0!==this.redoStack.length}})}({}),yne_ytable_editor_commands_CommandFactory=function(a){var b=yne_ytable_tools_web_console,c={},d=function(a){this.editor=a};return d.register=function(a){var d=a.prototype.name;return c[d]?void b.error("The command class `"+d+"` is already registed!"):void(c[d]=a)},d.create=function(a,d,e){var f=c[a];return f||(b.error("no command class: "+a),f=c.NoOp),new f({table:d,args:e})},d.prototype.create=function(a,b){return d.create(a,this.editor.getTable(),b)},d}({}),yne_ytable_editor_commands_CommandHelper=function(a){var b=yne_ytable_tools_core_Class,c=yne_ytable_tools_web_console,d=yne_ytable_tools_core_underscore;return b.extend({initialize:function(a){var b=this;b.editor=a.editor},fixRange:function(a){var b=this,c=b.editor,e=c.getTable(),f={};if(d.isNumber(a.left)&&d.isNumber(a.right)){if(a.left>=e.MAX_COLUMN_COUNT)return null;if(f.left=a.left,a.right>e.MAX_COLUMN_COUNT?f.right=e.MAX_COLUMN_COUNT:f.right=a.right,f.right<=f.left)return null}if(d.isNumber(a.top)&&d.isNumber(a.bottom)){if(a.top>=e.MAX_ROW_COUNT)return null;if(f.top=a.top,a.bottom>e.MAX_ROW_COUNT?f.bottom=e.MAX_ROW_COUNT:f.bottom=a.bottom,f.bottom<=f.top)return null}return c.createRange(f)},setCellValueAt:function(a,b,c){var d=this,e=d.editor,f=e.getTable(),g=e.getCommandFactory(),h=e.getCommander();a>=f.MAX_ROW_COUNT||b>=f.MAX_COLUMN_COUNT||h.exec(g.create("SetCellValue",{row:a,col:b,value:c}),!0)},setCellValueWithUriRec:function(a,b,c,e){var f=this,g=f.editor.getCommander(),h=/^(https?:\/\/|www\.|ssh:\/\/|ftp:\/\/)[^\s]+$/i,i=/^[a-z0-9_+\-\.]+@[a-z0-9_+\-\.]+$/i,j=/<[^><]*href='?"?([^<>'\"]*)"?'?[^><]*>/,k=null;e&&e.match(j)?k=e.match(j)[1]:c?h.test(c)?(k=c,"www."===k.substr(0,4)&&(k="http://"+k)):i.test(c)&&(k="mailto:"+c):k="",g.beginCompond(),d.isString(k)&&f.addCellStylesAt(a,b,{link:k}),f.setCellValueAt(a,b,c),g.endCompond()},addCellStylesAt:function(a,b,c){var d=this,e=d.editor,f=e.getTable(),g=e.getCommandFactory(),h=e.getCommander();a>=f.MAX_ROW_COUNT||b>=f.MAX_COLUMN_COUNT||h.exec(g.create("SetCellStyles",{row:a,col:b,styles:c}),!0)},setCellStylesAt:function(a,b,c){var d=this,e=d.editor,f=e.getTable(),g=e.getCommandFactory(),h=e.getCommander();a>=f.MAX_ROW_COUNT||b>=f.MAX_COLUMN_COUNT||(h.beginCompond(),h.exec(g.create("ClearCellStyles",{row:a,col:b}),!0),d.addCellStylesAt(a,b,c),h.endCompond())},setCellAttributesAt:function(a,b,c){var d=this,e=d.editor,f=e.getTable(),g=e.getCommandFactory(),h=e.getCommander();a>=f.MAX_ROW_COUNT||b>=f.MAX_COLUMN_COUNT||h.exec(g.create("SetCellAttributes",{row:a,col:b,attrs:c}),!0)},clearRangeData:function(a){var b=this,c=b.editor,d=c.getCommandFactory(),e=c.getCommander();a=b.fixRange(a),a&&e.exec(d.create("DelRangeValue",{range:a}),!0)},setRangeValue:function(a,b){var c=this,d=c.editor,e=d.getCommandFactory(),f=d.getCommander();a=c.fixRange(a),a&&f.exec(e.create("SetRangeValue",{range:a,value:b||""}),!0)},clearSelectionData:function(){var a=this,b=a.editor,c=b.getSelection();c.forEachRange(function(b){a.clearRangeData(b)})},clearRangeStyles:function(a){var b=this,d=b.editor,e=d.getCommandFactory(),f=d.getCommander();c.log("clearRangeStyles range before fix",a+""),a=b.fixRange(a),a&&(c.log("clearRangeStyles range",a+""),f.exec(e.create("ClearRangeStyles",{range:a}),!0))},setRangeStyles:function(a,b){var c=this,d=c.editor,e=d.getCommandFactory(),f=d.getCommander();a=c.fixRange(a),a&&f.exec(e.create("SetRangeStyles",{range:a,styles:b||{}}),!0)},clearSelectionStyles:function(){var a=this,b=a.editor,c=b.getSelection(),d=b.getCommander();d.beginCompond(),c.forEachRange(function(b){a.clearRangeStyles(b)}),d.endCompond()},setRowHeight:function(a,b){var c=this,d=c.editor,e=d.getTable(),f=d.getCommandFactory(),g=d.getCommander();a>=e.MAX_ROW_COUNT||g.exec(f.create("SetRowHeight",{row:a,height:b}),!0)},setColumnWidth:function(a,b){var c=this,d=c.editor,e=d.getTable(),f=d.getCommandFactory(),g=d.getCommander();a>=e.MAX_COLUMN_COUNT||g.exec(f.create("SetColumnWidth",{col:a,width:b}),!0)},insertRow:function(a,b){var c=this,d=[];d.length=b>1?b:1,c.insertRows(a,d)},insertRows:function(a,b,c){var d=this,e=d.editor,f=e.getCommander(),g=e.getCommandFactory();
f.exec(g.create("InsertRows",{row:a,rowDataList:b,rowHeightList:c}),!0)},deleteRows:function(a,b){var c=this,d=c.editor,e=d.getCommander(),f=d.getCommandFactory();e.exec(f.create("DeleteRows",{row:a,count:b,editor:d}),!0)},insertColumn:function(a,b){var c=this,d=[];d.length=b,c.insertColumns(a,d)},insertColumns:function(a,b,c){var d=this,e=d.editor,f=e.getCommander(),g=e.getCommandFactory();f.exec(g.create("InsertColumns",{col:a,colDataList:b,colWidthList:c}),!0)},deleteColumns:function(a,b){var c=this,d=c.editor,e=d.getCommander(),f=d.getCommandFactory();e.exec(f.create("DeleteColumns",{col:a,count:b,editor:d}),!0)}})}({}),yne_ytable_editor_core_Clipboard=function(a){var b=yne_ytable_tools_core_EventClass,c=yne_ytable_tools_core_underscore,d=yne_ytable_editor_utils_TableUtils;return b.extend({initialize:function(a){var b=this,d=a.editor;b.editor=d,b.reset(),c.bindAll(b,"onCommandExec"),d.onCommander("commandExec",b.onCommandExec)},reset:function(){var a=this;a.status="none",a.range=null,a.data=null,a.trigger("change",a)},canPaste:function(){var a=this.status,b=this.range;return b&&("copy"===a||"cut"===a)},getRange:function(){return this.range},mark:function(){var a=this,b=a.editor,c=b.getSelection(),d=c.getFirstRange();a.range=d,a.data=a.extractData()},copy:function(){var a=this;a.mark(),a.status="copy",a.trigger("change",a)},cut:function(){var a=this;a.mark(),a.status="cut",a.trigger("change",a)},paste:function(a,b,c){if(!this.editor.locked&&this.range){b||(b=0),c||(c=0);var d,e=this,f=e.editor,g=e.range,h=g.getRect(),i=f.getSelection(),j=i.getFirstRange(),k=j.getRect(),l=0>=b?h.bottom-h.top:b,m=0>=c?h.right-h.left:c,n={top:k.top,left:k.left,bottom:k.top+l,right:k.left+m},o=e.data,p=1===o.length&&o[0]&&1===o[0].length,q=p?j:f.createRange(n),r=f.getCommandHelper(),s=f.getCommander();s.beginCompond(),"cut"===e.status&&(r.clearRangeData(g),a||r.clearRangeStyles(g)),p?(d=o[0][0],d&&(r.setRangeValue(q,d.value),a||r.setRangeStyles(q,d.styles))):q.forEachReversed(function(b,c){var d=b-n.top,e=c-n.left,f=o[d][e];f&&(r.setCellValueAt(b,c,f.value),r.setCellAttributesAt(b,c,f),a||r.setCellStylesAt(b,c,f.styles))}),s.endCompond(),i.select(n.top,n.left,q),"cut"===e.status&&e.reset()}},extractData:function(){if(!this.range)return null;var a=this,b=a.range,c=b.getRect(),d=c.top,e=c.left,f=[],g=a.editor,h=g.getTable();return b.forEach(function(a,b){var c=a-d,g=b-e;f[c]||(f[c]=[]),f[c][g]=h.copyCell(a,b)}),f},extractJson:function(){if(!this.range)return null;var a=this,b=a.range,d=a.editor,e=d.getTable(),f={widths:[],heights:[],cells:[]};return b.forEachColumn(function(a){f.widths.push(e.getColumnWidth(a))}),b.forEachRow(function(a){f.heights.push(e.getRowHeight(a))}),b.forEach(function(a,b){var d=e.getAttributesAt(a,b),g={};c.extend(g,d),e.isMergedCell(a,b)||(c.extend(g,e.getStylesAt(a,b)),g.value=e.getValueAt(a,b)),f.cells.push(g)}),f},extractContents:function(){if(!this.range)return null;var a=this,b=a.range,c=document.createElement("table"),e={},f=0,g=a.editor,h=g.getTable();return c.setAttribute("cellspacing","0"),c.setAttribute("cellpadding","0"),c.setAttribute("border","1"),c.setAttribute("style","table-layout:fixed;border-collapse:collapseborder:1px solid #ccc"),b.forEachRow(function(a){e[a]=c.insertRow(f++)}),b.forEach(function(a,b){if(!h.isMergedCell(a,b)){var c,f=e[a],g=document.createElement("td"),i=h.getValueAt(a,b),j=h.getStylesAt(a,b),k=h.getAttributesAt(a,b);c=k.mergeWidth,c&&c>1&&g.setAttribute("colspan",c),c=k.mergeHeight,c&&c>1&&g.setAttribute("rowspan",c),d.setElementStyles(g,j),d.setElementText(g,i,j),f.appendChild(g.cloneNode(!0))}}),{html:c.outerHTML,text:c.innerText}},onCommandExec:function(a,b){if(this.range&&"SetColumnWidth"!==b.name&&"SetRowHeight"!==b.name){var c=b.getRange(this.editor);c&&this.reset()}}})}({}),yne_ytable_editor_core_Range=function(a){var b,c=yne_ytable_tools_core_underscore,d=yne_ytable_tools_core_Class,e=yne_ytable_tools_web_console,f=function(a,b){var c;return a.x>b.x&&(c=a,a=b,b=c),a.y>b.x};return b=d.extend({TYPE:{NORMAL:0,COLUMNS:1,ROWS:2,ALL:3},initialize:function(a){a=a||{};var b=this;delete b.options,b.editor=a.editor,b.setRange(a)},setRange:function(a){var d=this,e=function(b){return c.isNumber(a[b])},f=function(b){c.each(b,function(b){d[b]=a[b]})};c.every(b.SIDES,e)?(d.type=d.TYPE.NORMAL,f(b.SIDES),d._fixMerge()):c.every(b.COL_SIDES,e)?(d.type=d.TYPE.COLUMNS,f(b.COL_SIDES)):c.every(b.ROW_SIDES,e)?(d.type=d.TYPE.ROWS,f(b.ROW_SIDES)):d.type=d.TYPE.ALL},_fixMerge:function(){var a=this;a.type===a.TYPE.NORMAL&&(a._walkedCells={},a._mergeFixing(),delete a._walkedCells)},_mergeFixing:function(){var a,b,c,d,f=this,g=f.editor.getTable(),h=f.top,i=f.left,j=f.bottom-1,k=f.right-1,l=!1;for(a=h;j>=a;a++){for(l=!1,b=i;k>=b;b++)if(d=a+","+b,!f._walkedCells[d]&&(f._walkedCells[d]=!0,c=g.getAttributesAt(a,b),c.mergeWidth>1||c.mergeHeight>1?(d=a+(c.mergeHeight||1),e.log("rowEnd: "+j+","+d),d>j&&(l=!0,f.bottom=d),d=b+(c.mergeWidth||1),d>k&&(l=!0,f.right=d)):null!=c.mergePointDX&&(a-=c.mergePointDY,b-=c.mergePointDX,c=g.getAttributesAt(a,b),h>a&&(l=!0,f.top=a),d=a+(c.mergeHeight||1),e.log("rowEnd: "+j+","+d),d>j&&(l=!0,f.bottom=d),i>b&&(l=!0,f.left=b),d=b+(c.mergeWidth||1),d>k&&(l=!0,f.right=d)),l)){f._markWalked(a,b,c.mergeWidth||1,c.mergeHeight||1);break}if(l)break}l&&f._mergeFixing()},_markWalked:function(a,b,c,d){var e,f,g=this,h=g._walkedCells;for(e=0;d>e;e++)for(f=0;c>f;f++)h[a+e+","+(b+f)]=!0},isValid:function(){var a=this,d=!0,e=function(b){b.forEach(function(b){d=d&&c.isNumber(a[b])})};if(a.type===a.TYPE.NORMAL)e(b.SIDES),d=d&&a.left<a.right,d=d&&a.top<a.bottom;else if(a.type===a.TYPE.COLUMNS)e(b.COL_SIDES),d=d&&a.left<a.right;else{if(a.type!==a.TYPE.ROWS)return a.type===a.TYPE.ALL?!0:!1;e(b.ROW_SIDES),d=d&&a.top<a.bottom}return d},forEach:function(a){if(this.isValid()){var b,c,d=this,e=this.editor.getTable(),f=d.left||0,g=d.right||e.getColumnCount(),h=d.top||0,i=d.bottom||e.getRowCount();for(b=h;i>b;++b)for(c=f;g>c;++c)a(b,c)}},forEachReversed:function(a){if(this.isValid()){var b,c,d=this,e=this.editor.getTable(),f=d.left||0,g=d.right||e.getColumnCount(),h=d.top||0,i=d.bottom||e.getRowCount();for(b=i-1;b>=h;--b)for(c=g-1;c>=f;--c)a(b,c)}},forEachRow:function(a){if(this.isValid()){var b,c=this,d=this.editor.getTable(),e=c.top||0,f=c.bottom||d.getRowCount();for(b=e;f>b;++b)a(b)}},forEachColumn:function(a){if(this.isValid()){var b,c=this,d=this.editor.getTable(),e=c.left||0,f=c.right||d.getColumnCount();for(b=e;f>b;++b)a(b)}},getRect:function(){if(this.isValid()){var a=this,b=this.editor.getTable(),c=a.left||0,d=a.right||b.getColumnCount(),e=a.top||0,f=a.bottom||b.getRowCount();return{top:e,right:d,bottom:f,left:c}}},overlaps:function(a){var b=this,c=b.getRect(),d=a.getRect();return f({x:c.left,y:c.right},{x:d.left,y:d.right})&&f({x:c.top,y:c.bottom},{x:d.top,y:d.bottom})},equals:function(a){var b=this;if(b.type!==a.type)return!1;switch(b.type){case b.TYPE.NORMAL:return b.left===a.left&&b.right===a.right&&b.top===a.top&&b.bottom===a.bottom;case b.TYPE.ROWS:return b.top===a.top&&b.bottom===a.bottom;case b.TYPE.COLUMNS:return b.left===a.left&&b.right===a.right;case b.TYPE.ALL:return!0;default:return!1}},onlyOneCell:function(){var a=this;return a.type===a.TYPE.NORMAL&&a.right===a.left+1&&a.bottom===a.top+1},isMerge:function(){var a=this,b=a.editor.getTable();return b.isMergeRange(a)},clone:function(){var a,d=this,e={editor:d.editor};return c.each(b.SIDES,function(a){var b=d[a];null!=b&&(e[a]=b)}),a=new b(e)},toJSON:function(){var a=this,d={};return c.each(b.SIDES,function(b){var c=a[b];null!=c&&(d[b]=c)}),d},toString:function(){var a=this,d=c.map(b.SIDES,function(b){return b+":"+a[b]});return d.join(",")}},{COL_SIDES:["left","right"],ROW_SIDES:["top","bottom"],SIDES:["left","right","top","bottom"]})}({}),yne_ytable_editor_commands_Command=function(a){var b=yne_ytable_tools_core_Class,c=yne_ytable_tools_core_underscore;return b.extend({name:"UnknownCommand",isSimple:!1,isComposite:!1,getRange:function(a){var b=this,d=b.args;return c.isObject(d)?c.isObject(d.range)?d.range:c.isNumber(d.row)&&c.isNumber(d.col)?a.createRange({left:d.col,top:d.row,right:d.col+1,bottom:d.row+1}):c.isNumber(d.row)?a.createRange({top:d.row,bottom:d.row+1}):c.isNumber(d.col)?a.createRange({left:d.col,right:d.col+1}):null:null},action:function(){throw"Command action undefined: "+this.name},getReversed:function(){throw"Command reverse undefined: "+this.name}})}({}),yne_ytable_editor_commands_SimpleCommand=function(a){var b=yne_ytable_editor_commands_Command;return b.extend({name:"UnknownSimpleCommand",isSimple:!0,initialize:function(a){this.table=a.table,this.args=a.args,this.action=this.action.bind(this,a.args)},query:function(){return!1}})}({}),yne_ytable_editor_commands_NoOp=function(a){var b,c=yne_ytable_editor_commands_SimpleCommand,d=yne_ytable_editor_commands_CommandFactory;return b=c.extend({name:"NoOp",initialize:function(){this.constructor.__super__.initialize.apply(this,arguments)},action:function(){},getReversed:function(){return this},query:function(){return!1}}),d.register(b),b}({}),yne_ytable_editor_commands_SetCellValue=function(a){var b,c=yne_ytable_editor_commands_SimpleCommand,d=yne_ytable_editor_commands_CommandFactory;return b=c.extend({name:"SetCellValue",initialize:function(){this.constructor.__super__.initialize.apply(this,arguments)},action:function(){var a=this,b=a.args,c=a.table;a.oldValue=c.getValueAt(b.row,b.col),c.setValueAt(b.row,b.col,b.value)},getReversed:function(){var a=this,c=a.args;return new b({table:a.table,args:{row:c.row,col:c.col,value:a.oldValue}})},query:function(){var a=this,b=a.args,c=a.table,d=c.getValueAt(b.row,b.col);return d===b.value}}),d.register(b),b}({}),yne_ytable_editor_commands_SetCellStyle=function(a){var b,c=yne_ytable_editor_commands_SimpleCommand,d=yne_ytable_editor_commands_CommandFactory;return b=c.extend({name:"SetCellStyle",initialize:function(){this.constructor.__super__.initialize.apply(this,arguments)},action:function(){var a=this,b=a.args,c=a.table,d={},e=b.style.key,f=b.style.value;return a.oldValue=c.getStylesAt(b.row,b.col)[e]||"",d[e]=f,c.addStylesAt(b.row,b.col,d),!0},getReversed:function(){var a=this,c=a.args;return new b({table:a.table,args:{row:c.row,col:c.col,style:{key:c.style.key,value:a.oldValue}}})},query:function(){var a=this,b=a.args,c=a.table,d=c.getStylesAt(b.row,b.col);return d[b.style.key]===b.style.value}}),d.register(b),b}({}),yne_ytable_editor_commands_CompositeCommand=function(a){var b=yne_ytable_editor_commands_Command,c=yne_ytable_tools_core_underscore,d=yne_ytable_editor_commands_CommandFactory;return b.extend({name:"UnknownCompositeCommand",isComposite:!0,initialize:function(a){this.table=a.table,this.args=a.args,this.action=this.action.bind(this,a.args)},action:function(){var a=this;c.each(a.getSubCommands(),function(a){a.action()})},getReversed:function(){var a,b=this,c=[],e=b.getSubCommands();for(a=e.length-1;a>=0;--a)c.push(e[a].getReversed());return d.create("CustomCommand",b.table,{cmdList:c})},getSubCommands:function(){var a=this;if(c.isArray(a.cmdSeq))return a.cmdSeq;if(a.getCommandSequence)return a.cmdSeq=a.getCommandSequence(),a.user&&c.each(a.cmdSeq,function(b){b.user=a.user}),a.cmdSeq;throw"Command action undefined: "+a.name},query:function(){var a=this.getSubCommands(),b=!0;return c.all(a,function(a){return b=b&&a.query()}),b}})}({}),yne_ytable_editor_commands_SetCellStyles=function(a){var b,c=yne_ytable_editor_commands_CompositeCommand,d=yne_ytable_editor_commands_CommandFactory,e=yne_ytable_tools_core_underscore;return b=c.extend({name:"SetCellStyles",initialize:function(){this.constructor.__super__.initialize.apply(this,arguments)},getCommandSequence:function(){var a=this,b=a.args,c=[];return e.each(b.styles,function(e,f){c.push(d.create("SetCellStyle",a.table,{row:b.row,col:b.col,style:{key:f,value:e}}))}),c}}),d.register(b),b}({}),yne_ytable_editor_commands_SetCellAttribute=function(a){var b,c=yne_ytable_editor_commands_SimpleCommand,d=yne_ytable_editor_commands_CommandFactory;return b=c.extend({name:"SetCellAttribute",initialize:function(){this.constructor.__super__.initialize.apply(this,arguments)},action:function(){var a=this,b=a.args,c=a.table,d=b.name,e=b.value;return a.oldValue=c.getAttributeAt(b.row,b.col,d),c.setAttributeAt(b.row,b.col,d,e),!0},getReversed:function(){var a=this,c=a.args;return new b({table:a.table,args:{row:c.row,col:c.col,name:c.name,value:a.oldValue}})},query:function(){var a=this,b=a.args,c=a.table,d=c.getAttributeAt(b.row,b.col,b.name);return d===b.value}}),d.register(b),b}({}),yne_ytable_editor_commands_SetCellAttributes=function(a){var b,c=yne_ytable_editor_commands_CompositeCommand,d=yne_ytable_editor_commands_CommandFactory,e=yne_ytable_tools_core_underscore;return b=c.extend({name:"SetCellAttributes",initialize:function(){this.constructor.__super__.initialize.apply(this,arguments)},getCommandSequence:function(){var a=this,b=a.args,c=b.attrs,f=[],g=["mergeWidth","mergeHeight","mergePointDX","mergePointDY"];return e.each(g,function(e){var g=c[e];f.push(d.create("SetCellAttribute",a.table,{row:b.row,col:b.col,name:e,value:g}))}),f}}),d.register(b),b}({}),yne_ytable_editor_commands_SetRangeValue=function(a){var b,c=yne_ytable_editor_commands_CompositeCommand,d=yne_ytable_editor_commands_CommandFactory;return b=c.extend({name:"SetRangeValue",initialize:function(){this.constructor.__super__.initialize.apply(this,arguments)},getCommandSequence:function(){var a=this,b=a.args,c=b.range,e=[];return c.forEach(function(c,f){e.push(d.create("SetCellValue",a.table,{row:c,col:f,value:b.value}))}),e}}),d.register(b),b}({}),yne_ytable_editor_commands_SetRangeStyle=function(a){var b,c=yne_ytable_editor_commands_SimpleCommand,d=yne_ytable_editor_commands_CommandFactory;return b=c.extend({name:"SetRangeStyle",initialize:function(){this.constructor.__super__.initialize.apply(this,arguments)},action:function(){var a,b=this,c=b.args,d=c.range,e=b.table,f={},g=c.style.key,h=c.style.value;f[g]=h,b.oldValues=a={},d.forEach(function(b,c){var d=b+" "+c;a[d]=e.getStylesAt(b,c)[g]||"",e.addStylesAt(b,c,f)})},getReversed:function(){var a=this,b=a.args,c=b.range,e=a.table,f=b.style.key,g=a.oldValues,h=[];return c.forEach(function(a,b){var c=a+" "+b,i=g[c];h.push(d.create("SetCellStyle",e,{row:a,col:b,style:{key:f,value:i}}))}),h.length>0?d.create("CustomCommand",e,{cmdList:h}):d.create("NoOp")},query:function(){var a=this,b=a.args,c=b.range,d=a.table,e=b.style.key,f=b.style.value,g=!0;return c.forEach(function(a,b){var c=d.getStylesAt(a,b);d.isMergedCell(a,b)||(g=g&&c[e]===f)}),g}}),d.register(b),b}({}),yne_ytable_editor_commands_SetRangeStyles=function(a){var b,c=yne_ytable_editor_commands_CompositeCommand,d=yne_ytable_editor_commands_CommandFactory,e=yne_ytable_tools_core_underscore;return b=c.extend({name:"SetRangeStyles",initialize:function(){this.constructor.__super__.initialize.apply(this,arguments)},getCommandSequence:function(){var a=this,b=a.args,c=b.range,f=[];return e.each(b.styles,function(b,e){f.push(d.create("SetRangeStyle",a.table,{range:c,style:{key:e,value:b}}))}),f}}),d.register(b),b}({}),yne_ytable_editor_commands_ToggleRangeMerge=function(a){var b,c=yne_ytable_editor_commands_CompositeCommand,d=yne_ytable_editor_commands_CommandFactory;return b=c.extend({name:"ToggleRangeMerge",initialize:function(){this.constructor.__super__.initialize.apply(this,arguments)},getCommandSequence:function(){var a,b,c,e,f=this,g=f.args,h=f.table,i=g.range,j=i.top,k=i.bottom,l=i.left,m=i.right,n=[],o={},p=!1;if(i.type!==i.TYPE.NORMAL||i.onlyOneCell())return n;for(c=i.isMerge(),a=j;k>a;a++)for(b=l;m>b;b++)a===j&&b===l?(o=c?{mergeWidth:null,mergeHeight:null}:{mergeWidth:m-l,mergeHeight:k-j},c||(p=!h.getValueAt(a,b))):(c||!p||e||h.getValueAt(a,b)&&(e=h.copyCell(a,b)),o=c?{mergePointDX:null,mergePointDY:null}:{mergePointDX:b-l,mergePointDY:a-j},n.push(d.create("SetCellValue",h,{row:a,col:b,value:""})),n.push(d.create("ClearCellStyles",h,{row:a,col:b}))),n.push(d.create("SetCellAttributes",h,{row:a,col:b,attrs:o}));return!c&&e&&(n.push(d.create("SetCellValue",h,{row:j,col:l,value:e.value})),n.push(d.create("SetCellStyles",h,{row:j,col:l,styles:e.styles}))),n}}),d.register(b),b}({}),yne_ytable_editor_commands_SetColumnWidth=function(a){var b,c=yne_ytable_editor_commands_SimpleCommand,d=yne_ytable_editor_commands_CommandFactory;return b=c.extend({name:"SetColumnWidth",initialize:function(){this.constructor.__super__.initialize.apply(this,arguments)},action:function(){var a=this,b=a.args,c=a.table;a.oldWidth=c.getColumnWidth(b.col),c.setColumnWidth(b.col,b.width)},getReversed:function(){var a=this,c=a.args;return new b({table:a.table,args:{col:c.col,width:a.oldWidth}})},query:function(){var a=this,b=a.args,c=a.table,d=c.getColumnWidth(b.col);return d===b.width}}),d.register(b),b}({}),yne_ytable_editor_commands_SetRowHeight=function(a){var b,c=yne_ytable_editor_commands_SimpleCommand,d=yne_ytable_editor_commands_CommandFactory;return b=c.extend({name:"SetRowHeight",initialize:function(){this.constructor.__super__.initialize.apply(this,arguments)},action:function(){var a=this,b=a.args,c=a.table;a.oldHeight=c.getRowHeight(b.row),c.setRowHeight(b.row,b.height)},getReversed:function(){var a=this,c=a.args;return new b({table:a.table,args:{row:c.row,height:a.oldHeight}})},query:function(){var a=this,b=a.args,c=a.table,d=c.getRowHeight(b.row);return d===b.height}}),d.register(b),b}({}),yne_ytable_editor_commands_DelRangeValue=function(a){var b,c=yne_ytable_editor_commands_CompositeCommand,d=yne_ytable_editor_commands_CommandFactory;return b=c.extend({name:"DelRangeValue",initialize:function(){this.constructor.__super__.initialize.apply(this,arguments)},getCommandSequence:function(){var a=this,b=a.args,c=b.range,e=[];return e.push(d.create("SetRangeValue",a.table,{range:c,value:""})),e}}),d.register(b),b}({}),yne_ytable_editor_commands_ClearCellStyles=function(a){var b,c=yne_ytable_editor_commands_CompositeCommand,d=yne_ytable_tools_core_underscore,e=yne_ytable_editor_commands_CommandFactory;return b=c.extend({name:"ClearCellStyles",initialize:function(){this.constructor.__super__.initialize.apply(this,arguments)},getCommandSequence:function(){var a=this,b=a.args,c=a.table,f=c.getStylesAt(b.row,b.col),g={},h=[];return d.each(f,function(a,b){"border"!==b.substr(0,6)&&(g[b]="")}),h.push(e.create("SetCellStyles",c,{row:b.row,col:b.col,styles:g})),h}}),e.register(b),b}({}),yne_ytable_editor_commands_ClearRangeStyles=function(a){var b,c=yne_ytable_editor_commands_CompositeCommand,d=yne_ytable_editor_commands_CommandFactory,e=yne_ytable_tools_web_console;return b=c.extend({name:"ClearRangeStyles",initialize:function(){this.constructor.__super__.initialize.apply(this,arguments)},getCommandSequence:function(){var a=this,b=a.args,c=b.range,f=[];return e.log("ClearRangeStyles"),c.forEach(function(b,c){f.push(d.create("ClearCellStyles",a.table,{row:b,col:c}))}),f}}),d.register(b),b}({}),yne_ytable_editor_commands_CustomCommand=function(a){var b,c=yne_ytable_editor_commands_CompositeCommand,d=yne_ytable_tools_core_underscore,e=yne_ytable_editor_commands_CommandFactory;return b=c.extend({name:"CustomCommand",initialize:function(){this.constructor.__super__.initialize.apply(this,arguments)},getCommandSequence:function(){return this.args.cmdList},getRange:function(a){var b=this,c=b.args.cmdList,e=null;return d.each(c,function(b){var c=b.getRange(a),f=["left","right","top","bottom"];c&&(null===e?(e={},f.forEach(function(a){d.isNumber(c[a])&&(e[a]=c[a])})):f.forEach(function(a){d.isNumber(c[a])&&d.isNumber(e[a])?"left"===a||"top"===a?e[a]=Math.min(e[a],c[a]):e[a]=Math.max(e[a],c[a]):delete e[a]}))}),e?a.createRange(e):null}}),e.register(b),b}({}),yne_ytable_editor_commands_InsertRowOnly=function(a){var b,c=yne_ytable_editor_commands_SimpleCommand,d=yne_ytable_editor_commands_CommandFactory;return b=c.extend({name:"InsertRowOnly",initialize:function(){this.constructor.__super__.initialize.apply(this,arguments)},action:function(){var a=this,b=a.args,c=a.table;return c.insertRowOnly(b.row,b.rowData,b.rowHeight),!0},getReversed:function(){var a=this,b=a.args;return d.create("DeleteRowOnly",a.table,{row:b.row})}}),d.register(b),b}({}),yne_ytable_editor_commands_InsertRow=function(a){var b,c=yne_ytable_editor_commands_CompositeCommand,d=yne_ytable_editor_commands_CommandFactory;return b=c.extend({name:"InsertRow",initialize:function(){this.constructor.__super__.initialize.apply(this,arguments)},getCommandSequence:function(){var a,b,c,e=this,f=e.args,g=f.row,h=e.table,i=h.data,j=f.rowData||[],k=[];for(b=i.length,e._walkedCells={},a=0;b>a;a++)h.isMergedCell(g,a)&&(c=h.getAttributesAt(g,a),c.mergePointDX=c.mergePointDX||0,c.mergePointDY=c.mergePointDY||0,c.mergePointDY>0&&e._handleRowInsert(c,g,a,j,k));return e._walkedCells={},k.push(d.create("InsertRowOnly",h,{row:g,rowData:j,rowHeight:f.rowHeight})),k},_handleRowInsert:function(a,b,c,e,f){var g,h,i,j,k,l,m,n,o,p,q=this,r=q.table,s=b-a.mergePointDY,t=c-a.mergePointDX,u=b+","+c;if(!(q._walkedCells[u]||(h=a.mergePointDY,k=a.mergePointDX,1>h||0>k))){for(g=r.getAttributesAt(s,t),i=g.mergeHeight,l=g.mergeWidth,m=k;l>m;m++)for(p=c+m,n=e[p]||r.createCell(),n.mergePointDY=b-s,n.mergePointDX=p-t,delete n.mergeWidth,delete n.mergeHeight,e[p]=n,j=h;i>j;j++)o=b+j-h,p=c+m-k,q._walkedCells[o+","+p]=!0,f.push(d.create("SetCellAttribute",r,{row:o,col:p,name:"mergePointDY",value:o-s+1}));f.push(d.create("SetCellAttribute",r,{row:s,col:t,name:"mergeHeight",value:g.mergeHeight+1}))}}}),d.register(b),b}({}),yne_ytable_editor_commands_InsertRows=function(a){var b,c=yne_ytable_editor_commands_CommandFactory,d=yne_ytable_editor_commands_CompositeCommand;return b=d.extend({name:"InsertRows",initialize:function(){this.constructor.__super__.initialize.apply(this,arguments)},getCommandSequence:function(){var a,b=this,d=b.args,e=d.row||0,f=d.rowDataList||[],g=f.length,h=d.rowHeightList||[],i=[];for(a=g-1;a>=0;a--)i.push(c.create("InsertRow",b.table,{row:e,rowData:f[a],rowHeight:h[a]}));return i}}),c.register(b),b}({}),yne_ytable_editor_commands_DeleteRowOnly=function(a){var b,c=yne_ytable_editor_commands_SimpleCommand,d=yne_ytable_editor_commands_CommandFactory;return b=c.extend({name:"DeleteRowOnly",initialize:function(){this.constructor.__super__.initialize.apply(this,arguments)},action:function(){var a=this,b=a.args,c=b.row,d=a.table;return a._backupRow=d.copyRow(c),a._backupRowHeight=d.getRowHeight(c),d.deleteRowOnly(c),!0},getReversed:function(){var a=this,b=a.args;return d.create("InsertRowOnly",a.table,{row:b.row,rowData:a._backupRow,rowHeight:a._backRowHeight})}}),d.register(b),b}({}),yne_ytable_editor_commands_DeleteRow=function(a){var b,c=yne_ytable_editor_commands_CompositeCommand,d=yne_ytable_editor_commands_CommandFactory,e=yne_ytable_tools_web_console;return b=c.extend({name:"DeleteRow",initialize:function(){this.constructor.__super__.initialize.apply(this,arguments)},getCommandSequence:function(){var a,b,c,e,f=this,g=f.args,h=g.row,i=g.editor,j=f.table,k=j.data,l=k.length,m=[];if(!(h>=l)){for(a=k[h],b=a.length,f._walkedCells={},c=0;b>c;c++)j.isMergePoint(h,c)?(e=j.getAttributesAt(h,c),e.mergeHeight>1&&f._handleRowDeleteForMergePoint(e,h,c,m)):j.isMergedCell(h,c)&&(e=j.getAttributesAt(h,c),e.mergePointDY>0&&f._handleRowDeleteForMergedCell(e,h,c,m));return 1===j.rowHeights.length&&0===h&&i.trigger("ytable-delete"),m.push(d.create("DeleteRowOnly",j,{row:h})),f._walkedCells={},m}},_handleRowDeleteForMergePoint:function(a,b,c,e){var f,g,h,i,j,k,l=this,m=b+","+c;if(!l._walkedCells[m])for(g=a.mergeHeight,i=a.mergeWidth||1,f=0;g>f;f++)for(j=b+f,h=0;i>h;h++)k=c+h,1===f?0===h?e.push(d.create("SetCellAttributes",l.table,{row:j,col:k,attrs:{mergePointDX:null,mergePointDY:null,mergeWidth:a.mergeWidth,mergeHeight:a.mergeHeight-1}})):e.push(d.create("SetCellAttribute",l.table,{row:j,col:k,name:"mergePointDY",value:f-1})):f>1&&e.push(d.create("SetCellAttribute",l.table,{row:j,col:k,name:"mergePointDY",value:f-1})),m=j+","+k,l._walkedCells[m]=!0},_handleRowDeleteForMergedCell:function(a,b,c,f){var g,h,i,j,k,l,m,n,o,p=this,q=p.table,r=b+","+c,s=a.mergePointDX||0,t=a.mergePointDY||0;if(!p._walkedCells[r]){for(g=b-t,h=c-s,i=q.getAttributesAt(g,h),e.log("mergePoint "+g+","+h),j=i.mergeHeight-t,l=i.mergeWidth-s,k=0;j>k;k++)for(m=0;l>m;m++)n=b+k,o=c+m,k>0&&f.push(d.create("SetCellAttribute",q,{row:n,col:o,name:"mergePointDY",value:n-g-1})),r=n+","+o,p._walkedCells[r]=!0;r=g+","+h,p._walkedCells[r]||(f.push(d.create("SetCellAttribute",q,{row:g,col:h,name:"mergeHeight",value:i.mergeHeight-1})),p._walkedCells[r]=!0)}}}),d.register(b),b}({}),yne_ytable_editor_commands_DeleteRows=function(a){var b,c=yne_ytable_editor_commands_CompositeCommand,d=yne_ytable_editor_commands_CommandFactory;return b=c.extend({name:"DeleteRows",initialize:function(){this.constructor.__super__.initialize.apply(this,arguments)},getCommandSequence:function(){var a,b=this,c=b.args,e=c.row,f=c.editor,g=c.count||1,h=[];for(a=0;g>a;a++)h.push(d.create("DeleteRow",b.table,{row:e,editor:f}));return h}}),d.register(b),b}({}),yne_ytable_editor_commands_InsertColumnOnly=function(a){var b,c=yne_ytable_editor_commands_SimpleCommand,d=yne_ytable_editor_commands_CommandFactory;return b=c.extend({name:"InsertColumnOnly",action:function(){var a=this,b=a.args;return a.table.insertColumnOnly(b.col,b.colData,b.colWidth),!0},getReversed:function(){var a=this,b=a.args;return d.create("DeleteColumnOnly",a.table,{col:b.col})}}),d.register(b),b}({}),yne_ytable_editor_commands_InsertColumn=function(a){var b,c=yne_ytable_editor_commands_CompositeCommand,d=yne_ytable_editor_commands_CommandFactory;return b=c.extend({name:"InsertColumn",initialize:function(){this.constructor.__super__.initialize.apply(this,arguments)},getCommandSequence:function(){var a,b,c=this,e=c.table,f=c.args,g=f.col,h=f.colData||[],i=e.data,j=i.length,k=[];for(c._walkedCells={},a=0;j>a;a++)e.isMergedCell(a,g)&&(b=e.getAttributesAt(a,g),b.mergePointDX=b.mergePointDX||0,b.mergePointDY=b.mergePointDY||0,b.mergePointDX>0&&c._handleColInsert(b,a,g,h,k));return c._walkedCells={},k.push(d.create("InsertColumnOnly",e,{col:g,colData:h,colWidth:f.colWidth})),k},_handleColInsert:function(a,b,c,e,f){var g,h,i,j,k,l,m,n,o,p,q,r,s=this,t=s.table,u=b+","+c;if(!s._walkedCells[u]){for(g=b-a.mergePointDY,h=c-a.mergePointDX,i=t.getAttributesAt(g,h),i.mergeHeight=i.mergeHeight||1,i.mergeWidth=i.mergeWidth||1,k=n=0,l=i.mergeHeight,o=i.mergeWidth,j=k;l>j;j++)for(p=g+j,r=e[p]||t.createCell(),r.mergePointDY=p-g,r.mergePointDX=a.mergePointDX,delete r.mergeWidth,delete r.mergeHeight,e[p]=r,m=n;o>m;m++)q=h+m,q>=c&&f.push(d.create("SetCellAttribute",t,{row:p,col:q,name:"mergePointDX",value:q-h+1})),u=p+","+q,s._walkedCells[u]=!0;f.push(d.create("SetCellAttribute",t,{row:g,col:h,name:"mergeWidth",value:i.mergeWidth+1}))}}}),d.register(b),b}({}),yne_ytable_editor_commands_InsertColumns=function(a){var b,c=yne_ytable_editor_commands_CommandFactory,d=yne_ytable_editor_commands_CompositeCommand;return b=d.extend({name:"InsertColumns",initialize:function(){this.constructor.__super__.initialize.apply(this,arguments)},getCommandSequence:function(){var a,b=this,d=b.args,e=d.col||0,f=d.colDataList||[],g=f.length,h=d.colWidthList||[],i=[];for(a=g-1;a>=0;a--)i.push(c.create("InsertColumn",b.table,{col:e,colData:f[a],colWidth:h[a]}));return i}}),c.register(b),b}({}),yne_ytable_editor_commands_DeleteColumnOnly=function(a){var b,c=yne_ytable_editor_commands_SimpleCommand,d=yne_ytable_editor_commands_CommandFactory;return b=c.extend({name:"DeleteColumnOnly",action:function(){var a=this,b=a.table,c=a.args,d=c.col;return a._backupColData=b.copyColumn(d),a._backupColWidth=b.getColumnWidth(d),b.deleteColumnOnly(d),!0},getReversed:function(){var a=this,b=a.args;return d.create("InsertColumnOnly",a.table,{col:b.col,colData:a._backupColData,colWidth:a._backupColWidth})}}),d.register(b),b}({}),yne_ytable_editor_commands_DeleteColumn=function(a){var b,c=yne_ytable_editor_commands_CompositeCommand,d=yne_ytable_editor_commands_CommandFactory;return b=c.extend({name:"DeleteColumn",initialize:function(){this.constructor.__super__.initialize.apply(this,arguments)},getCommandSequence:function(){var a,b,c=this,e=c.table,f=e.data,g=f.length,h=c.args,i=h.col,j=h.editor,k=[];for(c._walkedCells={},a=0;g>a;a++)e.isMergePoint(a,i)?(b=e.getAttributesAt(a,i),b.mergeWidth=b.mergeWidth||1,b.mergeHeight=b.mergeHeight||1,b.mergeWidth>1&&c._handleColDeleteForMergePoint(b,a,i,k)):e.isMergedCell(a,i)&&(b=e.getAttributesAt(a,i),b.mergePointDX=b.mergePointDX||0,b.mergePointDY=b.mergePointDY||0,b.mergePointDX>0&&c._handleColDeleteForMergedCell(b,a,i,k));return c._walkedCells={},1===e.colWidths.length&&0===i&&j.trigger("ytable-delete"),k.push(d.create("DeleteColumnOnly",e,{col:i})),k},_handleColDeleteForMergePoint:function(a,b,c,e){var f,g,h,i,j,k,l,m,n=this,o=n.table,p=b+","+c;if(!n._walkedCells[p])for(f=i=0,g=a.mergeHeight,j=a.mergeWidth,h=f;g>h;h++)for(l=b+h,k=i;j>k;k++)m=c+k,k===i+1?h===f&&e.push(d.create("SetCellAttributes",o,{row:l,col:m,attrs:{mergePointDX:null,mergePointDY:null,mergeWidth:a.mergeWidth-1,mergeHeight:a.mergeHeight}})):k>i+1&&e.push(d.create("SetCellAttribute",o,{row:l,col:m,name:"mergePointDX",value:k-i-1})),p=l+","+m,n._walkedCells[p]=!0},_handleColDeleteForMergedCell:function(a,b,c,e){var f,g,h,i,j,k,l,m,n,o,p,q=this,r=q.table,s=b+","+c;if(!q._walkedCells[s]){for(f=b-a.mergePointDY,g=c-a.mergePointDX,h=r.getAttributesAt(f,g),h.mergeWidth=h.mergeWidth||1,h.mergeHeight=h.mergeHeight||1,i=l=0,j=h.mergeHeight,m=h.mergeWidth,k=i;j>k;k++)for(o=f+k,n=l;m>n;n++)p=g+n,p>c&&e.push(d.create("SetCellAttribute",r,{row:o,col:p,name:"mergePointDX",value:n-l-1})),s=o+","+p,q._walkedCells[s]=!0;e.push(d.create("SetCellAttribute",r,{row:f,col:g,name:"mergeWidth",value:h.mergeWidth-1}))}}}),d.register(b),b}({}),yne_ytable_editor_commands_DeleteColumns=function(a){var b,c=yne_ytable_editor_commands_CompositeCommand,d=yne_ytable_editor_commands_CommandFactory;return b=c.extend({name:"DeleteColumns",initialize:function(){this.constructor.__super__.initialize.apply(this,arguments)},getCommandSequence:function(){var a,b=this,c=b.args,e=c.editor,f=c.col,g=c.count||1,h=[];for(a=0;g>a;a++)h.push(d.create("DeleteColumn",b.table,{col:f,editor:e}));return h}}),d.register(b),b}({}),yne_ytable_editor_config_config=function(a){var b={toolbar:!0,toolbarShowAtInit:!0,toolbarFloat:!1,footer:!0,handleKeyUndo:!0,tableMode:!1,plugins:["undo","basic","border","merge"],commands:[yne_ytable_editor_commands_NoOp,yne_ytable_editor_commands_SetCellValue,yne_ytable_editor_commands_SetCellStyle,yne_ytable_editor_commands_SetCellStyles,yne_ytable_editor_commands_SetCellAttribute,yne_ytable_editor_commands_SetCellAttributes,yne_ytable_editor_commands_SetRangeValue,yne_ytable_editor_commands_SetRangeStyle,yne_ytable_editor_commands_SetRangeStyles,yne_ytable_editor_commands_ToggleRangeMerge,yne_ytable_editor_commands_SetColumnWidth,yne_ytable_editor_commands_SetRowHeight,yne_ytable_editor_commands_DelRangeValue,yne_ytable_editor_commands_ClearCellStyles,yne_ytable_editor_commands_ClearRangeStyles,yne_ytable_editor_commands_CustomCommand,yne_ytable_editor_commands_InsertRowOnly,yne_ytable_editor_commands_InsertRow,yne_ytable_editor_commands_InsertRows,yne_ytable_editor_commands_DeleteRowOnly,yne_ytable_editor_commands_DeleteRow,yne_ytable_editor_commands_DeleteRows,yne_ytable_editor_commands_InsertColumnOnly,yne_ytable_editor_commands_InsertColumn,yne_ytable_editor_commands_InsertColumns,yne_ytable_editor_commands_DeleteColumnOnly,yne_ytable_editor_commands_DeleteColumn,yne_ytable_editor_commands_DeleteColumns],defaults:yne_ytable_editor_config_defaults,contextmenu:"default"};return b}({}),yne_ytable_editor_plugins_utils=function(a){var b=yne_ytable_tools_core_underscore,c=yne_ytable_templates_jst,d=yne_ytable_tools_core_Class,e=yne_ytable_editor_utils_OperateTable;return d.extend({initialize:function(a){var b=this;b.editor=a.editor,b._operateTable=new e({editor:b.editor})},addSplit:function(){
var a=this,b=a.editor,c=b.getToolbar();return c.addControl({type:"split"})},addToggleButton:function(a,c,d,e){var f,g,h=this,i=h.editor,j=i.getToolbar(),k=i.getSelection(),l=i.getCommandFactory(),m=i.getCommander();return g=function(a){var b=!0;a.forEachRange(function(a){if(a.type!==a.TYPE.NORMAL)b=!1;else{var c=l.create("SetRangeStyle",{range:a,style:{key:d,value:"true"}});b=b&&c.query()}}),b?f.activate():f.deactivate()},g=b.debounce(g,80),f=j.addControl({type:"button",name:a,tag:c,text:e,click:function(){k.forEachRange(function(a){var b=l.create("SetRangeStyle",{range:a,style:{key:d,value:"true"}});b.query()&&(b.args.style.value="false"),m.exec(b,!0)}),g(k)}}),i.onSelection("change",g),i.onCommander("commandExec",function(){g(k)}),f},addMergeToggleButton:function(){var a,c,d=this,e=d.editor,f=e.getToolbar(),g=e.getSelection(),h=e.getCommandFactory(),i=e.getCommander();return c=function(b){var c=!0;b.forEachRange(function(a){c=c&&a.isMerge()}),c?a.activate():a.deactivate()},c=b.debounce(c,80),a=f.addControl({type:"button",name:"cell-merge",tag:"合并单元格",text:"合并单元格",click:function(){g.forEachRange(function(a){var b=h.create("ToggleRangeMerge",{range:a});i.exec(b,!0)}),c(g)}}),e.onSelection("change",c),e.onCommander("commandExec",function(){c(g)}),a},addColorComboBox:function(a,d,e,f,g,h){var i,j,k=this,l=k.editor,m=l.getToolbar(),n={},o={},p=l.getSelection(),q=l.getCommandFactory(),r=l.getCommander(),s=1,t=function(a){n["split"+s]={type:"split",html:"<hr><div>"+a+"</div>"},++s},u=b.size(b.keys(f.other)),v=0;return b.each(["default","theme","other","standard"],function(a){"theme"===a?t("主题颜色"):"standard"===a?t("标准色"):"other"===a&&(n["split"+s]={type:"split",html:'<div style="height:10px;"></div>'},++s),b.each(f[a],function(b,d){var f=c.getTemplate("plugins",g),h="";"other"===a&&(h=10>v?"other-top":10>=u-v?"other-bottom":"other-middle",++v),n[d]={html:f({setupName:d,dispName:b,type:a,additionalClass:h}),click:function(){p.forEachRange(function(a){var c=q.create("SetRangeStyle",{range:a,style:{key:e,value:b}});r.exec(c,!0)})}},o[d]=b})}),i=m.addControl({type:"color-combo",name:a,tag:d,items:n,colors:o}),j=function(a,b,c){var d=l.getTable(),f=d.getStylesAt(b,c),g=f[e];g||(g="default"),i.select(g)},l.onSelection("activeCellChanged",j),l.onCommander("commandExec",function(){var a=p.getActiveCell();j(p,a.row,a.col)}),h&&(i.setDefaultKey(h),b.isFunction(i.setCurrent)&&i.setCurrent(h)),i.select("default"),i},addValueComboBox:function(a,d,e,f,g,h,i){var j,k,l=this,m=l.editor,n=m.getToolbar(),o={},p=m.getSelection(),q=m.getCommandFactory(),r=m.getCommander();return"combo"!==i&&"button-combo"!==i&&"color-combo"!==i&&(i="combo"),b.each(f,function(a,b){var d=c.getTemplate("plugins",g),f=d({setupName:b,dispName:a});o[b]={html:f,click:function(){p.forEachRange(function(a){var c=q.create("SetRangeStyle",{range:a,style:{key:e,value:b}});r.exec(c,!0)})}}}),j=n.addControl({type:i,name:a,tag:d,items:o}),k=function(a,b,c){var d=m.getTable(),f=d.getStylesAt(b,c),g=f[e];g||(g="default"),j.select(g)},m.onSelection("activeCellChanged",k),m.onCommander("commandExec",function(){var a=p.getActiveCell();k(p,a.row,a.col)}),h&&(j.setDefaultKey(h),b.isFunction(j.setCurrent)&&j.setCurrent(h)),j.select("default"),j},addValueButton:function(a,c,d,e){var f,g,h=this,i=h.editor,j=i.getToolbar(),k=i.getSelection(),l=i.getCommandFactory(),m=i.getCommander();return f=j.addControl({type:"button",name:a,tag:c,click:function(){k.forEachRange(function(a){var b=l.create("SetRangeStyle",{range:a,style:{key:d,value:e}});m.exec(b,!0)})}}),g=function(a){var b=!0;a.forEachRange(function(a){if(a.type!==a.TYPE.NORMAL)b=!1;else{var c=i.getCommandFactory(),f=c.create("SetRangeStyle",{range:a,style:{key:d,value:e}});b=b&&f.query()}}),b?f.activate():f.deactivate()},g=b.debounce(g,100,!0),i.onSelection("change",g),i.onCommander("commandExec",function(){g(k)}),f},addCustomButton:function(a,b,c,d){var e=this,f=e.editor,g=f.getToolbar();return g.addControl({type:"button",name:a,tag:b,text:d,click:c})},addCustomComboBox:function(a,d,e,f,g,h,i,j){var k,l=this,m=l.editor,n=m.getToolbar(),o={};return"combo"!==i&&"button-combo"!==i&&"color-combo"!==i&&(i="combo"),b.each(e,function(a,b){var d=c.getTemplate("plugins",f),e=d({key:b,info:a});"-"===a?o[b]={type:"split"}:o[b]={html:e,click:function(){g(b,a)}}}),k=n.addControl({type:i,name:a,tag:d,items:o,text:j}),h&&(k.setDefaultKey(h),b.isFunction(k.setCurrent)&&k.setCurrent(h)),k.select("default"),k},addCustomColorComboBox:function(a,d,e,f,g,h){var i,j=this,k=j.editor,l=k.getToolbar(),m={},n={},o=1,p=function(a){m["split"+o]={type:"split",html:"<hr><div>"+a+"</div>"},++o},q=b.size(b.keys(f.other)),r=0;return b.each(["default","theme","other","standard"],function(a){"theme"===a?p("主题颜色"):"standard"===a?p("标准色"):"other"===a&&(m["split"+o]={type:"split",html:'<div style="height:10px;"></div>'},++o),b.each(f[a],function(d,f){var h=c.getTemplate("plugins",g),i="";"other"===a&&(i=10>r?"other-top":10>=q-r?"other-bottom":"other-middle",++r),m[f]={html:h({setupName:f,dispName:d,type:a,additionalClass:i}),click:function(){b.isFunction(e)&&e(d,f)}},n[f]=d})}),i=l.addControl({type:"color-combo",name:a,tag:d,items:m,colors:n}),h&&(i.setDefaultKey(h),b.isFunction(i.setCurrent)&&i.setCurrent(h)),i.select("default"),i},addTableButton:function(a,b,c){var d,e,f=this,g=f.editor,h=g.getToolbar(),i=f._operateTable;return e={up:{click:i.insertRowUp.bind(f),html:"在上方插入行"},down:{click:i.insertRowDown.bind(f),html:"在下方插入行"},"delete-row":{click:i.deleteRow.bind(f),html:"删除整行"},split1:{type:"split",html:""},left:{click:i.insertColumnLeft.bind(f),html:"在左侧插入列"},right:{click:i.insertColumnRight.bind(f),html:"在右侧插入列"},"delete-col":{click:i.deleteColumn.bind(f),html:"删除整列"},split2:{type:"split",html:""},"delete-table":{click:i.deleteTable.bind(f),html:"删除整个表格"}},d=h.addControl({name:a,tag:b,type:c+"-combo",items:e}),d.setCurrent("up"),d},addMoreCombo:function(a,b,c,d){var e=this,f=e.editor,g=f.getToolbar();return g.addControl({type:"more-combo",name:a,tag:b,text:c,click:d})}})}({}),yne_ytable_editor_plugins_undo_plugin=function(a){var b=yne_ytable_editor_plugins_utils;return{initialize:function(a){var c,d,e,f,g,h=new b({editor:a}),i=a.getCommander();e=function(){i.canUndo()?c.enable():c.disable(),i.canRedo()?d.enable():d.disable()},a.on("key-undo",e),a.on("key-redo",e),f=function(){i.undo(),e()},g=function(){i.redo(),e()},c=h.addCustomButton("undo","撤销",f),d=h.addCustomButton("redo","重做",g),e(),i.on("sendCommand",e),h.addSplit()}}}({}),yne_ytable_editor_plugins_globalUndo_plugin=function(a){var b=yne_ytable_editor_plugins_utils;return{initialize:function(a){var c,d,e=new b({editor:a}),f=function(a,b){a?c.enable():c.disable(),b?d.enable():d.disable()};c=e.addCustomButton("undo","撤销",function(){a.trigger("global-undo",f)}),d=e.addCustomButton("redo","重做",function(){a.trigger("global-redo",f)}),f(!1,!1),a.on("global-command-exec",f),a.on("global-undo-status",f)}}}({}),yne_ytable_editor_plugins_colors=function(){var a={theme:{white:"#FFFFFF",black:"#000000",tan:"#EEECE1",darkBlue:"#1F497D",blue:"#4F81BD",red:"#C0504D",olive:"#9BBB59",purple:"#8064A2",green:"#4BACC6",orange:"#F79646"},other:{white1:"#F2F2F2",black1:"#7F7F7F",tan1:"#DDD9C3",darkBlue1:"#C6D9F0",blue1:"#DBE5F1",red1:"#F2DCDB",olive1:"#EBF1DD",purple1:"#E5E0EC",green1:"#DBEEF3",orange1:"#FDEADA",white2:"#D8D8D8",black2:"#595959",tan2:"#C4BD97",darkBlue2:"#8DB3E2",blue2:"#B8CCE4",red2:"#E5B9B7",olive2:"#D7E3BC",purple2:"#CCC1D9",green2:"#B7DDE8",orange2:"#FBD5B5",white3:"#BFBFBF",black3:"#3F3F3F",tan3:"#938953",darkBlue3:"#548DD4",blue3:"#95B3D7",red3:"#D99694",olive3:"#C3D69B",purple3:"#B2A2C7",green3:"#92CDDC",orange3:"#FAC08F",white4:"#A5A5A5",black4:"#262626",tan4:"#494429",darkBlue4:"#17365D",blue4:"#366092",red4:"#953734",olive4:"#76923C",purple4:"#5F497A",green4:"#31859B",orange4:"#E36C09",white5:"#7F7F7F",black5:"#0C0C0C",tan5:"#1D1B10",darkBlue5:"#0F243E",blue5:"#244061",red5:"#632423",olive5:"#4F6128",purple5:"#3F3151",green5:"#205867",orange5:"#974806"},standard:{darkRed:"#C00000",stdRed:"#FF0000",stdOrange:"#FFC000",yellow:"#FFFF00",auqa:"#92D050",stdGreen:"#00B050",lightBlue:"#00B0F0",stdBlue:"#0070C0",stdDarkBlue:"#002060",stdPurple:"#7030A0"}};return a}(),yne_ytable_editor_plugins_basic_plugin=function(a){var b=yne_ytable_editor_plugins_utils,c=yne_ytable_editor_plugins_colors,d=yne_ytable_editor_config_defaults,e=yne_ytable_tools_core_underscore;return{initialize:function(a){var f=this,g=new b({editor:a});f.editor=a,f.utils=g,g.addCustomButton("remove-format","清除格式",function(){var b=a.getCommandHelper();b.clearSelectionStyles()}),g.addSplit(),g.addValueComboBox("fontName","字体","fontName",{Simsun:"宋体",NSimSum:"新宋体",FangSong_GB2312:"仿宋",KaiTi_GB2312:"楷体",SimHei:"黑体","Microsoft YaHei":"微软雅黑",Arial:"Arial","Arial Black":"Arial Black","Times New Roman":"Times New Roman","Courier New":"Courier New",Tahoma:"Tahoma",Verdana:"Verdana"},"font_name_combo_item",d.fontName),g.addValueComboBox("fontSize","字号","fontSize",{"9px":"9px","12px":"12px","14px":"14px","16px":"16px","18px":"18px","22px":"22px","26px":"26px","30px":"30px","36px":"36px","42px":"42px"},"font_size_combo_item",d.fontSize+"px"),g.addToggleButton("bold","粗体","bold"),g.addToggleButton("italic","斜体","italic"),g.addToggleButton("underline","下划线","underline"),g.addToggleButton("line-through","删除线","lineThrough"),g.addSplit(),g.addColorComboBox("text-color","文字颜色","textColor",e.extend(e.clone(c),{"default":{black0:"#000000"}}),"color_combo_item","stdRed"),g.addColorComboBox("back-color","背景颜色","backColor",e.extend(e.clone(c),{"default":{white0:""}}),"color_combo_item","yellow"),g.addSplit(),g.addValueButton("justify-left","左对齐","textAlign","left"),g.addValueButton("justify-center","居中","textAlign","center"),g.addValueButton("justify-right","右对齐","textAlign","right"),g.addValueButton("justify-top","顶端对齐","verticalAlign","top"),g.addValueButton("justify-middle","水平居中","verticalAlign","middle"),g.addValueButton("justify-bottom","底端对齐","verticalAlign","bottom"),g.addSplit(),g.addToggleButton("wrap","自动换行","wrap","自动换行"),g.addTableButton("table","插入/删除","table")}}}({}),yne_ytable_editor_plugins_border_plugin=function(a){var b=yne_ytable_editor_plugins_utils,c=yne_ytable_tools_core_underscore,d=yne_ytable_tools_web_console,e=yne_ytable_editor_plugins_colors;return{initialize:function(a){var f=this,g=new b({editor:a}),h=a.getCommandHelper(),i="#000000",j=c.extend({"default":{black0:i}},e),k="border|horizontal",l="border|vertical";f.editor=a,f.utils=g,g.addSplit(),g.addCustomButton("toggle-grid","隐藏网格线",function(){var b=this,c=a.mountElement.querySelector(".contents");c&&(c.classList.contains("noborder")?(c.classList.remove("noborder"),b.deactivate()):(c.classList.add("noborder"),b.activate()))},"隐藏网格线"),g.addCustomComboBox("border","边框线",{"top-border":{name:"上框线"},"bottom-border":{name:"下框线"},"left-border":{name:"左框线"},"right-border":{name:"右框线"},"split-1":"-","no-border":{name:"无框线"},"all-border":{name:"所有框线"},"outer-border":{name:"外侧框线"}},"border_combo_item",function(b){var c=a.getSelection(),e=a.getCommander(),f=a.getCommandFactory();c.forEachRange(function(c){d.log("The Range "+c);var g,j=c.getRect(),m=[],n="1px solid "+i,o="",p=function(a,b,c){a=h.fixRange(a),a&&m.push(f.create("SetRangeStyle",{range:a,style:{key:b,value:c}}))};("top-border"===b||"outer-border"===b)&&(g=a.createRange({left:j.left,right:j.right,top:j.top,bottom:j.top+1}),p(g,k,n)),("bottom-border"===b||"outer-border"===b)&&(g=a.createRange({left:j.left,right:j.right,top:j.bottom,bottom:j.bottom+1}),p(g,k,n)),("left-border"===b||"outer-border"===b)&&(g=a.createRange({left:j.left,right:j.left+1,top:j.top,bottom:j.bottom}),p(g,l,n)),("right-border"===b||"outer-border"===b)&&(g=a.createRange({left:j.right,right:j.right+1,top:j.top,bottom:j.bottom}),d.log("right border range "+g+" "+l+" "+n),p(g,l,n)),("all-border"===b||"no-border"===b)&&(g=a.createRange({left:j.left,right:j.right+1,top:j.top,bottom:j.bottom}),p(g,l,"all-border"===b?n:o),g=a.createRange({left:j.left,right:j.right,top:j.top,bottom:j.bottom+1}),p(g,k,"all-border"===b?n:o)),e.exec(f.create("CustomCommand",{cmdList:m}),!0)})},"all-border","button-combo","边框线"),g.addCustomColorComboBox("border-color","边框线颜色",function(b){i=b;var c,d=a.getSelection(),e=a.getCommander(),f="1px solid "+i;d.forEachRange(function(b){var d=b.getRect(),g=a.createRange({left:d.left,right:d.right+1,top:d.top,bottom:d.bottom}),i=a.createRange({left:d.left,right:d.right,top:d.top,bottom:d.bottom+1});e.beginCompond(),c={},c[l]=f,h.setRangeStyles(g,c),c={},c[k]=f,h.setRangeStyles(i,c),e.endCompond()})},j,"color_combo_item","black0")}}}({}),yne_ytable_editor_plugins_merge_plugin=function(a){var b=yne_ytable_editor_plugins_utils;return{initialize:function(a){var c=this,d=new b({editor:a});c.editor=a,c.utils=d,d.addSplit(),d.addMergeToggleButton()}}}({}),yne_ytable_editor_plugins_more_plugin=function(a){var b=yne_ytable_editor_plugins_utils;return{initialize:function(a){var c=this,d=new b({editor:a});c.editor=a,c.utils=d,d.addMoreCombo("more","更多","更多",function(){})}}}({}),yne_ytable_editor_config_pluginMap={undo:yne_ytable_editor_plugins_undo_plugin,globalUndo:yne_ytable_editor_plugins_globalUndo_plugin,basic:yne_ytable_editor_plugins_basic_plugin,border:yne_ytable_editor_plugins_border_plugin,merge:yne_ytable_editor_plugins_merge_plugin,more:yne_ytable_editor_plugins_more_plugin},yne_ytable_editor_core_Editor=function(a){var b=yne_ytable_tools_core_EventClass,c=yne_ytable_tools_core_underscore,d=yne_ytable_tools_jq_jquery,e=yne_ytable_tools_core_console,f=yne_ytable_editor_views_EditorView,g=yne_ytable_editor_core_Table,h=yne_ytable_editor_core_Selection,i=yne_ytable_editor_core_Toolbar,j=yne_ytable_editor_core_Commander,k=yne_ytable_editor_commands_CommandFactory,l=yne_ytable_editor_commands_CommandHelper,m=yne_ytable_editor_core_Clipboard,n=yne_ytable_editor_core_HotkeyManager,o=yne_ytable_editor_core_Range,p=yne_ytable_editor_config_config,q=yne_ytable_editor_config_pluginMap,r=function(){var a=window.location.hash.substring(1),b=a.split("&"),d={};return c.each(b,function(a){a=a.split("=");var b=(a[0]||"").trim(),c=(a[1]||"").trim();(b||c)&&(d[b]=c)}),d},s=b.extend({defaultConfig:p,mountElement:null,_isViewRendered:!1,initialize:function(a){var b,d,e=this;a=a||{},c.defaults(a,e.defaultConfig),e.options=a,c.isFunction(a.contextmenu)?(e.on("contextmenu",a.contextmenu),e.isDefaultContextmenu=!1):"none"===a.contextmenu?e.isDefaultContextmenu=!1:e.isDefaultContextmenu=!0,e.locked=!1,e.table=new g,e.selection=new h({editor:e}),a.toolbar===!0?e.toolbar=new i({editor:e}):e.toolbar=null,e.commander=new j({editor:e}),e.commandFactory=new k(e),e.commandHelper=new l({editor:e}),e.clipboard=new m({editor:e}),e.hotkeyManager=new n,d=c.isString(a.mountElement)?document.querySelector(a.mountElement):a.mountElement,b=a.MainView||f,e.view=new b({editor:e,toolbar:a.toolbar,toolbarFloat:a.toolbarFloat,toolbarShowAtInit:a.toolbarShowAtInit,footer:a.footer,tableMode:a.tableMode}),e.view.on("cell-enter",function(){var a=["cell-enter"].concat(c.toArray(arguments));e.trigger.apply(e,a)}),e.view.on("cell-leave",function(){var a=["cell-leave"].concat(c.toArray(arguments));e.trigger("cell-leave",a)}),e.hash=r(),window.addEventListener("hashchange",function(){e.hash=r(),e.trigger("hashchange")}),a.handleKeyUndo&&(e.on("key-undo",e._onKeyUndo.bind(e)),e.on("key-redo",e._onKeyRedo.bind(e))),d&&e.renderView(d),e.trigger("ready"),e._bindEvents()},_onKeyUndo:function(){var a=this,b=a.getCommander();b&&b.undo()},_onKeyRedo:function(){var a=this,b=a.getCommander();b&&b.redo()},_bindEvents:function(){var a=this,b=a.table,c=function(){a.trigger("content-change")};b.on("valueChanged",c),b.on("stylesChanged",c),b.on("attributeChanged",c),b.on("rowInserted",c),b.on("rowDeleted",c),b.on("columnInserted",c),b.on("columnDeleted",c),a.on("view-resize",function(){a.view.trigger("view-resize")})},renderView:function(a){var b=this,c=b.view.el;return a?(b.unmountView(),d(a).append(c).css("overflow","visible"),b.mountElement=a,b._isViewRendered||(b.view.render(),b._initPlugins(),b._isViewRendered=!0),void b.view.trigger("view-resize")):void e.error("no mountElement")},unmountView:function(){var a=this,b=a.view.el;if(a.hideToolbar(),b.parentNode)try{b.parentNode.removeChild(b)}catch(c){e.error(c)}a.mountElement=null},_initPlugins:function(){var a=this,b=a.options.plugins;c.each(b,function(b){var c=q[b];return c&&c.initialize?void c.initialize(a):void e.warn("pluin "+b+" is not valid!")})},setContextmenuCallback:function(a){var b=this;b.on("contextmenu",a),b.isDefaultContextmenu&&(b.isDefaultContextmenu=!1,b.trigger("replaceContextmenu"))},lock:function(){var a=this,b=a.table;a.locked=!0,b.lock(),a.trigger("lock")},unlock:function(){var a=this,b=a.table;a.locked=!1,b.unlock(),a.trigger("unlock")},onTable:function(a,b){var c=this.table;c.on(a,b.bind(c,c))},getTable:function(){return this.table},onSelection:function(a,b){var c=this.selection;c.on(a,b.bind(c,c))},getSelection:function(){return this.selection},onCommander:function(a,b){var c=this.commander;c.on(a,b.bind(c,c))},getCommander:function(){return this.commander},getHotkeyManager:function(){return this.hotkeyManager},getToolbar:function(){return this.toolbar},getCommandFactory:function(){return this.commandFactory},getCommandHelper:function(){return this.commandHelper},getClipboard:function(){return this.clipboard},getView:function(){return this.view},getTableView:function(){var a=this.getView();return a?a.tableView:void 0},getDefaults:function(){return this.options.defaults},createRange:function(a){a=a||{};var b=this,d=new o(c.extend(a,{editor:b}));return d},triggerTable:function(a){var b=this.table;b.trigger.apply(b,[a].concat(arguments))},triggerSelection:function(a){var b=this.selection;b.trigger.apply(b,[a].concat(arguments))},showToolbar:function(a){var b=this.getToolbar();b&&(b.mountTo(a),b.show())},hideToolbar:function(){var a=this,b=a.getToolbar();b&&(b.hide(),a.remountToolbar())},remountToolbar:function(){var a=this,b=a.getToolbar();b&&b.mountTo(a.view.$el,!0)},getTableContent:function(){var a=this,b=a.getTable();return b.getContent()},setTableContent:function(a){var b=this,d=b.getTable();c.isString(a)&&(a=window.JSON.parse(a)),d.setContent(a)},_getRowFirstCellRange:function(a){var b,c,d,e=this,f=0,g=0;return a===!1&&(d=e.getTable(),f=d.getRowCount()-1),b=e.createRange({top:f,bottom:f+1,left:g,right:g+1}),c=b.toJSON()},getFirstRangeAsJSON:function(){var a,b=this,c=b.getSelection(),d=c.getFirstRange();return d&&d.toJSON&&(a=d.toJSON()),a||b.getFirstRowRangeAsJSON()},getFirstRowRangeAsJSON:function(){return this._getRowFirstCellRange(!0)},getLastRowRangeAsJSON:function(){return this._getRowFirstCellRange(!1)},selectRangeJSON:function(a){if(a){var b,c=this,d=c.createRange(a);d&&(b=c.getSelection(),b.select(d.top||0,d.left||0,d))}},becomeFirstResponder:function(){var a=this.getTableView();a&&(a.showSelectionView(),a.focusDebounced())},resignFirstResponder:function(){var a=this,b=a.getTableView(),c=a.getSelection();b&&b.hideSelectionView(),c&&c.removeAllRanges()},isRangeInEditBox:function(a){var b=this.getTableView();return b.isRangeInEditBox(a)},isRangeInLastRow:function(a){var b=this.getTableView();return b.isRangeInLastRow(a)},isEditing:function(){var a=this.getTableView();return a.isEditing()}});return s}({}),yne_common_data_tableDataValidator=function(a){var b=yne_underscore,c=function(a,c,d,e){if(null==a[c])return e===!0?!1:!0;var f="is"+d;return b[f]?b[f](a[c]):!1},d=function(a,d,e){var f={valid:!1};return e=e||"",b.some(a,function(a){var b=c(d,a.name,a.type,a.required);return b?void 0:(f.msg="The `"+a.name+"` of object is not valid! "+e,!0)}),f.msg?f:{valid:!0}},e=function(a,c,d){var e={},f={valid:!1};return b.some(a,function(b,c){if(!e[c+""]){var g,h,i,j,k,l,m,n,o,p,q,r;if(b.mergeWidth||b.mergeHeight){if(null!=b.mergePointDX||null!=b.mergePointDY)return f.msg="The cell data is not valid, index: "+c,!0;for(g=b.mergeWidth||1,h=b.mergeHeight||1,i=Math.floor(c/d),j=c%d,o=0;h>o;o++)for(k=i+o,n=0;g>n;n++)if(o>0||n>0){if(l=j+n,m=k*d+l,p=a[m],p.mergeWidth||p.mergeHeight)return f.msg="The merged cell should not have `mergeWidth` or `mergeHeight`, merge point cell index: "+c+", merged cell index: "+m,!0;if(p.value)return f.msg="The `value` of merged cell should be empty string,merge point cell index: "+c+", index: "+m,!0;if(q=p.mergePointDX||0,r=p.mergePointDY||0,q!==n||r!==o)return f.msg="The `mergePointDX` or `mergePointDY` of mergedCell is not valid, merge point cell index: "+c+",  merged cell index: "+m,!0;e[m+""]=!0}}e[c+""]=!0}}),f&&f.msg?f:{valid:!0}},f=[{name:"heights",type:"Array",required:!0},{name:"widths",type:"Array",required:!0},{name:"cells",type:"Array",required:!0}],g=[{name:"value",type:"String"},{name:"mergeWidth",type:"Number"},{name:"mergeHeight",type:"Number"},{name:"mergePointDX",type:"Number"},{name:"mergePointDY",type:"Number"}];return{inputCheck:function(a){if(!a)return{valid:!1,msg:"The data does not exist!"};var c,h,i,j,k;return c=d(f,a),c.valid!==!0?c:(c=null,(k=b.some(a.cells,function(a,b){var e=d(g,a,"The cell index is "+b);return e.valid!==!0?(c=e,!0):void 0}))?c:(h=a.heights.length,i=a.widths.length,j=h*i,j!==a.cells.length?{valid:!1,msg:"The cells length is not valid: heights.length * widths.length = "+j+" cells.length = "+a.cells.length}:(c=e(a.cells,h,i),c.valid!==!0?c:{valid:!0})))}}}({}),yne_common_data_Table=function(a){var b=yne_common_data_Block,c=yne_common_data_blockTypes,d=yne_jquery,e=yne_underscore,f=yne_jtk_core_L,g=yne_common_util_unknownTree,h=yne_common_util_blockStyles,i=yne_ytable_editor_utils_TableUtils,j=yne_ytable_client_editor_TableConvertor,k=yne_ytable_editor_core_Editor,l=yne_common_data_tableDataValidator,m=yne_ytable_editor_config_defaults,n=b.extend({_type:c.TABLE,data:null,_ytableEditor:null,initialize:function(a){var c,d=this;if(b.prototype.initialize.apply(d,arguments),c=l.inputCheck(a.data),c&&c.valid!==!0)throw f.log(a.data),c.msg;d.data=a.data,delete d.options,d.on("detached",d._onDetached.bind(d)),d.on("attached",d._onAttached.bind(d)),d.on("locked-change",d._onLockedChange.bind(d)),d.on("view-resize",function(){d._ytableEditor.trigger("view-resize")})},toXml:function(a){var b,c,d=this,e=a.createElement("table"),i=a.createElement("content"),j=d._getOutData();return j?(c=window.JSON.stringify(j),i.appendChild(a.createTextNode(c)),e.appendChild(i),b=a.createElement("styles"),h.toXml(d,b,a),e.appendChild(b),g.appendToXml(d.unknownTree,e),e):void f.error("ytable editor has no data!")},toJSON:function(){var a=this,b=a._getOutData();return b?{blockType:a._type,data:e.clone(b)}:void f.error("ytable editor has no data!")},toHtml:function(){var a,b,c,d,e,g,h,j,k,l,n,o,p,q,r,s,t=this,u=t._getOutData(),v=function(a){return a.mergePointDX>=1||a.mergePointDY>=1},w=0;if(!u)return f.error("ytable editor has no data!"),"";for(b=document.createElement("table"),c=u.heights.length,d=u.widths.length,g=0;d>g;g++)w+=u.widths[g];for(b.setAttribute("cellspacing","0"),b.setAttribute("cellpadding","0"),b.setAttribute("border","1"),b.setAttribute("style","table-layout:fixed;border-collapse:collapse;border:1px solid #ccc;width:"+w+"px"),e=0;c>e;e++)h=b.insertRow(e);for(j=b.querySelectorAll("tr"),k=j.length,e=0;c>e;e++)for(o=j[e],g=0;d>g;g++)l=e*d+g,n=u.cells[l],v(n)||(p=document.createElement("td"),p.style.wordWrap="break-word",h=n.mergeWidth,h&&h>1?p.setAttribute("colspan",h):p.style.width=(u.widths[g]||m.columnWidth)+"px",h=n.mergeHeight,h&&h>1?p.setAttribute("rowspan",h):p.style.height=(u.heights[e]||m.rowHeight)+"px",i.setElementStyles(p,n),s=n.value,null!=s&&""!==s?i.setElementText(p,s,n):p.innerHTML="<br/>",o.appendChild(p));return a=document.createElement("div"),a.appendChild(b),a.style.fontSize="12px",a.style.width="100%",a.style.overflow="auto",r=["Microsoft YaHei","微软雅黑","华文黑体","STHeiti","Microsoft JhengHei","sans-serif"],r='"'+r.join('","')+'"',a.style.fontFamily=r,q=a.outerHTML},toPlain:function(){var a=this,b=a._getOutData();return b?e.pluck(b.cells,"value").join(""):(f.error("ytable editor has no data!"),"")},countWords:function(){var a=this,b=a._getOutData(),c=0;return b?(e.each(b.cells,function(a){var b=a.value||"";c+=b.length}),c):c},_getOutData:function(){var a=this;return a._ytableEditor?j.toOutData(a._ytableEditor):a.data},renderYTableView:function(a){var b,c,d=this;return a&&a.parentNode?(d._ytableEditor||(d._ytableEditor=new k({toolbar:!0,toolbarFloat:!1,handleKeyUndo:!1,plugins:["globalUndo","basic","merge","more"],toolbarShowAtInit:!1,footer:!1,tableMode:!0,contextmenu:function(a){d.trigger("ytable-contextmenu",a)}})),d._ytableEditor.renderView(a),d._ytableEditor.resignFirstResponder(),d.data&&(b=d._ytableEditor.getTable(),c=j.toEditorData(d.data),b.setContent(c),d.data=null),d.trigger("ytable-register",d._ytableEditor),void d._bindEventsForYTable(d._ytableEditor)):void f.error("no mountElement")},_unbindEventsForYTable:function(a){a&&a.off&&a.off("ytable-delete")},_bindEventsForYTable:function(a){var b=this;b._unbindEventsForYTable(a),a&&a.on&&a.on("ytable-delete",b.trigger.bind(b,"ytable-delete"))},unmountYTableView:function(){var a=this;a._ytableEditor&&a._ytableEditor.unmountView()},_onDetached:function(){var a=this;a.unmountYTableView(),a.trigger("ytable-unregister",a._ytableEditor),a._unbindEventsForYTable(a._ytableEditor)},_onAttached:function(){var a=this;a.trigger("ytable-register",a._ytableEditor),a._bindEventsForYTable(a._ytableEditor)},_onLockedChange:function(){var a=this;a._updateYTableEditorLockStatus()},_updateYTableEditorLockStatus:function(){var a=this,b=a.isLocked(),c=a.getYTableEditor();c&&(b?c.lock():c.unlock())},getYTableEditor:function(){var a=this;return a._ytableEditor}},{fromXml:function(a){var b,c,e=d(a),i=e.find("content").eq(0),j=d.trim(i.text());try{b=window.JSON.parse(j)}catch(k){return void f.error(k)}return c=new n({data:b}),e.children().each(function(a,b){switch(b.nodeName){case"content":break;case"styles":h.fromXml(c,b);break;default:g.appendToTree(c.unknownTree,b)}}),c},fromJSON:function(a){return a&&a.blockType&&a.blockType===c.TABLE?new n({data:a.data}):void f.warn("jsonObj is not valid!")}});return n}({}),yne_common_data_Hr=function(a){var b,c,d,e=yne_common_data_Block,f=yne_common_data_blockTypes,g=yne_jtk_core_L,h=yne_underscore,i=yne_jquery,j=yne_common_util_unknownTree,k=yne_common_util_blockStyles;return c={_type:f.HR,_styles:null,initialize:function(){var a=this;e.prototype.initialize.apply(a,arguments)},toXml:function(a){var b=this,c=a.createElement("horizontal-line"),d=a.createElement("styles");return k.toXml(b,d,a),c.appendChild(d),j.appendToXml(b.unknownTree,c),c},toHtml:function(){var a,b=this,c=document.createElement("hr"),d=i(c),e=b.getBlockStyles();return d.attr("yne-bulb-block","hr"),h.each(e,function(a,b){d.attr("yne-style-"+b,a)}),d.css("clear","both"),a=c.outerHTML},toJSON:function(){var a=this;return{blockType:f.HR,styles:a.getBlockStyles()}},toPlain:function(){var a=new Array(81);return a.join("-")},countWords:function(){return 0}},d={fromXml:function(a){var c=new b,d=i(a);return d.children().each(function(a,b){switch(b.nodeName){case"styles":k.fromXml(c,b);break;default:j.appendToTree(c.unknownTree,b)}}),c},fromJSON:function(a){if(!a||a.blockType!==f.HR)return void g.error("invalid jsonObj");var c=new b;return h.each(a.styles,function(a,b){c.setBlockStyle(b,a)}),c}},b=e.extend(c,d)}({}),yne_common_data_Unknown=function(a){var b,c,d,e=yne_common_data_blockTypes,f=yne_common_data_Block;return c={_type:e.UNKNOWN,_styles:null,_supportedBlockStyles:null,_xmlNode:null,initialize:function(a){this._xmlNode=a.xmlNode},setBlockStyle:function(){},setBlockStyles:function(){},getBlockStyles:function(){},getBlockStyle:function(){},getDefaultBlockStyles:function(){},toXml:function(){return this._xmlNode},getType:function(){return this._type},toJSON:function(){},toHtml:function(){return""},toPlain:function(){return""},countWords:function(){return 0}},d={fromXml:function(a){return new b({xmlNode:a})},fromJSON:function(){}},b=f.extend(c,d)}({}),yne_common_data_blockMap={para:yne_common_data_Paragraph,image:yne_common_data_Image,attach:yne_common_data_Attachment,"list-item":yne_common_data_ListItem,table:yne_common_data_Table,"horizontal-line":yne_common_data_Hr,unknown:yne_common_data_Unknown},yne_parser_html_handlers_tagHandlers=function(a){var b=yne_underscore,c=yne_jtk_core_L,d={h1:32,h2:24,h3:18,h4:16,h5:13,h6:12},e={b:function(a){a.bold=!0},i:function(a){a.italic=!0},u:function(a){a.underline=!0},strike:function(a){a.strike=!0},code:function(a){a["font-family"]="monospace"},mark:function(a){a["back-color"]="#ffff00",a.color="#000000"},font:function(a,b){var c=b.getAttribute("color"),d=b.getAttribute("face");c&&(a.color=c),d&&(a["font-family"]=d)},pre:function(a){a["white-space"]="pre"},a:function(a,b){b&&b.href&&(a.color="#0000ff",a.underline=!0)}},f=function(a,d){var f=e[a];return f?void b.each(d,function(a){e[a]||(e[a]=f)}):void c.error("The tag handler for `"+a+"` does not exist!")};return b.each(d,function(a,b){e[b]=function(b){b.bold=!0,b["font-size"]=a}}),f("b",["strong"]),f("i",["em","cite","var","address","dfn"]),f("strike",["s","del"]),f("u",["ins"]),f("code",["tt","kbd","samp","pre","xmp","plaintext","listing"]),e}({}),yne_tinycolor=function(){var a=window.tinycolor;if(!a&&window.require&&(a=window.require("tinycolor")),!a)throw"no `tinycolor` library";return a}(),yne_parser_html_utils_convertColor=function(a){var b=yne_tinycolor,c=yne_underscorestring,d={};return function(a){var e,f;return a=c(a).trim().toLowerCase().value(),a&&"inherit"!==a?"transparent"===a?a:(e=d[a])?e:(f=b(a),f.isValid()?(e=f.toHexString(),d[a]=e,e):void 0):void 0}}({}),yne_parser_html_handlers_styleHandlers=function(a){var b=yne_underscorestring,c=yne_common_constants,d=yne_underscore,e=yne_parser_html_utils_convertColor,f=["bold","bolder","700","800","900"],g={"xx-small":12,"x-small":12,small:13,medium:16,large:18,"x-large":24,"xx-large":32},h={bold:{inheritable:!0,action:function(a){var c=a.style.fontWeight;return c=c&&b.trim(c).toLowerCase(),c&&"inherit"!==c?-1!==d.indexOf(f,c):null}},italic:{inheritable:!0,action:function(a){var b=a.style.fontStyle;return b?"italic"===b:null}},underline:{inheritable:!0,action:function(a,b,c){var d=a.style.textDecoration;return/(^|\s)underline($|\s)/i.test(d)?!0:d&&!c?!1:c}},strike:{inheritable:!0,action:function(a,b,c){var d=a.style.textDecoration;return/(^|\s)line-through($|\s)/i.test(d)?!0:d&&!c?!1:c}},"font-family":{inheritable:!0,action:function(a){var b,c=a.style.fontFamily;return c&&"inherit"!==c?(b=c.split(",")[0],b=b.replace(/^[ '"]+|[ '"]+$/g,""),b||null):void 0}},"font-size":{inheritable:!0,action:function(a,c,d){var e=a.style.fontSize;return e=b.trim(e+""),/^[\d.]+px$/.test(e)?e=parseInt(e,10):/^[\d.]+pt$/.test(e)?e=Math.floor(4*parseFloat(e,10)/3):/^[\d.]+em$/.test(e)?(e=parseFloat(e,10),e*=d||14,e=Math.floor(e)):/^[\d.]+rem$/.test(e)?(e=parseFloat(e,10),e=10*e,e=Math.floor(e)):e=g[e],e&&!isNaN(e)?e:void 0}},color:{inheritable:!0,action:function(a){var b=a.style.color;return e(b)}},"back-color":{inheritable:!0,action:function(a){var b=a.style.backgroundColor;return e(b)}},align:{inheritable:!0,action:function(a){var c=a.style.textAlign||a.align;return c=c&&b.trim(c).toLowerCase(),c&&"inherit"!==c?c:void 0}},"line-height":{inheritable:!0,requireValues:["font-size"],action:function(a,c){var d=b.trim(a.style.lineHeight+""),e=c["font-size"]||14;return/^[\d.]+$/.test(d)?d=parseFloat(d,10):/^[\d.]+px$/.test(d)?(d=parseFloat(d,10),d/=e):d=0,d&&!isNaN(d)&&d>1?d:void 0}},indent:{inheritable:!0,action:function(a,b,c){var d=0;return"BLOCKQUOTE"===a.tagName&&(d=1),d+=c||0}},"text-indent":{inheritable:!0,action:function(a){var d=a.style.textIndent;return d=b.trim(d+""),d=/^[\d.]+px$/.test(d)?parseFloat(d,10):/^[\d.]+pt$/.test(d)?4*parseFloat(d,10)/3:null,d?(d=Math.floor(d/c.INDENT_WIDTH),d||1):void 0}},width:{inheritable:!1,action:function(a){var c=a.style.width||a.width;return c=b.trim(c+""),
/^[\d.]+(px)?$/.test(c)&&(c=parseInt(c,10)),c&&!isNaN(c)?c:void 0}},"float":{inheritable:!1,action:function(a){var b=a.style["float"];return b}},"white-space":{inheritable:!0,action:function(a){var b=a.style.whiteSpace;return b&&"inherit"!==b?b:void 0}}};return h}({}),yne_parser_html_handlers_BaseHandler=function(a){var b,c=yne_jtk_core_Class,d=yne_underscore,e=yne_jtk_core_L,f=yne_parser_html_handlers_tagHandlers,g=yne_parser_html_handlers_styleHandlers;return b=c.extend({inheritStyleHandlers:null,uninheritStyleHandlers:null,tagHandler:null,el:null,parent:null,children:null,styles:null,constructor:function(a,b){var c=this;c.el=a,c.children=[],c.parent=b,c.parent&&c.parent.children&&c.parent.children.push(c),c._computeStyles(),c.computeBulbStyles()},computeBulbStyles:function(){},_findStyleHandler:function(a,c){var f,g=this,h=a?g.inheritStyleHandlers:g.uninheritStyleHandlers,i=h[c];if(d.isFunction(i))return{action:i};if(d.isObject(i)&&i.action)return i;if(i===!0&&(f=b.styleHandlers[c],f&&f.action))return f.inheritable!==a?void e.error("The inheritable value of "+c+" is unvalid!"):f},_computeStyles:function(){var a=this,c=a.el,d={},e=a.tagHandler||b.tagHandlers[c.tagName.toLowerCase()];e&&e(d,c),a.styles={},a._computeInheritStyles(d),a._computeUninheritStyles(d)},_computeStyle:function(a,b){var c,e,f,g=this,h=null!=g.inheritStyleHandlers[b],i=g.parent,j=g.el;null==g.styles[b]&&(!h||i)&&(c=g._findStyleHandler(h,b),c&&c.action&&(c.requireValues&&c.requireValues.length&&d.each(c.requireValues,function(b){g._computeStyle(a,b)}),h?(e=(i.styles||{})[b],f=c.action(j,g.styles,e),f||f===!1||(f=a[b]),f||f===!1||(f=e)):(f=c.action(j,g.styles),f||f===!1||(f=a[b])),(f||f===!1)&&(g.styles[b]=f)))},_computeInheritStyles:function(a){var b=this;b.inheritStyleHandlers&&d.each(b.inheritStyleHandlers,function(c,d){c&&b._computeStyle(a,d)})},_computeUninheritStyles:function(a){var b=this;b.uninheritStyleHandlers&&d.each(b.uninheritStyleHandlers,function(c,d){c&&b._computeStyle(a,d)})},setup:function(){},capture:function(){},finish:function(){},emit:function(a){var b=this;b.parent&&b.parent.capture(a)},getRoot:function(){var a=this;return a.parent?a.parent.getRoot():void 0}},{tagHandlers:f,styleHandlers:g})}({}),yne_parser_html_utils_handleParagraphSpaces=function(a){var b=yne_underscore,c=yne_underscorestring,d=["normal","nowrap","pre-line"],e=function(a,b){return b&&"normal"!==b&&"nowrap"!==b?"pre-line"===b?a.replace(/[ \t]+/g," "):a:a.replace(/[ \t\r\n]+/g," ")},f=function(a,b){return b&&"normal"!==b&&"nowrap"!==b?"pre-line"===b?a.replace(/^[ \t]+/g,""):a:a.replace(/^[ \t\r\n]+/g,"")},g=function(a,b){return b&&"normal"!==b&&"nowrap"!==b?"pre-line"===b?a.replace(/[ \t]+$/g,""):a:a.replace(/[ \t\r\n]+$/g,"")},h=function(a){var c=a.styles["white-space"];return!c||b.contains(d,c)};return function(a){var d,i,j,k,l,m;for(b.each(a,function(a){a.text=e(a.text,a.styles["white-space"])}),j=a.length,d=0;j>d&&(k=a[d],k.text=f(k.text,k.styles["white-space"]),!k.text);d++);for(d=0,i=1;j>i;i++)l=a[d],m=a[i],h(l)&&h(m)&&(c.endsWith(l.text," ")&&c.startsWith(m.text," ")&&(m.text=m.text.slice(1)),""===m.text)||(d=i);for(d=j-1;d>=0&&(k=a[d],k.text=g(k.text,k.styles["white-space"]),!k.text);d--);return a}}({}),yne_parser_html_handlers_ParagraphHandler=function(a){var b=yne_parser_html_handlers_BaseHandler,c=yne_common_data_Paragraph,d=yne_common_data_RichText,e=yne_parser_html_utils_handleParagraphSpaces,f=yne_common_constants,g=yne_underscore;return b.extend({inheritStyleHandlers:{bold:!0,italic:!0,underline:!0,strike:!0,"font-family":!0,"font-size":!0,color:!0,"back-color":!0,"white-space":!0,align:!0,"line-height":!0,indent:!0,"text-indent":!0},computeBulbStyles:function(){var a,b=this,c=b.el,d=c.getAttribute("yne-bulb-block");"paragraph"===d&&(a=c.style.marginLeft,a=parseInt(a,10),isNaN(a)||(a=Math.ceil(a/f.INDENT_WIDTH),b.styles.indent=(b.styles.indent||0)+a))},setup:function(){var a=this;a.block=null},capture:function(a){var b=this;a&&a.isBr===!0?b.emitBlock(!0):a&&a.isText===!0?b._appendText(a):b.captureBlock(a)},captureBlock:function(a){this.emitBlock(),this.emit(a)},finish:function(){this.emitBlock()},_getBlock:function(){var a=this;return a.block||(a.block=a.createBlock()),a.block},createBlock:function(){return new c},_appendText:function(a){var b=this;b.txtList=b.txtList||[],b.txtList.push(a)},emitBlock:function(a){var b,c,f,h=this,i=h.txtList;c=h._getBlock(),i&&(i=e(i),g.each(i,function(a){a.text&&(f=new d({text:a.text}),b=f.getLength(),g.each(a.styles,function(a,c){f.setStyle(0,b,c,a)}),c.append(f))})),(a||c.getLength()>0)&&(c.setBlockStyles(h.styles),h.emit(c)),h.block=null,h.txtList=null}})}({}),yne_parser_html_handlers_DocumentHandler=function(a){var b,c=yne_underscore,d=yne_parser_html_handlers_ParagraphHandler;return b=d.extend({constructor:function(a){var b=this;d.call(this,a,null),b.blocks=[]},setup:function(){var a=this;d.prototype.setup.apply(a),a.blocks=[]},emit:function(a){var b=this;c.isString(a)||b.blocks.push(a)},getRoot:function(){return this}})}({}),yne_parser_html_handlers_UnknownHandler=function(a){var b=yne_parser_html_handlers_BaseHandler;return b.extend({_computeStyles:function(){var a=this,b=a.parent;b&&(a.styles=b.styles)},capture:function(a){var b=this;b.emit(a)}})}({}),yne_jtk_web_dom_parseHTML=function(){var a=function(a,b){var c,d,e;if(b.implementation&&b.implementation.createHTMLDocument)return c=b.implementation.createHTMLDocument("title"),c.body.innerHTML=a,c;if(e=b.defaultView||window,e.DOMParser){d=new e.DOMParser;try{c=d.parseFromString("","text/html")}catch(f){}if(c)return c.body.innerHTML=a,c}};return function(b,c,d){if(b){c=c||document;var e,f,g,h,i=a(b,c);if(i){if(d!==!1)return i.body;for(g=i.body.childNodes,e=g.length,h=[],f=0;e>f;f++)h.push(g[f]);return h}}}}(),yne_parser_html_Parser=function(a){var b,c=yne_underscore,d=yne_jtk_core_Class,e=yne_parser_html_handlers_DocumentHandler,f=yne_parser_html_handlers_UnknownHandler,g=yne_jtk_web_dom_parseHTML;return b=d.extend({_mapper:{},_blackTagList:{},constructor:function(a){var b=this;b._mapper={},b._blackTagList={},c.each(a,function(a,d){a===!1?b._blackTagList[d]=!0:a&&c.isObject(a)&&b.define(d,a)})},parse:function(a,b){var c,d,f=this,h=/<html[\S\s]*<\/html>/i;return h.test(a)&&(a=a.match(h)[0]),c=g(a,document,!0),c?d=new e(c):(c=document.createElement("div"),c.innerHTML=a,d=new e(c)),f._parseRecursively(d,b),d.blocks},_shouldBreak:function(a){return"none"===a.style.display||"hidden"===a.style.visibility?!0:!1},_shouldWalkChild:function(a){return"TABLE"===a.tagName?!1:!0},_parseRecursively:function(a,b){var d,e,g,h,i,j=this,k=a.el;if(j._shouldBreak(k)!==!0){if(a.setup(),j._shouldWalkChild(k))for(d=k.firstChild;d;)1===d.nodeType?(i=d.tagName.toLowerCase(),j._blackTagList[i]||(g=j._findHandlers(d),g=c.isFunction(g)?g:f,h=new g(d,a),j._parseRecursively(h,b))):3===d.nodeType&&(e=d.textContent,e&&a.capture({text:e,styles:a.styles,isText:!0})),d=d.nextSibling;a.finish(b)}},define:function(a,c,d){var e=this;e._mapper[a]={Class:c,priority:d||b.PRIORITY.DEFAULT}},_findHandlers:function(a){var b=[],d=function(a,b){return a?a.matches?a.matches(b):a.webkitMatchesSelector?a.webkitMatchesSelector(b):void 0:void 0};return c.each(this._mapper,function(c,e){d(a,e)&&b.push(c)}),0!==b.length?(b.sort(function(a,b){return b.priority-a.priority}),b[0].Class):void 0}},{PRIORITY:{HIGH:1,DEFAULT:0,LOW:-1}})}({}),yne_parser_html_handlers_InlineHandler=function(a){var b=yne_underscore,c=yne_parser_html_handlers_BaseHandler;return c.extend({inheritStyleHandlers:{bold:!0,italic:!0,underline:!0,strike:!0,"font-family":!0,"font-size":!0,color:!0,"back-color":!0,"white-space":!0},inheritBlockStyles:{align:!0,"line-height":!0,indent:!0,"text-indent":!0},_computeInheritStyles:function(){var a=this;c.prototype._computeInheritStyles.apply(a,arguments),a._computeInheritBlockStyles()},_computeInheritBlockStyles:function(){var a,c=this,d=c.parent,e=c.inheritBlockStyles;d&&d.styles&&(a=d.styles,b.each(e,function(b,d){if(b===!0){var e=a[d];e&&(c.styles[d]=e)}}))},capture:function(a){this.emit(a)}})}({}),yne_parser_html_handlers_AnchorHandler=function(a){var b=yne_parser_html_handlers_BaseHandler;return b.extend({inheritStyleHandlers:{bold:!0,italic:!0,underline:!0,strike:!0,"font-family":!0,"font-size":!0,color:!0,"back-color":!0,"white-space":!0},constructor:function(a,c){b.call(this,a,c)},capture:function(a){var b=this,c=b.el.getAttribute("href");return c&&"#"!==c&&0!==c.indexOf("javascript")?void(a&&a.isText===!0?(a.styles.href=a.styles.href||c,b.emit(a)):b.emit(a)):void b.emit(a)}})}({}),yne_parser_html_handlers_BreakHandler=function(a){var b,c=yne_parser_html_handlers_InlineHandler;return b=c.extend({inheritStyleHandlers:!1,inheritBlockStyles:{"line-height":!0,indent:!0,"text-indent":!0},finish:function(){var a=this;a.emit({isBr:!0,styles:a.styles})}})}({}),yne_parser_html_handlers_HrHandler=function(a){var b=yne_parser_html_handlers_BaseHandler,c=yne_common_data_Hr,d=yne_underscore,e=yne_common_data_supportedBlockStyles,f=e.getBlockStyles("horizontal-line");return b.extend({computeBulbStyles:function(){var a=this,b=a.el,c=b.getAttribute("yne-bulb-block");"hr"===c&&d.each(f,function(c,d){var e=b.getAttribute("yne-style-"+d);e&&(a.styles[d]=e)})},finish:function(){var a=this,b=new c;a.styles&&b.setBlockStyles(a.styles),a.emit(b)}})}({}),yne_parser_html_handlers_ImageHandler=function(a){var b,c=yne_parser_html_handlers_InlineHandler,d=yne_common_data_Image,e=yne_common_data_Attachment,f=yne_underscore;return b=c.extend({inheritStyleHandlers:!1,uninheritStyleHandlers:{width:!0,"float":!0},inheritBlockStyles:{align:!0},_handleNoteLink:function(){var a,b,c,d=this,e=d.el;a=e.getAttribute("data-attr-noteid"),b=e.getAttribute("alt"),a&&b&&(c=d.parent&&d.parent.styles?f.clone(d.parent.styles):{},c.href="note://"+a,c.color="#0000ff",c.underline=!0,d.emit({text:b,styles:c,isText:!0}))},finish:function(a){var c,g,h,i,j=this,k=j.el,l=k.getAttribute("src"),m=function(a,b){f.each(a,function(a,c){var d=b.style[a];d&&(j.styles[c]=d)})};return b.isNoteLink(k)?void j._handleNoteLink():void(l&&(a&&/^file:\/\/\//i.test(l)||(h=k.parentNode,h&&(i=h.getAttribute("yne-bulb-block")),b.isAttachment(k)?(g=k.getAttribute("path"),c=new e({source:l,resource:g,fileName:b.getAttachmentFileName(k),fileLength:b.getAttachmentFileLength(k)}),"attachment"===i&&m({align:"textAlign","float":"float"},h)):b.isImage(k)&&("image"===i&&m({align:"textAlign",width:"width","float":"float"},h),c=new d({source:l})),c&&(c.setStyles(j.styles),j.emit(c)))))}},{isAttachment:function(a){var b=a.getAttribute("path"),c=a.dataset.mediaType;return b&&("attachment"===c||!c)},isImage:function(a){var b=a.dataset.mediaType,c=a.getAttribute("path"),d=["image","handwrite"];return!c&&(!b||d.indexOf(b)>-1)},isNoteLink:function(a){var b=a.dataset.mediaType;return"notelink"===b},getAttachmentFileName:function(a){var b=a.getAttribute("filename")||a.getAttribute("alt")||a.getAttribute("title");return b||""},getAttachmentFileLength:function(a){var b=a.getAttribute("filelength");return b||""}})}({}),yne_parser_html_handlers_TableHandler=function(a){var b=yne_parser_html_handlers_BaseHandler,c=yne_common_data_Table,d=yne_common_data_Image,e=yne_parser_html_handlers_ImageHandler,f=yne_common_data_Attachment,g=yne_jtk_core_L,h=yne_jquery,i=yne_underscore,j=yne_parser_html_handlers_styleHandlers,k=function(a,b){var c;if(a&&a.tagName){if(c=(a.tagName+"").toLowerCase(),c===b+"")return!0;if(i.contains(b,c))return!0}},l=function(a,b,c){if(!a)return c;var d=a.getAttribute(b);return d=parseInt(d||c,10),isNaN(d)&&(d=c),d},m=function(a,b,c){if(!a)return c;var d=a.style[b];return d=parseInt(d||c,10),isNaN(d)&&(d=c),d},n=function(a){if(!a)return!1;var b=["white","#fff","#ffffff","rgb(255,255,255)"];return a=(a+"").toLowerCase(),a=h.trim(a),a=a.replace(/ /g,""),i.contains(b,a)};return b.extend({DEFAULT_HEIGHT:32,DEFAULT_WIDTH:72,_styleHandlers:{bold:{tagList:["b","strong"],styleHandler:function(a){return j.bold.action(a,{},null)}},lineThrough:{tagList:["strike","s","del"],styleHandler:function(a){return j.strike.action(a,{},null)}},underline:{tagList:["u","ins"],styleHandler:function(a){return j.underline.action(a,{},null)}},italic:{tagList:["i","em","cite","var","address","dfn"],styleHandler:function(a){return j.italic.action(a,{},null)}},fontName:function(a){var b=j["font-family"].action(a,{},null);return b?b:"FONT"===a.tagName?(b=a.getAttribute("face"),b||null):void 0},fontSize:function(a){var b=j["font-size"].action(a,{},null);return b?b+"px":void 0},textColor:function(a){var b=j.color.action(a,{},null);return b?b:"FONT"===a.tagName?(b=a.getAttribute("color"),b||null):void 0},backColor:function(a){var b=j["back-color"].action(a,{},null);return b},textAlign:function(a){var b=j.align.action(a,{},null);return b}},_tableStyleHandlers:{verticalAlign:function(a){var b,c=["THEAD","TBODY","TFOOT"];if(a)return b=a.style.verticalAlign||a.getAttribute("valign"),b?b:a.tagName&&i.contains(c,a.tagName)?"middle":void 0},textAlign:function(a){return a?a.style&&a.style.textAlign?a.style.textAlign:a.getAttribute("align"):void 0},textColor:function(a){var b=j.color.action(a,{},null);return b},backColor:function(a){var b=a.style.backgroundColor;return b||null},bold:function(a){if(a&&a.tagName&&"TH"===a.tagName)return"true";var b=j.bold.action(a,{},null);return b?"true":void 0},italic:function(a){var b=j.italic.action(a,{},null);return b?"true":void 0},underline:function(a){var b=j.underline.action(a,{},null);return b?"true":void 0},lineThrough:function(a){var b=j.strike.action(a,{},null);return b?"true":void 0},fontName:function(a){var b=j["font-family"].action(a,{},null);return b},fontSize:function(a){var b=j["font-size"].action(a,{},null);return b?b+"px":void 0}},constructor:function(a,b){var c=this;c.el=a,c.parent=b},_inheritStyles:function(a,b,c){var d=this,e={};return c=c||{},i.each(d._styleHandlers,function(d,f){var g;a[f]!==!1&&(i.isFunction(d)?g=d(b):(d.styleHandler&&(g=d.styleHandler(b)),!g&&d.tagList&&(g=k(b,d.tagList))),g&&"inherit"!==g||(g=c[f]),e[f]=g)}),e},_mergeStyles:function(a,b){var c=this,d=h.trim(a.value),e=d.length;i.each(c._styleHandlers,function(c,d){0===e?b[d]?a[d]=b[d]:a[d]=!1:a[d]&&b[d]!==a[d]&&(a[d]=!1)})},_inheritTableStyles:function(a,b){var c=this,d={},e=["TABLE","THEAD","TBODY","TFOOT","TR","TD","TH"];return i.contains(e,a.tagName+"")?(b=b||{},i.each(c._tableStyleHandlers,function(c,e){var f=c(a);(null==f||"inherit"===f)&&(f=b[e]),null!=f&&(d[e]=f)}),d):{}},_parseImage:function(a,b){var c,g,h,i=this,j=a.getAttribute("src");return e.isNoteLink(a)?(h=a.getAttribute("alt")||"",void(b.value+=h)):void(j&&(e.isAttachment(a)?(g=a.getAttribute("path"),c=new f({source:j,resource:g,fileName:e.getAttachmentFileName(a),fileLength:e.getAttachmentFileLength(a)})):e.isImage(a)&&(c=new d({source:j})),c&&i._blockList.push(c)))},_shouldAddLineBreak:function(a){a=(a+"").toLowerCase();var b=["article","aside","blockquote","br","button","caption","col","colgroup","dd","div","dl","dt","fieldset","figcaption","figure","footer","form","h1","h2","h3","h4","h5","h6","header","hgroup","hr","li","map","ol","output","p","pre","progress","section","textarea","tfoot","ul","video"],c=i.contains(b,a);return c},_parseContent:function(a,b,c){var d,e,f,g,i=this,j=a.firstChild;for(c=c||{};j;)1===j.nodeType?(d=j.tagName,"TABLE"===d?i._parseTable(j):"IMG"===d?i._parseImage(j,b):"BR"===d?b.value+="\n":(f=i._inheritStyles(b,j,c),i._parseContent(j,b,f),i._shouldAddLineBreak(d)&&(b.value+="\n"))):3===j.nodeType&&(e=j.nodeValue,g=h.trim(e),g&&g.length?(i._mergeStyles(b,c),b.value+=e.replace(/[\r\n]/g," ").replace(/\s+/g," ")):b.value+=" "),j=j.nextSibling},_isLinkCell:function(a){if(!a)return!1;var b,c,d,e,f,g,i,j=a.querySelectorAll("a"),k=function(a){return a?1===a.nodeType?""===h.trim(a.textContent||""):3===a.nodeType?""===h.trim(a.nodeValue||""):!0:!0};if(!j||!j.length||1!==j.length)return!1;for(b=j[0],d=b,c=d.parentNode;c&&c!==a;){for(e=c.childNodes,f=e.length,g=0;f>g;g++)if(i=e[g],i!==d&&!k(i))return!1;d=c,c=d.parentNode}return!0},_parseCellContent:function(a,b,c){var d,e=this;e._isLinkCell(a)&&(d=a.querySelector("a"),b.link=d.getAttribute("href")),e._parseContent(a,b,c)},_parseCell:function(a,b,c){var d,e,f,g=this,j={value:""};return g._parseCellContent(a,j,{}),e=h.trim(j.value),e=e.replace(/\n+/g,"\n"),d={value:e},d.value&&j.link&&(d.link=j.link),c===g.DEFAULT_HEIGHT&&(d.wrap="true"),i.each(g._styleHandlers,function(a,b){j[b]===!0?d[b]="true":j[b]&&(d[b]=j[b])}),e=l(a,"colspan",1),e>1&&(d.mergeWidth=e),e=l(a,"rowspan",1),e>1&&(d.mergeHeight=e),f=g._inheritTableStyles(a,b),i.each(f,function(a,b){null==d[b]&&a&&(d[b]=a)}),n(d.backColor)&&delete d.backColor,d},_isArrayFull:function(a,b){var c;if(0===b)return!1;for(c=0;b>c;c++)if(null==a[c])return!1;return!0},_parseTbodyCells:function(a,b,c){var d,e=this,f=i.filter(b.children,e._isTableRow),g=[],h=a.widths.length,j=a.heights.length,k=0;return d=e._inheritTableStyles(b,c),i.each(f,function(b){for(var c=i.filter(b.children,e._isTableCell),f=e._inheritTableStyles(b,d),m=k,n=g[m];n&&e._isArrayFull(n,h);)k++,m++,n=g[m];for(n||(n=g[m]=[]),i.each(c,function(b){for(var c,d,h,i,k,o,p,q,r,s=0,t=n[s];t;)s++,t=n[s];for(c=s,i=e._parseCell(b,f,a.heights[m]),n[c]=i,d=l(b,"rowspan",1),h=l(b,"colspan",1),d>j-m&&(d=j-m,i.mergeHeight=d),k=0;d>k;k++)for(p=m+k,r=g[p],r||(r=g[p]=[]),o=0;h>o;o++)q=c+o,r[q]||(r[q]={mergePointDX:o,mergePointDY:k})});n.length<h;)n.push({value:""});k++}),g},_isTableCell:function(a){if(!a||!a.tagName)return!1;var b=a.tagName||"",c=["TD","TH"];return i.contains(c,b)},_isTableRow:function(a){return a&&a.tagName?"TR"===a.tagName:!1},_getTbodySize:function(a){var b,c,d,e,f,g,h=this,j=[],k=a.length,n=0;for(j.length=k,i.each(a,function(b,c){for(var d,e,f=c,g=j[f];g&&h._isArrayFull(g,n);)f++,g=j[f];g||(g=j[f]=[]),b=a[c],d=i.filter(b.children,h._isTableCell),i.each(d,function(a,b){var c,d,i,k,n,o,p=l(a,"colspan",1),q=l(a,"rowspan",1),r=m(a,"width",0)||l(a,"width",0);for(e+=p,r=Math.max(Math.round(r/p),h.DEFAULT_WIDTH),k=b;null!=g[k];)k++;for(i=0;p>i;i++)n=k+i,g[n]=r;for(c=1;q>c;c++)for(d=f+c,o=j[d],o||(o=j[d]=[]),i=0;p>i;i++)n=k+i,o[n]=r}),e=g.length,e>n&&(n=e)}),b=j.length,g=[],c=0;n>c;c++){for(e=(j[0]||[])[c]||h.DEFAULT_WIDTH,d=1;b>d;d++)f=(j[d]||[])[c],f&&f>e&&(e=f);g.push(e)}return{rows:b,columns:n,columnWidthList:g}},_createBlankRow:function(a){for(var b=[];a>0;)b.push({value:""});return b},_parseTbody:function(a,b,c){var d,e,f,g,h=this,j=i.filter(a.children,h._isTableRow),k=0,n={},o=[],p=0;for(g=h._getTbodySize(j),n.heights=i.map(j,function(a){var b=i.filter(a.children,h._isTableCell),c=0;return i.some(b,function(a){if(!a.getAttribute("rowspan")){var b=m(a,"height",0)||l(a,"height",0);if(b)return c=b,!0}}),c=Math.max(c,h.DEFAULT_HEIGHT)});n.heights.length<g.rows;)n.heights.push(h.DEFAULT_HEIGHT);if(p=0,i.each(g.columnWidthList,function(a){p+=a}),c>p?(e=Math.ceil((c-p)/g.columns),o=i.map(g.columnWidthList,function(a){return a+e})):o=g.columnWidthList,n.widths=o,d=h._parseTbodyCells(n,a,b),f=d.length,k=n.heights.length,k>f)for(;k>f;)d.push(h._createBlankRow(g.columns)),f++;else if(f>k)for(;f>k;)n.heights.push(h.DEFAULT_HEIGHT),k++;return n.cells=d,n},_extendBodyInfo:function(a,b){var c,d,e,f=a.cells,g=a.heights.length,h=a.widths.length;if(!(h>=b))for(c=0;g>c;c++)for(d=f[c],e=d.length;b>e;e++)d.push({value:""})},_convertToTableCells:function(a,b){var c,d,e,f,h,i=a.length,j=[];for(c=0;i>c;c++)for(d=a[c],e=0;b>e;e++)f=d[e],f?(h=c*b+e,j[h]=f):g.error("No tdInfo  at row, col: "+c+", "+e);return j},_mergeTbody:function(a){if(a&&a.length){var b,c=this,d=0,e=[],f=[],g={};return i.each(a,function(a){var c=a.widths.length;c>d&&(d=c,b=a.widths)}),i.each(a,function(a){c._extendBodyInfo(a,d)}),i.each(a,function(a){e=e.concat(a.heights),f=f.concat(a.cells)}),f=c._convertToTableCells(f,d),g.widths=b,g.heights=e,g.cells=f,g}},_parseTable:function(a){var b,c=this,d=i.toArray(a.children),e=["thead","tbody","tfoot"],f={thead:[],tbody:[],tfoot:[]},g=[],h=c._blockList.length,j=c._inheritTableStyles(a,{}),k=m(a,"width",0)||l(a,"width",0);c._blockList.push(0),i.each(d,function(a){var b,d=(a.tagName||"").toLowerCase();i.contains(e,d)&&(b=c._parseTbody(a,j,k),f[d].push(b))}),i.each(e,function(a){var b=f[a];b&&b.length&&(g=g.concat(b))}),b=c._mergeTbody(g),b&&(c._blockList[h]=b)},setup:function(){var a=this;a._blockList=[]},finish:function(){var a=this;a._parseTable(a.el),i.each(a._blockList,function(b){var d;b&&b.heights?d=new c({data:{heights:b.heights,widths:b.widths,cells:b.cells}}):b&&(d=b),d&&a.emit(d)})}})}({}),yne_common_data_List=function(a){var b,c=yne_jtk_core_Class,d=yne_backbone.Events,e=yne_underscore,f=yne_jquery,g=yne_jtk_core_assert;return b=c.extend(e.extend({_id:null,_type:null,_items:null,unknownAttrs:null,initialize:function(a){var b=this;b._id=e.uniqueId("list"),b._type=a.type,b._items=[],b.unknownAttrs=[]},getId:function(){return this._id},isOrdered:function(){return this._type===b.ORDERED},isUnordered:function(){return this._type===b.UNORDERED},getType:function(){return this._type},setType:function(a){g(a===b.ORDERED||a===b.UNORDERED),a!==this._type&&(this._type=a,this.updateIndexes(),this.trigger("type-change"))},getLength:function(){return this._items.length},getItems:function(){return this._items},updateIndexes:function(){if(this._type===b.ORDERED){var a,c,d,e=this,f=e._items,g=f.length,h=0,i={};for(a=0;g>a;++a)c=f[a],d=c.getLevel(),d>h?i[d]=1:i[d]?i[d]++:i[d]=1,h=d,c.setIndex(i[d])}},insertItem:function(a,b){var c=this,d=c._items;return g(a>0||a<=d.length),g(!(b in d)),d.splice(a,0,b),c.updateIndexes(),a},insertAfter:function(a,b){var c=this,d=c._items,e=b?d.indexOf(b):-1;c.insertItem(e+1,a)},removeItem:function(a){var b=this,c=b._items,d=c.indexOf(a);return d>=0&&(c.splice(d,1),b.updateIndexes()),d}},d),{ORDERED:"ordered",UNORDERED:"unordered",fromXml:function(a){var c=f(a),d=c.attr("type"),g=new b({type:d});return e.each(a.attributes,function(a){switch(a.nodeName){case"id":case"type":break;default:g.unknownAttrs.push(a.cloneNode(!0))}}),g}})}({}),yne_parser_html_handlers_ListHandler=function(a){var b,c=yne_parser_html_handlers_BaseHandler,d=yne_common_data_List,e=yne_common_data_ListItem,f=yne_underscore;return b=c.extend({list:null,level:null,type:null,_itemCounter:null,prevSimilar:null,inheritStyleHandlers:{bold:!0,italic:!0,underline:!0,strike:!0,"font-family":!0,"font-size":!0,color:!0,"back-color":!0,"white-space":!0,align:!0,"line-height":!0,indent:!0,"text-indent":!0},_parseTypeFromElement:function(){var a=this;return"ul"===a.el.tagName.toLowerCase()?d.UNORDERED:d.ORDERED},_getStartIndexFromElement:function(){var a=this,b=a.type,c=a.el,e=-1;return b!==d.ORDERED?e:("list"===c.getAttribute("yne-block-type")&&(e=parseInt(c.getAttribute("start"),10),isNaN(e)&&(e=-1)),e)},increaseItemCounter:function(){var a,b=this,c=b.prevSimilar;c&&c.increaseItemCounter?c.increaseItemCounter():(a=b._itemCounter||0,a+=1,b._itemCounter=a)},getItemCounter:function(){var a=this,b=a.prevSimilar;return b?b.getItemCounter():a._itemCounter||0},setup:function(){var a,b,c,e=this,f=e._findParentListHandler();e.list=null,e.level=1,f&&(e.level=f.level+1),c=e._parseTypeFromElement(),e.type=c,b=e._getStartIndexFromElement(),b>1&&(a=e._getPreviousSimilar(),a&&a.getItemCounter()===b-1&&(e.prevSimilar=a,e.list=a.list)),e.list||(e.list=new d({type:c}))},capture:function(a){var b=this,c=b.level;a instanceof e&&a.getLevel()<c&&a.setLevel(c),b.emit(a)},_findParentListHandler:function(){for(var a=this.parent;a;){if(a instanceof b)return a;a=a.parent}},_getPreviousSimilar:function(){var a,c=this,d=c.level,e=c.type,g=c.parent,h=g.children;return f.some(h,function(c){return c instanceof b&&c.level===d&&c.type===e?(a=c,!0):void 0}),a}})}({}),yne_parser_html_handlers_ListItemHandler=function(a){var b=yne_parser_html_handlers_ParagraphHandler,c=yne_common_data_ListItem,d=yne_parser_html_handlers_ListHandler;return b.extend({setup:function(){var a=this;a.ownerListHandler=a._findOwnerListHandler()},captureBlock:function(a){var b=this,c=null;b.emitBlock(),!b._listed&&a.getType&&"paragraph"===a.getType()?(c=b.createBlock(),c.append(a.getText()),b.emit(c)):b.emit(a)},emit:function(a){var d=this;a instanceof c&&(d._listed=!0),b.prototype.emit.call(d,a)},createBlock:function(){var a=this,d=a.ownerListHandler;return!a._listed&&d&&d.list?(d.increaseItemCounter(),new c({list:d.list})):b.prototype.createBlock.call(a)},_findOwnerListHandler:function(){for(var a=this.parent;a;){if(a instanceof d)return a;a=a.parent}}})}({}),yne_parser_html_handlers_handlerMap={ParagraphHandler:yne_parser_html_handlers_ParagraphHandler,InlineHandler:yne_parser_html_handlers_InlineHandler,AnchorHandler:yne_parser_html_handlers_AnchorHandler,BreakHandler:yne_parser_html_handlers_BreakHandler,HrHandler:yne_parser_html_handlers_HrHandler,TableHandler:yne_parser_html_handlers_TableHandler,ImageHandler:yne_parser_html_handlers_ImageHandler,ListHandler:yne_parser_html_handlers_ListHandler,ListItemHandler:yne_parser_html_handlers_ListItemHandler},yne_parser_html_tagConfig=function(a){var b=!1,c=yne_parser_html_handlers_handlerMap;return{a:c.AnchorHandler,abbr:c.InlineHandler,acronym:c.InlineHandler,address:c.ParagraphHandler,applet:b,area:b,article:c.ParagraphHandler,aside:c.ParagraphHandler,audio:b,b:c.InlineHandler,base:b,basefont:b,bdi:c.InlineHandler,bdo:c.InlineHandler,bgsound:b,big:c.InlineHandler,blink:c.InlineHandler,blockquote:c.ParagraphHandler,body:c.ParagraphHandler,br:c.BreakHandler,button:b,canvas:b,center:c.ParagraphHandler,cite:c.InlineHandler,code:c.InlineHandler,command:b,content:b,data:b,datalist:b,dd:c.ParagraphHandler,del:c.InlineHandler,details:c.ParagraphHandler,dfn:c.InlineHandler,dialog:b,dir:c.InlineHandler,div:c.ParagraphHandler,dl:c.ParagraphHandler,dt:c.ParagraphHandler,element:b,em:c.InlineHandler,embed:b,fieldset:c.ParagraphHandler,figcaption:c.ParagraphHandler,figure:c.ParagraphHandler,font:c.InlineHandler,footer:c.ParagraphHandler,form:c.ParagraphHandler,frame:b,frameset:b,h1:c.ParagraphHandler,h2:c.ParagraphHandler,h3:c.ParagraphHandler,h4:c.ParagraphHandler,h5:c.ParagraphHandler,h6:c.ParagraphHandler,header:c.ParagraphHandler,hgroup:c.ParagraphHandler,hr:c.HrHandler,html:c.ParagraphHandler,i:c.InlineHandler,iframe:b,image:b,img:c.ImageHandler,input:b,ins:c.InlineHandler,isindex:b,kbd:c.InlineHandler,keygen:b,label:c.InlineHandler,legend:c.ParagraphHandler,li:c.ListItemHandler,link:b,listing:b,main:c.ParagraphHandler,map:b,mark:c.InlineHandler,marquee:c.ParagraphHandler,menu:b,menuitem:b,meta:b,meter:c.InlineHandler,multicol:c.ParagraphHandler,nav:c.ParagraphHandler,nobr:c.InlineHandler,noembed:b,noframes:b,noscript:b,object:b,ol:c.ListHandler,optgroup:b,option:b,output:c.InlineHandler,p:c.ParagraphHandler,param:b,picture:b,plaintext:c.ParagraphHandler,pre:c.ParagraphHandler,progress:b,q:c.InlineHandler,rp:c.InlineHandler,rt:c.InlineHandler,rtc:c.InlineHandler,ruby:c.ParagraphHandler,s:c.InlineHandler,samp:c.InlineHandler,script:b,section:c.ParagraphHandler,select:b,shadow:b,small:c.InlineHandler,source:b,spacer:b,span:c.InlineHandler,strike:c.InlineHandler,strong:c.InlineHandler,style:b,sub:c.InlineHandler,summary:c.ParagraphHandler,sup:c.InlineHandler,table:c.TableHandler,template:b,textarea:c.ParagraphHandler,time:c.InlineHandler,title:b,track:b,tt:c.InlineHandler,u:c.InlineHandler,ul:c.ListHandler,"var":c.InlineHandler,video:b,wbr:b,xmp:b}}({}),yne_parser_html_mso_ListHandler=function(a){function b(a,b){var c=a.match(/(@[\w_\-:\s]+)\n\s*\{(.|\n)*?\}/gm);null!==c&&c.forEach(function(a){var c=/@([\w_\-:\s]+)/.exec(a)[1].trim(),d=a.substring(a.indexOf("{")+1,a.indexOf("}")).trim(),e={};d.split(";").forEach(function(a){var b;-1!==a.indexOf(":")&&(b=a.split(":"),e[b[0].trim()]=b[1].trim())}),b[c]||(b[c]={}),g.extend(b[c],e)})}var c=yne_parser_html_handlers_ParagraphHandler,d=yne_common_data_List,e=yne_common_data_ListItem,f=yne_jtk_core_L,g=yne_underscore;return c.extend({setup:function(){var a,b,e,f,g,h,i,j=this.getRoot();c.prototype.setup.call(this),a=this.el.getAttribute("style"),a&&(b=/mso-list:(l\d+) (level\d+)/.exec(a),b&&(g=b[1],h=b[2],e=this._getStyles(),f=e["list "+g+":"+h],f&&(i=j["mso-"+g],i||(i=j["mso-"+g]=new d({type:"bullet"===f["mso-level-number-format"]?d.UNORDERED:d.ORDERED})),this.list=i,this.level=Number(h.replace("level","")),this.el.querySelector('[style="mso-list:Ignore"]').remove())))},createBlock:function(){return this.list?new e({list:this.list,level:this.level}):c.prototype.createBlock.call(this)},_getStyles:function(){var a,c=this.getRoot(),d=this.el.ownerDocument,e={};return c.msoStyles?c.msoStyles:(a=d.querySelectorAll("style"),g.each(a,function(a){1===a.childNodes.length&&3===a.firstChild.nodeType&&b(a.firstChild.textContent,e)}),f.log(e),c.msoStyles=e,e)}})}({}),yne_parser_html_convert=function(a){var b,c=yne_parser_html_Parser,d=yne_parser_html_tagConfig,e=yne_parser_html_mso_ListHandler;return function(a,f){return b||(b=new c(d),b.define(".MsoListParagraph",e,c.PRIORITY.HIGH)),b.parse(a,f)}}({}),yne_parser_plain_createRichText=function(a){var b=yne_common_data_RichText;return function(a,c){var d;return a+="",a=a.replace(/[\r\n]/g,""),d=new b({text:a}),c&&d.setStyles(0,d.getLength(),c),d}}({}),yne_common_commands_link_LinkMatch={matchEnd:function(a){var b,c,d=/(https?:\/\/|www\.|ssh:\/\/|ftp:\/\/)[a-z0-9&_+\-\?\/\.=\#,:,@]+$/i,e=/[a-z0-9_+\-\.]+@[a-z0-9_+\-\.]+$/i;return a=String(a),(b=d.exec(a))?(c=b[0],{mail:!1,fullURI:0===c.toLowerCase().indexOf("www.")?"http://"+c:c,result:b}):(b=e.exec(a),b?(c=b[0],{mail:!0,fullURI:"mailto:"+c,result:b}):void 0)}},yne_parser_plain_parseLine=function(a){var b=yne_parser_plain_createRichText,c=yne_common_data_Paragraph,d=yne_common_commands_link_LinkMatch,e=yne_underscore;return function(a,f,g){if(null!=a){var h,i,j=new c;return h=d.matchEnd(a),h&&0===h.result.index&&e.extend(f?f:f={},{href:h.fullURI,underline:!0,color:"#0000ff"}),i=b(a,f),j.setText(i),g&&e.each(g,function(a,b){j.setBlockStyle(b,a)}),j}}}({}),yne_parser_plain_convert=function(a){var b=yne_jtk_core_L,c=yne_underscore,d=yne_parser_plain_parseLine;return function(a,e,f){var g,h=[];return a?(g=a.split(/\r?\n/),g&&g.length?(c.each(g,function(a){var b=d(a,e,f);b&&h.push(b)}),b.log("to paste text",h),h):void b.warn("lines do not exist or lines.length is 0!")):void b.warn("no text when paste plain text!")}}({}),yne_parser_json_createBlock=function(a){var b=yne_common_data_Paragraph,c=yne_common_data_ListItem,d=yne_common_data_Image,e=yne_common_data_Attachment,f=yne_common_data_Table,g=yne_common_data_Hr,h=yne_common_data_blockTypes,i=yne_jtk_core_L;return function(a){if(!a||!a.blockType)return void i.warn("jsonObj is null or jsonObj has no `blockType` property!");var j,k=a.blockType;switch(k){case h.PARAGRAPH:j=b.fromJSON(a);break;case h.LIST_ITEM:j=c.fromJSON(a);break;case h.IMAGE:j=d.fromJSON(a);break;case h.ATTACHMENT:j=e.fromJSON(a);break;case h.TABLE:j=f.fromJSON(a);break;case h.HR:j=g.fromJSON(a);break;default:i.warn("jsonObj.blockType = "+k)}return j}}({}),yne_parser_json_convert=function(a){var b=yne_jtk_core_L,c=yne_underscore,d=yne_common_data_List,e=yne_common_data_blockTypes,f=yne_parser_json_createBlock;return function(a,g){var h,i,j,k=[],l={};if(c.isString(a))try{h=window.JSON.parse(a)}catch(m){b.error("parse json string error: ",a)}else c.isArray(a)&&(h=a);if(h&&h.length)return b.log("createBlocksFromJSON array: ",h),c.each(h,function(a){var b;g&&a.source&&/^file:\/\/\//i.test(a.source)||(b=f(a),b&&(a.listId&&a.listType&&e.isListItem(b)&&(i=a.listId,j=l[i],j||(j=new d({type:a.listType}),l[i]=j),b.setOwnerList(j)),k.push(b)))}),k}}({}),yne_parser_Parser=function(a){var b=yne_parser_html_convert,c=yne_parser_plain_convert,d=yne_parser_json_convert,e=yne_jtk_core_L;return{parseHtml:function(a,c){var d=b(a,c);return e.log("parseHtml OK",d),d},parsePlain:function(a){var b=c(a);return b},parseJSON:function(a,b){var c=d(a,b);return c}}}({}),yne_common_util_ListItemNode=function(a){var b,c=yne_jtk_core_Class,d=yne_underscore,e=yne_jtk_core_L;
return b=c.extend({constructor:function(a,b,c){var f=this;e.DEBUG&&(f._debugId=d.uniqueId()),f.level=a||0,f.block=b,f.addChildNodes(c)},addChildNodes:function(a){var b=this;a&&(d.isArray(a)||(a=[a]),d.each(a,function(a){a.parentNode=b,b.childNodes||(b.childNodes=[]),b.childNodes.push(a)}))},childrenCount:function(){var a=this,b=a.childNodes;return b?b.length:0},hasChildren:function(){var a=this.childrenCount();return a>0},isOrdered:function(){var a=this;return a.block?a.block.isOrdered():a.parentNode?a.parentNode.isOrdered():!1},getStartIndex:function(){var a=this;return a.block?a.block.getIndex():1},isChildOrdered:function(){var a=this,b=a.childNodes||[],c=b[0];return c?c.isOrdered():!1},getChildStartIndex:function(){var a=this,b=a.childNodes||[],c=b[0];return c?c.getStartIndex():1},toHtml:function(){var a,b,c,e,f,g,h=this,i=h.block,j=[];return h.hasChildren()?(f=i?i.toHtml():"",j.push(f),a=h.isChildOrdered()?"ol":"ul",c="<"+a+' yne-block-type="list"',b=h.getChildStartIndex(),b>1&&(c+=' start="'+b+'"'),c+=">",j.push(c),g=h.childNodes,d.each(g,function(a){var b=a.toHtml();j.push(b)}),e="</"+a+">",j.push(e)):(f=i?i.toHtml(i._toHtmlStart,i._toHtmlEnd):"<li></li>",j.push(f)),j=j.join("")}})}({}),yne_common_data_Note=function(a){var b,c,d,e=yne_underscore,f=yne_backbone,g=yne_jtk_core_Class,h=yne_jquery,i=yne_underscorestring,j=yne_common_data_blockMap,k=yne_common_data_Unknown,l=yne_parser_Parser,m=yne_common_data_Paragraph,n=yne_jtk_core_L,o=yne_common_data_List,p=yne_common_data_ListItem,q=yne_common_data_blockTypes,r=yne_common_constants,s=yne_common_data_supportedInlineStyles,t=yne_common_util_ListItemNode,u=yne_common_util_schemaVersion,v=function(a){return a instanceof m&&!a.isEmpty()},w=u.getDefaultAsString(),x=yne_common_util_clearString;return b={blocks:null,_isReadOnly:!1,headUnknownNodeList:null,initialize:function(){var a=this;a.blocks=[],a.headUnknownNodeList=[],a.schemaVersion=w},getBlockAt:function(a){var b=this;return b.blocks[a]},getBlockIndex:function(a){var b=this;return e.indexOf(b.blocks,a)},getPreBlock:function(a){var b=this,c=b.getBlockIndex(a);return c>0?b.getBlockAt(c-1):void 0},getNextBlock:function(a){var b=this,c=b.getBlockIndex(a);return c>=0?b.getBlockAt(c+1):void 0},getLastBlock:function(){var a=this,b=e.last(a.blocks);return b},lastBlockIsEasyInput:function(){var a=this,b=a.getLastBlock();return q.isParagraph(b)||q.isListItem(b)},getInterBlocks:function(a,b,c){var d=this,e=d.blocks,f=d.getBlockIndex(a),g=d.getBlockIndex(b);return c?e.slice(f,g+1):e.slice(f+1,g)},getAllBlocks:function(){var a=this;return a.blocks},getCommonInlineStyle:function(a,b){if(a&&b){var c,d=a.getStartBlockRange(),f=a.getEndBlockRange(),g=d.block,h=f.block,i=null,j=[],k=!0;return v(g)&&(j.push(g.getCommonStyle(b,d)),k=!1),g!==h&&(c=this.getInterBlocks(g,h),e.each(c,function(a){v(a)&&(j.push(a.getCommonStyle(b)),k=!1)}),v(h)&&(j.push(h.getCommonStyle(b,f)),k=!1)),k?(q.isParagraph(g)&&(i=g.getDefaultInlineStyle(b)),i||s.getDefault(b)):(e.each(j,function(a){null===i?i=a:null!=a&&i!==a&&(i=r.INTERM)}),i)}},getRangeBlockStyle:function(a,b){if(a&&b){var c=a.getStartBlockRange(),d=a.getEndBlockRange(),f=c.block,g=d.block,h=this.getInterBlocks(f,g,!0),i=null;return e.each(h,function(a){var c=a.getBlockStyle(b);i=null===i?c:i===c?i:r.INTERM}),i}},isSameList:function(a,b){var c,d,e,f,g=a.getStartBlockRange(),h=a.getEndBlockRange(),i=g.block,j=h.block,k=this.getInterBlocks(i,j,!0),l=k.length;for(c=0;l>c;c++)if(d=k[c],d instanceof m){if(!(d instanceof p))return!1;if(e=d.getOwnerList(),e.getType()!==b)return!1;if(f){if(f!==d.getOwnerList())return!1}else f=e}return f?!0:!1},insert:function(a,b){var c=this;c.blocks.splice(a,0,b),c._bindEventsForBlock(b),b.trigger("attached",c),c.trigger("insert-block",a,b)},append:function(a){var b=this,c=b.blocks;b.insert(c.length,a)},replace:function(a,b){var c=this,d=c.blocks.splice(a,1,b)[0];return d.trigger("detached",c),c._unbindEventsForBlock(d),c._bindEventsForBlock(b),b.trigger("attached",c),c.trigger("replace-block",a,b,d),d},remove:function(a){var b=this,c=b.blocks.splice(a,1)[0];c&&(c.trigger("detached",b),b._unbindEventsForBlock(c),b.trigger("remove-block",a,c))},removeBlock:function(a){var b=this;b.remove(b.getBlockIndex(a))},toXml:function(){var a,b,c=this,d="<?xml",f='<?xml version="1.0"?>\n',g="http://note.youdao.com",h=document.implementation,j=h.createDocument(g,"note",null),k=j.createElement("head"),l=j.createElement("body"),m={},o=c.getSchemaVersion(),p=j.documentElement;return p.appendChild(k),p.appendChild(l),o&&p.setAttribute("schema-version",o),e.each(c.blocks,function(a){var b,c,d,f,g;a&&a.toXml&&(b=a.toXml(j)),b?b.listItem?(c=b,l.appendChild(c.listItem),f=c.listId,m[f]||(m[f]=!0,d=j.createElement("list"),g=c.ownerList.unknownAttrs,e.each(g,function(a){var b=a.cloneNode(!0);d.setAttributeNode(b)}),d.setAttribute("id",f),d.setAttribute("type",c.listType),k.appendChild(d))):l.appendChild(b):n.warn("block.toXml() failed!")}),e.each(c.headUnknownNodeList,function(a,b){if(b&&b.cloneNode){var c=b.cloneNode(!0);k.appendChild(c)}}),a=new window.XMLSerializer,b=a.serializeToString(j),i.startsWith(b,d)||(b=f+b),b},_parseToTree:function(a){var b,c,d,e,f,g,h,i=new t(0),j=a.length;for(d=i,b=0;j>b;b++){if(c=a[b],g=c.getLevel(),f=new t(g,c),h=g-d.level,h>1)for(;g-d.level>1;)e=new t(d.level+1),d.addChildNodes(e),d=e;else if(1>h)for(;g-d.level<1;)d=d.parentNode;d.addChildNodes(f),d=f}return i},_toHtmlWithSameOwnerList:function(a){var b,c=this,d=c._parseToTree(a);return d&&(b=d.toHtml()),b||""},toHtml:function(a){var b,c,d,e,f,g,h=this,i=h.blocks,j=i.length,k=[],l=[];for(a?(f=a.startIndex,g=a.endIndex,i[f]._toHtmlStart=a.startRangeStart,i[f]._toHtmlEnd=a.startRangeEnd,i[g]._toHtmlStart=a.endRangeStart,i[g]._toHtmlEnd=a.endRangeEnd,g++):(f=0,g=j),b=f;g>b;b++)q.isListItem(i[b])?(e=i[b].getOwnerList(),d&&d!==e&&l.length&&(c=h._toHtmlWithSameOwnerList(l),k.push(c),l=[]),l.push(i[b]),d=e):(d=null,l.length&&(c=h._toHtmlWithSameOwnerList(l),k.push(c),l=[]),c=i[b].toHtml(i[b]._toHtmlStart,i[b]._toHtmlEnd),k.push(c));return l.length&&(c=h._toHtmlWithSameOwnerList(l),k.push(c)),a&&(delete i[f]._toHtmlStart,delete i[f]._toHtmlEnd,delete i[g-1]._toHtmlStart,delete i[g-1]._toHtmlEnd),k=k.join("")},toPlain:function(){var a=this,b=e.map(a.blocks,function(a){return a.toPlain()});return b=b.join("\n")},countWords:function(){var a=this,b=0;return e.each(a.blocks,function(a){var c=a.countWords()||0;b+=c}),b},destroy:function(){var a=this;e.each(a.blocks,function(b){a._unbindEventsForBlock(b)}),a.blocks=null},_bindEventsForBlock:function(a){var b=this;a&&(b._unbindEventsForBlock(a),q.isTable(a)&&(a.on("ytable-register",b.trigger.bind(b,"ytable-register")),a.on("ytable-unregister",b.trigger.bind(b,"ytable-unregister")),a.on("ytable-contextmenu",b.trigger.bind(b,"ytable-contextmenu")),a.on("ytable-delete",function(){b.trigger("ytable-delete",a)})))},_unbindEventsForBlock:function(a){a&&q.isTable(a)&&(a.off("ytable-register"),a.off("ytable-unregister"),a.off("ytable-contextmenu"),a.off("ytable-delete"))},setSchemaVersion:function(a){this.schemaVersion=a||w},getSchemaVersion:function(){return this.schemaVersion||w},setReadOnly:function(a){var b=this;a=!!a,e.each(b.blocks,function(b){b.setLocked(a)}),b._isReadOnly=a,b.trigger("read-only-change",a)},isReadOnly:function(){return this._isReadOnly}},c={fromXml:function(a){var b,c,f,g=new d,i={};return e.isString(a)?(a=x(a),b=h.parseXML(a)):b=a,n.log(b),c=h(b).find("note:first"),f=c.attr("schema-version"),f&&g.setSchemaVersion(f),c&&c.get(0)?(c.find("head").children().each(function(a,b){var c,d=b.nodeName;switch(d){case"list":c=o.fromXml(b),i[h(b).attr("id")]=c;break;default:c=h(b).attr(r.COMPAT),u.isCompatable(c)&&(c=b.cloneNode(!0),g.headUnknownNodeList.push(c))}}),c.find("body").children().each(function(a,b){var c,d,e=b.nodeName,f=j[e];if(!f){if(c=h(b).attr(r.COMPAT),!u.isCompatable(c))return;f=k}f&&f.fromXml&&(d=f.fromXml(b),"list-item"===d.getType()&&d.setOwnerList(i[h(b).attr("list-id")]),g.append(d))}),g):void 0},fromHtml:function(a){var b=l.parseHtml(a),c=new d,f=0;return e.each(b,function(a){a&&(c.append(a),f++)}),f?c:null},createBlank:function(){var a=new d,b=new m;return a.append(b),a}},e.extend(b,f.Events),d=g.extend(b,c)}({}),yne_common_selection_NoteSelection=function(a){var b,c,d=yne_jtk_core_Class,e=yne_backbone,f=yne_underscore,g=yne_common_selection_NoteRange,h=yne_jtk_core_L,i=yne_common_selection_nativeSelection;return c={noteView:null,_noteRange:null,initialize:function(a){var b=this;b.noteView=a.noteView,b._bindEvents()},_bindEvents:function(){var a=this,b=a.noteView;f.bindAll(a,"_onDocSelectionChange","_onSetRange"),b.on("selectionchange",a._onDocSelectionChange),b.on("set-range",a._onSetRange)},_onDocSelectionChange:function(){h.log("on doc selection change!");var a=this,b=i.getRange(),c=a._convertToNoteRange(b);return a._noteRange=c,h.log("NoteSelection -> contentchange"),c&&!c.canDrawedByNative()?void a.setRange(c):void a._triggerSelectionChange()},_triggerSelectionChange:function(){var a=this;h.log("---------note-selection-change---------"),a.trigger("selection-change")},_onSetRange:function(a,b,c){var d=this;d._setRange(a,b,c)},_setRange:function(a,b,c){var d=this,e=d._convertToNoteRange(a);return e?(d._noteRange=e,b&&d._drawRange(),void(c&&d._triggerSelectionChange())):void h.warn("Failed convert native range to note range!")},_drawRange:function(){var a=this,b=a._noteRange;a.noteView.trigger("draw-range",b)},_convertToNoteRange:function(a){var b=this,c=b.noteView,d=g.fromNativeRange(a,c);return d},setRange:function(a){var b=this;b._setRange(a,!0,!0)},getRange:function(){var a=this;return a._noteRange},getNativeRange:function(){return i.getRange(window)},isCollapsed:function(){var a=this,b=a._noteRange;return b?b.isCollapsed():void 0},collapseToStart:function(){var a=this,b=a._noteRange;b&&b.collapse&&(b.collapse(!0),a._drawRange(),a._triggerSelectionChange())},collapseToEnd:function(){var a=this,b=a._noteRange;b&&b.collapse&&(b.collapse(!1),a._drawRange(),a._triggerSelectionChange())},reset:function(){var a=this;a._noteRange=null}},f.extend(c,e.Events),b=d.extend(c)}({}),yne_common_commands_Command=function(a){var b=yne_jtk_core_Class;return b.extend({name:"UnknownCommand",isSimple:!1,apply:function(){throw"Method not implemented."},doReapply:function(){throw"Method not implemented."},doUnapply:function(){throw"Method not implemented."}})}({}),yne_common_commands_SimpleCommand=function(a){var b=yne_common_commands_Command,c=yne_jtk_core_L;return b.extend({name:"UnknownSimpleCommand",isSimple:!0,initialize:function(){},apply:function(){throw"Method not implemented."},doReapply:function(){var a=this;c.log("doReapply(): `"+a.name+"`"),a.apply()},doUnapply:function(){var a=this;throw c.log("doReapply(): `"+a.name+"`"),"Method not implemented."}})}({}),yne_common_commands_ManagerAdapter=function(a){var b=yne_common_commands_SimpleCommand,c=b.extend({name:"managerAdapter",initialize:function(a){var b=this;b.undoManager=a.undoManager},apply:function(){},doReapply:function(){var a=this;a.undoManager.redo()},doUnapply:function(){var a=this;a.undoManager.undo()}},{create:function(a){return a&&a.redo&&a.undo?new c({undoManager:a}):void 0}});return c}({}),yne_common_commands_CommandManager=function(a){var b,c,d=yne_jtk_core_Class,e=yne_underscore,f=yne_jtk_core_L,g=yne_backbone,h=yne_common_commands_ManagerAdapter;return c={_undoStack:null,_redoStack:null,initialize:function(){var a=this;a._undoStack=[],a._redoStack=[]},exec:function(a){var b,c,d=this;return a.apply(),c=a.getEndingRange(),a.effected?(d._undoStack.push(a),d._redoStack=[],d.trigger("update-selection",c),void d.trigger("command-exec",a.name)):(b=a.getStartingRange(),void(b!==c&&d.trigger("update-selection",c)))},canUndo:function(){var a=this;return 0!==a._undoStack.length},undo:function(){if(!this.canUndo())return f.warn("Can Not undo"),!1;var a=this,b=a._undoStack,c=a._redoStack,d=b.pop();return d.doUnapply(),c.push(d),a.trigger("command-exec",d.name),"managerAdapter"!==d.name&&a.trigger("update-selection",d.getStartingRange()),!0},canRedo:function(){var a=this;return 0!==a._redoStack.length},redo:function(){if(!this.canRedo())return!1;var a=this,b=a._undoStack,c=a._redoStack,d=c.pop();return d.doReapply(),b.push(d),a.trigger("command-exec",d.name),"managerAdapter"!==d.name&&a.trigger("update-selection",d.getEndingRange()),!0},reset:function(){var a=this;a._undoStack=[],a._redoStack=[]},registerManager:function(a){var b=this;return a&&a.on?(b.unregisterManager(a),void a.on("execute-command",function(){var c=h.create(a);return c?(b._undoStack.push(c),b._redoStack=[],void b.trigger("command-exec",c.name)):void f.warn("ManagerAdapter failed to create command!")})):void f.warn("undoManager is not Valid!")},unregisterManager:function(a){a&&a.on&&a.off("execute-command")}},e.extend(c,g.Events),b=d.extend(c)}({}),yne_common_commands_CompositeCommand=function(a){var b=yne_common_commands_Command,c=yne_jtk_core_L;return b.extend({name:"UnknownCompositeCommand",isSimple:!1,startingRange:null,endingRange:null,effected:!1,initialize:function(){},_applyCommandToComposite:function(a,b){var c=this,d=c._cmds;d||(d=c._cmds=[]),a.apply(),a.isSimple?c.effected=!0:c.effected=c.effected||a.effected,b||a.isSimple||!a.getEndingRange||(b=a.getEndingRange()),b&&c.setEndingRange(b),d.push(a)},apply:function(){throw"Method not implemented."},doReapply:function(){var a,b,d=this,e=d._cmds;if(c.log("doReapply(): `"+d.name+"`"),!e||!e.length)return void c.warn("doReapply(): the composite command `"+d.name+"`no _cmds");for(a=e.length,b=0;a>b;++b)e[b].doReapply()},doUnapply:function(){var a,b=this,d=b._cmds;if(c.log("doUnapply(): `"+b.name+"`"),!d||!d.length)return void c.warn("doUnapply(): the composite command `"+b.name+"`no _cmds");for(a=d.length-1;a>=0;--a)d[a].doUnapply()},setStartingRange:function(a){this.startingRange=a},setEndingRange:function(a){this.endingRange=a},getStartingRange:function(){return this.startingRange},getEndingRange:function(){return this.endingRange}})}({}),yne_common_commands_paragraph_DeleteRange=function(a){var b=yne_common_commands_SimpleCommand;return b.extend({name:"DeleteRange",_paragraph:null,_args:null,_deletedText:null,initialize:function(a){var b=this,c=a.paragraph,d=a.args;b._paragraph=c,b._args=d},apply:function(){var a=this,b=a._paragraph,c=a._args,d=c.range,e=b.getRangeText(d);return e?(a._deletedText=e,b.deleteText(d),!0):!1},doUnapply:function(){var a=this,b=a._paragraph,c=a._args,d=c.range,e=a._deletedText;e&&b.insertText(d.start,e)}})}({}),yne_common_commands_paragraph_SetStyle=function(a){var b=yne_common_commands_SimpleCommand;return b.extend({name:"SetStyle",_paragraph:null,_args:null,_oldValue:null,initialize:function(a){var b=this;b._paragraph=a.paragraph,b._args=a.args},apply:function(){var a=this,b=a._paragraph,c=a._args,d=c.range,e=c.name,f=c.value;a._oldValue=b.getTextStyle(e,d),b.setTextStyle(e,f,d)},doUnapply:function(){var a=this,b=a._paragraph,c=a._args,d=c.range,e=c.name;b.setTextStyle(e,a._oldValue,d)}})}({}),yne_common_commands_link_DeleteLink=function(a){var b=yne_common_commands_CompositeCommand,c=yne_common_commands_paragraph_SetStyle,d=yne_common_selection_ParagraphRange,e=yne_underscore;return b.extend({name:"DeleteLink",initialize:function(a){var b=this;b._note=a.note,b._args=a.args},apply:function(){function a(a){var f;f=new d({block:g.block,start:a,end:j.length}),e.each(k,function(a,d){b._applyCommandToComposite(new c({paragraph:h,args:{range:f,name:d,value:a}}))})}var b=this,f=b._args,g=f.range,h=g.block,i=g.end-1,j=h.getText().toString(),k={href:"",color:"block",underline:!1};" "===j[i]&&i--;for(var l=i;l>0;l--){if(!h.getTextStyle("href",l,l+1))return!1;if(h.getTextStyle("href",l,l+1)[0]!==h.getTextStyle("href",l-1,l)[0])return a(l);if(1===l)return a(0)}}})}({}),yne_common_commands_paragraph_DeleteBackward=function(a){var b=yne_common_commands_CompositeCommand,c=yne_common_selection_NoteRange,d=yne_common_selection_ParagraphRange,e=yne_common_data_Paragraph,f=yne_common_commands_paragraph_DeleteRange,g=yne_jtk_core_assert,h=yne_common_commands_link_DeleteLink;return b.extend({name:"DeleteBackward",initialize:function(a){var b=this;b._block=a.block,b._args=a.args},apply:function(){var a,b,i,j=this,k=j._block,l=j._args.range,m=l.start,n=l.end;g(k instanceof e),g(m>0),g(m===n),b=a=m-1,b>0&&(i=k.getTextStyle("href",b-1,b),i[0]&&j._applyCommandToComposite(new h({args:{range:l}}))),j._applyCommandToComposite(new f({paragraph:k,args:{range:{start:a,end:m}}}),new c({blockRanges:[new d({block:k,start:a,end:b})]}))}})}({}),yne_common_commands_paragraph_Merge=function(a){var b=yne_common_commands_SimpleCommand;return b.extend({name:"Merge",_note:null,_args:null,_paragraphLength:null,initialize:function(a){var b=this,c=a.note,d=a.args;b._note=c,b._args=d},apply:function(){var a,b=this,c=b._note,d=b._args,e=d.paragraph,f=d.preParagraph;a=f.getEndOffset(),c.removeBlock(e),f.insertText(a,e.getText()),b._mergedIndex=a,b._paragraph=e},doUnapply:function(){var a,b=this,c=b._note,d=b._args,e=d.paragraph,f=d.preParagraph,g=b._mergedIndex;f.deleteText(g),a=c.getBlockIndex(f),c.insert(a+1,e)}})}({}),yne_common_commands_paragraph_DeleteAtStart=function(a){var b=yne_common_commands_CompositeCommand,c=yne_common_data_Paragraph,d=yne_common_commands_paragraph_Merge,e=yne_common_selection_NoteRange,f=yne_common_selection_ParagraphRange,g=yne_jtk_core_assert,h=yne_common_commands_link_DeleteLink;return b.extend({name:"DeleteAtStart",initialize:function(a){var b=this,c=a.note,d=a.args;b._note=c,b._args=d},apply:function(){var a,b=this,i=b._note,j=b._args,k=j.range,l=k.block,m=i.getPreBlock(l),n=new f({block:m,start:m.getEndOffset(),end:m.getEndOffset()});g(l instanceof c),g(m instanceof c),g(0===k.start&&0===k.end),n.end>0&&(a=m.getTextStyle("href",n.end-1,n.end),a[0]&&b._applyCommandToComposite(new h({args:{range:n}}))),b._applyCommandToComposite(new d({note:i,args:{paragraph:l,preParagraph:m}}),new e({blockRanges:[n]}))}})}({}),yne_common_commands_block_SetBlockStyle=function(a){var b=yne_common_commands_SimpleCommand;return b.extend({name:"SetBlockStyle",_block:null,_args:null,_oldValue:null,initialize:function(a){var b=this;b._block=a.block,b._args=a.args},apply:function(){var a=this,b=a._block,c=a._args,d=c.name,e=c.value;null===a._oldValue&&(a._oldValue=b.getBlockStyle(d)),b.setBlockStyle(d,e)},doUnapply:function(){var a=this,b=a._block,c=a._args,d=c.name,e=a._oldValue;b.setBlockStyle(d,e)}})}({}),yne_common_commands_note_TextIndent=function(a){var b=yne_common_commands_CompositeCommand,c=yne_common_commands_block_SetBlockStyle,d=yne_common_data_Paragraph,e=yne_jtk_core_assert,f=yne_underscore;return b.extend({name:"TextIndent",initialize:function(a){var b=this;b._note=a.note,b._args=a.args},apply:function(){var a=this,b=a._note,g=a._args,h=g.range,i=g.step,j=h.getStartBlockRange().block,k=h.getEndBlockRange().block,l=b.getInterBlocks(j,k,!0);e(1===i||-1===i,"Invalid indent step."),f.each(l,function(b){if(b instanceof d){var e=b.getBlockStyle("text-indent");1===i?e+=1:e-=1,0>e&&(e=0),a._applyCommandToComposite(new c({block:b,args:{name:"text-indent",value:e}}))}})}})}({}),yne_common_commands_note_ReplaceBlock=function(a){var b=yne_common_commands_SimpleCommand;return b.extend({name:"ReplaceBlock",_note:null,_args:null,_oldBlock:null,initialize:function(a){var b=this,c=a.note,d=a.args;b._note=c,b._args=d},apply:function(){var a=this,b=a._note,c=a._args,d=c.index,e=c.block;return a._oldBlock=b.replace(d,e),!0},doUnapply:function(){var a=this,b=a._note,c=a._args,d=c.index,e=a._oldBlock;b.replace(d,e)}})}({}),yne_common_commands_note_ReplaceListItemWithParagraph=function(a){var b=yne_common_commands_CompositeCommand,c=yne_common_selection_NoteRange,d=yne_common_data_Paragraph,e=yne_common_selection_ParagraphRange,f=yne_common_commands_note_ReplaceBlock,g=yne_jtk_core_assert,h=yne_underscore;return b.extend({name:"ReplaceListItemWithParagraph",_note:null,_args:null,_newParagraph:null,initialize:function(a){var b=this;b._note=a.note,b._args=a.args},apply:function(){var a=this,b=a._note,i=a._args,j=i.range,k=j.block,l=a._newParagraph;g("list-item"===k.getType(),'block must be of type "list-item"'),l||(l=new d,l.setText(k.getText()),h.each(k.getBlockStyles(),function(a,b){l.setBlockStyle(b,a)}),a._newParagraph=l),a._applyCommandToComposite(new f({note:b,args:{index:b.getBlockIndex(k),block:l}}),new c({blockRanges:[new e({block:l,start:j.start,end:j.end})]}))}})}({}),yne_common_commands_list_SetLevel=function(a){var b=yne_common_commands_SimpleCommand;return b.extend({name:"SetLevel",_listItem:null,_args:null,_oldLevel:null,initialize:function(a){var b=this;b._listItem=a.listItem,b._args=a.args},apply:function(){var a=this,b=a._listItem,c=a._args,d=c.level;return a._oldLevel=b.getLevel(),b.setLevel(d),!0},doUnapply:function(){var a=this,b=a._listItem,c=a._oldLevel;b.setLevel(c)}})}({}),yne_common_commands_list_DeleteAtStart=function(a){var b=yne_common_commands_CompositeCommand,c=yne_common_commands_note_ReplaceListItemWithParagraph,d=yne_common_commands_list_SetLevel,e=yne_common_data_ListItem,f=yne_jtk_core_assert;return b.extend({name:"DeleteAtStart",initialize:function(a){var b=this;b._note=a.note,b._args=a.args},apply:function(){var a=this,b=a._note,g=a._args.range,h=g.block;f(h instanceof e),f(0===g.start&&0===g.end),h.getLevel()<=1?a._applyCommandToComposite(new c({note:b,args:{range:g}})):a._applyCommandToComposite(new d({listItem:h,args:{level:h.getLevel()-1}}))}})}({}),yne_common_commands_note_DeleteBlock=function(a){var b=yne_common_commands_SimpleCommand;return b.extend({name:"DeleteBlock",_note:null,_args:null,_block:null,_blockIndex:null,initialize:function(a){var b=this,c=a.note,d=a.args;b._note=c,b._args=d},apply:function(){var a,b=this,c=b._note,d=b._args,e=d.block;a=c.getBlockIndex(e),b._block=e,b._blockIndex=a,c.remove(a)},doUnapply:function(){var a=this,b=a._note,c=a._block,d=a._blockIndex;b.insert(d,c)}})}({}),yne_common_selection_ListItemRange=function(a){var b,c=yne_common_selection_ParagraphRange;return b=c.extend({_type:"list-item",initialize:function(){var a=this;c.prototype.initialize.apply(a,arguments)}})}({}),yne_common_selection_rangeUtil=function(a){var b=yne_underscore,c=yne_common_selection_ParagraphRange,d=yne_common_selection_ListItemRange,e=yne_common_selection_ImageRange,f=yne_common_selection_AttachmentRange,g=yne_common_selection_TableRange,h=yne_common_selection_HrRange,i=yne_common_selection_UnknownRange,j=yne_jtk_core_L;return{createWholeRangeOfBlock:function(a){if(a&&a.getType){var b,f,g=a.getType();switch(g){case"paragraph":case"list-item":f="paragraph"===g?c:d,b=new f({start:0,end:a.getEndOffset(),block:a});break;case"image":b=new e({block:a});break;default:j.error("block type is not valid!")}return b}},createRangeByBlock:function(a){if(j.log(a),!a||!a.block)return void j.warn("arguments is not valid!");var d,k=a.block,l=k.getType(),m=0,n=0;switch(a=b.extend({allContent:!0,collapseToStart:!1},a),l){case"paragraph":case"list-item":a.allContent?n=k.getEndOffset():a.collapseToStart||(m=k.getEndOffset(),n=m),d=new c({block:k,start:m,end:n});break;case"image":d=new e({block:k});break;case"attachment":d=new f({block:k});break;case"table":d=new g({block:k,type:a.collapseToStart?g.TYPES.FIRST_ROW:g.TYPES.LAST_ROW});break;case"horizontal-line":d=new h({block:k});break;case"unknown":d=new i({block:k});break;default:j.error("block.type ["+l+"] is not valid!")}return d}}}({}),yne_common_commands_utils_CmdUtils=function(a){var b=yne_common_selection_rangeUtil;return{getBackwardBlockRange:function(a,c){var d=a.getPreBlock(c);return d?b.createRangeByBlock({block:d,allContent:!1,collapseToStart:!1}):void 0},getForwardBlockRange:function(a,c){var d=a.getNextBlock(c);return d?b.createRangeByBlock({block:d,allContent:!1,collapseToStart:!0}):void 0}}}({}),yne_common_commands_image_Delete=function(a){var b=yne_common_commands_CompositeCommand,c=yne_common_commands_note_DeleteBlock,d=yne_common_selection_NoteRange,e=yne_common_commands_utils_CmdUtils,f=yne_common_data_Image,g=yne_jtk_core_assert,h=yne_jtk_core_L;return b.extend({name:"Delete",initialize:function(a){var b=this,c=a.note,d=a.args;b._note=c,b._args=d},apply:function(){var a,b,i=this,j=i._args,k=i._note,l=j.range,m=l.getStartBlockRange(),n=m.block;g(n instanceof f),b=e.getBackwardBlockRange(k,n)||e.getForwardBlockRange(k,n),b||h.error("pre or next block not found"),a=new d({startRange:b,endRange:b}),i._applyCommandToComposite(new c({note:k,args:{block:n}}),a)}})}({}),yne_common_commands_attachment_Delete=function(a){var b=yne_common_commands_CompositeCommand,c=yne_common_commands_note_DeleteBlock,d=yne_common_selection_NoteRange,e=yne_common_commands_utils_CmdUtils,f=yne_jtk_core_L;return b.extend({name:"Delete",initialize:function(a){var b=this,c=a.note,d=a.args;b._note=c,b._args=d},apply:function(){var a,b,g=this,h=g._args,i=g._note,j=h.range,k=j.getStartBlockRange(),l=k.block;b=e.getBackwardBlockRange(i,l)||e.getForwardBlockRange(i,l),b||f.error("pre or next block not found"),a=new d({startRange:b,endRange:b}),g._applyCommandToComposite(new c({note:i,args:{block:l}}),a)}})}({}),yne_common_commands_table_Delete=function(a){var b=yne_common_commands_CompositeCommand,c=yne_common_commands_note_DeleteBlock,d=yne_common_selection_NoteRange,e=yne_common_commands_utils_CmdUtils,f=yne_jtk_core_L;return b.extend({name:"Delete",initialize:function(a){var b=this,c=a.note,d=a.args;b._note=c,b._args=d},apply:function(){var a,b,g=this,h=g._args,i=g._note,j=h.range,k=j.getStartBlockRange(),l=k.block;b=e.getBackwardBlockRange(i,l)||e.getForwardBlockRange(i,l),b||f.error("pre or next block not found"),a=new d({startRange:b,endRange:b}),g._applyCommandToComposite(new c({note:i,args:{block:l}}),a)}})}({}),yne_common_commands_note_DeleteRange=function(a){var b=yne_common_commands_CompositeCommand,c=yne_common_selection_NoteRange,d=yne_common_selection_ParagraphRange,e=yne_common_data_Paragraph,f=yne_common_data_blockTypes,g=yne_common_commands_paragraph_DeleteRange,h=yne_common_commands_note_DeleteBlock,i=yne_common_commands_image_Delete,j=yne_common_commands_attachment_Delete,k=yne_common_commands_table_Delete,l=yne_common_commands_paragraph_Merge,m=yne_underscore,n=yne_jtk_core_assert,o=yne_jtk_core_L;return b.extend({name:"DeleteRange",initialize:function(a){var b=this,c=a.note,d=a.args;b._note=c,b._args=d},apply:function(){var a=this,b=a._args.range;return n(!b.isCollapsed()),b.canDrawedByNative()?void(b.isInSingleBlock()?a._deleteSingle():b.isInMultiBlock()?a._deleteMulti():o.error("invalid noteRange")):void a._deleteCustom()},_deleteSingle:function(){var a=this,b=a._args,f=b.range,h=f.getStartBlockRange(),i=h.block;n(i instanceof e),n(h.end>h.start),a._applyCommandToComposite(new g({paragraph:i,args:{range:h}}),new c({blockRanges:[new d({block:i,start:h.start,end:h.start})]}))},_deleteMulti:function(){var a,b,f,i,j,k=this,n=k._note,p=k._args,q=p.range,r=q.getStartBlockRange(),s=r.block,t=[];a=q.getEndBlockRange(),b=a.block,i=s instanceof e,j=b instanceof e,i?k._applyCommandToComposite(new g({paragraph:s,args:{range:r}})):t.push(s),f=n.getInterBlocks(s,b),t=t.concat(f),j?k._applyCommandToComposite(new g({paragraph:b,args:{range:a}})):t.push(b),m.each(t,function(a){k._applyCommandToComposite(new h({note:n,args:{block:a}}))}),i&&j&&k._applyCommandToComposite(new l({note:n,args:{preParagraph:s,paragraph:b}})),i?k.setEndingRange(new c({blockRanges:[new d({block:s,start:r.start,end:r.start})]})):j?k.setEndingRange(new c({blockRanges:[new d({block:b,start:0,end:0})]})):o.error("执行DeleteRange Command时，NoteRange的边界都不在段落中!")},_deleteCustom:function(){var a=this,b=a._note,c=a._args.range,d=c.getStartBlockRange(),e=d.block;f.isImage(e)?a._applyCommandToComposite(new i({note:b,args:{range:c}})):f.isAttachment(e)?a._applyCommandToComposite(new j({note:b,args:{range:c}})):f.isTable(e)?a._applyCommandToComposite(new k({note:b,args:{range:c}})):o.warn("unsupported block type")}})}({}),yne_common_commands_key_Backspace=function(a){var b=yne_common_commands_CompositeCommand,c=yne_common_data_Paragraph,d=yne_common_data_ListItem,e=yne_common_selection_ImageRange,f=yne_common_selection_AttachmentRange,g=yne_common_selection_TableRange,h=yne_common_selection_NoteRange,i=yne_common_commands_paragraph_DeleteBackward,j=yne_common_commands_paragraph_DeleteAtStart,k=yne_common_commands_note_TextIndent,l=yne_common_commands_list_DeleteAtStart,m=yne_common_commands_note_DeleteRange,n=yne_common_commands_note_DeleteBlock,o=yne_common_data_blockTypes,p=yne_jtk_core_assert,q=yne_jtk_core_L;return b.extend({name:"Backspace",initialize:function(a){var b=this,c=a.note,d=a.args;b._note=c,b._args=d},apply:function(){var a=this,b=a._args,c=b.range;c.isCollapsed()?a._deleteBackward():a._deleteRange()},_deleteBackward:function(){var a,b=this,e=b._note,f=b._args.range,g=f.getStartBlockRange(),h=g.block;p(h instanceof c),a=g.start,a>0?b._applyCommandToComposite(new i({block:h,args:{range:g}})):f.isCollapsed()&&0===a&&h.getBlockStyle("text-indent")>0?b._applyCommandToComposite(new k({note:e,args:{range:f,step:-1}})):h instanceof d?b._applyCommandToComposite(new l({note:e,args:{range:g}})):b._deleteAtParagraphStart()},_deleteAtParagraphStart:function(){var a,b,c,d=this,i=d._note,k=d._args.range,l=k.getStartBlockRange(),m=l.block,p=i.getPreBlock(m);if(!p)return void q.log("caret at start of note");switch(a=p.getType()){case o.PARAGRAPH:case o.LIST_ITEM:d._applyCommandToComposite(new j({note:i,args:{range:l}}));break;case o.IMAGE:d.setEndingRange(new h({blockRanges:[new e({block:p})]}));break;case o.ATTACHMENT:d.setEndingRange(new h({blockRanges:[new f({block:p})]}));break;case o.TABLE:b=new g({block:p,type:g.TYPES.LAST_ROW}),c=new h({startRange:b,endRange:b}),d.setEndingRange(c);break;case o.HR:case o.UNKNOWN:d._applyCommandToComposite(new n({note:i,args:{block:p}}));break;default:q.warn("unsupported block type")}},_deleteRange:function(){var a=this,b=a._note,c=a._args.range;a._applyCommandToComposite(new m({note:b,args:{range:c}}))}})}({}),yne_common_commands_paragraph_SplitParagraph=function(a){var b=yne_underscore,c=yne_common_commands_SimpleCommand,d=yne_common_data_Paragraph,e=yne_common_data_ListItem,f=yne_common_data_blockTypes;return c.extend({name:"SplitParagraph",initialize:function(a){var b=this;b._note=a.note,b._args=a.args},apply:function(){var a,c=this,g=c._note,h=c._args,i=h.block,j=h.range,k=c._insertedBlock,l=j.start,m=g.getBlockIndex(i);c._start&&(l=c._start),a=i.sliceText(0,l),i.deleteText(0,l),k||(k=f.isListItem(i)?new e({level:i.getLevel(),list:i.getOwnerList()}):new d,k.setText(a),b.each(i.getBlockStyles(),function(a,b){k.setBlockStyle(b,a)}),c._insertedBlock=k,c._splitedInlineStyles=i.getDefaultInlineStyles()),i.setDefaultInlineStyles(h.insertedInlineStyles),k.setDefaultInlineStyles(c._splitedInlineStyles),g.insert(m,k),c._start=l},doUnapply:function(){var a=this,b=a._note,c=a._args,d=c.block,e=a._insertedBlock,f=b.getBlockIndex(e);b.remove(f),d.insertText(0,e.getText()),d.setDefaultInlineStyles(a._splitedInlineStyles),e.setDefaultInlineStyles(c.insertedInlineStyles)}})}({}),yne_common_commands_paragraph_InsertText=function(a){var b=yne_common_commands_SimpleCommand;return b.extend({name:"InsertText",_paragraph:null,_args:null,_isInserted:null,initialize:function(a){var b=this,c=a.paragraph,d=a.args;b._paragraph=c,b._args=d},apply:function(){var a=this,b=a._paragraph,c=a._args,d=c.range.start,e=c.richText;return a._isInserted=b.insertText(d,e),a._isInserted},doUnapply:function(){var a=this,b=a._paragraph,c=a._args,d=c.range.start,e=c.richText.getLength();a._isInserted&&b.deleteText(d,d+e)}})}({}),yne_common_commands_key_InsertLink=function(a){var b=yne_common_commands_CompositeCommand,c=yne_common_data_Paragraph,d=yne_common_commands_paragraph_SetStyle,e=yne_common_commands_paragraph_InsertText,f=yne_common_selection_NoteRange,g=yne_common_selection_ParagraphRange,h=yne_common_data_RichText,i=yne_underscore,j={
color:"#0000ff",underline:!0};return b.extend({name:"InsertLink",initialize:function(a){var b=this;b._note=a.note,b._args=a.args},apply:function(){var a,b,k,l,m,n,o=this,p=o._args,q=p.range,r=p.src||"";q.canDrawedByNative()&&(b=q.getStartBlockRange(),a=b.block,q.isInSingleBlock()&&a instanceof c&&(b.isCollapsed()?(k=new h({text:r}),l=k.getLength(),k.setStyle(0,l,"href",r),i.each(j,function(a,b){k.setStyle(0,l,b,a)}),n=b.start+l,m=new g({block:a,start:n,end:n}),o._applyCommandToComposite(new e({paragraph:a,args:{range:b,richText:k}}),new f({startRange:m,endRange:m}))):(o._applyCommandToComposite(new d({paragraph:a,args:{range:b,name:"href",value:r,_isToRangeEnd:p._isToRangeEnd}})),i.each(j,function(c,e){o._applyCommandToComposite(new d({paragraph:a,args:{range:b,name:e,value:c,_isToRangeEnd:p._isToRangeEnd}}))}))))}})}({}),yne_common_commands_link_RecognitionLink=function(a){var b=yne_common_commands_CompositeCommand,c=yne_common_commands_key_InsertLink,d=yne_common_selection_NoteRange,e=yne_common_selection_ParagraphRange,f=yne_common_commands_link_LinkMatch;return b.extend({name:"RecognitionLink",initialize:function(a){var b=this;b._note=a.note,b._args=a.args},apply:function(){function a(a,b){var f;f=new e({block:l.block,start:a,end:n}),i._applyCommandToComposite(new c({args:{src:b,range:new d({startRange:f,endRange:f})}}))}var b,g,h,i=this,j=i._args,k=j.range,l=k.getStartBlockRange(),m=l.block,n=l.end,o=0;if(m.getText){b=m.getText().toString().slice(0,n),g=b.length-1;for(var p=g;p>0;p--)if(m.getTextStyle("href",p,p+1)[0]){o=p,b=b.slice(p,n);break}h=f.matchEnd(b),h&&h.result&&a(h.result.index+o,h.fullURI)}}})}({}),yne_common_commands_key_Enter=function(a){var b=yne_common_commands_CompositeCommand,c=yne_common_commands_note_DeleteRange,d=yne_common_commands_list_DeleteAtStart,e=yne_common_commands_paragraph_SplitParagraph,f=yne_common_selection_NoteRange,g=yne_common_selection_ParagraphRange,h=yne_common_data_Paragraph,i=yne_common_data_ListItem,j=yne_jtk_core_assert,k=yne_underscore,l=yne_common_commands_link_RecognitionLink;return b.extend({name:"Enter",initialize:function(a){var b=this;b._note=a.note,b._args=a.args},apply:function(){var a,b,m=this,n=m._note,o=m._args,p=o.range;return m._applyCommandToComposite(new l(m.options)),p.isCollapsed()||(m._applyCommandToComposite(new c({note:n,args:{range:p}})),p=m.getEndingRange()),j(p),j(p.isCollapsed()),a=p.getStartBlockRange(),b=a.block,j(b instanceof h),b instanceof i&&b.isEmpty()?void m._applyCommandToComposite(new d({note:n,args:{range:a}})):void m._applyCommandToComposite(new e({note:n,args:{range:a,block:b,insertedInlineStyles:k.clone(o.inlineStyles)}}),new f({blockRanges:[new g({block:b,start:0,end:0})]}))}})}({}),yne_common_commands_note_InsertText=function(a){var b=yne_common_commands_CompositeCommand,c=yne_jtk_core_assert,d=yne_common_data_Paragraph,e=yne_common_selection_NoteRange,f=yne_common_selection_ParagraphRange,g=yne_common_commands_paragraph_InsertText,h=yne_common_commands_note_DeleteRange;return b.extend({name:"InsertText",initialize:function(a){var b=this,c=a.note,d=a.args;b._note=c,b._args=d},apply:function(){var a,b,i,j,k=this,l=k._note,m=k._args,n=m.range,o=m.richText;c(o),n.isCollapsed()||(k._applyCommandToComposite(new h({note:l,args:{range:n}})),n=k.getEndingRange()),c(n),c(n.isCollapsed()),a=n.getStartBlockRange(),b=a.block,c(b instanceof d),j=i=a.start+o.getLength(),k._applyCommandToComposite(new g({paragraph:b,args:{range:a,richText:o}}),new e({blockRanges:[new f({block:b,start:i,end:j})]}))}})}({}),yne_common_commands_key_TextInput=function(a){var b=yne_common_commands_CompositeCommand,c=yne_common_commands_note_InsertText;return b.extend({name:"TextInput",initialize:function(){},apply:function(){var a=this;a._applyCommandToComposite(new c(a.options))}})}({}),yne_common_commands_key_Space=function(a){var b=yne_common_commands_CompositeCommand,c=yne_common_commands_link_RecognitionLink,d=yne_common_commands_key_TextInput,e=yne_common_data_RichText;return b.extend({name:"Space",initialize:function(a){var b=this;b._note=a.note,b._args=a.args},apply:function(){var a=this,b=a._note,f=a._args,g=f.range,h=g.getEndBlockRange(),i=h.block,j=f.inlineStyles,k=new e({text:" "});k.setStyles(0,k.getLength(),j),a._applyCommandToComposite(new c(a.options)),a._applyCommandToComposite(new d({paragraph:i,note:b,args:{range:g,richText:k}}))}})}({}),yne_common_commands_note_IndentOutdent=function(a){var b=yne_underscore,c=yne_common_commands_CompositeCommand,d=yne_common_commands_block_SetBlockStyle,e=yne_common_commands_list_SetLevel,f=yne_common_data_ListItem,g=yne_jtk_core_assert;return c.extend({name:"IndentOutdent",_note:null,_args:null,initialize:function(a){var b=this,c=a.note,d=a.args;b._note=c,b._args=d},apply:function(){var a,c,d,e=this,h=e._note,i=e._args,j=i.step,k=i.range,l=k.getStartBlockRange().block,m=!1,n=null;g(1===j||-1===j),k.canDrawedByNative()&&(k.isInMultiBlock()?(a=k.getEndBlockRange().block,c=h.getInterBlocks(l,a,!0)):c=[l],m=b.every(c,function(a,b){if(a instanceof f){if(0===b)return n=a.getOwnerList(),!0;if(a.getOwnerList()===n)return!0}return!1}),m?(d=n.getItems(),0===b.indexOf(d,l)?e._updateBlocksIndentLevel(d,j):e._updateListItemsLevel(c,j)):e._updateBlocksIndentLevel(c,j))},_updateBlocksIndentLevel:function(a,c){var e,f=this;b.each(a,function(a){e=a.getBlockStyle("indent"),b.isNumber(e)&&(0>=e&&-1===c||(e+=c,0>e&&(e=0),f._applyCommandToComposite(new d({block:a,args:{name:"indent",value:e}}))))})},_updateListItemsLevel:function(a,c){var h=this;b.each(a,function(a){var i,j;if(g(a instanceof f),i=a.getLevel(),i+=c,!(0>i)){if(-1===c){if(j=a.getBlockStyle("indent"),!b.isNumber(j))return;if(0>j)return;h._applyCommandToComposite(new d({block:a,args:{name:"indent",value:0}}))}h._applyCommandToComposite(new e({listItem:a,args:{level:i}}))}})}})}({}),yne_common_commands_key_Tab=function(a){var b=yne_common_commands_CompositeCommand,c=yne_common_commands_note_IndentOutdent,d=yne_common_commands_note_TextIndent,e=yne_common_data_ListItem,f=yne_common_data_Paragraph,g=yne_common_data_RichText,h=yne_common_commands_note_InsertText,i=yne_jtk_core_assert,j=yne_jtk_core_L,k={INSERT_TEXT:0,INDENT:1,TEXT_INDENT:2},l=function(a){var b,c,d,g,h;return b=a.getStartBlockRange(),c=b.block,a.isInSingleBlock()?(i(c instanceof f),d=b.start,0!==d?k.INSERT_TEXT:(g=b.end,h=c.getLength(),g===h&&g>0?k.INDENT:c instanceof e&&d===g?k.INDENT:c instanceof e||d!==g?k.INSERT_TEXT:k.TEXT_INDENT)):a.isInMultiBlock()?k.INDENT:void j.error("invalid noteRange")};return b.extend({name:"Tab",initialize:function(a){var b=this;b._note=a.note,b._args=a.args},apply:function(){var a,b=this,c=b._args.range;if(c.canDrawedByNative())switch(a=l(c)){case k.INSERT_TEXT:b._insertText();break;case k.INDENT:b._indent();break;case k.TEXT_INDENT:b._indentFirstLine();break;default:j.error("unsupported tab action")}},_insertText:function(){var a,b=this,c=b._note,d=b._args,e=d.inlineStyles;a=new g({text:"	"}),a.setStyles(0,a.getLength(),e),b._applyCommandToComposite(new h({note:c,args:{range:d.range,richText:a}}))},_indent:function(){var a=this,b=a._note,d=a._args.range;a._applyCommandToComposite(new c({note:b,args:{range:d,step:1}}))},_indentFirstLine:function(){var a=this,b=a._note,c=a._args.range;a._applyCommandToComposite(new d({note:b,args:{range:c,step:1}}))}})}({}),yne_common_commands_key_Indent=function(a){var b=yne_common_commands_CompositeCommand,c=yne_common_commands_note_IndentOutdent;return b.extend({name:"Indent",_note:null,_args:null,initialize:function(a){var b=this;b._note=a.note,b._args=a.args},apply:function(){var a=this,b=a._note,d=a._args.range;a._applyCommandToComposite(new c({note:b,args:{range:d,step:1}}))}})}({}),yne_common_commands_key_Outdent=function(a){var b=yne_common_commands_CompositeCommand,c=yne_common_commands_note_IndentOutdent;return b.extend({name:"Indent",_note:null,_args:null,initialize:function(a){var b=this;b._note=a.note,b._args=a.args},apply:function(){var a=this,b=a._note,d=a._args.range;a._applyCommandToComposite(new c({note:b,args:{range:d,step:-1}}))}})}({}),yne_common_commands_paragraph_ForwardDelete=function(a){var b=yne_common_commands_SimpleCommand;return b.extend({name:"ForwardDelete",_paragraph:null,_args:null,_deletedText:null,initialize:function(a){var b=this,c=a.paragraph,d=a.args;b._paragraph=c,b._args=d},apply:function(){var a,b=this,c=b._paragraph,d=b._args,e=d.range,f=e.clone();return f.isCollapsed()&&(f.end=f.start+1),(a=c.getRangeText(f))?(b._deletedText=a,void c.deleteText(f)):!1},doUnapply:function(){var a=this,b=a._paragraph,c=a._args,d=c.range,e=a._deletedText;b.insertText(d.start,e)}})}({}),yne_common_commands_paragraph_ForwardDeleteAtStart=function(a,b,c,d,e,f){return a.extend({name:"ForwardDeleteAtStart",initialize:function(a){var b=this;b._note=a.note,b._args=a.args},apply:function(){var a=this,g=a._note,h=a._args,i=h.range,j=i.block,k=g.getNextBlock(j);f(j instanceof b),f(k instanceof b),a._applyCommandToComposite(new c({note:g,args:{paragraph:k,preParagraph:j}}),new d({blockRanges:[new e({block:j,start:j.getEndOffset(),end:j.getEndOffset()})]}))}})}(yne_common_commands_CompositeCommand,yne_common_data_Paragraph,yne_common_commands_paragraph_Merge,yne_common_selection_NoteRange,yne_common_selection_ParagraphRange,yne_jtk_core_assert),yne_common_commands_key_Delete=function(a,b,c,d,e,f,g,h,i,j,k,l,m){return a.extend({name:"Delete",initialize:function(a){var b=this,c=a.note,d=a.args;b._note=c,b._args=d},apply:function(){var a=this,b=a._args,c=b.range;c.isCollapsed()?a._deleteForward():a._deleteRange()},_deleteForward:function(){var a,b=this,f=b._args.range,g=f.getStartBlockRange(),h=g.block;c(h instanceof d),a=g.start,a<h.getEndOffset()?b._applyCommandToComposite(new e({paragraph:h,args:{range:g}})):b._deleteAtParagraphEnd()},_deleteRange:function(){var a=this,c=a._note,d=a._args.range;a._applyCommandToComposite(new b({note:c,args:{range:d}}))},_deleteAtParagraphEnd:function(){var a,b,c,d=this,e=d._note,n=d._args.range,o=n.getStartBlockRange(),p=o.block,q=e.getNextBlock(p);if(!q)return void m.log("delete at end of note");switch(a=q.getType()){case f.PARAGRAPH:case f.LIST_ITEM:d._applyCommandToComposite(new g({note:e,args:{range:o}}));break;case f.IMAGE:d.setEndingRange(new h({blockRanges:[new i({block:q})]}));break;case f.ATTACHMENT:d.setEndingRange(new h({blockRanges:[new j({block:q})]}));break;case f.TABLE:b=new k({block:q,type:k.TYPES.FIRST_ROW}),c=new h({startRange:b,endRange:b}),d.setEndingRange(c);break;case f.HR:case f.UNKNOWN:d._applyCommandToComposite(new l({note:e,args:{block:q}}));break;default:m.warn("unsupported block type")}}})}(yne_common_commands_CompositeCommand,yne_common_commands_note_DeleteRange,yne_jtk_core_assert,yne_common_data_Paragraph,yne_common_commands_paragraph_ForwardDelete,yne_common_data_blockTypes,yne_common_commands_paragraph_ForwardDeleteAtStart,yne_common_selection_NoteRange,yne_common_selection_ImageRange,yne_common_selection_AttachmentRange,yne_common_selection_TableRange,yne_common_commands_note_DeleteBlock,yne_jtk_core_L),yne_common_commands_block_InsertBlock=function(a){var b=yne_common_commands_SimpleCommand;return b.extend({initialize:function(a){var b=this;b._note=a.note,b._block=a.args.block,b._index=a.args.index},apply:function(){var a=this;a._note.insert(a._index,a._block)},doUnapply:function(){var a=this;a._note.remove(a._index)}})}({}),yne_common_commands_block_InsertBlocks=function(a){var b=yne_common_commands_CompositeCommand,c=yne_common_commands_block_InsertBlock;return b.extend({initialize:function(a){var b=this;b._note=a.note,b._blocks=a.args.blocks,b._index=a.args.index},apply:function(){var a=this,b=a._note,d=a._blocks,e=a._index;d.forEach(function(d){a._applyCommandToComposite(new c({note:b,args:{block:d,index:e++}}))})}})}({}),yne_common_commands_note_InsertBlocks=function(a){var b=yne_common_commands_CompositeCommand,c=yne_common_commands_note_DeleteRange,d=yne_common_commands_block_InsertBlocks,e=yne_common_commands_paragraph_SplitParagraph,f=yne_common_selection_NoteRange,g=yne_common_selection_ParagraphRange,h=yne_common_commands_paragraph_InsertText,i=yne_common_data_List,j=yne_common_data_Paragraph,k=yne_common_data_blockTypes,l=yne_underscore,m=yne_jtk_core_L,n=function(a,b,c){var d,e,f=0;k.isListItem(b)&&k.isListItem(c)&&(e=c.getOwnerList().getId(),d=b.getOwnerList(),f=b.getLevel()-c.getLevel()),l.chain(a).groupBy(function(a){return k.isListItem(a)?a.getOwnerList().getId():void 0}).each(function(a,b){var c;"undefined"!==b&&a.length>0&&(d&&b===e?l.each(a,function(a){0!==f&&a.setLevel(a.getLevel()+f),a.setOwnerList(d)}):(c=new i({type:a[0].getListType()}),l.each(a,function(a){a.setOwnerList(c)})))})};return b.extend({name:"InsertBlocks",initialize:function(a){var b=this;b._note=a.note,b._args=a.args},apply:function(){var a,b,d,e,f=this,g=f._note,h=f._args,i=h.range,j=h.blocks;if(i.isCollapsed()||(f._applyCommandToComposite(new c({note:g,args:{range:i}})),i=f.getEndingRange()),!l.isEmpty(j)){if(a=i.getStartBlockRange(),b=a.block,!k.isParagraph(b))return n(j),void f._insertBlocksAndSetEndingRange(j,b);if(d=a.end,e=b.getLength(),0>=e)f._insertAtEmptyParagraph(b,0,j);else if(d===e)f._insertAtParagraphEnd(b,d,j);else if(0===d)f._insertAtParagraphStart(b,0,j);else{if(!(d>0&&e>d))return void m.error("Invaid ParagraphRange for InsertBlocks Command");f._insertAtParagraphMiddle(b,d,j)}}},_insertAtEmptyParagraph:function(a,b,c){this._insertAtParagraphEnd(a,b,c)},_insertAtParagraphEnd:function(a,b,c){var d=this,e=l.first(c),f=b;return k.isParagraph(e)&&(f=d._insertParagraphContent(a,b,e),c.shift(),l.isEmpty(c))?void d._setEndingRangeAtParagraph(a,f):(n(c,a,e),void d._insertBlocksAndSetEndingRange(c,a))},_insertAtParagraphStart:function(a,b,c){var d,e=this,f=e._note,g=l.last(c),h=b;k.isParagraph(g)&&(h=e._insertParagraphContent(a,b,g),c.pop()),l.isEmpty(c)||(n(c,a,g),d=f.getBlockIndex(a),e._insertBlocksAtIndex(c,d)),e._setEndingRangeAtParagraph(a,h)},_insertAtParagraphMiddle:function(a,b,c){var d,f,g,h,i,j=this,m=j._note,o=b;return g=l.first(c),1===c.length&&k.isParagraph(g)?(o=j._insertParagraphContent(a,b,g),void j._setEndingRangeAtParagraph(a,o)):(j._applyCommandToComposite(new e({note:m,args:{range:{block:a,start:b,end:b},block:a}})),d=m.getPreBlock(a),f=a,o=0,k.isParagraph(g)&&(j._insertParagraphContent(d,b,g),c.shift()),h=l.last(c),k.isParagraph(h)&&(o=j._insertParagraphContent(f,0,h),c.pop()),n(c,a,g),i=m.getBlockIndex(d)+1,j._insertBlocksAtIndex(c,i),void j._setEndingRangeAtParagraph(f,o))},_insertParagraphContent:function(a,b,c){var d=c.getText(),e=b+d.getLength();return this._applyCommandToComposite(new h({paragraph:a,args:{range:{start:b,end:b},richText:d}})),e},_insertBlocksAndSetEndingRange:function(a,b){var c,d,e=this,f=e._note;c=f.getBlockIndex(b)+1,d=l.last(a),k.isParagraph(d)||(d=new j,a.push(d)),e._insertBlocksAtIndex(a,c),e._setEndingRangeAtParagraph(d,d.getLength())},_insertBlocksAtIndex:function(a,b){var c=this,e=c._note;c._applyCommandToComposite(new d({note:e,args:{blocks:a,index:b}}))},_setEndingRangeAtParagraph:function(a,b){this.setEndingRange(new f({blockRanges:[new g({block:a,start:b,end:b})]}))}})}({}),yne_common_commands_key_InsertHorizontalRule=function(a){var b=yne_common_commands_CompositeCommand,c=yne_common_commands_note_InsertBlocks,d=yne_common_data_Hr;return b.extend({name:"InsertHorizontalRule",initialize:function(a){var b=this;b._note=a.note,b._args=a.args},apply:function(){var a=this,b=a._note,e=a._args,f=e.range;a._applyCommandToComposite(new c({note:b,args:{range:f,blocks:[new d]}}))}})}({}),yne_common_commands_key_InsertImage=function(a){var b=yne_common_commands_CompositeCommand,c=yne_common_commands_note_InsertBlocks,d=yne_common_data_Image,e=yne_common_data_Paragraph;return b.extend({name:"InsertImage",initialize:function(a){var b=this;b._note=a.note,b._args=a.args},apply:function(){var a=this,b=a._note,f=a._args,g=f.range;a._applyCommandToComposite(new c({note:b,args:{range:g,blocks:[new d({source:f.src}),new e]}}))}})}({}),yne_common_commands_key_InsertAttachment=function(a){var b=yne_common_commands_CompositeCommand,c=yne_common_commands_note_InsertBlocks,d=yne_common_data_Attachment,e=yne_common_data_Paragraph;return b.extend({name:"InsertAttachment",initialize:function(a){var b=this;b._note=a.note,b._args=a.args},apply:function(){var a=this,b=a._note,f=a._args,g=f.range;a._applyCommandToComposite(new c({note:b,args:{range:g,blocks:[new d({source:f.src,resource:f.resource,fileName:f.fileName,fileLength:f.fileLength}),new e]}}))}})}({}),yne_common_commands_key_InsertTable=function(a){var b=yne_common_commands_CompositeCommand,c=yne_common_commands_note_InsertBlocks,d=yne_common_data_Table,e=yne_common_selection_TableRange,f=yne_common_selection_NoteRange,g=yne_ytable_client_shared_const,h=function(a,b){for(var c=[];a--;)c[a]=b;return c};return b.extend({name:"InsertTable",initialize:function(a){var b=this;b._note=a.note,b._args=a.args},apply:function(){var a,b,i,j,k=this,l=k._note,m=k._args,n=m.range,o=m.cols||1,p=m.rows||1;a=new d({data:{widths:h(o,g.DEFAULT_COLUMN_WIDTH),heights:h(p,g.DEFAULT_ROW_HEIGHT),cells:h(o*p,{value:""})}}),b=new e({block:a,type:e.TYPES.FIRST_ROW}),i=new f({startRange:b,endRange:b}),j=new c({note:l,args:{range:n,blocks:[a]}}),k._applyCommandToComposite(j,i)}})}({}),yne_common_commands_note_ApplyInlineStyle=function(a){var b=yne_common_commands_CompositeCommand,c=yne_common_commands_paragraph_SetStyle,d=yne_common_data_blockTypes,e=yne_underscore,f=yne_jtk_core_L;return b.extend({name:"ApplyInlineStyle",initialize:function(a){var b=this,c=a.note,d=a.args;b._note=c,b._args=d},apply:function(){var a,b=this,g=b._args,h=b._note,i=g.range,j=g.name,k=g.value,l=i.getStartBlockRange(),m=l.block,n=i.getEndBlockRange(),o=n.block;return i.isCollapsed()?void f.error("invalid noteRange"):(d.isParagraph(m)&&b._applyCommandToComposite(new c({paragraph:l.block,args:{range:l,name:j,value:k}})),void(i.isInMultiBlock()&&(a=h.getInterBlocks(m,o),e.each(a,function(a){d.isParagraph(a)&&b._applyCommandToComposite(new c({paragraph:a,args:{range:{start:a.getStartOffset(),end:a.getEndOffset()},name:j,value:k}}))}),d.isParagraph(o)&&b._applyCommandToComposite(new c({paragraph:o,args:{range:n,name:j,value:k}})))))}})}({}),yne_common_commands_note_ApplyBlockStyle=function(a){var b=yne_underscore,c=yne_common_commands_CompositeCommand,d=yne_common_commands_block_SetBlockStyle,e=yne_jtk_core_L;return c.extend({name:"ApplyBlockStyle",_note:null,_args:null,initialize:function(a){var b=this,c=a.note,d=a.args;b._note=c,b._args=d},apply:function(){var a=this,c=a._args,f=c.range,g=a._note,h=c.name,i=c.value,j=f.getStartBlockRange().block,k=f.getEndBlockRange().block,l=g.getInterBlocks(j,k,!0);return j&&k?void b.each(l,function(b){a._applyCommandToComposite(new d({block:b,args:{name:h,value:i}}))}):void e.error("选区状态不正确")}})}({}),yne_common_commands_note_ReplaceParagraphWithListItem=function(a){var b=yne_common_commands_CompositeCommand,c=yne_common_selection_NoteRange,d=yne_common_data_ListItem,e=yne_common_selection_ParagraphRange,f=yne_common_commands_note_ReplaceBlock,g=yne_jtk_core_assert,h=yne_underscore;return b.extend({name:"ReplaceParagraphWithListItem",_note:null,_args:null,_newListItem:null,initialize:function(a){var b=this;b._note=a.note,b._args=a.args},apply:function(){var a=this,b=a._note,i=a._args,j=i.range,k=j.block,l=i.list,m=a._newListItem;g("paragraph"===k.getType(),'block must be of type "paragraph"'),m||(m=new d({list:l}),m.setText(k.getText()),h.each(k.getBlockStyles(),function(a,b){m.setBlockStyle(b,a)}),a._newListItem=m),a._applyCommandToComposite(new f({note:b,args:{index:b.getBlockIndex(k),block:m}}),new c({blockRanges:[new e({block:m,start:j.start,end:j.end})]}))}})}({}),yne_common_commands_list_ToggleType=function(a){var b=yne_common_commands_SimpleCommand;return b.extend({name:"ToggleType",_list:null,_args:null,initialize:function(a){var b=this;b._list=a.list,b._args=a.args},apply:function(){var a=this,b=a._list;return b.isUnordered()?b.setType("ordered"):b.setType("unordered"),!0},doUnapply:function(){this.apply()}})}({}),yne_common_commands_note_InsertList=function(a){var b=yne_common_commands_CompositeCommand,c=yne_common_commands_note_ReplaceParagraphWithListItem,d=yne_common_commands_note_ReplaceListItemWithParagraph,e=yne_common_commands_note_ReplaceBlock,f=yne_common_commands_list_ToggleType,g=yne_common_data_Paragraph,h=yne_common_data_ListItem,i=yne_common_data_List,j=yne_common_selection_NoteRange,k=yne_common_selection_ParagraphRange,l=yne_underscore;return b.extend({name:"InsertList",_note:null,_args:null,initialize:function(a){var b=this;b._note=a.note,b._args=a.args},apply:function(){var a=this,b=a._args,c=b.range;c.isInSingleBlock()?a._applySingle():a._applyMultiple()},_applySingle:function(){var a,b,e,g=this,h=g._note,j=g._args,k=j.range,l=j.type,m=k.getStartBlockRange(),n=m.block,o=n.getType();switch(o){case"paragraph":e=(a=h.getPreBlock(n))&&"list-item"===a.getType()&&a.getOwnerList().getType()===l?a.getOwnerList():(b=h.getNextBlock(n))&&"list-item"===b.getType()&&b.getOwnerList().getType()===l?b.getOwnerList():new i({type:l}),g._applyCommandToComposite(new c({note:h,args:{range:m,list:e}}));break;case"list-item":e=n.getOwnerList(),e.getType()!==l?g._applyCommandToComposite(new f({list:e})):g._applyCommandToComposite(new d({note:h,args:{range:m}}))}},_applyMultiple:function(){var a,b,c,d,f,m,n,o,p,q,r=this,s=r._note,t=r._args,u=t.range,v=t.type,w=u.getStartBlockRange(),x=w.block,y=u.getEndBlockRange(),z=y.block,A=s.getInterBlocks(x,z,!0),B=s.getBlockIndex(x),C=A.length,D=null,E="do-nothing";for(b=0;C>b;++b)if(c=A[b],d=c.getType(),"paragraph"===d||"list-item"===d){if("paragraph"===d){E="make-new-list";break}if(f=c.getOwnerList(),f.getType()!==v&&(E="make-new-list"),D&&D!==f){E="make-new-list";break}D=f}switch(D&&D.getType()===v?E="cancel-list":D&&(E="make-new-list"),E){case"make-new-list":m=(a=s.getPreBlock(x))&&"list-item"===a.getType()&&a.getOwnerList().getType()===v?a.getOwnerList():new i({type:v}),n=[],l.each(A,function(a,b){var c=a.getType(),d=null,f=1;("paragraph"===c||"list-item"===c)&&("list-item"===c&&(f=a.getLevel()),d=new h({list:m,level:f}),l.each(a.getBlockStyles(),function(a,b){d.setBlockStyle(b,a)}),d.setText(a.getText()),r._applyCommandToComposite(new e({note:s,args:{index:B+b,block:d}}))),n.push(d)});break;case"cancel-list":n=[],l.each(A,function(a,b){var c=null;"list-item"===a.getType()&&(c=new g,c.setText(a.getText()),l.each(a.getBlockStyles(),function(a,b){c.setBlockStyle(b,a)}),r._applyCommandToComposite(new e({note:s,args:{index:B+b,block:c}}))),n.push(c)})}n&&(o=n[0],p=n[n.length-1],q=new j({blockRanges:[new k({block:o||x,start:w.start,end:w.end}),new k({block:p||z,start:y.start,end:y.end})]}),r.setEndingRange(q))}})}({}),yne_common_commands_note_InsertOrderedList=function(a){var b=yne_common_commands_CompositeCommand,c=yne_common_commands_note_InsertList;return b.extend({name:"InsertOrderedList",_note:null,_args:null,_noteRange:null,initialize:function(a){var b=this;b._note=a.note,b._args=a.args},apply:function(){var a=this,b=a._note;a._applyCommandToComposite(new c({note:b,args:{range:a._args.range,type:"ordered"}}))}})}({}),yne_common_commands_note_InsertUnorderedList=function(a){var b=yne_common_commands_CompositeCommand,c=yne_common_commands_note_InsertList;return b.extend({name:"InsertUnorderedList",_note:null,_args:null,_noteRange:null,initialize:function(a){var b=this;b._note=a.note,b._args=a.args},apply:function(){var a=this,b=a._note;a._applyCommandToComposite(new c({note:b,args:{range:a._args.range,type:"unordered"}}))}})}({}),yne_common_commands_key_RemoveFormat=function(a){var b=yne_common_commands_CompositeCommand,c=yne_common_data_supportedInlineStyles,d=yne_common_commands_note_ApplyInlineStyle,e=yne_common_commands_block_SetBlockStyle,f=yne_common_data_Paragraph,g=yne_underscore,h=function(a){var b=a.block;return b instanceof f?0===a.start&&a.end===b.getLength()?!0:!1:!0};return b.extend({name:"RemoveFormat",initialize:function(a){this.note=a.note,this.args=a.args},apply:function(){var a,b,f,i,j,k,l=this,m=l.note,n=l.args,o=n.range;o.isCollapsed()||(a=o.getStartBlockRange(),b=a.block,f=o.getEndBlockRange(),i=f.block,k=c.getAllConfig(["href"]),g.each(k,function(a,b){l._applyCommandToComposite(new d({note:m,args:g.extend(n,{name:b,value:a["default"]})}))}),j=m.getInterBlocks(b,i),h(a)&&j.unshift(b),b!==i&&h(f)&&j.push(i),g.each(j,function(a){g.each(a.getDefaultBlockStyles(),function(b,c){l._applyCommandToComposite(new e({block:a,args:{name:c,value:b}}))})}))}})}({}),yne_common_commands_key_FormatPainter=function(a){var b=yne_common_commands_CompositeCommand,c=yne_common_commands_key_RemoveFormat,d=yne_common_commands_note_ApplyInlineStyle,e=yne_common_commands_note_ApplyBlockStyle,f=yne_common_constants,g=yne_underscore;return b.extend({name:"FormatPainter",initialize:function(a){this._note=a.note,this._args=a.args},apply:function(){var a=this,b=a._note,h=a._args,i=h.range,j=h.data,k=j.inlineStyles,l=j.blockStyles;i.isCollapsed()||(a._applyCommandToComposite(new c({note:b,args:{range:i}})),k=g.omit(k,"href"),g.each(k,function(c,e){c&&c!==f.INTERM&&a._applyCommandToComposite(new d({note:b,args:{range:i,name:e,value:c}}))}),g.each(l,function(c,d){c&&c!==f.INTERM&&a._applyCommandToComposite(new e({note:b,args:{range:i,name:d,value:c}}))}))}})}({}),yne_common_commands_image_ReplaceSrc=function(a){var b=yne_common_commands_SimpleCommand,c=b.extend({name:"ReplaceSrc",_image:null,_oldSrc:null,_isChanged:null,initialize:function(a){var b=this;b._args=a.args,b._image=a.args.image},apply:function(){var a=this,b=a._args,c=b.image;c&&c.setSource&&b&&b.src&&(a._oldSrc=c.getSource(),a._isChanged=c.setSource(b.src))},doReapply:function(){var a=this;a._isChanged&&a._image.setSource(a._args.src)},doUnapply:function(){var a=this;a._isChanged&&a._image.setSource(a._oldSrc)}});return c}({}),yne_common_commands_image_Replace=function(a){var b=yne_common_commands_CompositeCommand,c=yne_common_commands_image_ReplaceSrc,d=yne_jtk_core_L,e=b.extend({name:"Replace",initialize:function(){},apply:function(){var a=this,b=a.options,e=b.args;e&&(e.src&&a._applyCommandToComposite(new c(b)),e.styles&&d.log("TODO"))}});return e}({}),yne_common_commands_attachment_ReplaceSource=function(a,b){return a.extend({name:"Replace",_attach:null,_isChanged:null,_oldSrc:null,_oldResource:null,_oldFileName:null,_oldFileLength:null,initialize:function(a){var b=this;b._args=a.args,b._attach=a.args.attachment},apply:function(){var a=this,c=a._args,d=c.attachment;b.some([d,c.src,c.resource],b.isUndefined)||(a._oldSrc=d.getSource(),a._oldResource=d.getResource(),a._oldFileName=d.getFileName(),a._oldFileLength=d.getFileLength(),a._isChanged=d.setSource(c.src)&&d.setResource(c.resource),c.fileName&&d.setFileName(c.fileName),c.fileLength&&d.setFileLength(c.fileLength))},doReapply:function(){var a=this,b=a._args,c=a._attach;a._isChanged&&(c.setSource(b.src),c.setResource(b.resource),c.setFileName(b.fileName),c.setFileLength(b.fileLength))},doUnapply:function(){var a=this,b=a._attach;a._isChanged&&(b.setSource(a._oldSrc),b.setResource(a._oldResource),b.setFileName(a._oldFileName),b.setFileLength(a._oldFileLength))}})}(yne_common_commands_SimpleCommand,yne_underscore),yne_common_commands_attachment_Replace=function(a,b){return a.extend({name:"Replace",initialize:function(){},apply:function(){var a=this,c=a.options,d=c.args;d&&d.src&&d.resource&&a._applyCommandToComposite(new b(c))}})}(yne_common_commands_CompositeCommand,yne_common_commands_attachment_ReplaceSource),yne_common_commands_note_DragBlocks=function(a){var b=yne_common_commands_CompositeCommand,c=yne_common_commands_note_DeleteRange,d=yne_common_commands_note_InsertBlocks;return b.extend({initialize:function(a){var b=this,c=a.note,d=a.args;b._note=c,b._args=d},apply:function(){var a=this,b=a._args,e=a._note,f=b.range,g=b.dropRange,h=f.getStartBlockRange(),i=b.blocks,j=h.end-h.start;a._applyCommandToComposite(new c({note:e,args:{range:f}})),g.block===h.block&&h.end<g.start&&(g.start-=j,g.end-=j),f.setBlockRanges([g]),a._applyCommandToComposite(new d({note:e,args:{range:f,blocks:i}}))}})}({}),yne_common_commands_CommandFactory=function(a){var b=yne_jtk_core_Class,c=yne_jtk_core_L,d={backspace:yne_common_commands_key_Backspace,enter:yne_common_commands_key_Enter,space:yne_common_commands_key_Space,textInput:yne_common_commands_key_TextInput,deleteRange:yne_common_commands_note_DeleteRange,tab:yne_common_commands_key_Tab,indent:yne_common_commands_key_Indent,outdent:yne_common_commands_key_Outdent,"delete":yne_common_commands_key_Delete,insertHorizontalRule:yne_common_commands_key_InsertHorizontalRule,insertImage:yne_common_commands_key_InsertImage,insertAttachment:yne_common_commands_key_InsertAttachment,insertTable:yne_common_commands_key_InsertTable,insertLink:yne_common_commands_key_InsertLink,applyInlineStyle:yne_common_commands_note_ApplyInlineStyle,applyBlockStyle:yne_common_commands_note_ApplyBlockStyle,insertOrderedList:yne_common_commands_note_InsertOrderedList,insertUnorderedList:yne_common_commands_note_InsertUnorderedList,insertBlocks:yne_common_commands_note_InsertBlocks,removeFormat:yne_common_commands_key_RemoveFormat,formatPainter:yne_common_commands_key_FormatPainter,replaceImage:yne_common_commands_image_Replace,replaceAttachment:yne_common_commands_attachment_Replace,dragBlocks:yne_common_commands_note_DragBlocks,recognitionLinks:yne_common_commands_link_RecognitionLink};return b.extend({initialize:function(){},create:function(a,b,e){var f,g=null;return a+="",f=d[a],f?(g=new f({note:b,args:e}),g.isSimple||(g.setStartingRange(e.range),g.setEndingRange(e.range))):c.warn("No class for `"+a+"` command"),g}})}({}),yne_common_core_Controller=function(a){var b,c,d=yne_jtk_core_Class,e=yne_common_selection_NoteSelection,f=yne_common_commands_CommandManager,g=yne_common_commands_CommandFactory,h=yne_common_selection_NoteRange,i=yne_common_data_RichText,j=yne_parser_Parser,k=yne_common_data_Paragraph,l=yne_common_constants,m=yne_underscore,n=yne_backbone,o=yne_common_selection_rangeUtil,p=yne_common_data_blockTypes,q=yne_jtk_core_L,r=yne_common_data_supportedInlineStyles,s=yne_common_data_supportedBlockStyles;return c={note:null,noteSelection:null,_isReadOnly:!1,initialize:function(a){var b=this,c=a.noteView;b.cmdManager=new f,b.cmdFactory=new g,m.bindAll(b,"onUpdateSelection","_onSelectionChange","_onDeleteSelection","_onKey","_onTextInput","onCommand","_onCopy","_onCut","onPaste","_registerYTable","_unregisterYTable","_deleteYTable","_onYTableKeyUndo","_onYTableKeyRedo","_onDragStart","_onDragOver","_onDrop","_onYTableGlobalUndo","_onYTableGlobalRedo","_onYTableMoveOverflow","_onYTableSaveContent","_onResize"),b.setOptions(a),b.noteView=c,b.noteSelection=new e({noteView:c}),b._bindEvents()},reset:function(){var a=this;a.cmdManager&&a.cmdManager.reset(),a.noteSelection&&a.noteSelection.reset(),a._isReadOnly=!1},setOptions:function(a){var b=this,c=a.note;a.removeLocalImg?b._removeLocalImg=a.removeLocalImg:b._removeLocalImg=b._removeLocalImg||!1,b.note&&(b.note.off("ytable-register"),b.note.off("ytable-unregister"),b.note.off("ytable-contextmenu")),b.reset(),b.note=a.note,c.on("ytable-register",b._registerYTable),c.on("ytable-unregister",b._unregisterYTable),c.on("ytable-delete",b._deleteYTable),c.on("ytable-contextmenu",b.trigger.bind(b,"ytable-contextmenu"))},_bindEvents:function(){var a=this,b=a.cmdManager,c=a.noteView;b.on("update-selection",a.onUpdateSelection),b.on("command-exec",a.trigger.bind(a,"command-exec")),a.noteSelection.on("selection-change",a._onSelectionChange),c.on("delete-selection",a._onDeleteSelection),c.on("text-input",a._onTextInput),c.on("key-pressed",a._onKey),c.on("command",a.onCommand),c.on("copy",a._onCopy),c.on("cut",a._onCut),c.on("paste",a.onPaste),c.on("contextmenu",a.trigger.bind(a,"contextmenu")),c.on("selectstart",a.trigger.bind(a,"selectstart")),c.on("yne-replace-image",a.trigger.bind(a,"yne-replace-image")),
c.on("yne-replace-attachment",a.trigger.bind(a,"yne-replace-attachment")),c.on("open-link",a.trigger.bind(a,"yne-open-link")),c.on("yne-download-attachment",a.trigger.bind(a,"yne-download-attachment")),c.on("dragstart",a._onDragStart),c.on("dragover",a._onDragOver),c.on("drop",a._onDrop),c.on("ytable-show-toolbar",a.trigger.bind(a,"ytable-show-toolbar")),c.on("ytable-hide-toolbar",a.trigger.bind(a,"ytable-hide-toolbar")),c.on("resize",a._onResize)},execCommand:function(a,b){var c,d,e=this,f=e.cmdManager;if(!e.isReadOnly())return"applyInlineStyle"===a&&(d=e.getNoteRange(),d.isCollapsed())?void e.setEditingInlineState(b.name,b.value):(c=e._createCmd(a,b),c?f.exec(c):!1)},_createCmd:function(a,b){var c=this,d=c.cmdFactory;return b=b||{},b.range=b.range||c.getNoteRange(),b.range?d.create(a,c.note,b):void 0},undo:function(){var a=this,b=a.cmdManager;return b.undo()},redo:function(){var a=this,b=a.cmdManager;return b.redo()},canUndo:function(){var a=this,b=a.cmdManager;return b.canUndo()},canRedo:function(){var a=this,b=a.cmdManager;return b.canRedo()},_onSelectionChange:function(){var a=this;a.updateSelectionStates()},_onDeleteSelection:function(){var a=this,b=a.getNoteRange();b.isCollapsed()||a.execCommand("deleteRange",{range:b})},onUpdateSelection:function(a){var b=this;b.noteSelection.setRange(a)},getNoteRange:function(){var a,b=this,c=b.noteSelection.getRange(),d=b.note;return null===c&&d&&d.getAllBlocks().length>0&&(a=o.createRangeByBlock({block:d.getBlockAt(0),allContent:!1,collapseToStart:!0}),c=new h({startRange:a,endRange:a})),c},_onKey:function(a,b){var c,d=this,e=d.noteView;if(d.isReadOnly())return void b.preventDefault();switch(e&&(e.directionKeyJustMoved=!1),a){case"backspace":b.preventDefault(),d.execDeleteBackward();break;case"del":b.preventDefault(),d.execDeleteForward();break;case"enter":b.preventDefault(),d._enterKeyDown();break;case"tab":b.preventDefault(),d._tabKeyDown();break;case"space":b.preventDefault(),d._spaceKeyDown();break;case"mod+z":b.preventDefault(),d.undo();break;case"mod+y":case"mod+shift+z":b.preventDefault(),d.redo();break;case"mod+shift+r":q.DEBUG&&(window.clearJstCache&&(window.clearJstCache(),window.alert("Clear JST cache... Done!")),c=window.location.href,window.location.href=c);break;case"mod+b":b.preventDefault(),d.toggleInlineStyle("bold");break;case"mod+i":b.preventDefault(),d.toggleInlineStyle("italic");break;case"mod+u":b.preventDefault(),d.toggleInlineStyle("underline");break;case"left":case"up":e&&(e.directionKeyJustMoved=!0),d._moveCaretWithDirection(!1,b);break;case"right":case"down":e&&(e.directionKeyJustMoved=!0),d._moveCaretWithDirection(!0,b);break;case"esc":d.trigger("esc");break;case"mod+s":b.preventDefault(),d.trigger("yne-save-content")}},execDeleteBackward:function(){var a=this,b=a.getNoteRange();return b?void a.execCommand("backspace"):void q.error("noteRange not found")},execDeleteForward:function(){var a=this,b=a.getNoteRange();return b?void a.execCommand("delete"):void q.error("noteRange not found")},_enterKeyDown:function(){this.execCommand("enter",{inlineStyles:this.queryInsertPositionInlineStyles()})},_tabKeyDown:function(){var a,b=this;a=b.queryInsertPositionInlineStyles(),b.execCommand("tab",{inlineStyles:a})},_spaceKeyDown:function(){var a,b=this;a=b.queryInsertPositionInlineStyles(),b.execCommand("space",{inlineStyles:a})},_onTextInput:function(a){var b=this;b._insertText(a)},_insertText:function(a){var b,c,d=this,e=d.getNoteRange();q.log("===> insertText...",a),c=d.queryInsertPositionInlineStyles(e),b=new i({text:a}),b.setStyles(0,b.getLength(),c),d.execCommand("textInput",{range:e,richText:b})},_moveCaretWithDirection:function(a,b){var c,d,e,f,g,i,j,k,l,m=this;return c=m.getNoteRange(),!c||(k=c.canDrawedByNative())?(l=c?"The noteRange can be drawed by native selection!":"The noteRange is null!",void q.warn(l)):(e=c.getStartBlockRange(),d=e.block,void((p.isImage(d)||p.isAttachment(d)||p.isTable(d)||p.isHr(d)||p.isUnknown(d))&&(a?(f=m._getNextCaretBlock(d),g=!0):(f=m._getPreCaretBlock(d),g=!1),f?(i=o.createRangeByBlock({block:f,allContent:!1,collapseToStart:g}),j=new h({startRange:i,endRange:i}),m.noteSelection.setRange(j,!0),b&&b.preventDefault()):a&&m.noteView.focusLastBlankLine())))},_getNextCaretBlock:function(a){for(var b=this.note.getNextBlock(a);b&&!this._isCaretBlock(b);)b=this.note.getNextBlock(b);return b},_getPreCaretBlock:function(a){for(var b=this.note.getPreBlock(a);b&&!this._isCaretBlock(b);)b=this.note.getPreBlock(b);return b},_isCaretBlock:function(a){return p.isParagraph(a)||p.isImage(a)||p.isAttachment(a)||p.isTable(a)},toggleInlineStyle:function(a){var b,c=this,d=c.getNoteRange();return d?(d.isCollapsed()?b=!c.editingInlineStates[a]:(b=c.querySelectionInlineStyle(a),b=b===!0?!1:!0),void c.execCommand("applyInlineStyle",{name:a,value:b})):void q.warn("noteRange not found")},updateEditingInlineStates:function(a){var b=this;b.editingInlineStates=a,b.isLinkStylesChanged=!1},toggleEditingInlineState:function(a){var b=this,c=!b.editingInlineStates[a];b.editingInlineStates[a]=c,b.trigger("yne-editing-state-change",a,c),b.isLinkStylesChanged=b._isLinkStyles(a)},setEditingInlineState:function(a,b){var c=this;c.editingInlineStates[a]=b,c.trigger("yne-editing-state-change",a,b),c.isLinkStylesChanged=c._isLinkStyles(a)},_isLinkStyles:function(a){return m.contains(["color","underline"],a)},updateSelectionStates:function(){var a,b=this,c=b.noteSelection.getRange();a=b.querySelectionInlineStyles(c),b.updateEditingInlineStates(a),b.trigger("yne-selection-change")},queryInsertPositionInlineStyles:function(a){var b,c,d,e,f=this;if(a=a||f.getNoteRange(),!a)return void q.error("noteRange is null");if(a.isCollapsed())e=f.editingInlineStates||f.querySelectionInlineStyles(a);else{if(b=a.getStartBlockRange(),c=b.block,!p.isParagraph(c))return null;d=b.clone(),d.collapse(),c.getEndOffset()>d.end&&d.end++,e=c.getCommonStyles(d)}return e.href&&f._isPartlyOverlapWithAnchor(a)&&(e.href=void 0,f.isLinkStylesChanged||(e.color="black",e.underline=!1)),e},_isPartlyOverlapWithAnchor:function(a){var b,c,d,e,f,g,h;return a.isInSingleBlock()?(b=a.getStartBlockRange(),c=b.block,c instanceof k?(d=b.start,e=b.end,d===e?(d>0&&(g=c.getTextStyle("href",d-1,d)[0]),d<c.getLength()&&(h=c.getTextStyle("href",d,d+1)[0]),(g||h)&&g!==h):(f=c.getCommonStyle("href",{start:d,end:e}),f&&f===l.INTERM)):!1):!1},querySelectionInlineStyle:function(a,b){var c=this,d=c.note;return b=b||c.getNoteRange(),b?d.getCommonInlineStyle(b,a):void q.warn("noteRange not found")},querySelectionBlockStyle:function(a,b){var c=this,d=c.note;return b=b||c.getNoteRange(),b?d.getRangeBlockStyle(b,a):void q.warn("noteRange not found")},querySelectionInlineStyles:function(a){var b=this,c={},d=r.getKeys();return(a=a||b.getNoteRange())?(m.each(d,function(d){c[d]=b.querySelectionInlineStyle(d,a)}),c):void q.warn("noteRange not found")},querySelectionBlockStyles:function(a){var b,c=this,d={};return(a=a||c.getNoteRange())?(b=s.getAllKeys(),m.each(b,function(b){d[b]=c.querySelectionBlockStyle(b,a)}),d):void q.warn("noteRange not found")},isSameList:function(a){var b=this,c=b.note,d=b.getNoteRange();return d?c.isSameList(d,a):!1},onCommand:function(a,b){var c=this;c.execCommand(a,b)},_onCut:function(a){var b=this,c=a.originalEvent,d=c.clipboardData,e=b.getNoteRange();a.preventDefault(),q.log("on cut!"),b._setClipboardByRange(e,d),e&&!e.isCollapsed()&&b.execCommand("deleteRange",{range:e})},_onCopy:function(a){var b=this,c=a.originalEvent,d=c.clipboardData,e=b.getNoteRange();a.preventDefault(),q.log("on copy!"),b._setClipboardByRange(e,d)},_setClipboardByRange:function(a,b){var c,d=this;return!a||a.isCollapsed()?void q.log("no note range or note range is collapsed!"):(c=a.getDataAsJSON(d.note),q.log("set clipboardData  text/yne-json",c),b.setData("text/yne-json",c),c=a.getDataAsHtml(d.note),q.log("set clipboardData text/html",c),b.setData("text/html",c),c=a.getDataAsPlain(d.note),q.log("set clipboardData text/plain",c),void b.setData("text/plain",c))},onPaste:function(a){var b,c,d,e,f=this,g=a.originalEvent,h=g.clipboardData;return a.preventDefault(),c=h.getData("text/yne-ytable-json"),c&&f._pasteYTableJson(c)||(b=h.getData("text/yne-json"),b&&f._pasteJSON(b))?void 0:(d=h.getData("text/html"),d&&f._pasteHTML(d)?void q.log("paste html ok"):(e=h.getData("text/plain"))?void f._pastePlain(e):void f.trigger("yne-blob-paste",a,function(a){a&&f.execCommand("insertImage",{src:a})}))},_pasteJSON:function(a){q.log("Paste JSON\n",a);var b=this,c=j.parseJSON(a,b._removeLocalImg);return b._pasteBlockList(c)},_pasteHTML:function(a){q.log("Paste HTML\n",a);var b=this,c=j.parseHtml(a,b._removeLocalImg);return b._pasteBlockList(c)},_pastePlain:function(a){var b=this,c=j.parsePlain(a);return b._pasteBlockList(c)},_pasteYTableJson:function(a){var b,c=this;try{b=window.JSON.parse(a)}catch(d){return void q.error("parse ytable json  string error")}return c._pasteJSON([{blockType:p.TABLE,data:b}])},_pasteBlockList:function(a){var b=this;if(a&&a.length)return b.execCommand("insertBlocks",{range:b.getNoteRange(),blocks:a}),!0},_registerYTable:function(a){var b,c=this;return a&&a.getCommander?(b=a.getCommander(),c.cmdManager.registerManager(b),a.trigger("global-undo-status",c.canUndo(),c.canRedo()),void c._bindEventsForYTable(a)):void q.warn("ytable editor has no method: getCommander")},_bindEventsForYTable:function(a){var b=this;b._unbindEventsForYTable(a),a.on("key-undo",b._onYTableKeyUndo),a.on("key-redo",b._onYTableKeyRedo),a.on("global-undo",b._onYTableGlobalUndo),a.on("global-redo",b._onYTableGlobalRedo),a.on("move-overflow",b._onYTableMoveOverflow),a.on("save-content",b._onYTableSaveContent)},_onYTableKeyUndo:function(){var a=this;a.undo()},_onYTableKeyRedo:function(){var a=this;a.redo()},_onYTableGlobalUndo:function(a){var b=this;b.undo(),a(b.canUndo(),b.canRedo())},_onYTableGlobalRedo:function(a){var b=this;b.redo(),a(b.canUndo(),b.canRedo())},_onYTableMoveOverflow:function(a){var b=this;q.log("The listener in bulb editor for move-overflow"),b._moveCaretWithDirection(!a)},_onYTableSaveContent:function(){var a=this;a.trigger("yne-save-content")},_unbindEventsForYTable:function(a){var b=this;a.off("key-undo",b._onYTableKeyUndo),a.off("key-redo",b._onYTableKeyRedo),a.off("global-undo",b._onYTableGlobalUndo),a.off("global-redo",b._onYTableGlobalRedo),a.off("move-overflow",b._onYTableGlobalRedo)},_unregisterYTable:function(a){var b,c=this;return a&&a.getCommander?(b=a.getCommander(),c.cmdManager.unregisterManager(b),void c._unbindEventsForYTable(a)):void q.warn("ytable editor has no method: getCommander")},_deleteYTable:function(){var a=this;a.execCommand("deleteRange")},_onDragStart:function(a){var b,c=this,d=c.getNoteRange();return c.startNoteRange=d,!d||d.isCollapsed()?void q.log("no note range or note range is collapsed!"):(b=d.getDataAsJSON(c.note),a.dataTransfer.setData("text/yne-json",b),b=d.getDataAsHtml(c.note),a.dataTransfer.setData("text/html",b),b=d.getDataAsPlain(c.note),a.dataTransfer.setData("text/plain",b),a.dataTransfer.clearData("text/uri-list"),void(a.dataTransfer.effectAllowed="move"))},getRangeByPoint:function(a,b){var c,d;return c=document.caretRangeFromPoint(a,b),d=document.createRange(),d.setStart(c.startContainer,c.startOffset),d},addDragHint:function(a,b){var c,d=this,e=d.getNoteRange().getStartBlockRange(),f=d.getRangeByPoint(a,b),g=d.noteView,h=g.parseNativeRange(f)[0];return h.block===e.block&&h.start>=e.start&&h.start<e.end?!1:(d.lastDragOver?c=d.lastDragSpace.parentNode.removeChild(d.lastDragSpace):(c=document.createElement("span"),c.id="drop-hint",c.textContent=" ",d.lastDragOver={}),d.lastDragOver.x=a,d.lastDragOver.y=b,d.lastDragSpace=c,void f.insertNode(c))},removeDragHint:function(){this.lastDragSpace&&this.lastDragSpace.parentNode&&this.lastDragSpace.parentNode.removeChild(this.lastDragSpace),this.lastDragOver=this.lastDragSpace=null},_onDragOver:function(a,b){var c=this,d=a.clientX,e=a.clientY,f=a.dataTransfer.types;if(!m.contains(f,"text/yne-json"))return!0;if(a.preventDefault(),a.stopPropagation(),!this.lastDragOver||c.lastDragOver.x!==d||c.lastDragOver.y!==e){if(!p.isParagraph(b)&&!p.isListItem(b))return a.dataTransfer.dropEffect="none",void c.removeDragHint();a.dataTransfer.dropEffect="move",!1===c.addDragHint(d,e)&&(a.dataTransfer.dropEffect="none")}},_onDrop:function(a){var b,c,d,e,f=this,g=a.dataTransfer,h=g.types,i=f.noteView,k=f.getRangeByPoint(a.clientX,a.clientY);m.contains(h,"text/yne-json")&&(b=g.getData("text/yne-json"),c=j.parseJSON(b),d=i.parseNativeRange(k),e=d[0],e&&e.isCollapsed()&&(i.trigger("command","dragBlocks",{range:f.startNoteRange,dropRange:e,blocks:c}),f.removeDragHint())),a.preventDefault(),a.stopPropagation()},selectAll:function(){var a=this,b=a.noteView;return b.onSelectAll()},canRemoveFormat:function(){var a=this,b=a.getNoteRange();return b&&!b.isCollapsed()},_onResize:function(){var a=this,b=a.noteView;return b.onResize()},defaultNoteRange:function(){var a,b,c=this,d=c.note.getBlockAt(0);if(d)return a=o.createRangeByBlock({block:d,allContent:!1,collapseToStart:!0}),b=new h({startRange:a,endRange:a})},isValidNoteRange:function(a){var b=this,c=function(a){var c,d;return a&&a.block?(c=a.block,d=b.note.getBlockIndex(c),d>-1?!0:!1):!1};return a?c(a.startRange)&&c(a.endRange):!1},setReadOnly:function(a){var b=this;a=!!a,b.isReadOnly()!==a&&(b._isReadOnly=a,m.each(["note"],function(c){var d=b[c];d&&d.setReadOnly&&d.setReadOnly(a)}))},isReadOnly:function(){return this._isReadOnly}},m.extend(c,n.Events),b=d.extend(c)}({}),yne_toolbar_BaseButton=function(a){var b=yne_backbone,c=yne_underscore,d=yne_common_jst;return b.View.extend({className:"tooblar-item toolbar-button",events:{click:"onClick",mousedown:"onMouseDown"},name:"unknown",label:"unknown",defaultState:!1,state:!1,templateName:"toolbar-button-template",editorEvents:null,initialize:function(a){var b=this;b.editor=a.editor,b.render(),b.setState(b.defaultState),b.bindEditorEvents(),b.bindEvents()},render:function(){var a,b=this,c=b.$el;c.addClass("button-"+b.name),a=d.render("web",b.templateName,{name:b.name,label:b.label,defaultState:b.defaultState}),c.html(a)},bindEvents:function(){},bindEditorEvents:function(){var a=this,b=a.editor,d=a.editorEvents;d&&c.each(d,function(c,d){b.on(d,a[c].bind(a))})},onMouseDown:function(a){a.preventDefault()},onClick:function(){},setState:function(a){var b=this,c=b.$el;a=a===!0,b.state=a,a?c.find(".button").addClass("active"):c.find(".button").removeClass("active")}})}({}),yne_toolbar_other_Undo=function(a){var b=yne_toolbar_BaseButton;return b.extend({name:"undo",label:"撤销",defaultState:!1,state:!1,templateName:"toolbar-button-template",editorEvents:{"command-exec":"onCommandExec"},onCommandExec:function(){var a=this;a.setState(a.editor.canUndo())},onClick:function(){var a=this;a.state===!0&&a.editor.undo()}})}({}),yne_toolbar_other_Redo=function(a){var b=yne_toolbar_BaseButton;return b.extend({name:"redo",label:"重做",defaultState:!1,state:!1,templateName:"toolbar-button-template",editorEvents:{"command-exec":"onCommandExec"},onCommandExec:function(){var a=this;a.setState(a.editor.canRedo())},onClick:function(){var a=this;a.state===!0&&a.editor.redo()}})}({}),yne_toolbar_other_RemoveFormat=function(a){var b=yne_toolbar_BaseButton;return b.extend({name:"remove-format",label:"清除格式",defaultState:!1,state:!1,templateName:"toolbar-button-template",editorEvents:{"yne-selection-change":"onSelectionChange"},onSelectionChange:function(){var a=this;a.setState(a.editor.canRemoveFormat())},onClick:function(){var a=this;a.editor.execCommand("removeFormat")}})}({}),yne_toolbar_other_FormatPainterManager=function(a){var b,c=yne_jtk_core_Class,d=yne_jquery,e=yne_backbone,f=yne_underscore,g={NONE:0,ONCE:1,REPEAT:2};return b={state:null,data:null,initialize:function(a){var b=this;b._editor=a.editor,b.state=g.NONE,f.bindAll(b,"stash","paint","reset","onSelectStart","onCommandExec")},stash:function(a){var b=this,c=b._editor;b.reset(),b.data={inlineStyles:c.querySelectionInlineStyles(),blockStyles:c.querySelectionBlockStyles()},a?b.setState(g.ONCE):b.setState(g.REPEAT),b.bindEvents()},paint:function(){var a=this;a.data&&a._editor.execCommand("formatPainter",{data:a.data}),a.state===g.ONCE&&a.reset()},reset:function(){var a=this;a.data=null,a.setState(g.NONE),a.unbindEvents()},setState:function(a){var b=this;b.state!==a&&(b.state=a,b.trigger("formatpainter-state-change",!!a),b.updateFormatPainterCursorUI(!!a))},updateFormatPainterCursorUI:function(a){this._editor.updateFormatPainterCursorUI(a)},bindEvents:function(){var a=this,b=a._editor;a.unbindEvents(),b.on("selectstart",a.onSelectStart),b.on("esc",a.reset),b.on("command-exec",a.onCommandExec)},unbindEvents:function(){var a=this,b=a._editor;b.off("selectstart",a.onSelectStart),b.off("esc",a.reset),b.off("command-exec",a.onCommandExec)},onSelectStart:function(){var a=this;d(document).one("mouseup",a.paint)},onCommandExec:function(a){"FormatPainter"!==a&&this.reset()}},f.extend(b,e.Events),c.extend(b)}({}),yne_toolbar_other_FormatPainter=function(a){var b=yne_toolbar_BaseButton,c=yne_toolbar_other_FormatPainterManager;return b.extend({name:"format-painter",label:"格式刷",events:{click:"onClick",dblclick:"onDblClick",mousedown:"onMouseDown"},defaultState:!1,state:!1,templateName:"toolbar-button-template",initialize:function(){var a=this;b.prototype.initialize.apply(a,arguments),a._initFormatPainterManager()},_initFormatPainterManager:function(){var a=this;a._formatPainterManager=new c({editor:a.editor}),a._formatPainterManager.on("formatpainter-state-change",a.onFormatPainterStateChange.bind(a))},clickAction:function(){var a=this;a.state===!0?a.reset():a.stash(!0)},onClick:function(){var a=this;clearTimeout(a._timer),a._timer=setTimeout(function(){a.clickAction()},300)},onDblClick:function(){var a=this;clearTimeout(a._timer),a.stash()},stash:function(a){this._formatPainterManager.stash(a)},reset:function(){this._formatPainterManager.reset()},onFormatPainterStateChange:function(a){this.setState(!!a)}})}({}),yne_toolbar_BaseSplit=function(a){var b=yne_backbone;return b.View.extend({className:"tooblar-item toolbar-split",initialize:function(){},render:function(){}})}({}),yne_toolbar_BaseComboBox=function(a){var b=yne_backbone,c=yne_underscore,d=yne_jquery,e=yne_common_jst;return b.View.extend({className:"toolbar-item toolbar-combo-box",events:{"click .combo-value-wrapper":"onValueWrapperElClick","click .combo-expand-wrapper":"onExpandWrapperElClick","click .combo-menu-wrapper":"onMenuWrapperClick",mousedown:"onMouseDown"},name:"unknown",label:"unknown",defaultValue:"",items:{},value:"",templateName:"toolbar-combo-box-template",editorEvents:null,initialize:function(a){var b=this;b.editor=a.editor,b.render(),b.select(b.defaultValue),b.bindEvents(),b.bindDocumentEvents(),b.bindEditorEvents()},render:function(){var a,b=this,c=b.$el;c.addClass("combo-box-"+b.name),a=e.render("web",b.templateName,{name:b.name,label:b.label,defaultValue:b.defaultValue,items:b.items}),c.html(a),b.valueWrapperEl=c.find(".combo-value-wrapper")[0],b.expandWrapperEl=c.find(".combo-expand-wrapper")[0],b.menuWrapperEl=c.find(".combo-menu-wrapper")[0]},bindEvents:function(){},bindDocumentEvents:function(){var a=this;c.bindAll(a,"onDocumentMouseDown"),d(document).on("mousedown",a.onDocumentMouseDown)},bindEditorEvents:function(){var a=this,b=a.editor,d=a.editorEvents;d&&c.each(d,function(c,d){b.on(d,a[c].bind(a))})},onValueWrapperElClick:function(){var a=this;a.toggleMenu()},onExpandWrapperElClick:function(){var a=this;a.toggleMenu()},onMenuWrapperClick:function(a){var b=this,c=a.target,e=d(c).closest(".combo-item")[0];e&&(b.hideMenu(),b.onItemClick(e))},onItemClick:function(a){var b=this,c=d(a).data("value");c&&c!==b.value&&(b.select(c),b.onChange(c))},select:function(a){var b=this;b.value=a,b.updateValueUI(a)},updateValueUI:function(){},onChange:function(){},showMenu:function(){var a,b=this,c=b.menuWrapperEl;d(c).removeClass("menu-position-fix"),d(c).addClass("show"),a=c.getBoundingClientRect(),a.right>document.documentElement.offsetWidth&&d(c).addClass("menu-position-fix")},hideMenu:function(){var a=this;d(a.menuWrapperEl).removeClass("show")},toggleMenu:function(){var a=this,b=d(a.menuWrapperEl);b.hasClass("show")?a.hideMenu():a.showMenu()},onDocumentMouseDown:function(a){var b=this,c=a.target;d.contains(b.el,c)||b.hideMenu()},onMouseDown:function(a){a.preventDefault()}})}({}),yne_toolbar_inline_BaseInlineComboBox=function(a){var b=yne_toolbar_BaseComboBox,c=yne_jquery;return b.extend({editorEvents:{"yne-selection-change":"onSelectionChange"},onChange:function(a){var b=this;b.editor.execCommand("applyInlineStyle",{name:b.name,value:a})},updateValueUI:function(a){var b=this,d=c(b.valueWrapperEl).find(".combo-value")[0];b.items[a]?c(d).html(b.items[a]):c(d).html(b.getUnlistedHtml(a)||"")},getUnlistedHtml:function(){return""},onSelectionChange:function(){var a=this,b=a.editor.querySelectionInlineStyle(a.name);a.select(b)}})}({}),yne_toolbar_inline_FontFamily=function(a){var b=yne_toolbar_inline_BaseInlineComboBox,c=yne_common_constants;return b.extend({name:"font-family",label:"字体",defaultValue:"Microsoft YaHei",items:{"Microsoft YaHei":"微软雅黑",Simsun:"宋体",NSimSum:"新宋体",FangSong_GB2312:"仿宋",KaiTi_GB2312:"楷体",SimHei:"黑体",Arial:"Arial","Arial Black":"Arial Black","Times New Roman":"Times New Roman","Courier New":"Courier New",Tahoma:"Tahoma",Verdana:"Verdana"},templateName:"toolbar-combo-box-font-family",getUnlistedHtml:function(a){return a&&a!==c.INTERM?a:void 0}})}({}),yne_toolbar_inline_FontSize=function(a){var b=yne_toolbar_inline_BaseInlineComboBox,c=yne_underscore;return b.extend({name:"font-size",label:"字号",defaultValue:"14",items:{9:"9px",12:"12px",14:"14px",16:"16px",18:"18px",22:"22px",26:"26px",30:"30px",36:"36px",42:"42px"},templateName:"toolbar-combo-box-font-size",getUnlistedHtml:function(a){return a&&c.isNumber(a)?a+"px":void 0}})}({}),yne_toolbar_inline_BaseInlineButton=function(a){var b=yne_toolbar_BaseButton;return b.extend({editorEvents:{"yne-selection-change":"onSelectionChange","yne-editing-state-change":"onEditingStateChange"},onSelectionChange:function(){var a=this;a.setState(a.querySelectionState())},onEditingStateChange:function(a,b){var c=this;a===c.name&&c.setState(b)},querySelectionState:function(){var a=this;return a.editor.querySelectionInlineStyle(a.name)},onClick:function(){var a=this;a.editor.execCommand("applyInlineStyle",{name:a.name,value:!a.state})}})}({}),yne_toolbar_inline_Bold=function(a){var b=yne_toolbar_inline_BaseInlineButton;return b.extend({name:"bold",label:"加粗"})}({}),yne_toolbar_inline_Italic=function(a){var b=yne_toolbar_inline_BaseInlineButton;return b.extend({name:"italic",label:"斜体"})}({}),yne_toolbar_inline_Underline=function(a){var b=yne_toolbar_inline_BaseInlineButton;return b.extend({name:"underline",label:"下划线"})}({}),yne_toolbar_inline_Strike=function(a){var b=yne_toolbar_inline_BaseInlineButton;return b.extend({name:"strike",label:"删除线"})}({}),yne_toolbar_config_colors={theme:["#FFFFFF","#000000","#EEECE1","#1F497D","#4F81BD","#C0504D","#9BBB59","#8064A2","#4BACC6","#F79646"],other:[["#F2F2F2","#7F7F7F","#DDD9C3","#C6D9F0","#DBE5F1","#F2DCDB","#EBF1DD","#E5E0EC","#DBEEF3","#FDEADA"],["#D8D8D8","#595959","#C4BD97","#8DB3E2","#B8CCE4","#E5B9B7","#D7E3BC","#CCC1D9","#B7DDE8","#FBD5B5"],["#BFBFBF","#3F3F3F","#938953","#548DD4","#95B3D7","#D99694","#C3D69B","#B2A2C7","#92CDDC","#FAC08F"],["#A5A5A5","#262626","#494429","#17365D","#366092","#953734","#76923C","#5F497A","#31859B","#E36C09"],["#7F7F7F","#0C0C0C","#1D1B10","#0F243E","#244061","#632423","#4F6128","#3F3151","#205867","#974806"]],standard:["#C00000","#FF0000","#FFC000","#FFFF00","#92D050","#00B050","#00B0F0","#0070C0","#002060","#7030A0"]},yne_toolbar_BaseColorComboBox=function(a){var b=yne_toolbar_BaseComboBox,c=yne_jquery,d=yne_toolbar_config_colors;return b.extend({name:"color",defaultValue:"#000000",items:d,templateName:"toolbar-combo-box-color",editorEvents:{"yne-selection-change":"onSelectionChange"},onValueWrapperElClick:function(){var a=this,b=a.value;a.hideMenu(),b!==a.selectedValue&&a.onChange(b)},onChange:function(a){var b=this;b.doAction(a)},doAction:function(){},onItemClick:function(a){var b=this,d=c(a).data("value");d&&d!==b.value&&b.select(d),d&&d!==b.selectedValue&&b.onChange(d)},updateValueUI:function(a){var b=this,d=c(b.valueWrapperEl).find(".combo-value-buttom-color")[0];c(d).css("background-color",a)},onSelectionChange:function(){var a=this,b=a.editor.querySelectionInlineStyle(a.name);a.selectedValue=b}})}({}),yne_toolbar_inline_Color=function(a){var b=yne_toolbar_BaseColorComboBox;return b.extend({name:"color",label:"文字颜色",defaultValue:"#FF0000",doAction:function(a){var b=this;b.editor.execCommand("applyInlineStyle",{name:b.name,value:a||b.value})}})}({}),yne_toolbar_inline_BackColor=function(a){var b=yne_toolbar_BaseColorComboBox;return b.extend({name:"back-color",label:"背景色",defaultValue:"#FFFF00",doAction:function(a){var b=this;b.editor.execCommand("applyInlineStyle",{name:b.name,value:a||b.value})}})}({}),yne_toolbar_block_BaseBlockComboBox=function(a){var b=yne_toolbar_BaseComboBox;return b.extend({editorEvents:{"yne-selection-change":"onSelectionChange"},onChange:function(a){var b=this;b.editor.execCommand("applyBlockStyle",{name:b.name,value:a})}})}({}),yne_toolbar_block_Align=function(a){var b=yne_toolbar_block_BaseBlockComboBox,c=yne_underscore,d=yne_jquery;return b.extend({name:"align",label:"对齐方式",defaultValue:"left",items:{justify:"两端对齐",left:"左对齐",center:"居中对齐",right:"右对齐"},templateName:"toolbar-combo-box-align",updateValueUI:function(a){var b=this,e=d(b.valueWrapperEl).find(".combo-value")[0];d(e).removeClass(c.keys(b.items).join(" ")),d(e).addClass(a)},onSelectionChange:function(){var a=this,b=a.editor.querySelectionBlockStyle(a.name);a.items[b]?a.select(b):this.select(a.defaultValue)}})}({}),yne_toolbar_block_Indent=function(a){var b=yne_toolbar_BaseButton;return b.extend({name:"indent",label:"增加缩进",defaultState:!1,state:!1,templateName:"toolbar-button-template",onClick:function(){var a=this;a.editor.execCommand("indent")}})}({}),yne_toolbar_block_Outdent=function(a){var b=yne_toolbar_BaseButton;return b.extend({name:"outdent",label:"减少缩进",defaultState:!1,state:!1,templateName:"toolbar-button-template",onClick:function(){var a=this;a.editor.execCommand("outdent")}})}({}),yne_toolbar_block_BaseBlockButton=function(a){var b=yne_toolbar_BaseButton;return b.extend({editorEvents:{"yne-selection-change":"onSelectionChange"},onSelectionChange:function(){var a=this;a.setState(a.querySelectionState())},querySelectionState:function(){var a=this;return a.editor.querySelectionInlineStyle(a.name)}})}({}),yne_toolbar_block_UnorderedList=function(a){var b=yne_toolbar_block_BaseBlockButton;return b.extend({name:"unordered-list",label:"无序列表",defaultState:!1,state:!1,templateName:"toolbar-button-template",querySelectionState:function(){var a=this;return a.editor.isSameList("unordered")},onClick:function(){var a=this;a.editor.execCommand("insertUnorderedList")}})}({}),yne_toolbar_block_OrderedList=function(a){var b=yne_toolbar_block_BaseBlockButton;return b.extend({name:"ordered-list",label:"项目编号",defaultState:!1,state:!1,templateName:"toolbar-button-template",querySelectionState:function(){var a=this;return a.editor.isSameList("ordered")},onClick:function(){var a=this;a.editor.execCommand("insertOrderedList")}})}({}),yne_toolbar_block_LineHeight=function(a){var b=yne_toolbar_block_BaseBlockComboBox,c=yne_underscore,d=yne_jquery;return b.extend({name:"line-height",label:"行高",defaultValue:"1",keys:[1.5,1.875,2.25,2.625,3,3.75,4.5],items:[{key:1.5,value:"1.0"},{key:1.875,value:"1.25"},{key:2.25,value:"1.5"},{key:2.625,value:"1.75"},{key:3,value:"2.0"},{key:3.75,value:"2.5"},{key:4.5,value:"3.0"}],templateName:"toolbar-combo-box-line-height",updateValueUI:function(a){var b=this,e=d(b.menuWrapperEl),f=c.indexOf(b.keys,a);e.find(".active").removeClass("active"),-1!==f&&e.find(".line-height-"+f).addClass("active")},onSelectionChange:function(){var a=this,b=a.editor.querySelectionBlockStyle(a.name),d=c.indexOf(a.keys,b);-1!==d?a.select(b):this.select(a.defaultValue)}})}({}),yne_toolbar_insert_InsertTable=function(a){var b=yne_backbone,c=yne_underscore,d=yne_jquery,e=yne_common_jst,f=6,g=8;return b.View.extend({className:"toolbar-item toolbar-combo-box",events:{"click .combo-value-wrapper":"onValueWrapperClick","mouseleave .combo-menu":"onMenuMouseLeave","mouseenter .combo-item":"onItemMouseEnter","click .combo-item":"onItemClick",mousedown:"onMouseDown"},name:"table",label:"表格",templateName:"toolbar-combo-box-table",initialize:function(a){var b=this;b.editor=a.editor,b.render(),b.bindDocumentEvents()},render:function(){var a,b=this,c=b.$el;a=e.render("web",b.templateName,{name:b.name,label:b.label,maxRows:f,maxCols:g}),c.html(a),b.menuWrapperEl=c.find(".combo-menu-wrapper")[0],b.menuLabelEl=c.find(".combo-menu-label-table")[0],b.comboItems=c.find(".combo-item")},bindDocumentEvents:function(){var a=this;c.bindAll(a,"onDocumentMouseDown"),d(document).on("mousedown",a.onDocumentMouseDown)},onDocumentMouseDown:function(a){var b=this,c=a.target;d.contains(b.el,c)||b.hideMenu()},onValueWrapperClick:function(){this.toggleMenu()},onItemMouseEnter:function(a){var b=a.target,c=this.getItemCoordinate(b);this.selectItems(c.row+1,c.col+1)},onItemClick:function(a){var b=this,c=a.target,d=b.getItemCoordinate(c);b.insertTable(d.row+1,d.col+1),b.hideMenu()},onMenuMouseLeave:function(){this.resetSelected()},onMouseDown:function(a){a.preventDefault()},getItemCoordinate:function(a){var b=d(a);return{row:b.data("row"),col:b.data("col")}},resetSelected:function(){this.selectItems(0,0)},selectItems:function(a,b){this.updateSelectedLabelText(a,b),this.updateSelectedItemsUI(a,b)},updateSelectedLabelText:function(a,b){var c=d(this.menuLabelEl);a>0&&b>0?c.html(a+" 行 "+b+" 列"):c.html("插入表格")},updateSelectedItemsUI:function(a,b){var c,e,f=this;for(d(f.comboItems).removeClass("selected"),c=0;a>c;c++)for(e=0;b>e;e++)d(f.comboItems[c*g+e]).addClass("selected")},insertTable:function(a,b){this.editor.execCommand("insertTable",{rows:a,cols:b})},toggleMenu:function(){var a=this,b=d(a.menuWrapperEl);b.hasClass("show")?a.hideMenu():a.showMenu()},showMenu:function(){var a,b=this,c=b.menuWrapperEl;d(c).removeClass("menu-position-fix"),d(c).addClass("show"),a=c.getBoundingClientRect(),a.right>document.documentElement.offsetWidth&&d(c).addClass("menu-position-fix")},hideMenu:function(){var a=this;d(a.menuWrapperEl).removeClass("show"),a.resetSelected()}})}({}),yne_toolbar_insert_InsertHorizontalRule=function(a){var b=yne_toolbar_BaseButton;return b.extend({name:"hr",label:"水平线",defaultState:!1,state:!1,templateName:"toolbar-button-template",onClick:function(){var a=this;a.editor.execCommand("insertHorizontalRule")}})}({}),yne_toolbar_insert_InsertLink=function(a){var b=yne_toolbar_BaseButton;return b.extend({name:"link",label:"链接",defaultState:!1,state:!1,templateName:"toolbar-button-template",onClick:function(){var a=this;a.editor.trigger("yne-insert-link",function(b){b&&a.editor.execCommand("insertLink",{src:b})})}})}({}),yne_toolbar_insert_InsertImage=function(a){var b=yne_toolbar_BaseButton;return b.extend({name:"img",label:"图片",defaultState:!1,state:!1,templateName:"toolbar-button-template",onClick:function(){var a=this;a.editor.trigger("yne-insert-photo",function(b){b&&a.editor.execCommand("insertImage",{src:b})})}})}({}),yne_toolbar_insert_InsertAttachment=function(a){function b(a){var b="other";return a&&a.src&&(b="image",a.resource&&a.fileName&&a.fileLength&&(b="attachment")),b}var c=yne_toolbar_BaseButton,d=yne_jtk_core_L;return c.extend({name:"attachment",label:"附件",defaultState:!1,state:!1,templateName:"toolbar-button-template",onClick:function(){var a=this;a.editor.trigger("yne-insert-attachment",function(c){switch(b(c)){case"attachment":a.editor.execCommand("insertAttachment",{src:c.src,resource:c.resource||"resource",fileName:c.fileName||"fileName",fileLength:c.fileLength||"fileLength"
});break;case"image":a.editor.execCommand("insertImage",{src:c.src});break;default:d.log("Error: attachment data is invald! "+c)}})}})}({}),yne_toolbar_other_showMore=function(a){var b=yne_backbone,c=yne_underscore,d=yne_jquery,e=yne_common_jst;return b.View.extend({className:"toolbar-item toolbar-combo-box toolbar-combo-more",name:"showmore",label:"查看更多",templateName:"toolbar-combo-box-show-more",events:{"click .combo-value-wrapper-showmore":"onValueWrapperClick",mousedown:"onMouseDown"},initialize:function(a){var b=this;b.editor=a.editor,b.items=a.items,b.render(),b.bindDocumentEvents()},render:function(){var a,b=this,c=b.$el;a=e.render("web",b.templateName,{name:b.name,label:b.label}),c.html(a),b.menuWrapperEl=c.find(".combo-menu-wrapper")[0],b.menuItemContainer=c.find(".combo-menu")[0],b.$split=c.find(".toolbar-more-split")},bindDocumentEvents:function(){var a=this;c.bindAll(a,"onDocumentMouseDown"),d(document).on("mousedown",a.onDocumentMouseDown)},onDocumentMouseDown:function(a){var b=this,c=a.target;d.contains(b.el,c)||b.hideMenu()},onMouseDown:function(a){a.preventDefault()},onValueWrapperClick:function(){this.toggleMenu()},toggleMenu:function(){var a=this,b=d(a.menuWrapperEl);b.toggleClass("show")},showMenu:function(){var a=this,b=a.menuWrapperEl;d(b).addClass("show")},hideMenu:function(){var a=this,b=a.menuWrapperEl;d(b).removeClass("show")},resetMenu:function(){var a,b=this,e=b.items,f=d(b.menuItemContainer);c.map(e,function(a){f.append(a.$el)}),f.children().length>0?(a=b.$el.prev(),"tooblar-item toolbar-split"===a.attr("class")?a.hide():a.show(),b.$el.show()):b.$el.hide()}})}({}),yne_toolbar_Toolbar=function(a){var b=yne_backbone,c=yne_underscore,d=yne_jquery,e=[yne_toolbar_other_Undo,yne_toolbar_other_Redo,yne_toolbar_other_RemoveFormat,yne_toolbar_other_FormatPainter,yne_toolbar_BaseSplit,yne_toolbar_inline_FontFamily,yne_toolbar_inline_FontSize,yne_toolbar_inline_Bold,yne_toolbar_inline_Italic,yne_toolbar_inline_Underline,yne_toolbar_inline_Strike,yne_toolbar_BaseSplit,yne_toolbar_inline_Color,yne_toolbar_inline_BackColor,yne_toolbar_BaseSplit,yne_toolbar_block_Align,yne_toolbar_BaseSplit,yne_toolbar_block_Indent,yne_toolbar_block_Outdent,yne_toolbar_block_UnorderedList,yne_toolbar_block_OrderedList,yne_toolbar_block_LineHeight,yne_toolbar_BaseSplit,yne_toolbar_insert_InsertTable,yne_toolbar_insert_InsertHorizontalRule,yne_toolbar_insert_InsertLink,yne_toolbar_insert_InsertImage,yne_toolbar_insert_InsertAttachment],f=yne_toolbar_other_showMore,g=[];return b.View.extend({className:"bulb-toolbar",initialize:function(a){var b=this,c=a.editor;b.editor=c,b.items=[],b.initItems(),b.isRendered=!1},initItems:function(){var a=this,b=a.editor;c.each(e,function(c){a.addItem(new c({editor:b}))}),a.addItem(new f({editor:b,items:g}))},render:function(){var a=this,b=this.items,e=this.$el;c.each(b,function(a){e.append(a.$el)}),a.isRendered=!0,d(window).on("resize",function(){c.each(b,function(a){e.append(a.$el)}),a.shrink.call(a)})},addItem:function(a){this.items.push(a)},addItems:function(a){this.items.concat(a)},show:function(){var a=this;a.$el.show(),a.shrink()},hide:function(){var a=this;a.$el.hide()},shrink:function(){var a=this,b=a.items,d=a.$el.parent().width(),e=c.last(b).$el,f=e.outerWidth(!0),h=f;g=[],c.map(b,function(a,c){return a.$el.show(),c===b.length-1?(a.items=g,void a.resetMenu()):(h+=a.$el.outerWidth(!0),void(h>d&&g.push(a)))})},enable:function(){var a=this;a.$el.removeClass("disabled")},disable:function(){var a=this;a.$el.addClass("disabled")}})}({}),yne_common_contextMenu_ContextMenuItem=function(a){var b=yne_underscore,c=yne_jtk_core_Class,d=yne_jtk_core_L,e={ITEM:0,SUBMENU:1,SPLIT:2},f=/Mac|iPod|iPhone|iPad/.test(navigator.platform)?"meta":"ctrl";return c.extend({index:-1,editor:null,initialize:function(a){var c=this,f=function(){d.error("The queryAction() of "+c.name+" should be implemented by options!")},g=function(){d.error("The selectAction() of "+c.name+" should be implemented by options!")};b.defaults(c,a,{name:null,label:null,type:e.ITEM,queryAction:f,selectAction:g,isDefault:!1,isDisabled:!1,isHidden:!1,key:"",items:null})},_resetStatus:function(){var a=this;a.isDefault=!1,a.isDisabled=!1,a.isHidden=!1},checkStatus:function(a,c){var d=this;d._resetStatus(),d.queryAction(a,c)===!1&&(d.isDisabled=d.isHidden=!0),d.isHidden||d.type===e.SUBMENU&&(b.invoke(d.items,"checkStatus",a,c),d.isDisabled=0===d.items.filter(function(a){return!a.isHidden&&!a.isDisabled}).length)},_getKey:function(){var a=this,b=a.key||"";return b?b=b.replace(/mod/i,f):""},select:function(){this.onSelected()},onSelected:function(){var a=this;a.selectAction()},simplify:function(){var a=this,c=a.items,d={index:a.index,type:a.type,isDisabled:a.isDisabled,isHidden:a.isHidden,isDefault:a.isDefault,label:a.label,key:a._getKey()};return c&&c.length&&(d.items=b.map(a.items,function(a){return a&&a.simplify?a.simplify():void 0})),d}},{TYPE:e})}({}),yne_common_contextMenu_ContextMenu=function(a){var b=yne_underscore,c=yne_jtk_core_Class,d=yne_common_contextMenu_ContextMenuItem,e=c.extend({initialize:function(){var a=this,b=a.options;a.editor=b.editor,a.items=[],a.indexArray=[]},addItems:function(a){var c=this;c.items=c.items.concat(a),b.each(a,c.prepareItem.bind(c))},prepareItem:function(a){var c=this;a.index=c.indexArray.length,a.editor=c.editor,c.indexArray.push(a),a.type===d.TYPE.SUBMENU&&b.each(a.items,c.prepareItem.bind(c))},select:function(a){var b=this,c=b.indexArray[a];c&&!c.items&&c.select&&c.select()},onContextMenu:function(a,c){var d,f=this,g=f.editor,h={top:a.pageY,left:a.pageX};b.invoke(f.items,"checkStatus",a,c||{}),d=e.filterItems(f.items),g.trigger("yne-context-menu",h,d,function(a){f.select(a)})}},{filterItems:function(a){var c=!1,f=[];return b.each(a,function(a){var g;switch(a&&a.simplify&&(a=a.simplify()),a.type){case d.TYPE.SPLIT:c||(c=!0,f.push(a));break;case d.TYPE.SUBMENU:a.isHidden||(c=!1,g=b.extend({},a,{items:e.filterItems(a.items)}),f.push(g));break;default:a.isHidden||(c=!1,f.push(a))}}),f}});return e}({}),yne_common_contextMenu_undo=function(a){var b=yne_common_contextMenu_ContextMenuItem;return function(){return new b({name:"undo",label:"撤销",key:"mod+z",queryAction:function(){var a=this,b=a.editor;return b.canUndo()},selectAction:function(){var a=this,b=a.editor;b.undo()}})}}({}),yne_common_contextMenu_redo=function(a){var b=yne_common_contextMenu_ContextMenuItem;return function(){return new b({name:"redo",label:"重做",key:"mod+y",queryAction:function(){var a=this,b=a.editor;return b.canRedo()},selectAction:function(){var a=this,b=a.editor;b.redo()}})}}({}),yne_common_contextMenu_removeFormat=function(a){var b=yne_common_contextMenu_ContextMenuItem;return function(){return new b({name:"removeFormat",label:"清除格式",queryAction:function(){var a=this,b=a.editor;return b.canRemoveFormat()},selectAction:function(){var a=this,b=a.editor;b.execCommand("removeFormat")}})}}({}),yne_common_contextMenu_selectAll=function(a){var b=yne_common_contextMenu_ContextMenuItem,c=yne_jtk_core_L;return function(){return new b({name:"selectAll",label:"全选",queryAction:function(){var a=this,b=a.editor;c.warn("context menu selectAll is not implemented!",b)},selectAction:function(){var a=this,b=a.editor;b.selectAll()}})}}({}),yne_common_contextMenu_countWords=function(a){var b=yne_common_contextMenu_ContextMenuItem,c=yne_jtk_core_L;return function(){return new b({name:"countWords",label:"统计字数",queryAction:function(){var a=this,b=a.editor;c.warn("context menu countWords is not implemented!",b)},selectAction:function(){var a=this,b=a.editor,c=b.countWords();b.trigger("yne-show-words",c)}})}}({}),yne_common_contextMenu_paste=function(a){var b=yne_common_contextMenu_ContextMenuItem;return function(){return new b({name:"paste",label:"粘贴",queryAction:function(a){var b=a.target,c=b.ownerDocument;return this._targetEl=b,this._doc=c,c.queryCommandSupported("paste")},selectAction:function(){var a=this,b=a._targetEl,c=a._doc;b.focus(),c.execCommand("paste")}})}}({}),yne_contextMenu_config=[yne_common_contextMenu_undo,yne_common_contextMenu_redo,yne_common_contextMenu_removeFormat,yne_common_contextMenu_selectAll,yne_common_contextMenu_countWords,yne_common_contextMenu_paste],yne_common_contextMenu_ytableAdapter=function(a){var b=yne_underscore,c=yne_common_contextMenu_ContextMenuItem,d=function(a){var d=[];return b.each(a,function(a,b){var e;e="-"===a?{index:b,type:c.TYPE.SPLIT}:{index:b,type:c.TYPE.ITEM,name:a.key,label:a.name,isDisabled:a.disabled||!1,isHidden:!1,isDefault:!1},d.push(e)}),d},e=function(a,c){var d;return b.some(a,function(a){return a.index===c?(d=a.name,!0):void 0}),d};return function(a,b){var c,f=a.callback,g=a.x,h=a.y,i=d(a.items);c={top:h,left:g},b.trigger("yne-context-menu",c,i,function(a){var b=e(i,a);b&&f(b)})}}({}),yne_common_core_Editor=function(a){var b,c,d=yne_common_data_Note,e=yne_jtk_core_Class,f=yne_underscore,g=yne_jtk_core_L,h=yne_backbone,i=yne_common_util_unknownInlineStyles,j=yne_common_data_supportedInlineStyles,k=yne_common_data_Rich2HtmlConvertor,l=yne_common_data_blankLine;return c={initialize:function(){g.error("The  initialize method should be implemented by subclass")},reset:function(){var a=this;a.controller&&a.controller.reset(),a.noteView&&a.noteView.reset(),a.note&&(a.note.destroy(),a.note=null),i.reset()},setHtmlContent:function(a){var b,c=this;c.reset(),b=d.fromHtml(a),b||(b=d.createBlank(),g.warn("empty note!")),c.note=b,c.noteView.setOptions({note:b}),c.controller.setOptions({note:b}),c.noteView.render()},setXmlContent:function(a){var b,c=this;c.reset(),b=d.fromXml(a),b||(b=d.createBlank(),g.warn("empty note!")),c.note=b,c.noteView.setOptions({note:b}),c.controller.setOptions({note:b}),c.noteView.render()},getXmlContent:function(){var a=this;return a.note.toXml()},getHtmlContent:function(){var a=this;return a.note.toHtml()},getPlainContent:function(){var a=this;return a.note.toPlain()},render:function(){g.error("The  render method should be implemented by subclass")},execCommand:function(a,b){var c=this;return c.controller.execCommand(a,b)},undo:function(){var a=this;return a.controller.undo()},redo:function(){var a=this;return a.controller.redo()},canUndo:function(){var a=this;return a.controller.canUndo()},canRedo:function(){var a=this;return a.controller.canRedo()},countWords:function(){var a=this;return a.note.countWords()},selectAll:function(){return this.controller.selectAll()},setReadOnly:function(a){this.controller.setReadOnly(a)},isReadOnly:function(){return this.controller.isReadOnly()},getNoteRange:function(){var a=this,b=a.controller.getNoteRange();return b},getSchemaVersion:function(){return this.note.getSchemaVersion()},setFont:function(a,b){if(a||b){var c,d=this,e={};a&&(c=j.getDefault("font-size"),e["font-size"]=function(b){var d=b["font-size"];return null!=d?Math.round(a*d/c)+"px":void 0},k.setCssRules(e),l.reset()),b&&(j.setDefault("font-family",b),k.resetInlineStyleDefaultForHtml("font-family")),d.noteView.reRenderTextBlockView()}},resetFont:function(){var a=this;k.resetCssRules(),l.reset(),j.reset(),a.noteView.reRenderTextBlockView()}},f.extend(c,h.Events),b=e.extend(c)}({}),yne_core_WebEditor=function(a){var b,c=yne_common_views_NoteView,d=yne_common_data_Note,e=yne_common_core_Controller,f=yne_jquery,g=yne_underscore,h=yne_jtk_core_L,i=yne_toolbar_Toolbar,j=yne_common_contextMenu_ContextMenu,k=yne_contextMenu_config,l=yne_common_contextMenu_ytableAdapter,m=yne_common_core_Editor;return b=m.extend({_isReadOnly:!1,_toolbar:null,_ytableToolbarWrapper:null,initialize:function(a){var b=this;b.parentEl=a.parentEl,f(b.parentEl).html(""),g.bindAll(b,"_updateNoteViewWrapperSize","onResize"),b.note=d.createBlank(),b.noteView=new c({note:b.note}),b.controller=new e({note:b.note,noteView:b.noteView,removeLocalImg:a.removeLocalImg}),b._bindEventsForController(),b._toolbar=new i({editor:b}),b._initContextMenu(),b.setReadOnly(a.readonly)},_initContextMenu:function(){var a,b,c=this;c._contextMenu||(a=c._contextMenu=new j({editor:c}),b=g.map(k,function(a){return a()}),a.addItems(b),c.on("contextmenu",a.onContextMenu.bind(a)),h.DEBUG&&c.on("yne-context-menu",function(a,b,c){var d,e,f=[];g.each(b,function(a){if(!a.isHidden){if(2===a.type)return void f.push("------------------");var b=a.isDisabled?"[":" ",c=a.isDisabled?"]":" ";f.push(b+a.index+". "+a.label+c)}}),d="context-menu: \n"+f.join("\n"),e=window.prompt(d),e&&(e=parseInt(e,10),isNaN(e)||c(e))}))},reset:function(){var a=this;a.constructor.__super__.reset.apply(a,arguments),a._toolbar.$el.find(".button-undo").removeClass("active"),a._toolbar.$el.find(".button-redo").removeClass("active"),a._ytableToolbarWrapper&&f(a._ytableToolbarWrapper).html("").hide(),a._toolbar&&a._toolbar.isRendered&&a._toolbar.show()},render:function(){var a=this,b=a.noteView;b&&(a._toolbar.render(),f(a.parentEl).append(a._toolbar.$el),a._toolbar.shrink(),a.initNoteViewWrapper(),f(a._noteViewWrapper).append(b.$el),b.render(),a._ytableToolbarWrapper=document.createElement("div"),f(a._ytableToolbarWrapper).addClass("ytable-toolbar-wrapper").hide().prependTo(a.parentEl))},initNoteViewWrapper:function(){var a=this,b=f(a.parentEl);a._noteViewWrapper||(a._noteViewWrapper=f('<div class="note-view-wrapper"></div>'),b.append(a._noteViewWrapper)),a._updateNoteViewWrapperSize(),function(){var c,d,e,f=500;c=function(){var g=!1;d!==b.width()&&(g=!0,d=b.width()),e!==b.height()&&(g=!0,e=b.height()),g&&a.onResize(),setTimeout(c,f)},setTimeout(c,f)}()},onResize:function(){this._updateNoteViewWrapperSize(),this.noteView.trigger("resize")},_updateNoteViewWrapperSize:function(){var a,b=this,c=b._noteViewWrapper,d=f(b.parentEl);c&&(a=f(c),a.height(d.height()-b._toolbar.$el.outerHeight()-a.outerHeight()+a.height()))},_bindEventsForController:function(){var a=this,b=a.controller,c=["yne-selection-change","yne-editing-state-change","command-exec","selectstart","esc","yne-replace-image","yne-replace-attachment","yne-open-link","yne-download-attachment","contextmenu","yne-show-words","yne-save-content","yne-blob-paste"];return b?(g.each(c,function(c){b.on(c,a.trigger.bind(a,c))}),b.on("ytable-contextmenu",function(b){l(b,a)}),b.on("ytable-show-toolbar",function(c){c.trigger("global-undo-status",b.canUndo(),b.canRedo()),c.showToolbar(a._ytableToolbarWrapper),f(a._ytableToolbarWrapper).show(),a._toolbar.hide()}),b.on("ytable-hide-toolbar",function(b){b&&b.hideToolbar(),f(a._ytableToolbarWrapper).hide(),a._toolbar.show()}),void b.on("command-exec",function(){a.trigger("yne-content-change")})):void h.warn("no controller!")},querySelectionInlineStyle:function(a){return this.controller.querySelectionInlineStyle(a)},querySelectionBlockStyle:function(a){return this.controller.querySelectionBlockStyle(a)},querySelectionInlineStyles:function(){return this.controller.querySelectionInlineStyles()},querySelectionBlockStyles:function(){return this.controller.querySelectionBlockStyles()},isSameList:function(a){return this.controller.isSameList(a)},canRemoveFormat:function(){return this.controller.canRemoveFormat()},updateFormatPainterCursorUI:function(a){this.noteView.updateFormatPainterCursorUI(a)},setReadOnly:function(a){var b=this;b.controller.setReadOnly(a),a?(b._toolbar.disable(),f(b._ytableToolbarWrapper).addClass("read-only")):(b._toolbar.enable(),f(b._ytableToolbarWrapper).removeClass("read-only"))}})}({}),yne_common_io_editorApi={setContent:function(a,b){var c=this;b===!0?c._editor.setHtmlContent(a):c._editor.setXmlContent(a)},getContent:function(a){var b=this,c=b._editor;return a===!0?c.getHtmlContent():c.getXmlContent()},getSchemaVersion:function(){var a=this,b=a._editor;return b.getSchemaVersion()},setFont:function(a,b){var c=this,d=c._editor;return d.setFont(a,b)},resetFont:function(){var a=this,b=a._editor;return b.resetFont()}},yne_io_editorApi=function(a){var b=yne_common_io_editorApi,c=yne_underscore;return c.extend({getPlain:function(){var a=this,b=a._editor;return b.getPlainContent()},setFont:function(a,b){var c=this,d=c._editor;return d.setFont(a,b)},resetFont:function(){var a=this,b=a._editor;return b.resetFont()}},b)}({}),yne_io_eventList=["content-change","insert-photo","insert-link","insert-attachment","replace-image","replace-attachment","open-link","download-attachment","context-menu","show-words","save-content","blob-paste"],yne_common_util_htmlConvert=function(a){var b=yne_common_data_Note;return{xml2html:function(a){var c=b.fromXml(a),d=c.toHtml();return d},html2xml:function(a){var c=b.fromHtml(a),d=c.toXml();return d},html2html:function(a){var c=b.fromHtml(a),d=c.toHtml();return d}}}({}),yne_BulbEditor=function(a){var b,c=yne_jtk_core_Class,d=yne_backbone,e=yne_core_WebEditor,f=yne_underscore,g=yne_io_editorApi,h=yne_io_eventList,i=yne_common_util_htmlConvert,j={};return f.extend(j,g,{initialize:function(a){var b,c=this;if(a=f.extend({parentEl:null,render:!0,removeLocalImg:!0},a),a.render&&!a.parentEl)throw"BulbEditor need `parentEl`!";c._editor=b=new e(a),a.render&&b.render(),f.each(h,function(a){var d="yne-"+a;b.bind(d,function(){c.trigger.bind(c,a).apply(c,arguments)})})}},d.Events),b=c.extend(j,i)}({})});